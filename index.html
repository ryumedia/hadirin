<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kehadiran Karyawan (SPA)</title>
    <!-- Memuat Font Montserrat dari Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Memuat Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Menetapkan Montserrat sebagai font 'sans' default Tailwind
                        sans: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Memuat icon (Ionicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
        }
        /* Menyembunyikan tampilan secara default */
        .view {
            display: none;
        }
        .spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Kontainer Utama -->
    <div id="appContainer" class="flex flex-col min-h-screen">
        
        <!-- Layar Loading Awal -->
        <div id="loadingView" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
            <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
            <p class="mt-4 text-gray-600">Memverifikasi sesi...</p>
        </div>

        <!-- 1. Tampilan Login -->
        <div id="loginView" class="view flex flex-grow items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 sm:p-10">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-blue-600">Hadirin.org</h1>
                    <p class="text-gray-500 mt-2">Aplikasi Manajemen Kehadiran</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <div class="relative">
                            <input type="email" id="login-email" required placeholder="Email Anda"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <ion-icon name="mail-outline" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></ion-icon>
                        </div>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" required placeholder="Password"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <ion-icon name="lock-closed-outline" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></ion-icon>
                        </div>
                    </div>

                    <div id="loginMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm" role="alert"></div>

                    <button type="submit" id="loginButton"
                        class="w-full flex items-center justify-center px-4 py-2.5 rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 disabled:opacity-50">
                        <ion-icon name="log-in-outline" class="text-xl mr-2"></ion-icon>
                        <span id="loginButtonText">Masuk</span>
                        <div id="loginSpinner" class="hidden spinner w-4 h-4 border-2 border-t-transparent border-white ml-2" role="status"></div>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 2. Tampilan Karyawan -->
        <div id="karyawanView" class="view flex flex-grow items-start justify-center p-4 sm:p-6 lg:p-8 pb-20">
            <div class="w-full max-w-lg">
                <!-- Karyawan Header (Tetap sticky dan di atas) -->
                    <header id="karyawanHeader" class="flex justify-between rounded-lg items-start p-4 bg-white/70 backdrop-blur sticky top-0 z-10 border-b border-gray-200">
                        
                        <!-- KONTEN KIRI: NAMA, PERUSAHAAN, dan JAM PUSAT -->
                        <div class="flex-1 min-w-0">
                            
                            <!-- BARIS 1: NAMA KARYAWAN (Tidak Wrap) -->
                            <!-- Gunakan whitespace-nowrap, overflow-hidden, dan text-ellipsis -->
                            <p id="karyawanUserName" class="text-lg font-bold text-gray-800 transition-opacity duration-300 whitespace-nowrap overflow-hidden text-ellipsis">
                                Halo, [Nama Pengguna]
                            </p>
                            
                            <!-- BARIS 2: NAMA PERUSAHAAN -->
                            <p id="companyText" class="text-sm text-gray-600 mt-0.5 transition-opacity duration-300">
                                Company Name
                            </p>
                        </div>
                        
                        <!-- KONTEN KANAN: ICON ADMIN & LOGOUT (Tetap) -->
                        <div class="flex items-center space-x-4 ml-4">
                            <!-- Tombol Admin/Pengaturan (id="karyawanAdminLink" wajib ada untuk JS) -->
                            <!-- onclick harus memanggil changeView dan showAdminSection untuk memastikan Admin Dashboard dimuat di Ringkasan Harian -->
                            <button onclick="changeView('adminView'); showAdminSection('summary');" id="karyawanAdminLink" class="p-2 text-gray-600 hover:text-blue-600 transition duration-150 hidden">
                                <!-- Icon Admin/Pengaturan: Menggunakan Icon Gerigi (Cog) -->
                                <ion-icon name="settings-outline" class="text-2xl"></ion-icon>
                            </button>
                            <!-- Tombol Logout (Menambahkan onclick yang benar) -->
                            <button id="logoutBtn" onclick="doLogout()" class="p-2 text-red-500 hover:text-red-700 transition duration-150">
                                <!-- Icon Logout -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            </button>
                        </div>
                    </header>

                    <!-- Karyawan Absensi Section -->
                    <div id="karyawanSection_Absensi" class="mt-4 p-6 bg-white rounded-xl shadow-lg transition-all duration-300" style="display: block;">
                        
                        <!-- JAM (DIPUSATKAN) -->
                        <!-- Gunakan div dengan w-full dan text-center untuk memusatkan jam -->
                        <div class="w-full text-center mt-3 mb-3">
                            <p id="currentTime" class="text-5xl font-extrabold text-blue-600 transition-opacity duration-300">
                                00:00:00
                            </p>
                        </div>

                        <!-- Tombol Aksi Absensi -->
                        <div class="grid grid-cols-2 gap-4 mb-6 mt-6">
                            <button id="karyawanClockInButton" class="bg-green-600 text-white p-4 rounded-xl shadow-md hover:bg-green-700 transition duration-150 flex items-center justify-center font-bold text-lg disabled:opacity-50">
                                Clock-In
                            </button>
                            <button id="karyawanClockOutButton" class="bg-red-600 text-white p-4 rounded-xl shadow-md hover:bg-red-700 transition duration-150 flex items-center justify-center font-bold text-lg disabled:opacity-50" disabled>
                                <ion-icon name="log-out-outline" class="text-2xl mr-2"></ion-icon>
                                Clock-Out
                            </button>
                        </div>        
                
                        <!-- KONTEN HEADER CARD: JUDUL + TANGGAL/HARI -->
                        <!-- KONTEN HEADER CARD: JUDUL, TANGGAL, DAN IKON RIWAYAT -->
                        <div class="mb-4 border-b pb-2 flex justify-between items-start">
                            <!-- KIRI: Judul dan Tanggal -->
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Presensi Hari Ini</h3>
                                <p id="currentDateTime" class="text-base text-gray-500 mt-0.5"></p> 
                            </div>
                            
                            <!-- KANAN: Tombol Riwayat (BARU) -->
                            <button onclick="showKaryawanContent('History')" class="text-gray-500 hover:text-blue-600 transition p-1 -mt-1 -mr-1">
                                <ion-icon name="clipboard-outline" class="text-2xl"></ion-icon>
                                <p class="text-base text-gray-500 mt-0.5">Riwayat Presensi</p>
                            </button>
                        </div>
                        <div id="karyawanAttendanceStatus" class="text-center p-4 rounded-lg bg-gray-100 text-gray-700 font-medium">
                            Memuat status...
                        </div>
                            <p id="karyawanLocationDisplay" class="text-center text-sm text-gray-500 mt-2">
                                Lokasi: Belum diambil
                            </p>
                        <div class="mt-6 grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">Jam Masuk</p>
                                <p id="karyawanClockInTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">Jam Pulang</p>
                                <p id="karyawanClockOutTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================== -->
                    <!-- SECTION 2: PENGAJUAN (REQUESTS) KARYAWAN (BARU) -->
                    <!-- ============================================== -->
                    <div id="karyawanSection_Requests" class="mt-4" style="display: none;">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                                <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Riwayat Pengajuan Koreksi</h2>
                                <!-- Tombol untuk membuka Modal -->
                                <button onclick="openRequestAttendanceModal()" class="w-full sm:w-auto flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                    <ion-icon name="add-outline" class="mr-1"></ion-icon> Ajukan Koreksi Baru
                                </button>
                            </div>
                            
                            <p class="text-sm text-gray-500 mb-4">Daftar ini adalah riwayat pengajuan koreksi absensi Anda (lupa clock-in/out).</p>

                            <!-- Tabel Riwayat Pengajuan Karyawan -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Absensi</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="requestListTableBody">
                                        <!-- Data riwayat pengajuan akan dimuat di sini oleh JS -->
                                        <tr><td colspan="3" class="text-center py-8 text-gray-500">Memuat riwayat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Tombol Kembali (BARU) -->
                            <button onclick="showKaryawanContent('Absensi')" class="mt-6 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                        </div>
                    </div>

            </div>
        </div>

        <!-- =============================================================== -->
        <!-- 3. TAMPILAN ADMIN (STRUKTUR DIPERBAIKI)                     -->
        <!-- =============================================================== -->
        <div id="adminView" class="view flex flex-grow w-full p-0 sm:p-0 lg:p-0">
            <!-- Kontainer Flexbox untuk Sidebar + Konten Utama -->
            <div class="w-full max-w-full mx-auto flex flex-col min-h-screen sm:flex-row">
                
                <!-- SIDEBAR (Menu Samping) -->
                <nav id="adminSidebar" class="bg-gray-800 text-white w-full sm:w-64 flex-shrink-0 p-4 sm:p-6 border-r border-gray-700 transition-all duration-300 ease-in-out">
                    <h2 class="text-xl font-bold mb-6 hidden sm:block">Menu Admin</h2>
                    
                    <ul id="adminSidebarContent" class="space-y-2">
                        <li>
                            <button id="menuSummary" onclick="showAdminSection('summary')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 bg-blue-600 hover:bg-blue-700">
                                <ion-icon name="speedometer-outline" class="text-lg mr-3"></ion-icon> Ringkasan Harian
                            </button>
                        </li>
                        <li>
                            <button id="menuEmployees" onclick="showAdminSection('employees')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="people-outline" class="text-lg mr-3"></ion-icon> Manajemen Karyawan
                            </button>
                        </li>
                        <li id="menuCompaniesContainer" class="hidden"> <!-- Kontainer untuk menu Super Admin -->
                            <button id="menuCompanies" onclick="showAdminSection('companies')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="business-outline" class="text-lg mr-3"></ion-icon> Manajemen Perusahaan
                            </button>
                        </li>
                        <li>
                            <button id="menuRekap" onclick="showAdminSection('rekap')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="calendar-outline" class="text-lg mr-3"></ion-icon> Rekap Kehadiran
                            </button>
                        </li>
                        <li>
                            <button id="menuMasters" onclick="showAdminSection('masters')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="archive-outline" class="text-lg mr-3"></ion-icon> Master Data
                            </button>
                        </li>
                        <!-- MANAJEMEN JAM KERJA (BARU) -->
                        <li>
                            <button id="menuWorkhours" onclick="showAdminSection('workhours')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="briefcase-outline" class="text-lg mr-3"></ion-icon> Manajemen Jam Kerja
                            </button>
                        </li>
                        <!-- Grup Menu PENGAJUAN (ACCORDION BARU) -->
                        <li>
                            <button id="menuRequests" onclick="toggleSubMenu('requestsSubMenu')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="document-text-outline" class="text-lg mr-3"></ion-icon> 
                                <span class="flex-1">Pengajuan (Requests)</span>
                                <ion-icon id="requestsSubMenuIcon" name="chevron-down-outline" class="text-lg transition-transform duration-300"></ion-icon>
                            </button>
                        </li>
                        
                        <!-- Sub Menu Requests (Default Hidden, overflow-hidden untuk transisi) -->
                        <ul id="requestsSubMenu" class="space-y-1 pl-4 h-0 overflow-hidden transition-all duration-300 ease-in-out">
                            <li>
                                <button id="menuReqAttendance" onclick="showAdminSection('reqattendance')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="time-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Koreksi Kehadiran
                                </button>
                            </li>
                            <li>
                                <button id="menuReqTimeoff" onclick="showAdminSection('reqtimeoff')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="calendar-number-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Izin / Cuti
                                </button>
                            </li>
                            <li>
                                <button id="menuReqOvertime" onclick="showAdminSection('reqovertime')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="stopwatch-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Lembur
                                </button>
                            </li>
                        </ul>
                        <!-- Akhir Sub Menu Requests -->
                        <!-- Akhir Grup Menu Pengajuan -->
                        <li>
                            <button id="menuTimeoffBalance" onclick="showAdminSection('timeoffbalance')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="today-outline" class="text-lg mr-3"></ion-icon> Saldo Cuti Karyawan
                            </button>
                        </li>
                        <!-- Tambahkan menu-menu baru di sini di masa depan -->
                    </ul>
                </nav>

                <!-- KONTEN UTAMA (Tempat Header dan Isi Dashboard berada) -->
                <main class="flex-grow p-4 sm:p-6 lg:p-8 bg-gray-50 overflow-y-auto">
                    
                    <!-- Header Admin (Dipindahkan ke dalam <main>) -->
                    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b pb-4">
                        <div class="flex items-center"> <!-- Kolom Kiri Header (DIUBAH) -->
                            <button id="sidebarToggleButton" onclick="toggleAdminSidebar()" class="text-gray-600 hover:text-gray-900 transition mr-4 hidden sm:block">
                                <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
                            </button>
                            <div>
                                <h1 class="text-3xl font-extrabold text-gray-900">Dashboard Admin <span id="adminRoleDisplay" class="text-sm font-medium text-blue-600"></span></h1>
                                <!-- Menampilkan Nama & Email Admin yang Login (BARU) -->
                                <p id="adminInfoDisplay" class="text-gray-900 font-normal mt-1 text-sm">Nama Admin (email@domain.com)</p>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 flex items-center space-x-4"> <!-- Kolom Kanan Header -->
                            <button onclick="changeView('karyawanView')" class="flex items-center text-blue-600 hover:text-blue-800 transition text-sm font-medium">
                                <ion-icon name="person-outline" class="mr-1"></ion-icon> Halaman Karyawan
                            </button>
                            <button onclick="doLogout()" class="flex items-center text-red-500 hover:text-red-700 transition text-sm font-medium">
                                <ion-icon name="log-out-outline" class="mr-1"></ion-icon> Logout
                            </button>
                        </div>
                    </header>

                    <!-- Kontainer Konten Sesuai Sidebar -->
                    <div id="adminContentContainer">
                        <!-- SECTION 1: RINGKASAN HARIAN (ID DIPERBAIKI) -->
                        <div id="sectionSummary" style="display: none;">
                            <!-- Kartu Statistik -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Total Karyawan</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="adminTotalEmployees">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Hadir (Clock In)</p>
                                    <p class="text-3xl font-bold text-green-600 mt-1" id="adminTotalHadir">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Izin / Sakit</p>
                                    <p class="text-3xl font-bold text-yellow-600 mt-1" id="adminTotalIzin">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Alpa</p>
                                    <p class="text-3xl font-bold text-red-600 mt-1" id="adminTotalAlpa">0</p>
                                </div>
                            </div>
                        
                            <!-- Filter dan Tabel -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-3 sm:space-y-0">
                                    <h2 class="text-xl font-semibold text-gray-800">Tabel Kehadiran Harian</h2>
                                    <input type="date" id="adminAttendanceDateFilter" class="border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Tabel Responsif -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="adminAttendanceTableBody">
                                            <!-- Data akan dimasukkan di sini oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <p id="adminNoDataMessage" class="hidden text-center text-gray-500 mt-4">Tidak ada data kehadiran untuk tanggal ini.</p>
                            </div>
                        </div> <!-- End sectionSummary -->

                        <!-- SECTION 2: MANAJEMEN KARYAWAN (ID DIPERBAIKI) -->
                        <div id="sectionEmployees" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Daftar Karyawan</h2>
                                    <button onclick="openEmployeeModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="person-add-outline" class="mr-1"></ion-icon> Tambah Karyawan Baru
                                    </button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Karyawan</th>
                                                <th id="companyColumnHeader" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="employeeListTableBody">
                                            <!-- Data akan dimuat di sini oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionEmployees -->

                        <!-- SECTION 3: MANAJEMEN PERUSAHAAN (BARU) -->
                        <div id="sectionCompanies" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Daftar Perusahaan</h2>
                                    <button onclick="openCompanyModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Perusahaan Baru
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Perusahaan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Dibuat</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="companyListTableBody">
                                            <!-- Data perusahaan akan dimuat oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionCompanies -->

                        <!-- SECTION 4: REKAP KEHADIRAN (BARU) -->
                        <div id="sectionRekap" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Laporan Kehadiran</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="rekapStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="rekapStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="rekapEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="rekapEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="rekapEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="rekapEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                            <!-- Opsi akan diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="rekapStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Kehadiran</label>
                                        <select id="rekapStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Hadir">Hadir</option>
                                            <option value="Terlambat">Terlambat</option>
                                            <option value="Izin">Izin</option>
                                            <option value="Sakit">Sakit</option>
                                            <option value="Alpa">Alpa</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="rekapFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Rekap
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Hasil Rekap</h3>

                                <!-- KARTU STATISTIK REKAP (BARU) -->
                                <!-- Container ini akan 'hidden' dan baru muncul setelah data dimuat -->
                                <div id="rekapSummaryContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 hidden">
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Total Hadir</p>
                                        <p class="text-2xl font-bold text-green-600 mt-1" id="rekapTotalHadir">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Terlambat</p>
                                        <p class="text-2xl font-bold text-yellow-600 mt-1" id="rekapTotalTerlambat">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Sakit</p>
                                        <p class="text-2xl font-bold text-yellow-600 mt-1" id="rekapTotalSakit">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Izin/Cuti</p>
                                        <p class="text-2xl font-medium text-gray-500" id="rekapTotalIzin">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Alpa</p>
                                        <p class="text-2xl font-bold text-red-600 mt-1" id="rekapTotalAlpa">0</p>
                                    </div>
                                </div>

                                <!-- Tabel Hasil Rekap -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="rekapTableBody">
                                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Rekap'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionRekap -->

                        <!-- SECTION 5: PENGAJUAN KOREKSI KEHADIRAN (BARU) -->
                        <div id="sectionReqattendance" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Koreksi Kehadiran</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqAttStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="reqAttStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqAttEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="reqAttEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="reqAttEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqAttEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                            <!-- Opsi akan diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="reqAttStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqAttStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqAttFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan</h3>

                                <!-- Tabel Hasil Pengajuan -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Kehadiran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi (Alasan)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status Pengajuan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqAttTableBody">
                                            <tr><td colspan="8" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionReqAttendance -->

                        <!-- SECTION 6: PENGAJUAN IZIN / CUTI (BARU) -->
                        <div id="sectionReqtimeoff" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Izin / Cuti</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal (Gunakan ID unik) -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqTimeoffStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="reqTimeoffStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqTimeoffEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="reqTimeoffEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan (Gunakan ID unik) -->
                                    <div>
                                        <label for="reqTimeoffEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqTimeoffEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                        </select>
                                    </div>

                                    <!-- Filter Status (Gunakan ID unik) -->
                                    <div>
                                        <label for="reqTimeoffStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqTimeoffStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqTimeoffFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan Izin/Cuti
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan</h3>

                                <!-- Tabel Hasil Pengajuan (Gunakan ID unik) -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Pengajuan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Timeoff</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Mulai</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Akhir</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqTimeoffTableBody">
                                            <tr><td colspan="9" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 7: PENGAJUAN LEMBUR (BARU) -->
                        <div id="sectionReqovertime" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Lembur</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal Lembur -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqOvertimeStartDate" class="block text-xs font-medium text-gray-700 mb-1">Tgl Lembur Dari</label>
                                            <input type="date" id="reqOvertimeStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqOvertimeEndDate" class="block text-xs font-medium text-gray-700 mb-1">Tgl Lembur Sampai</label>
                                            <input type="date" id="reqOvertimeEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="reqOvertimeEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqOvertimeEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="reqOvertimeStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqOvertimeStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqOvertimeFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan Lembur
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan Lembur</h3>

                                <!-- Tabel Hasil Pengajuan -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Lembur</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai - Akhir</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqOvertimeTableBody">
                                            <tr><td colspan="8" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan Lembur'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionReqovertime -->

                        <!-- ============================================= -->
                        <!-- SECTION 8: MASTER DATA (BARU)               -->
                        <!-- ============================================= -->
                        <div id="sectionMasters" style="display: none;">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manajemen Master Data</h2>

                            <!-- Kontainer Tab -->
                            <div class="mb-4 border-b border-gray-200">
                                <nav class="flex -mb-px space-x-8" aria-label="Tabs">
                                    <!-- Tab 1: Tipe Izin/Cuti (Aktif) -->
                                    <button id="tabMasterTimeoff" onclick="showMasterTab('timeoff')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                                        Tipe Izin/Cuti
                                    </button>
                                    <!-- Tab 2: Tipe Gaji -->
                                    <button id="tabMasterSalary" onclick="showMasterTab('salary')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        Tipe Gaji
                                    </button>
                                    <!-- Tab 3: Tipe Potongan -->
                                    <button id="tabMasterDeduction" onclick="showMasterTab('deduction')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        Tipe Potongan
                                    </button>
                                </nav>
                            </div>

                            <!-- Konten Tab -->
                            <div>
                                <!-- Konten 1: Tipe Izin/Cuti -->
                                <div id="masterContentTimeoff">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Tipe Izin/Cuti</h3>
                                            <button onclick="openMasterModal('add', 'timeoff')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Tipe Baru
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tipe Izin/Cuti</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi (Opsional)</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="timeoffTypesTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Konten 2: Tipe Gaji (Aktif) -->
                                <div id="masterContentSalary" class="hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Tipe Gaji</h3>
                                            <!-- (PENTING) 'salary' merujuk ke tipe di JS -->
                                            <button onclick="openMasterModal('add', 'salary')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Tipe Gaji
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tipe Gaji</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai (Rp/%)</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="salaryTypesTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Konten 3: Tipe Potongan (Aktif) -->
                                <div id="masterContentDeduction" class="hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Tipe Potongan</h3>
                                            <!-- (PENTING) 'deduction' merujuk ke tipe di JS -->
                                            <button onclick="openMasterModal('add', 'deduction')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Tipe Potongan
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tipe Potongan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai (Rp/%)</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="deductionTypesTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End sectionMasters -->

                        <!-- ============================================= -->
                        <!-- SECTION 9: MANAJEMEN JAM KERJA (BARU)       -->
                        <!-- ============================================= -->
                        <div id="sectionWorkhours" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Manajemen Jam Kerja</h2>
                                    <button onclick="openWorkhourModal('add')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Pola Jam Kerja
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Buat pola jam kerja (cth: "Shift Pagi", "Full-time") lalu tugaskan karyawan ke pola ini di menu "Manajemen Karyawan".
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pola Jam Kerja</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="workhoursTableBody">
                                            <!-- Data diisi oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionWorkhours -->

                        <!-- ============================================= -->
                        <!-- SECTION 10: MANAJEMEN SALDO CUTI (BARU)     -->
                        <!-- ============================================= -->
                        <div id="sectionTimeoffbalance" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Manajemen Saldo Cuti Tahunan</h2>
                                    <button onclick="openTimeoffBalanceModal('add')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Saldo Baru
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Atur jatah hari cuti tahunan (atau cuti berbatas lainnya) untuk setiap karyawan.
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe Cuti</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Sisa (Hari)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="timeoffBalanceTableBody">
                                            <!-- Data diisi oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionTimeoffbalance -->
            
                        <!-- SECTION 8: TIMEOFF (KONTEN BARU) -->
                        <div id="karyawanSection_Timeoff" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Manajemen Cuti & Izin</h2>
                                <p class="text-gray-500 mt-2">Fitur setting cuti akan ditambahkan di sini.</p>
                            </div>
                        </div>

                        <!-- SECTION 9: OVERTIME (KONTEN BARU) -->
                        <div id="karyawanSection_Overtime" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Manajemen Lembur</h2>
                                <p class="text-gray-500 mt-2">Fitur setting lembur akan ditambahkan di sini.</p>
                            </div>
                        </div>

                        <!-- SECTION 10: SALARY (KONTEN BARU) -->
                        <div id="karyawanSection_Salary" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Informasi Gaji</h2>
                                <p class="text-gray-500 mt-2">setting gaji dan rincian akan ditampilkan di sini.</p>
                            </div>
                        </div>

                    </div> <!-- End adminContentContainer -->
                </main> <!-- End main -->
            </div> <!-- End flex container -->
        </div> <!-- End adminView -->

            <!-- ============================================== -->
            <!-- FOOTER NAVIGASI KARYAWAN (BARU)              -->
            <!-- ============================================== -->
            <footer id="karyawanFooterNav" class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 shadow-xl hidden">
                <div class="grid grid-cols-5 h-16 max-w-lg mx-auto">
                    
                    <!-- 1. Request Attendance (Koreksi Absensi) -->
                    <button id="tabRequestAttendance" onclick="showKaryawanContent('Requests')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="document-text-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Request</span>
                    </button>

                    <!-- 2. Request Timeoff (Cuti/Izin) -->
                    <button id="tabRequestTimeoff" onclick="showKaryawanContent('Timeoff')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="calendar-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Timeoff</span>
                    </button>

                    <!-- 3. Attendance (HOME) - Default Active -->
                    <button id="tabAttendanceHome" onclick="showKaryawanContent('Absensi')" class="flex flex-col items-center justify-center text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="home-outline" class="text-2xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Home</span>
                    </button>

                    <!-- 4. Overtime (Lembur) -->
                    <button id="tabOvertime" onclick="showKaryawanContent('Overtime')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="stopwatch-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Lembur</span>
                    </button>

                    <!-- 5. Salary (Gaji) -->
                    <button id="tabSalary" onclick="showKaryawanContent('Salary')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="wallet-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Gaji</span>
                    </button>

                </div>
            </footer>

        </div> <!-- End AppContainer -->

            <!-- =============================================================== -->
            <!-- MODALS (DIPINDAHKAN KE LUAR TAMPILAN)                         -->
            <!-- =============================================================== -->

            <!-- Modal Ubah Status Kehadiran -->
            <div id="statusModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Ubah Status Kehadiran
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500 mb-4">Karyawan: <span id="modalEmployeeName" class="font-semibold text-gray-700"></span></p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label for="modalStatus" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="modalStatus" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                            <option value="Hadir">Hadir</option>
                                            <option value="Terlambat">Terlambat</option>
                                            <option value="Izin">Izin</option>
                                            <option value="Sakit">Sakit</option>
                                            <option value="Alpa">Alpa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="modalClockIn" class="block text-sm font-medium text-gray-700">Jam Masuk (Jika Hadir)</label>
                                        <input type="time" id="modalClockIn" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled>
                                    </div>
                                    <div>
                                        <label for="modalClockOut" class="block text-sm font-medium text-gray-700">Jam Pulang (Jika Hadir)</label>
                                        <input type="time" id="modalClockOut" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="modalSaveButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Simpan
                            </button>
                            <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Tambah/Edit Karyawan -->
            <div id="employeeModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeEmployeeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
                        <form id="employeeForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="employeeModalTitle">
                                    Tambah Karyawan Baru
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Input Email & Password -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                            <input type="email" id="employeeEmail" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="employeePassword" class="block text-sm font-medium text-gray-700">Password</label>
                                            <input type="password" id="employeePassword" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>

                                    <!-- Nama & ID Karyawan -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeFullName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                            <input type="text" id="employeeFullName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="employeeIDNumber" class="block text-sm font-medium text-gray-700">ID Karyawan</label>
                                            <input type="text" id="employeeIDNumber" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>
                                    
                                    <!-- Pilih Perusahaan (Hanya untuk Super Admin) -->
                                    <div id="companySelectContainer" class="hidden">
                                        <label for="employeeCompany" class="block text-sm font-medium text-gray-700">Perusahaan</label>
                                        <select id="employeeCompany" onchange="loadWorkhourDropdown('employeeWorkhour', this.value)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <!-- Opsi perusahaan akan dimuat oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Role & Status -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeRole" class="block text-sm font-medium text-gray-700">Peran (Role)</label>
                                            <select id="employeeRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="karyawan">Karyawan</option>
                                                <option value="company_admin">Company Admin</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="employeeStatus" class="block text-sm font-medium text-gray-700">Status</label>
                                            <select id="employeeStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="Percobaan">Percobaan</option>
                                                <option value="Kontrak">Kontrak</option>
                                                <option value="Tetap">Tetap</option>
                                                <option value="Freelance">Freelance</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- (BARU) PILIH POLA JAM KERJA -->
                                    <div id="workhourSelectContainer">
                                        <label for="employeeWorkhour" class="block text-sm font-medium text-gray-700">Pola Jam Kerja</label>
                                        <select id="employeeWorkhour" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Pola Jam Kerja --</option>
                                            <!-- Opsi akan dimuat oleh JS dari tabel workhours -->
                                        </select>
                                    </div>

                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveEmployeeButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan & Daftarkan
                                </button>
                                <button type="button" onclick="closeEmployeeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>    

            <!-- Modal Tambah/Edit Perusahaan -->
            <div id="companyModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeCompanyModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="companyForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="companyModalTitle">
                                    Tambah Perusahaan Baru
                                </h3>
                                <div class="mt-4">
                                    <div>
                                        <label for="companyName" class="block text-sm font-medium text-gray-700">Nama Perusahaan</label>
                                        <input type="text" id="companyName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveCompanyButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan
                                </button>
                                <button type="button" onclick="closeCompanyModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Ajukan Koreksi Kehadiran (BARU) -->
            <div id="requestAttendanceModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <!-- Latar belakang overlay -->
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeRequestAttendanceModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <!-- Konten Modal -->
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="requestAttendanceForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="requestModalTitle">
                                    Ajukan Koreksi Kehadiran
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Tanggal Absensi -->
                                    <div>
                                        <label for="reqAttDate" class="block text-sm font-medium text-gray-700">Tanggal Absensi yang Dikoreksi</label>
                                        <input type="date" id="reqAttDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    
                                    <!-- Jam Masuk & Pulang -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="reqAttClockIn" class="block text-sm font-medium text-gray-700">Jam Masuk (Seharusnya)</label>
                                            <input type="time" id="reqAttClockIn" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="reqAttClockOut" class="block text-sm font-medium text-gray-700">Jam Pulang (Seharusnya)</label>
                                            <input type="time" id="reqAttClockOut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>

                                    <!-- Alasan -->
                                    <div>
                                        <label for="reqAttDescription" class="block text-sm font-medium text-gray-700">Alasan Koreksi</label>
                                        <textarea id="reqAttDescription" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Lupa absen pulang karena meeting mendadak di luar kantor."></textarea>
                                    </div>
                                    
                                    <p class="text-xs text-gray-500">Penting: Anda harus mengisi setidaknya salah satu Jam Masuk atau Jam Pulang.</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveRequestButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Kirim Pengajuan
                                </button>
                                <button type="button" onclick="closeRequestAttendanceModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Status Perusahaan (BARU) -->
            <div id="companyStatusModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmStatusModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="companyStatusModalTitle">
                                Konfirmasi Perubahan Status
                                </h3>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600" id="companyStatusModalText">
                                    Apakah Anda yakin ingin mengubah status perusahaan ini?
                                    </p>
                                </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="companyStatusConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Ubah Status
                            </button>
                            <button type="button" onclick="closeConfirmStatusModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Alasan Keterlambatan (BARU) -->
            <div id="lateReasonModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <!-- Konten Modal -->
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="lateReasonForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="lateReasonModalTitle">
                                    Anda Terlambat
                                </h3>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600 mb-4">
                                        Waktu clock-in Anda melewati batas toleransi. Silakan isi alasan keterlambatan Anda di bawah ini.
                                    </p>
                                    <div>
                                        <label for="lateReasonDescription" class="block text-sm font-medium text-gray-700">Alasan Keterlambatan</label>
                                        <textarea id="lateReasonDescription" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Terjebak macet di jalan..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="lateReasonSubmitButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Kirim Alasan & Clock-In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Add/Edit Master Data (BARU) -->
            <div id="masterDataModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeMasterModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="masterDataForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="masterModalTitle">
                                    Tambah Data Master
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div>
                                        <label for="masterName" class="block text-sm font-medium text-gray-700">Nama</label>
                                        <input type="text" id="masterName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <!-- DROPDOWN PERUSAHAAN (BARU) -->
                                    <div id="masterCompanySelectContainer" class="hidden">
                                        <label for="masterCompanySelect" class="block text-sm font-medium text-gray-700">Perusahaan</label>
                                        <select id="masterCompanySelect" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="masterDescription" class="block text-sm font-medium text-gray-700">Deskripsi (Opsional)</label>
                                        <textarea id="masterDescription" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"></textarea>
                                    </div>
                                    <!-- (BARU) Field Khusus Tipe Potongan -->
                                    <div id="masterDeductionFields" class="hidden space-y-4 pt-4 border-t">
                                        <h4 class="text-sm font-medium text-gray-500">Aturan Potongan</h4>
                                        <div>
                                            <label for="masterDeductionMethod" class="block text-sm font-medium text-gray-700">Metode Perhitungan</label>
                                            <select id="masterDeductionMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="Nominal Tetap">Nominal Tetap</option>
                                                <option value="Persentase">Persentase</option>
                                                <option value="Berdasarkan Absensi">Berdasarkan Absensi</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="masterDeductionValue" class="block text-sm font-medium text-gray-700">Nilai (Rp. atau %)</label>
                                            <input type="number" id="masterDeductionValue" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Contoh: 10000 atau 5 (untuk 5%)">
                                        </div>
                                        <!-- (BARU) DROPDOWN KONDISI (PEMICU) -->
                                        <div id="masterDeductionConditionContainer" class="hidden"> 
                                            <label for="masterDeductionCondition" class="block text-sm font-medium text-gray-700">Terapkan Jika Status Absensi</label>
                                            <select id="masterDeductionCondition" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="">-- Pilih Pemicu --</option>
                                                <option value="Terlambat">Terlambat</option>
                                                <option value="Alpa">Alpa</option>
                                                <option value="Sakit">Sakit</option>
                                                <option value="Izin">Izin</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- (BARU) Field Khusus Tipe Gaji -->
                                    <div id="masterSalaryFields" class="hidden space-y-4 pt-4 border-t">
                                        <h4 class="text-sm font-medium text-gray-500">Aturan Tunjangan/Gaji</h4>
                                        <div>
                                            <label for="masterSalaryMethod" class="block text-sm font-medium text-gray-700">Metode Perhitungan</label>
                                            <select id="masterSalaryMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <!-- Opsi dari ENUM 'salary_method_enum' -->
                                                <option value="Nominal Tetap">Nominal Tetap</option>
                                                <option value="Berdasarkan Lembur">Berdasarkan Lembur</option>
                                                <option value="Berdasarkan Absensi">Berdasarkan Absensi</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="masterSalaryValue" class="block text-sm font-medium text-gray-700">Nilai (Rp)</label>
                                            <input type="number" id="masterSalaryValue" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: 25000 (untuk per jam lembur)">
                                        </div>
                                        
                                        <!-- (BARU) DROPDOWN KONDISI (PEMICU) UNTUK GAJI -->
                                        <div id="masterSalaryConditionContainer" class="hidden"> 
                                            <label for="masterSalaryCondition" class="block text-sm font-medium text-gray-700">Pemicu Aturan</label>
                                            <select id="masterSalaryCondition" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="">-- Pilih Pemicu --</option>
                                                <!-- Pemicu untuk 'Berdasarkan Lembur' -->
                                                <option value="overtime_approved">Lembur Disetujui</option>
                                                <!-- Pemicu untuk 'Berdasarkan Absensi' -->
                                                <option value="Hadir">Bonus Kehadiran (Hadir)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveMasterButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan
                                </button>
                                <button type="button" onclick="closeMasterModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Delete Master Data (BARU) -->
            <div id="masterDeleteModal" class="fixed z-40 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmDeleteModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Konfirmasi Hapus
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600" id="masterDeleteText">
                                    Apakah Anda yakin ingin menghapus data ini?
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="masterDeleteConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Hapus
                            </button>
                            <button type="button" onclick="closeConfirmDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Add/Edit Jam Kerja (BARU) -->
            <div id="workhourModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeWorkhourModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <!-- Konten Modal (Dibuat lebih lebar: sm:max-w-3xl) -->
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                        <form id="workhourForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="workhourModalTitle">
                                    Tambah Pola Jam Kerja
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Nama Pola dan Perusahaan (jika Super Admin) -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="workhourName" class="block text-sm font-medium text-gray-700">Nama Pola Jam Kerja</label>
                                            <input type="text" id="workhourName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Full-time (08-17)">
                                        </div>
                                        <div id="workhourCompanyContainer" class="hidden">
                                            <label for="workhourCompanySelect" class="block text-sm font-medium text-gray-700">Perusahaan</tabel>
                                            <select id="workhourCompanySelect" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <!-- Opsi diisi oleh JS -->
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Pengaturan Jadwal 7 Hari -->
                                    <div class="space-y-3 pt-4 border-t">
                                        <h4 class="text-md font-medium text-gray-800">Atur Jadwal Mingguan</h4>
                                        <!-- (JS akan digunakan untuk enable/disable time input) -->
                                        <!-- Nama hari (cth: 'senin') HARUS lowercase untuk ID -->
                                        
                                        <!-- HARI (Dibuat sebagai Grid) -->
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4">
                                            <!-- Contoh 1 Hari: Senin -->
                                            <div id="wh_day_senin" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Senin</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_senin_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_senin_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_senin_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_senin_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Selasa -->
                                            <div id="wh_day_selasa" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Selasa</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_selasa_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_selasa_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_selasa_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_selasa_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Rabu -->
                                            <div id="wh_day_rabu" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Rabu</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_rabu_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_rabu_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_rabu_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_rabu_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Kamis -->
                                            <div id="wh_day_kamis" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Kamis</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_kamis_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_kamis_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_kamis_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_kamis_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Jumat -->
                                            <div id="wh_day_jumat" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Jumat</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_jumat_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_jumat_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_jumat_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_jumat_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Sabtu -->
                                            <div id="wh_day_sabtu" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Sabtu</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_sabtu_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
                                                        <label for="wh_sabtu_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_sabtu_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="09:00" disabled>
                                                    <input type="time" id="wh_sabtu_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="14:00" disabled>
                                                </div>
                                            </div>
                                            <!-- Minggu -->
                                            <div id="wh_day_minggu" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Minggu</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_minggu_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
                                                        <label for="wh_minggu_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_minggu_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="09:00" disabled>
                                                    <input type="time" id="wh_minggu_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="14:00" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveWorkhourButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan Pola Jam Kerja
                                </button>
                                <button type="button" onclick="closeWorkhourModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Delete Jam Kerja (BARU) -->
            <div id="workhourDeleteModal" class="fixed z-40 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmWorkhourDelete()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Konfirmasi Hapus Jam Kerja
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600" id="workhourDeleteText">
                                    Apakah Anda yakin ingin menghapus pola jam kerja ini?
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="workhourDeleteConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Hapus
                            </button>
                            <button type="button" onclick="closeConfirmWorkhourDelete()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Add/Edit Saldo Cuti (BARU) -->
            <div id="timeoffBalanceModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeTimeoffBalanceModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="timeoffBalanceForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="timeoffBalanceModalTitle">
                                    Tetapkan Saldo Cuti Baru
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Pilih Karyawan (Hanya mode ADD) -->
                                    <div id="balanceEmployeeSelectContainer">
                                        <label for="balanceEmployeeSelect" class="block text-sm font-medium text-gray-700">Karyawan</label>
                                        <select id="balanceEmployeeSelect" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Karyawan --</option>
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Pilih Tipe Cuti (Hanya mode ADD) -->
                                    <div id="balanceTimeoffTypeSelectContainer">
                                        <label for="balanceTimeoffTypeSelect" class="block text-sm font-medium text-gray-700">Tipe Cuti (Berbatas)</label>
                                        <select id="balanceTimeoffTypeSelect" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Tipe Cuti --</option>
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>
                                    
                                    <!-- Jumlah Hari Saldo -->
                                    <div>
                                        <label for="balanceDays" class="block text-sm font-medium text-gray-700">Jumlah Saldo Hari (Cth: 12)</label>
                                        <input type="number" id="balanceDays" step="0.5" required min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Masukkan jumlah hari cuti">
                                    </div>

                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveTimeoffBalanceButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan Saldo
                                </button>
                                <button type="button" onclick="closeTimeoffBalanceModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Kotak Pesan Global -->
            <div id="messageBox" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

    <script>
        // ===============================================================
        // KONFIGURASI SUPABASE
        // ===============================================================
        const SUPABASE_URL = 'https://fmknmegucccckdivoslm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZta25tZWd1Y2NjY2tkaXZvc2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzAyMTUsImV4cCI6MjA3ODQ0NjIxNX0.usJdg1Pcl_UezylR09srX_-Z0W9Vo4Xxn1XAWWhCOhI';
        // ===============================================================

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // GLOBAL STATE
        let globalProfile = null; // Menyimpan data profil pengguna yang sedang login
        let currentAttendanceId = null; // ID absensi hari ini yang sedang aktif (untuk Karyawan)
        let modalAttendanceData = {}; // Data absensi yang sedang diedit di modal Admin
        let allEmployees = []; // Digunakan untuk mengisi dropdown filter
        
        // DOM ELEMENTS
        const loadingView = document.getElementById('loadingView');
        const loginView = document.getElementById('loginView');
        const karyawanView = document.getElementById('karyawanView');
        const adminView = document.getElementById('adminView');
        const messageBox = document.getElementById('messageBox');
        
        // --- KARYAWAN ELEMENTS ---
        const karyawanUserName = document.getElementById('karyawanUserName');
        const karyawanAttendanceStatus = document.getElementById('karyawanAttendanceStatus');
        const karyawanClockInTime = document.getElementById('karyawanClockInTime');
        const karyawanClockOutTime = document.getElementById('karyawanClockOutTime');
        const karyawanClockInButton = document.getElementById('karyawanClockInButton');
        const karyawanClockOutButton = document.getElementById('karyawanClockOutButton');
        const karyawanAdminLink = document.getElementById('karyawanAdminLink');
        
        // --- ADMIN ELEMENTS ---
        const adminRoleDisplay = document.getElementById('adminRoleDisplay');
        const adminAttendanceTableBody = document.getElementById('adminAttendanceTableBody');
        const adminAttendanceDateFilter = document.getElementById('adminAttendanceDateFilter');
        const employeeListTableBody = document.getElementById('employeeListTableBody');

        // --- MODAL ELEMENTS ---
        const statusModal = document.getElementById('statusModal');
        const modalEmployeeName = document.getElementById('modalEmployeeName');
        const modalStatus = document.getElementById('modalStatus');
        const modalClockIn = document.getElementById('modalClockIn');
        const modalClockOut = document.getElementById('modalClockOut');
        const modalSaveButton = document.getElementById('modalSaveButton');
        const lateReasonModal = document.getElementById('lateReasonModal');
        const lateReasonForm = document.getElementById('lateReasonForm');
        const lateReasonDescription = document.getElementById('lateReasonDescription');

        let tempClockInData = {};
        
        // ===============================================================
        // HELPER FUNCTIONS (UTILITY)
        // ===============================================================

        // --- FUNGSI BARU: MEMUAT NAMA PERUSAHAAN ---
        async function loadCompanyDetails() {
            if (!globalProfile || !globalProfile.company_id) {
                document.getElementById('companyText').textContent = 'Tidak Terikat Perusahaan';
                return;
            }

            const { data, error } = await _supabase
                .from('companies')
                .select('name')
                .eq('id', globalProfile.company_id)
                .single();

            if (error || !data) {
                console.error("Gagal memuat nama perusahaan:", error?.message || 'Data tidak ditemukan');
                document.getElementById('companyText').textContent = 'Perusahaan Tidak Ditemukan';
                return;
            }

            // SET NAMA PERUSAHAAN DI HEADER KARYAWAN
            document.getElementById('companyText').textContent = data.name;
        }
        
        // FUNGSI NAVIGASI SIDEBAR ADMIN (DIPERBAIKI UNTUK ACCORDION)
        function showAdminSection(sectionName) {
            // Daftar semua section 
            const sections = ['summary', 'employees', 'companies', 'rekap', 'reqattendance', 'reqtimeoff', 'reqovertime', 'masters', 'workhours', 'timeoffbalance'];
            
            // Daftar semua tombol menu (termasuk sub-menu)
            const menus = ['menuSummary', 'menuEmployees', 'menuCompanies', 'menuRekap', 'menuReqAttendance', 'menuReqTimeoff', 'menuReqOvertime', 'menuRequests', 'menuMasters', 'menuWorkhours', 'menuTimeoffBalance'];
            
            // Elemen Accordion
            const requestsMenu = document.getElementById('menuRequests');
            const requestsSubMenu = document.getElementById('requestsSubMenu');
            const requestsSubMenuIcon = document.getElementById('requestsSubMenuIcon');

            // 1. Reset semua section dan menu
            sections.forEach(name => {
                const sectionId = 'section' + name.charAt(0).toUpperCase() + name.slice(1);
                const sectionElement = document.getElementById(sectionId);
                if (sectionElement) sectionElement.style.display = 'none';
            });

            menus.forEach(menuId => {
                const menuElement = document.getElementById(menuId);
                if (menuElement) {
                    menuElement.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'bg-gray-700');
                    menuElement.classList.add('text-white', 'hover:bg-gray-700'); // Atur ulang warna default sidebar
                }
            });

            // 2. Tampilkan section yang dipilih
            const selectedSectionId = 'section' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            const selectedMenuId = 'menu' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            
            const selectedSection = document.getElementById(selectedSectionId);
            const selectedMenu = document.getElementById(selectedMenuId);

            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            if (selectedMenu) {
                selectedMenu.classList.remove('hover:bg-gray-700');
                selectedMenu.classList.add('bg-blue-600', 'hover:bg-blue-700'); // Tandai menu aktif
            }
            
            // 3. LOGIKA ACCORDION: Atur status menu Pengajuan jika sub-menu dipilih
            if (sectionName.startsWith('req')) {
                // Jika sub-menu dipilih, pastikan menu Requests (parent) terlihat aktif dan terbuka
                if(requestsMenu) {
                    requestsMenu.classList.remove('hover:bg-gray-700');
                    requestsMenu.classList.add('bg-gray-700'); // Beri warna aktif ke parent
                }
                if(requestsSubMenu && !requestsSubMenu.classList.contains('active')) {
                    // Buka Accordion jika belum terbuka
                    requestsSubMenu.style.height = requestsSubMenu.scrollHeight + 'px';
                    requestsSubMenu.classList.add('active');
                    requestsSubMenuIcon.classList.add('rotate-180');
                }
            } else {
                // Jika menu non-Request yang dipilih, pastikan sub-menu Requests tertutup
                if(requestsSubMenu && requestsSubMenu.classList.contains('active')) {
                    requestsSubMenu.style.height = '0';
                    requestsSubMenu.classList.remove('active');
                    requestsSubMenuIcon.classList.remove('rotate-180');
                }
                if(requestsMenu) {
                    requestsMenu.classList.remove('bg-gray-700');
                    requestsMenu.classList.add('hover:bg-gray-700');
                }
            }

            // 4. Panggil fungsi pemuatan data
            if (sectionName === 'summary') {
                loadAdminAttendanceData(adminAttendanceDateFilter.value);
            } else if (sectionName === 'employees') {
                loadEmployeeList(); 
            } else if (sectionName === 'companies') { 
                loadCompanyList();
            } else if (sectionName === 'rekap') { 
                initializeRekapFilters();
                document.getElementById('rekapTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Silakan atur filter dan klik "Tampilkan Rekap".</td></tr>';
            } else if (sectionName === 'reqattendance') { 
                initializeReqAttFilters(); 
            } else if (sectionName === 'reqtimeoff') { 
                initializeReqTimeoffFilters(); 
            } else if (sectionName === 'reqovertime') { 
                initializeReqOvertimeFilters();
            } else if (sectionName === 'masters') { // <-- TAMBAHKAN BLOK INI
                // Tampilkan tab default (timeoff) dan muat datanya
                showMasterTab('timeoff');
                loadTimeoffTypes(); 
            } else if (sectionName === 'workhours') { // <-- TAMBAHKAN BLOK INI
                loadWorkhoursList();
            } else if (sectionName === 'timeoffbalance') { // <-- TAMBAHKAN BLOK INI
                loadTimeoffBalanceList();
            }
        }

        // --- FUNGSI TOGGLE SUB-MENU (ACCORDION) (BARU) ---
        function toggleSubMenu(subMenuId) {
            const subMenu = document.getElementById(subMenuId);
            const icon = document.getElementById(subMenuId + 'Icon');
            
            if (subMenu.classList.contains('active')) {
                // Tutup Sub-Menu
                subMenu.style.height = '0';
                subMenu.classList.remove('active');
                icon.classList.remove('rotate-180');
            } else {
                // Buka Sub-Menu
                // Set height ke nilai scrollHeight untuk transisi yang dinamis
                subMenu.style.height = subMenu.scrollHeight + 'px';
                subMenu.classList.add('active');
                icon.classList.add('rotate-180');
            }
        }

        // --- FUNGSI TOGGLE SIDEBAR ADMIN (BARU) ---
        function toggleAdminSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const content = document.getElementById('adminSidebarContent');
            
            isSidebarOpen = !isSidebarOpen;

            if (isSidebarOpen) {
                // STATE TERTUTUP -> TERBUKA
                sidebar.classList.remove('sm:w-0', 'p-0', 'overflow-hidden');
                sidebar.classList.add('sm:w-64', 'p-4', 'sm:p-6');
                content.classList.remove('hidden');
            } else {
                // STATE TERBUKA -> TERTUTUP
                sidebar.classList.remove('sm:w-64', 'p-4', 'sm:p-6');
                sidebar.classList.add('sm:w-0', 'p-0', 'overflow-hidden'); 
                // Tunda penyembunyian konten agar transisi lebar terlihat
                setTimeout(() => {
                    content.classList.add('hidden');
                }, 300); // Sesuai dengan durasi transisi Tailwind (duration-300)
            }
        }

        const employeeModal = document.getElementById('employeeModal');
        const employeeForm = document.getElementById('employeeForm');

        async function openEmployeeModal() {
            employeeModal.classList.remove('hidden');
            document.getElementById('employeeModalTitle').textContent = 'Tambah Karyawan Baru';
            employeeForm.reset(); // Kosongkan form
            delete employeeForm.dataset.editingId; // Hapus mode edit
            
            document.getElementById('employeeEmail').disabled = false;
            document.getElementById('employeePassword').required = true;
            document.getElementById('employeePassword').previousElementSibling.textContent = "Password";
            document.getElementById('saveEmployeeButton').textContent = "Simpan & Daftarkan";

            // Logika untuk Dropdown Perusahaan
            const companySelectContainer = document.getElementById('companySelectContainer');
            const companySelect = document.getElementById('employeeCompany');
            
            if (globalProfile.role === 'super_admin') {
                // Super Admin: Tampilkan dropdown dan isi dengan perusahaan
                companySelectContainer.classList.remove('hidden');
                companySelect.required = true;
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                
                const { data, error } = await _supabase
                    .from('companies')
                    .select('id, name')
                    .order('name', { ascending: true });
                    
                if (data) {
                    companySelect.innerHTML = '<option value="">-- Pilih Perusahaan --</option>' + 
                                            data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } else {
                // Company Admin: Sembunyikan dropdown
                companySelectContainer.classList.add('hidden');
                companySelect.required = false;
            }
            // Muat dropdown jam kerja berdasarkan peran
            if (globalProfile.role === 'company_admin') {
                // Company Admin: Langsung muat jam kerja untuk perusahaannya + Global
                await loadWorkhourDropdown('employeeWorkhour', globalProfile.company_id);
            } else {
                // Super Admin: Muat jam kerja Global dulu (jika ada)
                // Dropdown akan di-reload jika dia memilih perusahaan (lihat Langkah 4)
                await loadWorkhourDropdown('employeeWorkhour', null); 
            }
            // (AKHIR BLOK BARU)

            employeeModal.classList.remove('hidden');
        }

        function closeEmployeeModal() {
            employeeModal.classList.add('hidden');
        }

        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Logika untuk 'Edit' vs 'Tambah Baru'
            const currentEditId = employeeForm.dataset.editingId;

            if (currentEditId) {
                await handleEditEmployee(currentEditId);
            } else {
                await handleAddNewEmployee();
            }
        });
        
        function openRequestAttendanceModal() {
            requestAttendanceForm.reset(); // Kosongkan form
            document.getElementById('saveRequestButton').disabled = false;
            // Set tanggal default ke hari ini
            document.getElementById('reqAttDate').value = getTodayDateString(); 
            requestAttendanceModal.classList.remove('hidden');
        }

        function closeRequestAttendanceModal() {
            requestAttendanceModal.classList.add('hidden');
        }

        async function handleAddNewEmployee() {
            const email = document.getElementById('employeeEmail').value;
            const password = document.getElementById('employeePassword').value;
            const fullName = document.getElementById('employeeFullName').value;
            const idNumber = document.getElementById('employeeIDNumber').value;
            const role = document.getElementById('employeeRole').value;
            const status = document.getElementById('employeeStatus').value;

            document.getElementById('saveEmployeeButton').disabled = true;
            showMessage("Mendaftarkan pengguna baru...", 'info');
            
            // 1. BUAT AKUN DI AUTH.USERS (Supabase Auth)
            const { data: authData, error: authError } = await _supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { 
                        full_name: fullName // Simpan nama di metadata Auth
                    }
                }
            });

            if (authError) {
                showMessage(`Gagal membuat akun: ${authError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }
            
            const newUser = authData.user;
            
            // 2. BUAT PROFIL DI TABEL 'profiles'
            // Tentukan company_id:
            // Jika Super Admin, ambil dari dropdown. Jika Company Admin, ambil dari profilnya.
            let selectedCompanyId = (globalProfile.role === 'super_admin')
                ? document.getElementById('employeeCompany').value
                : globalProfile.company_id;

            if (!selectedCompanyId) {
                 showMessage('Gagal: Super Admin harus memilih perusahaan.', 'error');
                 document.getElementById('saveEmployeeButton').disabled = false;
                 return;
            }

            const newProfile = {
                id: newUser.id,
                company_id: selectedCompanyId, // Wajib diisi dari Admin yang login
                full_name: fullName,
                email: email,
                user_id_number: idNumber,
                role: role,
                user_status: status,
                workhour_id: document.getElementById('employeeWorkhour').value || null,
            };
            
            const { error: profileError } = await _supabase
                .from('profiles')
                .insert([newProfile]);
            
            if (profileError) {
                console.error("Gagal membuat profil, namun akun Auth sudah terbuat:", profileError.message);
                showMessage(`Peringatan: Akun dibuat tapi gagal menyimpan detail profil: ${profileError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }
            
            // 3. SELESAI
            showMessage(`Karyawan ${fullName} berhasil didaftarkan.`, 'success');
            closeEmployeeModal();
            loadEmployeeList(); // Muat ulang daftar karyawan
            document.getElementById('saveEmployeeButton').disabled = false;
        }
        // (Fungsi handleEditEmployee akan ditambahkan di langkah selanjutnya)
        async function handleEditEmployee(profileId) {
            const fullName = document.getElementById('employeeFullName').value;
            const idNumber = document.getElementById('employeeIDNumber').value;
            const role = document.getElementById('employeeRole').value;
            const status = document.getElementById('employeeStatus').value;
            
            // Tentukan company_id: Ambil dari dropdown jika Super Admin, dari globalProfile jika Company Admin
            const companyId = (globalProfile.role === 'super_admin')
                ? document.getElementById('employeeCompany').value // Nilai dari dropdown
                : globalProfile.company_id; // Nilai dari profil Admin yang login

            document.getElementById('saveEmployeeButton').disabled = true;
            showMessage("Menyimpan perubahan...", 'info');

            const profilePayload = {
                full_name: fullName,
                user_id_number: idNumber,
                role: role,
                user_status: status,
                company_id: companyId,
                workhour_id: document.getElementById('employeeWorkhour').value || null,
            };

            // 1. Update data di tabel 'profiles'
            const { error: profileError } = await _supabase
                .from('profiles')
                .update(profilePayload)
                .eq('id', profileId);

            if (profileError) {
                showMessage(`Gagal menyimpan profil: ${profileError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }

            // 2. Update password (Tidak didukung di sini; harus menggunakan Supabase Admin SDK)
            const password = document.getElementById('employeePassword').value;
            if (password) {
                showMessage(`Peringatan: Perubahan password harus dilakukan menggunakan Supabase Admin API.`, 'error');
            }

            showMessage('Perubahan berhasil disimpan.', 'success');
            closeEmployeeModal();
            loadEmployeeList(); // Muat ulang daftar karyawan
            document.getElementById('saveEmployeeButton').disabled = false;
        }

        const companyModal = document.getElementById('companyModal');
        const companyForm = document.getElementById('companyForm');
        let currentCompanyId = null; // Untuk edit nanti
        let isSidebarOpen = true;

        function openCompanyModal() {
            companyModal.classList.remove('hidden');
            companyForm.reset();
            document.getElementById('companyModalTitle').textContent = 'Tambah Perusahaan Baru';
            currentCompanyId = null; // Mode 'Tambah Baru'
        }

        function closeCompanyModal() {
            companyModal.classList.add('hidden');
        }

        async function loadCompanyList() {
            const tableBody = document.getElementById('companyListTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat daftar perusahaan...</td></tr>';
            
            // RLS sudah diatur agar hanya Super Admin yang bisa memanggil ini
            const { data, error } = await _supabase
                .from('companies')
                .select('id, name, created_at, status')
                .order('name', { ascending: true });

            if (error) {
                console.error("Gagal memuat perusahaan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada perusahaan terdaftar.</td></tr>';
                return;
            }

            let html = data.map(company => {
                const createdDate = new Date(company.created_at).toLocaleDateString('id-ID');
                const status = company.status; // 'aktif' atau 'tidak aktif'
                const statusClass = status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                // Tentukan status baru (kebalikannya) untuk dikirim ke fungsi
                const newStatus = status === 'aktif' ? 'tidak aktif' : 'aktif'; 

                return `
                    <tr data-id="${company.id}">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${company.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${createdDate}</td>
                        <td class="px-4 py-3 text-left">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="editCompany('${company.id}', '${company.name}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit Nama</button>
                            <button onclick="openConfirmStatusModal('${company.id}', '${company.name}', '${newStatus}')" class="text-yellow-600 hover:text-yellow-900">Ubah Status</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        companyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyName = document.getElementById('companyName').value;
            
            document.getElementById('saveCompanyButton').disabled = true;
            showMessage("Menyimpan perusahaan...", 'info');

            let query;
            if (currentCompanyId) {
                // Mode EDIT
                query = _supabase.from('companies').update({ name: companyName }).eq('id', currentCompanyId);
            } else {
                // Mode TAMBAH BARU (RLS memastikan hanya Super Admin)
                query = _supabase.from('companies').insert([{ name: companyName }]);
            }

            const { error } = await query;

            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                document.getElementById('saveCompanyButton').disabled = false;
                return;
            }

            showMessage('Data perusahaan berhasil disimpan.', 'success');
            closeCompanyModal();
            loadCompanyList(); // Muat ulang daftar
            document.getElementById('saveCompanyButton').disabled = false;
        });

        function editCompany(id, name) {
            // Membuka modal dalam mode Edit
            currentCompanyId = id;
            document.getElementById('companyModalTitle').textContent = 'Edit Nama Perusahaan';
            document.getElementById('companyName').value = name;
            companyModal.classList.remove('hidden');
        }

        // --- FUNGSI BARU: LOGIKA MODAL STATUS PERUSAHAAN ---
        const companyStatusModal = document.getElementById('companyStatusModal');
        const companyStatusConfirmButton = document.getElementById('companyStatusConfirmButton');
        const companyStatusModalText = document.getElementById('companyStatusModalText');

        let statusChangeData = {}; // Menyimpan data sementara

        function openConfirmStatusModal(companyId, companyName, newStatus) {
            statusChangeData = { id: companyId, status: newStatus };
            
            // Tampilkan pesan konfirmasi yang spesifik
            companyStatusModalText.innerHTML = `Apakah Anda yakin ingin mengubah status perusahaan <strong>${companyName}</strong> menjadi <strong>${newStatus}</strong>?`;
            
            // Ubah warna tombol konfirmasi
            companyStatusConfirmButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
            if (newStatus === 'tidak aktif') {
                companyStatusConfirmButton.textContent = 'Ya, Nonaktifkan';
                companyStatusConfirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                companyStatusConfirmButton.textContent = 'Ya, Aktifkan';
                companyStatusConfirmButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }

            companyStatusModal.classList.remove('hidden');
        }

        function closeConfirmStatusModal() {
            companyStatusModal.classList.add('hidden');
            statusChangeData = {};
        }

        // Logika saat tombol konfirmasi di modal diklik
        companyStatusConfirmButton.addEventListener('click', async () => {
            const { id, status } = statusChangeData;
            if (!id || !status) return;

            showMessage("Memperbarui status perusahaan...", 'info');
            
            // Hanya Super Admin yang bisa melakukan ini (RLS sudah diatur)
            const { error } = await _supabase
                .from('companies')
                .update({ status: status }) // Menggunakan enum 'aktif' atau 'tidak aktif'
                .eq('id', id);

            if (error) {
                showMessage(`Gagal memperbarui status: ${error.message}`, 'error');
                return;
            }

            showMessage('Status perusahaan berhasil diperbarui.', 'success');
            closeConfirmStatusModal();
            loadCompanyList(); // Muat ulang daftar perusahaan untuk melihat perubahan
        });

        function showMessage(message, type = 'success') {
            const box = document.createElement('div');
            box.className = `p-4 mb-2 rounded-lg shadow-md transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
                type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
                'bg-blue-100 border border-blue-400 text-blue-700'
            }`;
            box.innerHTML = `<p class="font-medium">${message}</p>`;
            messageBox.appendChild(box);

            setTimeout(() => {
                box.style.opacity = '0';
                box.addEventListener('transitionend', () => box.remove());
            }, 5000);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            // Ubah timestampz (UTC) ke waktu lokal (tanpa detik)
            const date = new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        function formatTimeForInput(timestamp) {
             if (!timestamp) return '';
             const date = new Date(timestamp);
             const hours = String(date.getHours()).padStart(2, '0');
             const minutes = String(date.getMinutes()).padStart(2, '0');
             return `${hours}:${minutes}`;
        }

        function getTodayDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

       function changeView(viewId) {
            const footer = document.getElementById('karyawanFooterNav');
            
            // Sembunyikan semua tampilan
            [loginView, karyawanView, adminView].forEach(v => v.style.display = 'none');
            
            // Tampilkan tampilan yang diminta
            document.getElementById(viewId).style.display = 'flex';

            // Logika baru: Tampilkan footer HANYA di tampilan Karyawan
            if (viewId === 'karyawanView') {
                footer.classList.remove('hidden');
            } else {
                // Sembunyikan footer di tampilan Admin dan Login
                footer.classList.add('hidden');
            }
        }
        
        function initializeClock(timeElement, dateElement) {
            function updateTime() {
                const now = new Date();
                
                // Format Waktu
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                timeElement.textContent = now.toLocaleTimeString('id-ID', timeOptions);

                // Format Tanggal
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('id-ID', dateOptions);
            }

            updateTime();
            setInterval(updateTime, 1000);
        }

        // ===============================================================
        // 1. LOGIKA LOGIN (loginView)
        // ===============================================================
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            setLoginLoading(true);
            
            const { error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showMessage(`Gagal masuk: ${error.message}`, 'error');
                setLoginLoading(false);
                return;
            }

            // Jika berhasil, panggil checkAuthAndRole untuk memuat profil dan mengarahkan
            await checkAuthAndRole();
            setLoginLoading(false);
        });

        function setLoginLoading(isLoading) {
            document.getElementById('loginButton').disabled = isLoading;
            document.getElementById('loginButtonText').textContent = isLoading ? 'Memproses...' : 'Masuk';
            document.getElementById('loginSpinner').classList.toggle('hidden', !isLoading);
        }


        // ===============================================================
        // 2. LOGIKA KARYAWAN (karyawanView)
        // ===============================================================
        
        // --- FUNGSI HELPER LOKASI (BARU) ---
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                // Periksa apakah browser mendukung Geolocation
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation tidak didukung oleh browser ini."));
                    return;
                }

                // Opsi untuk akurasi dan timeout
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 detik
                    maximumAge: 0 // Tidak menggunakan cache
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        resolve({ latitude, longitude });
                    },
                    (error) => {
                        // Tangani error izin (Permission Denied) atau timeout
                        let errorMessage = "Gagal mengambil lokasi.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Izin lokasi ditolak. Harap izinkan GPS untuk absen.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Timeout: Gagal mendapatkan lokasi akurat.";
                        }
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        }

        // --- FUNGSI KARYAWAN (ABSENSI) ---
        async function loadKaryawanAttendanceStatus() {
            const todayDate = getTodayDateString();
            const startOfDay = new Date(todayDate).toISOString();
            const endOfDay = new Date(new Date(todayDate).getTime() + 24 * 60 * 60 * 1000).toISOString();
            
            karyawanAttendanceStatus.textContent = 'Memuat status...';

            const { data, error } = await _supabase
                .from('attendance')
                .select('*')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startOfDay)
                .lt('created_at', endOfDay)
                .limit(1);

            if (error) {
                console.error("Gagal memuat status absensi:", error.message);
                karyawanAttendanceStatus.textContent = 'Gagal memuat status.';
                return;
            }

            if (data && data.length > 0) {
                const attendance = data[0];
                currentAttendanceId = attendance.id; 

                karyawanClockInTime.textContent = formatTime(attendance.clock_in);
                karyawanClockOutTime.textContent = formatTime(attendance.clock_out);
                
                let statusText = attendance.attendance_status;
                let statusClass = 'bg-green-100 text-green-700';
                
                if (statusText === 'Alpa' || statusText === 'Terlambat') {
                    statusClass = 'bg-red-100 text-red-700';
                } else if (statusText === 'Izin' || statusText === 'Sakit') {
                    statusClass = 'bg-yellow-100 text-yellow-700';
                }

                karyawanAttendanceStatus.textContent = `Status hari ini: ${statusText}.`;
                karyawanAttendanceStatus.className = `text-center p-4 rounded-lg ${statusClass} font-medium`;

                // Atur status tombol
                karyawanClockInButton.disabled = true;
                if (!attendance.clock_out && (statusText === 'Hadir' || statusText === 'Terlambat')) {
                    karyawanClockOutButton.disabled = false;
                } else {
                    karyawanClockOutButton.disabled = true;
                }
            } else {
                // Belum ada absensi hari ini
                karyawanAttendanceStatus.textContent = 'Anda belum melakukan Clock-in hari ini.';
                karyawanAttendanceStatus.className = 'text-center p-4 rounded-lg bg-yellow-50 text-yellow-700 font-medium';
                karyawanClockInTime.textContent = '-';
                karyawanClockOutTime.textContent = '-';
                karyawanClockInButton.disabled = false;
                karyawanClockOutButton.disabled = true;
                currentAttendanceId = null;
            }
        }

        // FUNGSI NAVIGASI KARYAWAN BARU (menggantikan showKaryawanSection)
        function showKaryawanContent(sectionName) {
            const sections = {
                'Absensi': document.getElementById('karyawanSection_Absensi'),
                'Requests': document.getElementById('karyawanSection_Requests'),
                'History': document.getElementById('karyawanSection_History'),
                'Timeoff': document.getElementById('karyawanSection_Timeoff'),
                'Overtime': document.getElementById('karyawanSection_Overtime'),
                'Salary': document.getElementById('karyawanSection_Salary')
            };
            const karyawanViewWrapper = document.querySelector('#karyawanView > div');
            
            // 1. Sembunyikan semua section dan atur lebar default
            Object.values(sections).forEach(sec => {
                if(sec) sec.style.display = 'none';
            });
            karyawanViewWrapper.classList.add('max-w-lg'); 
            karyawanViewWrapper.classList.remove('max-w-full');

            // 2. Tampilkan section yang dipilih
            if (sections[sectionName]) {
                sections[sectionName].style.display = 'block';

                // Jika tabel (Requests) yang dibuka, buat lebar penuh
                if (sectionName === 'Requests') {
                    karyawanViewWrapper.classList.remove('max-w-lg');
                    karyawanViewWrapper.classList.add('max-w-full'); 
                    loadAttendanceRequests(); // Muat data
                } else if (sectionName === 'History') { 
                    karyawanViewWrapper.classList.remove('max-w-lg');
                    karyawanViewWrapper.classList.add('max-w-full'); 
                    loadKaryawanHistory(); // <-- FUNGSI BARU
                } else if (sectionName === 'Timeoff' || sectionName === 'Overtime' || sectionName === 'Salary') {
                    // Muat data spesifik di sini nanti
                    // loadTimeoffData();
                }
            }
            
            // 3. Atur tombol footer yang aktif
            // Catatan: Karena History bukan di footer, ia akan mengatur Absensi jika kembali, atau tidak mengubah state footer
            if (sectionName !== 'History') {
               setActiveFooterTab(sectionName);
            }
        }

        // FUNGSI UNTUK MENGATUR TOMBOL FOOTER AKTIF
        function setActiveFooterTab(activeSection) {
            const tabIds = ['tabRequestAttendance', 'tabRequestTimeoff', 'tabAttendanceHome', 'tabOvertime', 'tabSalary'];
            let activeId;

            // Tentukan ID tombol yang harus aktif berdasarkan nama section
            if (activeSection === 'Absensi') activeId = 'tabAttendanceHome';
            else if (activeSection === 'Requests') activeId = 'tabRequestAttendance';
            else if (activeSection === 'Timeoff') activeId = 'tabRequestTimeoff';
            else if (activeSection === 'Overtime') activeId = 'tabOvertime';
            else if (activeSection === 'Salary') activeId = 'tabSalary';

            tabIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    const isActive = id === activeId;
                    // Hapus kelas aktif dari semua
                    button.classList.remove('text-blue-600');
                    button.classList.add('text-gray-500');
                    // Tambahkan kelas aktif pada yang dipilih
                    if (isActive) {
                        button.classList.remove('text-gray-500');
                        button.classList.add('text-blue-600');
                    }
                }
            });
        }

        // --- FUNGSI KARYAWAN (RIWAYAT KEHADIRAN) ---
        async function loadKaryawanHistory() {
            const historyBody = document.getElementById('historyListTableBody');
            historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat riwayat kehadiran...</td></tr>';
            
            // Tentukan rentang waktu (misal, 60 hari ke belakang)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 60);

            const startISO = startDate.toISOString();
            const endISO = endDate.toISOString();

            const { data, error } = await _supabase
                .from('attendance')
                .select('*')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startISO)
                .lt('created_at', endISO)
                .order('created_at', { ascending: false }); // Terbaru di atas

            if (error) {
                console.error("Gagal memuat riwayat:", error.message);
                historyBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat riwayat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Tidak ada riwayat kehadiran dalam 60 hari terakhir.</td></tr>';
                return;
            }

            let html = data.map(att => {
                const dateDisplay = new Date(att.created_at).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                const statusClass = getStatusClass(att.attendance_status); // Menggunakan helper Admin yang sudah ada

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${dateDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatTime(att.clock_in)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatTime(att.clock_out)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${att.attendance_status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            historyBody.innerHTML = html;
        }

        // --- 3. FUNGSI BARU: MEMUAT DAFTAR REQUEST KARYAWAN ---
        async function loadAttendanceRequests() {
            // Fungsi ini dipanggil oleh showKaryawanContent('Requests')
            const tableBody = document.getElementById('requestListTableBody');
            if (!tableBody) {
                console.error("Elemen requestListTableBody tidak ditemukan!");
                return; 
            }
            
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat riwayat pengajuan...</td></tr>';
            
            // Ambil data HANYA untuk karyawan yang login
            const { data, error } = await _supabase
                .from('attendance_requests')
                .select('created_at, attendance_date, requests_status')
                .eq('user_id', globalProfile.id)
                .order('created_at', { ascending: false }); // Terbaru di atas

            if (error) {
                console.error("Gagal memuat riwayat pengajuan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Anda belum memiliki riwayat pengajuan.</td></tr>';
                return;
            }

            let html = data.map(req => {
                // Tgl Diajukan (Kapan request dibuat)
                const submittedDate = new Date(req.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                // Tgl Absensi (Tanggal yang dikoreksi)
                const attendanceDate = new Date(req.attendance_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                const status = req.requests_status;
                
                let statusClass;
                if (status === 'Diajukan') statusClass = 'bg-yellow-100 text-yellow-800';
                else if (status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                else statusClass = 'bg-red-100 text-red-800'; // Ditolak

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${submittedDate}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${attendanceDate}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        async function doClockIn() {
            karyawanClockInButton.disabled = true;
            showMessage("Meminta izin lokasi...", 'info');
            const locationDisplayElement = document.getElementById('karyawanLocationDisplay');

            let locationString = 'Lokasi gagal didapatkan';
            let locationCoords = null;
            
            try {
                locationCoords = await getCurrentLocation();
                locationString = `${locationCoords.latitude}, ${locationCoords.longitude}`;
                locationDisplayElement.textContent = `Lokasi: ${locationString}`;
            } catch (e) {
                showMessage(`Gagal Absen: ${e.message}`, 'error');
                karyawanClockInButton.disabled = false;
                locationDisplayElement.textContent = `Lokasi: ${e.message.split('.')[0]}`;
                return;
            }

            const now = new Date();
            
            // --- LOGIKA CEK KETERLAMBATAN (BARU - DINAMIS) ---
            let isLate = false;
            try {
                // 1. Tentukan nama hari ini (Sesuai key JSON: "Senin", "Selasa", ...)
                const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
                const todayName = dayNames[now.getDay()]; // cth: "Jumat"

                // 2. Ambil jadwal kerja dari globalProfile (yang dimuat saat login)
                const schedule = globalProfile.workhours?.schedule;

                if (!globalProfile.workhours || !schedule || !schedule[todayName]) {
                    // Karyawan tidak punya jam kerja / tidak ada aturan untuk hari ini
                    console.warn(`Tidak ada jadwal kerja (workhour) ditemukan untuk ${globalProfile.full_name} pada hari ${todayName}. Keterlambatan tidak dihitung.`);
                    // Anggap tidak terlambat agar tidak error
                    isLate = false;
                } else {
                    const todayRule = schedule[todayName];

                    // 3. Cek jika hari ini libur (is_off)
                    if (todayRule.is_off) {
                        // Tidak terlambat jika jadwalnya hari libur
                        isLate = false;
                    } else if (todayRule.start) {
                        // 4. Bandingkan jam
                        const [hours, minutes] = todayRule.start.split(':').map(Number);
                        const deadline = new Date(now); // Salin objek 'now'
                        deadline.setHours(hours, minutes, 0, 0); // Atur jam deadline (cth: 08:30:00.000)

                        if (now > deadline) {
                            isLate = true; // Karyawan terlambat!
                        }
                    } else {
                        // Ada jadwal hari ini tapi tidak ada jam 'start'
                        console.warn(`Jadwal hari ${todayName} tidak memiliki jam 'start'. Keterlambatan tidak dihitung.`);
                        isLate = false;
                    }
                }
            } catch (e) {
                console.error("Gagal memproses logika jam kerja (workhours):", e.message);
                // Jika proses gagal = anggap tidak terlambat agar tidak error
                isLate = false;
            }
            // --- AKHIR LOGIKA CEK KETERLAMBATAN ---

            if (isLate) {
                // JIKA TERLAMBAT: Buka modal
                showMessage("Anda terlambat! Harap isi alasan.", 'info');
                // Simpan data sementara untuk digunakan saat modal disubmit
                tempClockInData = { now, locationString }; 
                openLateReasonModal();
                // Tombol clock-in akan tetap 'disabled' sampai modal disubmit
            } else {
                // JIKA TEPAT WAKTU: Langsung insert
                showMessage("Lokasi didapatkan. Memproses Clock-In...", 'info');
                await insertAttendance(now, locationString, 'Hadir', null);
                // Tombol akan di-handle oleh loadKaryawanAttendanceStatus (menjadi disabled)
            }
        }

        async function doClockOut() {
            if (!currentAttendanceId) {
                showMessage("Gagal Absen Pulang: Data Absen Masuk tidak ditemukan.", 'error');
                return;
            }
            
            karyawanClockOutButton.disabled = true;
            showMessage("Memproses Absen Pulang...", 'info');
            
            const now = new Date().toISOString();

            const { error } = await _supabase
                .from('attendance')
                .update({ clock_out: now })
                .eq('id', currentAttendanceId);

            if (error) {
                console.error('Gagal Absen Pulang:', error.message);
                showMessage(`Gagal Absen Pulang: ${error.message}.`, 'error');
                karyawanClockOutButton.disabled = false;
                return;
            }

            showMessage('Absen Pulang Berhasil! Terima kasih.', 'success');
            loadKaryawanAttendanceStatus();
        }

        karyawanClockInButton.addEventListener('click', doClockIn);
        karyawanClockOutButton.addEventListener('click', doClockOut);

        // ===============================================================
        // 3. LOGIKA ADMIN (adminView)
        // ===============================================================
        
        function getStatusClass(status) {
            if (status === 'Hadir' || status === 'Terlambat') return 'bg-green-100 text-green-800';
            if (status === 'Izin' || status === 'Sakit') return 'bg-yellow-100 text-yellow-800';
            if (status === 'Alpa' || !status) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        async function loadAdminAttendanceData(dateString) {
            adminAttendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
            
            const startOfDay = new Date(dateString).toISOString();
            const endOfDay = new Date(new Date(dateString).getTime() + 24 * 60 * 60 * 1000).toISOString();
            
            // 1. Ambil semua karyawan di perusahaan admin
            let profilesQuery = _supabase
                .from('profiles')
                .select('id, full_name');
            
            // Tambahkan filter HANYA jika yang login BUKAN Super Admin
            if (globalProfile.role !== 'super_admin') {
                profilesQuery = profilesQuery.eq('company_id', globalProfile.company_id);
            }
            
            // Jalankan query yang sudah dimodifikasi
            const { data: profiles, error: profilesError } = await profilesQuery;

            if (profilesError) {
                console.error("Gagal memuat daftar karyawan:", profilesError.message);
                return;
            }

            const employeeIds = profiles.map(p => p.id);
            if (employeeIds.length === 0) {
                 adminAttendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada karyawan di perusahaan ini.</td></tr>';
                 document.getElementById('adminNoDataMessage').classList.add('hidden');
                 return;
            }

            // 2. Ambil data absensi untuk tanggal dan user ID yang sesuai
            const { data: attendanceData, error: attendanceError } = await _supabase
                .from('attendance')
                .select('id, user_id, clock_in, clock_out, attendance_status, location')
                .in('user_id', employeeIds)
                .gte('created_at', startOfDay)
                .lt('created_at', endOfDay);
            
            if (attendanceError) {
                console.error("Gagal memuat data absensi:", attendanceError.message);
                return;
            }
            
            const attendanceMap = attendanceData.reduce((map, att) => {
                map[att.user_id] = att;
                return map;
            }, {});

            // 3. Gabungkan dan Render Data
            adminAttendanceTableBody.innerHTML = ''; // Kosongkan tabel
            
            let html = '';
            let totalHadir = 0, totalIzin = 0, totalAlpa = 0;

            profiles.forEach(profile => {
                const att = attendanceMap[profile.id];
                let status = att ? att.attendance_status : 'Alpa';
                
                // Hitung statistik
                if (status === 'Hadir' || status === 'Terlambat') totalHadir++;
                else if (status === 'Izin' || status === 'Sakit') totalIzin++;
                else if (status === 'Alpa') totalAlpa++;

                html += `
                    <tr data-id="${att ? att.id : 'new'}" data-user-id="${profile.id}">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${profile.full_name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${att ? formatTime(att.clock_in) : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${att ? formatTime(att.clock_out) : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(status)}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                            ${att ? (att.location || '-') : '-'}
                        </td>
                    </tr>
                `;
            });
            
            adminAttendanceTableBody.innerHTML = html;
            document.getElementById('adminTotalEmployees').textContent = employeeIds.length;
            document.getElementById('adminTotalHadir').textContent = totalHadir;
            document.getElementById('adminTotalIzin').textContent = totalIzin;
            document.getElementById('adminTotalAlpa').textContent = totalAlpa;

            document.getElementById('adminNoDataMessage').classList.toggle('hidden', employeeIds.length > 0);
        }

        async function loadEmployeeList() {
            employeeListTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat daftar karyawan...</td></tr>';
            
            // 1. Mulai query dasar
            let query = _supabase
                .from('profiles')
                .select('id, full_name, user_id_number, role, user_status, companies(name)'); // Ambil juga nama perusahaan

            // 2. Tambahkan filter HANYA jika yang login BUKAN Super Admin
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            
            // 3. Tambahkan pengurutan dan jalankan query
            query = query.order('full_name', { ascending: true });
            const { data: profiles, error } = await query;

            if (error) {
                console.error("Gagal memuat daftar karyawan:", error.message);
                employeeListTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (profiles.length === 0) {
                employeeListTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada karyawan terdaftar di perusahaan ini.</td></tr>';
                return;
            }

            // Sembunyikan kolom "Perusahaan" jika bukan Super Admin
            const companyHeader = document.getElementById('companyColumnHeader');
            if (companyHeader) {
                 companyHeader.style.display = (globalProfile.role === 'super_admin') ? 'table-cell' : 'none';
            }

            let html = profiles.map(profile => {
                const roleText = profile.role.replace('_', ' ');
                const statusClass = (profile.user_status === 'Percobaan' || profile.user_status === 'Kontrak') ? 'bg-yellow-100 text-yellow-800' : 
                                    (profile.user_status === 'Tetap' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');

                // Tampilkan nama perusahaan (jika ada)
                const companyName = profile.companies ? profile.companies.name : 'N/A';
                const companyCell = (globalProfile.role === 'super_admin') 
                    ? `<td class="px-4 py-3 text-sm text-gray-500">${companyName}</td>` 
                    : ''; // Sembunyikan sel jika Company Admin

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${profile.full_name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${profile.user_id_number || 'N/A'}</td>
                        ${companyCell} <!-- Sel Perusahaan -->
                        <td class="px-4 py-3 text-sm text-blue-600">${roleText.toUpperCase()}</td>
                        <td class="px-4 py-3 text-left">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${profile.user_status ? profile.user_status.toUpperCase() : 'N/A'}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="editEmployee('${profile.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');

            employeeListTableBody.innerHTML = html;
        }

        // --- LOGIKA REKAP KEHADIRAN ---

        async function initializeRekapFilters() {
            const employeeFilter = document.getElementById('rekapEmployeeFilter');

            // HANYA muat jika belum pernah dimuat
            if (allEmployees.length === 0) {
                 // 1. Ambil daftar karyawan (mirip loadEmployeeList)
                let query = _supabase
                    .from('profiles')
                    .select('id, full_name')
                    .order('full_name', { ascending: true });

                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter rekap:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // 2. Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // 3. Atur tanggal default ke 30 hari ke belakang
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('rekapEndDate').value = today;
            document.getElementById('rekapStartDate').value = getTodayDateString(thirtyDaysAgo);
        }

        async function loadRekapData() {
            const rekapTableBody = document.getElementById('rekapTableBody');
            const startDate = document.getElementById('rekapStartDate').value;
            const endDate = document.getElementById('rekapEndDate').value;
            const employeeId = document.getElementById('rekapEmployeeFilter').value;
            const statusFilter = document.getElementById('rekapStatusFilter').value;

            if (!startDate || !endDate) {
                showMessage("Harap isi rentang tanggal.", 'error');
                return;
            }

            rekapTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Mencari data...</td></tr>';

            // Menyesuaikan rentang tanggal (Supabase menggunakan created_at)
            const startISO = new Date(startDate).toISOString();
            // Tambahkan 24 jam ke tanggal akhir agar inklusif
            const endOfDay = new Date(new Date(endDate).getTime() + 24 * 60 * 60 * 1000);
            const endISO = endOfDay.toISOString();

            let query = _supabase
                .from('attendance')
                .select(`
                    *,
                    profiles(full_name)
                `)
                .gte('created_at', startISO)
                .lt('created_at', endISO);

            // Filter berdasarkan Perusahaan (Penting untuk RLS, tapi kita filter lagi di sini)
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            
            // Filter berdasarkan Nama Karyawan
            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }

            // Filter berdasarkan Status
            if (statusFilter) {
                query = query.eq('attendance_status', statusFilter);
            }

            // Urutkan berdasarkan tanggal terbaru
            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;
            const summaryContainer = document.getElementById('rekapSummaryContainer');


            if (error) {
                console.error("Gagal memuat data rekap:", error.message);
                rekapTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
                summaryContainer.classList.add('hidden'); // Sembunyikan jika error
                return;
            }

            if (data.length === 0) {
                rekapTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data kehadiran yang cocok dengan filter yang Anda pilih.</td></tr>';
                return;
                summaryContainer.classList.add('hidden'); // Sembunyikan jika tidak ada data
                return;
            }

            // --- TAMBAHKAN LOGIKA PENGHITUNGAN BARU INI (baris ~1677) ---
            let countHadir = 0;
            let countTerlambat = 0;
            let countSakit = 0;
            let countIzin = 0;
            let countAlpa = 0;

            // Hitung total dari data yang didapat
            data.forEach(att => {
                switch (att.attendance_status) {
                    case 'Hadir':
                        countHadir++;
                        break;
                    case 'Terlambat':
                        countTerlambat++;
                        break;
                    case 'Sakit':
                        countSakit++;
                        break;
                    case 'Izin':
                        countIzin++;
                        break;
                    case 'Alpa':
                        countAlpa++;
                        break;
                }
            });

            // Update kartu statistik di HTML
            document.getElementById('rekapTotalHadir').textContent = countHadir;
            document.getElementById('rekapTotalTerlambat').textContent = countTerlambat;
            document.getElementById('rekapTotalSakit').textContent = countSakit;
            document.getElementById('rekapTotalIzin').textContent = countIzin;
            document.getElementById('rekapTotalAlpa').textContent = countAlpa;

            // Tampilkan kontainer statistik
            summaryContainer.classList.remove('hidden');

            // --- LOGIKA PENGUMPULAN KETERANGAN DARI TABEL REQUESTS ---
            const employeeIdsInRekap = [...new Set(data.map(att => att.user_id))];
            const uniqueAttendanceDates = [...new Set(data.map(att => getTodayDateString(new Date(att.created_at))))];
            let requestsMap = {}; // Key: user_id|YYYY-MM-DD, Value: description

            // Helper untuk memuat request yang SUDAH DISETUJUI
            const loadRequests = async (tableName, dateColumn, statusColumn) => {
                const { data: requests, error } = await _supabase
                    .from(tableName)
                    .select(`user_id, description, ${dateColumn}, ${statusColumn}`) 
                    .in('user_id', employeeIdsInRekap)
                    .eq(statusColumn, 'Disetujui') // HANYA ambil yang disetujui
                    .in(dateColumn, uniqueAttendanceDates);
                
                if (error) {
                    console.error(`Gagal memuat data ${tableName}:`, error.message);
                    return;
                }

                if (requests) {
                    requests.forEach(req => {
                        const dateValue = req[dateColumn];
                        const key = `${req.user_id}|${dateValue}`;
                        // Simpan deskripsi pengajuan
                        requestsMap[key] = req.description; 
                    });
                }
            };
            
            if (employeeIdsInRekap.length > 0 && uniqueAttendanceDates.length > 0) {
                // 1. Ambil dari attendance_requests (Koreksi Absensi)
                await loadRequests('attendance_requests', 'attendance_date', 'requests_status');
                
                // 2. Ambil dari overtime_requests (Lembur)
                await loadRequests('overtime_requests', 'overtime_date', 'overtime_status'); 
                
                // 3. (Tambahkan di sini jika ada timeoff_requests)
                // await loadRequests('timeoff_requests', 'timeoff_date', 'timeoff_status'); 
            }
            // --- AKHIR LOGIKA KETERANGAN ---

            let html = data.map(att => {
                const date = new Date(att.created_at);
                const dateDisplay = date.toLocaleDateString('id-ID'); 
                const dateKey = getTodayDateString(date); 

                const requestKey = `${att.user_id}|${dateKey}`;
                
                // Ambil keterangan: 
                // Prioritas 1: Langsung dari data absensi (untuk alasan telat)
                // Prioritas 2: Dari requestsMap (untuk koreksi yang disetujui)
                const keterangan = att.description || requestsMap[requestKey] || '-';

                const name = att.profiles ? att.profiles.full_name : 'N/A';
                const statusClass = getStatusClass(att.attendance_status);
                
                return `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dateDisplay}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(att.clock_in)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(att.clock_out)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${att.attendance_status}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">${keterangan}</td>
                    </tr>
                `;
            }).join('');
            rekapTableBody.innerHTML = html;
        }
        
        // --- FUNGSI BARU: INIT FILTER PENGAJUAN KOREKSI KEHADIRAN (DITINGKATKAN) ---
        async function initializeReqAttFilters() {
            const employeeFilter = document.getElementById('reqAttEmployeeFilter');
            const tableBody = document.getElementById('reqAttTableBody'); // Tambahkan ini

            // BARIS KRITIS: Cek apakah elemen filter ditemukan sebelum melanjutkan
            if (!employeeFilter || !tableBody) {
                const sectionContainer = document.getElementById('sectionReqAttendance');
                if (sectionContainer) {
                    sectionContainer.innerHTML = '<div class="p-8 bg-red-100 border border-red-400 text-red-700 rounded-xl">Kesalahan! Elemen HTML Koreksi Kehadiran (Filter/Tabel) tidak ditemukan. Mohon periksa kembali struktur HTML pada SECTION 5.</div>';
                }
                return;
            }

            // Reuse allEmployees data if already loaded by Rekap feature
            // Variabel allEmployees didefinisikan di logic Rekap Kehadiran
            if (allEmployees.length === 0) { 
                 // 1. Ambil daftar karyawan
                let query = _supabase
                    .from('profiles')
                    .select('id, full_name')
                    .order('full_name', { ascending: true });

                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter pengajuan:", error.message);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat daftar karyawan.</td></tr>';
                    loadRequestAttendanceData(); // Kita tetap panggil loader agar tampilan tidak kosong total
                    return;
                }
                allEmployees = data;
            }

            // 2. Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // 3. Atur tanggal default ke 30 hari ke belakang
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqAttEndDate').value = today;
            document.getElementById('reqAttStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // 4. Muat data setelah filter siap
            loadRequestAttendanceData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN KOREKSI KEHADIRAN ---
        async function loadRequestAttendanceData() {
            const tableBody = document.getElementById('reqAttTableBody');
            const startDate = document.getElementById('reqAttStartDate').value;
            const endDate = document.getElementById('reqAttEndDate').value;
            const employeeId = document.getElementById('reqAttEmployeeFilter').value;
            const statusFilter = document.getElementById('reqAttStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Mencari pengajuan...</td></tr>';

            // Filter oleh RLS sudah berjalan otomatis berdasarkan company_id

            let query = _supabase
                .from('attendance_requests')
                .select(`
                    id, 
                    attendance_date, 
                    clock_in, 
                    clock_out, 
                    description, 
                    requests_status,
                    user_id,
                    company_id,
                    profiles(full_name)
                `)
                // Filter Tanggal Kehadiran (attendance_date)
                .gte('attendance_date', startDate) 
                .lte('attendance_date', endDate); 

            // Filter berdasarkan Nama Karyawan
            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }

            // Filter berdasarkan Status
            if (statusFilter) {
                query = query.eq('requests_status', statusFilter);
            }

            // Urutkan berdasarkan tanggal diajukan (terbaru di atas)
            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan koreksi:", error.message);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada pengajuan koreksi yang cocok dengan filter.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const dateDisplay = new Date(req.attendance_date).toLocaleDateString('id-ID');
                // Catatan: Gunakan req.clock_in / req.clock_out karena ini adalah data yang diajukan
                const clockInTime = req.clock_in ? formatTime(req.clock_in) : '-'; 
                const clockOutTime = req.clock_out ? formatTime(req.clock_out) : '-';
                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const description = req.description || '-';
                const status = req.requests_status;
                
                let statusClass;
                let actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveRequest('${req.id}', '${req.user_id}', '${req.company_id}', '${req.attendance_date}', '${req.clock_in}', '${req.clock_out}', '${req.description}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectRequest('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${dateDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${clockInTime}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${clockOutTime}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI ADMIN: AKSI PENGAJUAN (IMPLEMENTASI BARU) ---
        async function handleApproveRequest(requestId, userId, companyId, attendanceDate, clockIn, clockOut, description) {
            showMessage("Memproses persetujuan...", 'info');
            
            // 1. Konversi string 'null' atau undefined ke null literal
            const clockInISO = (clockIn === 'null' || !clockIn) ? null : clockIn;
            const clockOutISO = (clockOut === 'null' || !clockOut) ? null : clockOut;
            
            // 2. Tentukan rentang tanggal (mulai dan akhir hari)
            // Penting: Gunakan 'T00:00:00' untuk memastikan interpretasi tanggal lokal
            const startOfDay = new Date(attendanceDate + 'T00:00:00').toISOString();
            const endOfDay = new Date(new Date(attendanceDate + 'T00:00:00').getTime() + 24 * 60 * 60 * 1000).toISOString();

            // 3. Cek apakah sudah ada data absensi di 'attendance' pada tanggal itu
            //    (Misalnya, jika statusnya 'Alpa' atau 'Izin')
            const { data: existingAtt, error: findError } = await _supabase
                .from('attendance')
                .select('id')
                .eq('user_id', userId)
                .gte('created_at', startOfDay) // Gunakan created_at untuk mencocokkan tanggal
                .lt('created_at', endOfDay)
                .limit(1)
                .single(); // Ambil satu saja

            // Abaikan error 'PGRST116' (No rows found), karena itu yang kita harapkan jika 'Alpa'
            if (findError && findError.code !== 'PGRST116') { 
                showMessage(`Gagal mencari absensi: ${findError.message}`, 'error');
                return;
            }

            // 4. Siapkan payload untuk tabel 'attendance'
            // Kita asumsikan statusnya menjadi 'Hadir'.
            const attendancePayload = {
                user_id: userId,
                company_id: companyId,
                attendance_status: 'Hadir', 
                clock_in: clockInISO,
                clock_out: clockOutISO,
                description: (description !== 'null' && description !== 'undefined' ? description : null),
                updated_at: new Date().toISOString()
            };

            let attendanceError = null;

            if (existingAtt) {
                // 5a. JIKA ADA: UPDATE data absensi yang ada
                const { error } = await _supabase
                    .from('attendance')
                    .update(attendancePayload)
                    .eq('id', existingAtt.id);
                attendanceError = error;
            } else {
                // 5b. JIKA TIDAK ADA: INSERT data absensi baru (kasus 'Alpa')
                const insertPayload = {
                    ...attendancePayload,
                    // Set created_at ke jam clock_in, atau awal hari jika clock_in null
                    created_at: clockInISO || startOfDay 
                };
                const { error } = await _supabase
                    .from('attendance')
                    .insert([insertPayload]);
                attendanceError = error;
            }

            if (attendanceError) {
                showMessage(`Gagal menyimpan ke absensi: ${attendanceError.message}`, 'error');
                return;
            }

            // 6. Update status di 'attendance_requests' menjadi 'Disetujui'
            const { error: requestError } = await _supabase
                .from('attendance_requests')
                .update({ requests_status: 'Disetujui' })
                .eq('id', requestId);

            if (requestError) {
                showMessage(`Absensi diperbarui, tapi status request gagal diubah: ${requestError.message}`, 'error');
            } else {
                showMessage('Pengajuan koreksi berhasil disetujui dan data absensi telah diperbarui.', 'success');
            }

            loadRequestAttendanceData(); // Muat ulang tabel pengajuan
        }

        async function handleRejectRequest(requestId) {
            showMessage("Memproses penolakan...", 'info');

            // Cukup update status request menjadi 'Ditolak'
            const { error } = await _supabase
                .from('attendance_requests')
                .update({ requests_status: 'Ditolak' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menolak pengajuan: ${error.message}`, 'error');
                return;
            }

            showMessage('Pengajuan koreksi telah ditolak.', 'success');
            loadRequestAttendanceData(); // Muat ulang tabel pengajuan
        }

        // --- FUNGSI BARU: INIT FILTER PENGAJUAN IZIN/CUTI ---
        async function initializeReqTimeoffFilters() {
            const employeeFilter = document.getElementById('reqTimeoffEmployeeFilter');
            const tableBody = document.getElementById('reqTimeoffTableBody');

            if (!employeeFilter || !tableBody) {
                console.error("Elemen filter Izin/Cuti tidak ditemukan!");
                return;
            }

            // (Gunakan data allEmployees yang sudah dimuat)
            if (allEmployees.length === 0) { 
                 let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data, error } = await query;
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter izin:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // Atur tanggal default
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqTimeoffEndDate').value = today;
            document.getElementById('reqTimeoffStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // Muat data awal
            loadRequestTimeoffData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN IZIN/CUTI ---
        async function loadRequestTimeoffData() {
            const tableBody = document.getElementById('reqTimeoffTableBody');
            const startDate = document.getElementById('reqTimeoffStartDate').value;
            const endDate = document.getElementById('reqTimeoffEndDate').value;
            const employeeId = document.getElementById('reqTimeoffEmployeeFilter').value;
            const statusFilter = document.getElementById('reqTimeoffStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Mencari pengajuan izin/cuti...</td></tr>';

            let query = _supabase
                .from('timeoff_requests')
                .select(`
                    id, 
                    created_at,
                    user_id,
                    timeoff_type_id, 
                    timeoff_types ( name ), 
                    start_date,
                    end_date,
                    description, 
                    timeoff_status,
                    profiles(full_name)
                `)
                // Filter Tanggal Mulai Izin (start_date)
                .gte('start_date', startDate) 
                .lte('start_date', endDate); 

            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }
            if (statusFilter) {
                query = query.eq('timeoff_status', statusFilter);
            }
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }

            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan izin:", error.message);
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Tidak ada pengajuan izin/cuti yang cocok.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const tglPengajuan = new Date(req.created_at).toLocaleDateString('id-ID');
                const tglMulai = new Date(req.start_date).toLocaleDateString('id-ID');
                const tglAkhir = new Date(req.end_date).toLocaleDateString('id-ID');
                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const timeoffName = (req.timeoff_types && req.timeoff_types.name) ? req.timeoff_types.name : 'N/A';
                const description = req.description || '-';
                const status = req.timeoff_status;
                
                let statusClass, actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveTimeoff('${req.id}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectTimeoff('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglPengajuan}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${timeoffName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglMulai}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglAkhir}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI BARU: AKSI SETUJUI / TOLAK IZIN/CUTI ---
        async function handleApproveTimeoff(requestId) {
            // LOGIKA KOMPLEKS:
            // 1. Ambil data timeoff_requests (untuk dapat tgl mulai, akhir, jenis, dan user_id)
            // 2. Loop dari tgl mulai s/d tgl akhir
            // 3. Untuk setiap tanggal, lakukan UPSERT ke tabel 'attendance'
            //    dengan status = timeoff_type (cth: 'Izin' atau 'Sakit')
            
            // Untuk SAAT INI, kita hanya update statusnya saja
            showMessage("Memproses persetujuan (Timeoff)...", 'info');
            const { error } = await _supabase
                .from('timeoff_requests')
                .update({ timeoff_status: 'Disetujui' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menyetujui: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Izin/Cuti disetujui.', 'success');
            loadRequestTimeoffData();
            // TODO: Tambahkan logika untuk memasukkan data ke tabel 'attendance'
        }

        async function handleRejectTimeoff(requestId) {
            showMessage("Memproses penolakan (Timeoff)...", 'info');
            const { error } = await _supabase
                .from('timeoff_requests')
                .update({ timeoff_status: 'Ditolak' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menolak: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Izin/Cuti ditolak.', 'success');
            loadRequestTimeoffData();
        }

        // --- FUNGSI BARU: INIT FILTER PENGAJUAN LEMBUR ---
async function initializeReqOvertimeFilters() {
            const employeeFilter = document.getElementById('reqOvertimeEmployeeFilter');
            const tableBody = document.getElementById('reqOvertimeTableBody');

            if (!employeeFilter || !tableBody) {
                console.error("Elemen filter Lembur tidak ditemukan!");
                return;
            }

            // (Gunakan data allEmployees yang sudah dimuat, atau muat jika kosong)
            if (allEmployees.length === 0) { 
                let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data, error } = await query;
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter lembur:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // Atur tanggal default
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqOvertimeEndDate').value = today;
            document.getElementById('reqOvertimeStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // Muat data awal
            loadRequestOvertimeData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN LEMBUR ---
        async function loadRequestOvertimeData() {
            const tableBody = document.getElementById('reqOvertimeTableBody');
            const startDate = document.getElementById('reqOvertimeStartDate').value;
            const endDate = document.getElementById('reqOvertimeEndDate').value;
            const employeeId = document.getElementById('reqOvertimeEmployeeFilter').value;
            const statusFilter = document.getElementById('reqOvertimeStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Mencari pengajuan lembur...</td></tr>';

            let query = _supabase
                .from('overtime_requests')
                .select(`
                    id, 
                    created_at,
                    user_id,
                    overtime_date, 
                    start_time,
                    end_time,
                    description, 
                    overtime_status,
                    profiles(full_name)
                `)
                // Filter Tanggal Lembur (overtime_date)
                .gte('overtime_date', startDate) 
                .lte('overtime_date', endDate); 

            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }
            if (statusFilter) {
                query = query.eq('overtime_status', statusFilter);
            }
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }

            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan lembur:", error.message);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada pengajuan lembur yang cocok.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const tglDiajukan = new Date(req.created_at).toLocaleDateString('id-ID');
                const tglLembur = new Date(req.overtime_date).toLocaleDateString('id-ID');
                
                // Format waktu untuk start_time dan end_time (karena itu timestamp with time zone)
                const waktuMulai = formatTime(req.start_time);
                const waktuAkhir = formatTime(req.end_time);

                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const description = req.description || '-';
                const status = req.overtime_status;
                
                let statusClass, actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveOvertime('${req.id}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectOvertime('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglDiajukan}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${tglLembur}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${waktuMulai} - ${waktuAkhir}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI BARU: AKSI SETUJUI / TOLAK LEMBUR ---

        async function handleApproveOvertime(requestId) {
            showMessage("Memproses persetujuan (Lembur)...", 'info');
            
            // Logika persetujuan lembur: hanya update status menjadi 'Disetujui'
            // Data lembur yang disetujui akan dihitung oleh sistem Payroll di masa depan
            const { error } = await _supabase
                .from('overtime_requests')
                .update({ overtime_status: 'Disetujui' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menyetujui lembur: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Lembur disetujui.', 'success');
            loadRequestOvertimeData();
        }

        async function handleRejectOvertime(requestId) {
            showMessage("Memproses penolakan (Lembur)...", 'info');
            
            const { error } = await _supabase
                .from('overtime_requests')
                .update({ overtime_status: 'Ditolak' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menolak lembur: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Lembur ditolak.', 'success');
            loadRequestOvertimeData();
        }

        // --- FUNGSI BARU: MASTER DATA (TAB, MODAL, CRUD) ---

        const masterDataModal = document.getElementById('masterDataModal');
        const masterDataForm = document.getElementById('masterDataForm');
        const masterModalTitle = document.getElementById('masterModalTitle');
        const masterName = document.getElementById('masterName');
        const masterDescription = document.getElementById('masterDescription');
        
        const masterDeleteModal = document.getElementById('masterDeleteModal');
        const masterDeleteText = document.getElementById('masterDeleteText');
        const masterDeleteConfirmButton = document.getElementById('masterDeleteConfirmButton');
        
        let currentMasterDelete = {}; // { type: 'timeoff', id: 123 }
        let currentMasterType = 'timeoff'; // 'timeoff', 'salary', 'deduction'

        // Mengatur Tab Aktif di Halaman Master Data
        function showMasterTab(tabName) {
            currentMasterType = tabName;
            
            // Definisikan tombol dan konten
            const tabs = ['timeoff', 'salary', 'deduction'];
            
            tabs.forEach(tab => {
                const tabButton = document.getElementById(`tabMaster${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                const tabContent = document.getElementById(`masterContent${tab.charAt(0).toUpperCase() + tab.slice(1)}`);

                if (tab === tabName) {
                    // Aktifkan tab
                    tabButton.classList.add('border-blue-500', 'text-blue-600');
                    tabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    tabContent.classList.remove('hidden');
                } else {
                    // Nonaktifkan tab
                    tabButton.classList.remove('border-blue-500', 'text-blue-600');
                    tabButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    tabContent.classList.add('hidden');
                }
            });

            // Muat data untuk tab yang dipilih (jika diperlukan)
            if (tabName === 'timeoff') {
                loadTimeoffTypes();
            } else if (tabName === 'salary') {
                loadSalaryTypes();
            } else if (tabName === 'deduction') {
                loadDeductionTypes();
            }
        }

        // Membuka Modal Add/Edit
        async function openMasterModal(mode, type, id = null, name = '', description = '', companyId = null, method = 'Nominal Tetap', value = 0, conditionRuleString = '{}') {
            masterDataForm.reset();
            currentMasterType = type;
            
            let titlePrefix = (mode === 'add') ? 'Tambah' : 'Edit';
            let tableName = '';
            
            if (type === 'timeoff') tableName = 'Tipe Izin/Cuti';
            else if (type === 'salary') tableName = 'Tipe Gaji';
            else if (type === 'deduction') tableName = 'Tipe Potongan';

            masterModalTitle.textContent = `${titlePrefix} ${tableName}`;
            masterName.value = name;
            masterDescription.value = (description && description !== 'null') ? description : '';

            // --- (LOGIKA DROPDOWN SUPER ADMIN - Tidak berubah) ---
            const companySelectContainer = document.getElementById('masterCompanySelectContainer');
            const companySelect = document.getElementById('masterCompanySelect');
            if (globalProfile.role === 'super_admin') {
                companySelectContainer.classList.remove('hidden');
                companySelect.required = false; 
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                const { data } = await _supabase.from('companies').select('id, name').order('name', { ascending: true });
                if (data) {
                    let options = '<option value="">-- Global (Semua Perusahaan) --</option>';
                    options += data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    companySelect.innerHTML = options;
                }
                companySelect.value = companyId || ''; 
            } else {
                companySelectContainer.classList.add('hidden');
                companySelect.required = false;
            }
            
            // --- (LOGIKA BARU) SEMBUNYIKAN/TAMPILKAN FIELD KHUSUS ---
            
            // 1. Ambil semua elemen field khusus
            const deductionFields = document.getElementById('masterDeductionFields');
            const salaryFields = document.getElementById('masterSalaryFields');
            const deductionConditionContainer = document.getElementById('masterDeductionConditionContainer');
            const salaryConditionContainer = document.getElementById('masterSalaryConditionContainer');

            // 2. Sembunyikan semua field khusus terlebih dahulu
            deductionFields.classList.add('hidden');
            salaryFields.classList.add('hidden');
            deductionConditionContainer.classList.add('hidden');
            salaryConditionContainer.classList.add('hidden');

            // 3. Parse aturan kondisi
            const conditionRule = JSON.parse(conditionRuleString.replace(/\\'/g, "'") || '{}');

            if (type === 'deduction') {
                // Tampilkan field POTONGAN
                deductionFields.classList.remove('hidden');
                document.getElementById('masterDeductionMethod').value = method;
                document.getElementById('masterDeductionValue').value = value;
                
                // Tampilkan pemicu jika 'Berdasarkan Absensi'
                if (method === 'Berdasarkan Absensi') {
                    deductionConditionContainer.classList.remove('hidden');
                    document.getElementById('masterDeductionCondition').value = conditionRule?.trigger_status || '';
                }
            
            } else if (type === 'salary') {
                // Tampilkan field GAJI
                salaryFields.classList.remove('hidden');
                document.getElementById('masterSalaryMethod').value = method;
                document.getElementById('masterSalaryValue').value = value;

                // Tampilkan pemicu jika 'Berdasarkan Lembur' atau 'Berdasarkan Absensi'
                if (method === 'Berdasarkan Lembur') {
                    salaryConditionContainer.classList.remove('hidden');
                    // Tentukan nilai pemicu berdasarkan 'trigger_source'
                    document.getElementById('masterSalaryCondition').value = (conditionRule?.trigger_source === 'overtime_requests') ? 'overtime_approved' : '';
                } else if (method === 'Berdasarkan Absensi') {
                    salaryConditionContainer.classList.remove('hidden');
                    // Tentukan nilai pemicu berdasarkan 'trigger_status'
                    document.getElementById('masterSalaryCondition').value = conditionRule?.trigger_status || '';
                }
            }
            // --- (AKHIR LOGIKA BARU) ---

            // Simpan data di form dataset
            masterDataForm.dataset.mode = mode;
            masterDataForm.dataset.id = id; 
            
            masterDataModal.classList.remove('hidden');
        }

        function closeMasterModal() {
            masterDataModal.classList.add('hidden');
        }

        // Membuka Modal Konfirmasi Hapus
        function openConfirmDeleteModal(type, id, name) {
            currentMasterDelete = { type, id };
            masterDeleteText.innerHTML = `Apakah Anda yakin ingin menghapus <strong>${name}</strong>? Data ini mungkin tidak bisa dipulihkan.`;
            masterDeleteModal.classList.remove('hidden');
        }

        function closeConfirmDeleteModal() {
            masterDeleteModal.classList.add('hidden');
            currentMasterDelete = {};
        }

        // CRUD: Memuat data Tipe Izin/Cuti
        async function loadTimeoffTypes() {
            const tableBody = document.getElementById('timeoffTypesTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data...</td></tr>'; // <-- Colspan diubah jadi 4

            // (PERBAIKAN 1) Ambil nama perusahaan
            let query = _supabase.from('timeoff_types').select('id, name, description, company_id, companies(name)');
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat timeoff_types:", error.message);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`; // <-- Colspan diubah jadi 4
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada data Tipe Izin/Cuti.</td></tr>'; // <-- Colspan diubah jadi 4
                return;
            }

            const html = data.map(item => {
                const description = item.description || '-';
                // Gunakan backslash untuk escape kutipan di dalam string
                const safeName = item.name.replace(/'/g, "\\'");
                const safeDesc = (item.description || '').replace(/'/g, "\\'");

                // (PERBAIKAN 2) Tentukan nama perusahaan
                // Jika Super Admin, tampilkan nama. Jika tidak ada, tampilkan 'Global'.
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-'); // Company admin tidak seharusnya melihat 'Global'

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td> <!-- (BARU) Kolom Perusahaan -->
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- (PERBAIKAN 3) Kirim item.company_id ke modal -->
                            <button onclick="openMasterModal('edit', 'timeoff', '${item.id}', '${safeName}', '${safeDesc}', '${item.company_id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('timeoff', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // CRUD: Memuat data Tipe Gaji (BARU)
        async function loadSalaryTypes() {
            const tableBody = document.getElementById('salaryTypesTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data...</td></tr>'; // Colspan jadi 6

            // (PERBAIKAN 1) Ambil 'method', 'value', 'condition_rule'
            let query = _supabase.from('salary_types').select('id, name, description, company_id, method, value, condition_rule, companies(name)');
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat salary_types:", error.message);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`; // Colspan 6
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada data Tipe Gaji.</td></tr>'; // Colspan 6
                return;
            }

            const html = data.map(item => {
                const description = item.description || '-';
                const safeName = item.name.replace(/'/g, "\\'");
                const safeDesc = (item.description || '').replace(/'/g, "\\'");
                // (PERBAIKAN 2) Siapkan method, value, companyId, dan condition
                const safeMethod = (item.method || 'Nominal Tetap').replace(/'/g, "\\'");
                const safeValue = item.value || 0;
                const safeCompanyId = item.company_id || '';
                const safeCondition = JSON.stringify(item.condition_rule || {}).replace(/'/g, "\\'");

                // Tentukan nama perusahaan
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-');
                
                // Format nilai
                const valueDisplay = (item.method === 'Berdasarkan Lembur') ? `Rp ${new Intl.NumberFormat('id-ID').format(item.value)} /jam` : 
                                     (item.method === 'Berdasarkan Absensi') ? `Rp ${new Intl.NumberFormat('id-ID').format(item.value)}` : 
                                     '-'; // Nominal Tetap tidak tampil nilai di sini

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${item.method}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${valueDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- (PERBAIKAN 3) Kirim data baru (method, value, condition) ke modal -->
                            <button onclick="openMasterModal('edit', 'salary', '${item.id}', '${safeName}', '${safeDesc}', '${safeCompanyId}', '${safeMethod}', ${safeValue}, '${safeCondition}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('salary', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // CRUD: Memuat data Tipe Potongan (BARU)
        async function loadDeductionTypes() {
            const tableBody = document.getElementById('deductionTypesTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data...</td></tr>'; // Colspan jadi 6

            // (PERBAIKAN 1) Ambil 'method' dan 'value'
            let query = _supabase.from('deduction_types').select('id, name, description, company_id, method, value, companies(name)');
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat deduction_types:", error.message);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`; // Colspan 6
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada data Tipe Potongan.</td></tr>'; // Colspan 6
                return;
            }

            const html = data.map(item => {
                const description = item.description || '-';
                const safeName = item.name.replace(/'/g, "\\'");
                const safeDesc = (item.description || '').replace(/'/g, "\\'");
                // (PERBAIKAN 2) Siapkan method, value, dan companyId
                const safeMethod = (item.method || 'Nominal Tetap').replace(/'/g, "\\'");
                const safeValue = item.value || 0;
                const safeCompanyId = item.company_id || '';
                const safeCondition = JSON.stringify(item.condition_rule || {}).replace(/'/g, "\\'");

                // Tentukan nama perusahaan
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-');
                
                // Format nilai
                const valueDisplay = (item.method === 'Persentase') ? `${item.value}%` : `Rp ${new Intl.NumberFormat('id-ID').format(item.value)}`;

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${item.method}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${valueDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- (PERBAIKAN 3) Kirim data baru ke modal -->
                            <button onclick="openMasterModal('edit', 'deduction', '${item.id}', '${safeName}', '${safeDesc}', '${safeCompanyId}', '${safeMethod}', ${safeValue})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('deduction', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // CRUD: Simpan data (Add/Edit)
        async function handleSaveMasterData(e) {
            e.preventDefault();
            
            const { mode, id } = masterDataForm.dataset;
            const tableName = (currentMasterType === 'timeoff') ? 'timeoff_types' : 
                              (currentMasterType === 'salary') ? 'salary_types' : 'deduction_types';

            // (Payload dasar)
            const payload = {
                name: masterName.value,
                description: masterDescription.value || null
            };

            // (Tentukan company_id - Tidak berubah)
            if (globalProfile.role === 'super_admin') {
                const selectedCompanyId = document.getElementById('masterCompanySelect').value;
                payload.company_id = selectedCompanyId ? selectedCompanyId : null; 
            } else {
                if (mode === 'add') {
                    payload.company_id = globalProfile.company_id;
                }
            }

            // (LOGIKA BARU) Tambahkan data khusus berdasarkan TIPE
            payload.condition_rule = null; // Reset dulu

            if (currentMasterType === 'deduction') {
                // Ambil data dari field Potongan
                payload.method = document.getElementById('masterDeductionMethod').value;
                payload.value = parseFloat(document.getElementById('masterDeductionValue').value) || 0;
                
                if (payload.method === 'Berdasarkan Absensi') {
                    const triggerStatus = document.getElementById('masterDeductionCondition').value;
                    if (triggerStatus) {
                        payload.condition_rule = { trigger_status: triggerStatus };
                    }
                }
            
            } else if (currentMasterType === 'salary') {
                // Ambil data dari field Gaji
                payload.method = document.getElementById('masterSalaryMethod').value;
                payload.value = parseFloat(document.getElementById('masterSalaryValue').value) || 0;

                const trigger = document.getElementById('masterSalaryCondition').value;
                
                if (payload.method === 'Berdasarkan Lembur' && trigger === 'overtime_approved') {
                    // Simpan aturan untuk lembur
                    payload.condition_rule = { 
                        trigger_source: 'overtime_requests', 
                        trigger_status: 'Disetujui' 
                    };
                } else if (payload.method === 'Berdasarkan Absensi' && trigger) {
                    // Simpan aturan untuk absensi (cth: bonus 'Hadir')
                    payload.condition_rule = { 
                        trigger_status: trigger 
                    };
                }
            }

            let query;
            if (mode === 'add') {
                query = _supabase.from(tableName).insert([payload]);
            } else {
                // Mode Edit
                query = _supabase.from(tableName).update(payload).eq('id', id);
            }

            showMessage("Menyimpan data...", 'info');
            const { error } = await query;

            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                return;
            }

            showMessage('Data master berhasil disimpan.', 'success');
            closeMasterModal();
            
            // Muat ulang data tabel yang sesuai
            if (currentMasterType === 'timeoff') loadTimeoffTypes();
            else if (currentMasterType === 'salary') loadSalaryTypes();
            else if (currentMasterType === 'deduction') loadDeductionTypes();
        }

        function openLateReasonModal() {
            lateReasonDescription.value = ''; // Kosongkan textarea
            lateReasonModal.classList.remove('hidden');
        }

        function closeLateReasonModal() {
            lateReasonModal.classList.add('hidden');
            tempClockInData = {}; // Hapus data sementara
        }

        // Fungsi baru untuk menangani INSERT (dipanggil oleh doClockIn atau submit modal)
        async function insertAttendance(clockInTime, location, status, description) {
            const newAttendance = {
                user_id: globalProfile.id,
                company_id: globalProfile.company_id,
                attendance_status: status, 
                clock_in: clockInTime.toISOString(),
                location: location,
                description: description // (BARU) Akan berisi alasan jika terlambat
            };
            
            const { error } = await _supabase
                .from('attendance')
                .insert([newAttendance]);

            if (error) {
                console.error(`Gagal Absen Masuk (${status}):`, error.message);
                showMessage(`Gagal Absen Masuk: ${error.message}.`, 'error');
                karyawanClockInButton.disabled = false; // Aktifkan lagi jika gagal
                return false;
            }
            
            const successMessage = (status === 'Terlambat') 
                ? 'Clock-In (Terlambat) Berhasil! Alasan Anda tersimpan.' 
                : 'Absen Masuk Berhasil! Selamat bekerja.';
                
            showMessage(successMessage, 'success');
            loadKaryawanAttendanceStatus(); // Muat ulang status (penting!)
            return true;
        }

        // Atur filter tanggal ke hari ini saat inisialisasi admin
        adminAttendanceDateFilter.value = getTodayDateString();
        adminAttendanceDateFilter.addEventListener('change', (e) => loadAdminAttendanceData(e.target.value));
        
        // --- LOGIKA MODAL ADMIN ---

        function openModal(attendanceId, userId, name, status, clockIn, clockOut) {
            modalAttendanceData = {
                id: attendanceId,
                user_id: userId,
                name: name
            };

            modalEmployeeName.textContent = name;
            
            modalStatus.value = status;
            modalClockIn.value = clockIn || '';
            modalClockOut.value = clockOut || '';

            const isHadir = status === 'Hadir' || status === 'Terlambat';
            modalClockIn.disabled = !isHadir;
            modalClockOut.disabled = !isHadir;

            modalStatus.onchange = () => {
                const newStatus = modalStatus.value;
                const newIsHadir = newStatus === 'Hadir' || newStatus === 'Terlambat';
                modalClockIn.disabled = !newIsHadir;
                modalClockOut.disabled = !newIsHadir;

                if (!newIsHadir) {
                    modalClockIn.value = '';
                    modalClockOut.value = '';
                }
            };

            statusModal.classList.remove('hidden');
        }

        function closeModal() {
            statusModal.classList.add('hidden');
            modalAttendanceData = {};
        }

        modalSaveButton.addEventListener('click', async () => {
            const status = modalStatus.value;
            const clockInTime = modalClockIn.value; // format HH:MM
            const clockOutTime = modalClockOut.value; // format HH:MM
            const dateString = adminAttendanceDateFilter.value;
            
            showMessage("Menyimpan perubahan...", 'info');
            
            // Konversi HH:MM menjadi ISO string pada tanggal yang difilter
            const combineDateTime = (time) => {
                if (!time) return null;
                const [hours, minutes] = time.split(':');
                const date = new Date(dateString);
                // Penting: Set jam dalam WAKTU LOKAL
                date.setHours(parseInt(hours, 10));
                date.setMinutes(parseInt(minutes, 10));
                date.setSeconds(0);
                date.setMilliseconds(0);
                return date.toISOString();
            };
            
            const payload = {
                attendance_status: status,
                clock_in: combineDateTime(clockInTime),
                clock_out: combineDateTime(clockOutTime),
                updated_at: new Date().toISOString()
            };

            if (modalAttendanceData.id && modalAttendanceData.id !== 'null') {
                // KASUS 1: UPDATE ABSENSI YANG SUDAH ADA
                const { error } = await _supabase
                    .from('attendance')
                    .update(payload)
                    .eq('id', modalAttendanceData.id);

                if (error) {
                    showMessage(`Gagal update: ${error.message}`, 'error');
                    return;
                }
                
            } else {
                // KASUS 2: BUAT ABSENSI BARU (Misal mengubah Alpa menjadi Hadir)
                const newPayload = {
                    ...payload,
                    user_id: modalAttendanceData.user_id,
                    company_id: globalProfile.company_id,
                    created_at: combineDateTime(clockInTime) || new Date(dateString).toISOString(), 
                };
                
                const { error } = await _supabase
                    .from('attendance')
                    .insert([newPayload]);

                if (error) {
                    showMessage(`Gagal insert baru: ${error.message}`, 'error');
                    return;
                }
            }
            
            showMessage('Perubahan berhasil disimpan.', 'success');
            closeModal();
            loadAdminAttendanceData(dateString); // Muat ulang tabel
        });

        // --- 4. FUNGSI BARU: HELPER KONVERSI WAKTU ---
        function combineDateAndTime(dateString, timeString) {
            if (!dateString || !timeString) return null;
            
            const [hours, minutes] = timeString.split(':');
            
            // Buat tanggal baru berdasarkan dateString (PENTING: gunakan 'T00:00:00' untuk memastikan interpretasi lokal)
            // Ini memperbaiki bug timezone jika pengguna menginput tanggal kemarin
            const date = new Date(dateString + 'T00:00:00'); 
            
            // Set jam dan menit dalam WAKTU LOKAL
            date.setHours(parseInt(hours, 10));
            date.setMinutes(parseInt(minutes, 10));
            date.setSeconds(0);
            date.setMilliseconds(0);
            
            // Kembalikan sebagai ISO string
            return date.toISOString();
        }


        // --- 5. FUNGSI BARU: KIRIM PENGAJUAN ---
        // (Letakkan setelah fungsi helper di atas, sekitar baris 1815)

        async function handleNewAttendanceRequest(e) {
            e.preventDefault(); // Mencegah form reload halaman
            const saveButton = document.getElementById('saveRequestButton');
            saveButton.disabled = true;

            const attDate = document.getElementById('reqAttDate').value;
            const clockInTime = document.getElementById('reqAttClockIn').value;
            const clockOutTime = document.getElementById('reqAttClockOut').value;
            const description = document.getElementById('reqAttDescription').value;

            // Validasi constraint dari Supabase: Minimal 1 jam harus diisi
            if (!clockInTime && !clockOutTime) {
                showMessage("Gagal: Harap isi Jam Masuk atau Jam Pulang.", 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Mengirim pengajuan...", 'info');

            // Siapkan payload sesuai skema 'attendance_requests'
            const newRequest = {
                user_id: globalProfile.id,
                company_id: globalProfile.company_id,
                attendance_date: attDate,
                // Gunakan helper baru untuk konversi waktu
                clock_in: combineDateAndTime(attDate, clockInTime),
                clock_out: combineDateAndTime(attDate, clockOutTime),
                description: description,
                requests_status: 'Diajukan' // Default saat insert
            };

            const { error } = await _supabase
                .from('attendance_requests')
                .insert([newRequest]);

            if (error) {
                console.error("Gagal mengirim pengajuan:", error.message);
                showMessage(`Gagal: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Pengajuan koreksi berhasil dikirim.", 'success');
            closeRequestAttendanceModal();
            loadAttendanceRequests(); // Muat ulang daftar request di belakang modal
        }

        // ===============================================================
        // 4. LOGIKA AUTHENTIKASI UTAMA (GLOBAL)
        // ===============================================================
        
        async function doLogout() {
            const { error } = await _supabase.auth.signOut();
            if (!error) {
                globalProfile = null;
                changeView('loginView');
                showMessage('Anda telah logout.', 'info');
            } else {
                showMessage('Gagal logout: ' + error.message, 'error');
            }
        }

        async function checkAuthAndRole() {
            loadingView.style.display = 'flex'; // Tampilkan loading
            
            const { data: { session } } = await _supabase.auth.getSession();
            
            if (!session) {
                loadingView.style.display = 'none';
                return changeView('loginView'); // BUG FIX: Arahkan ke login jika tidak ada sesi
            }

            // Ambil data profil untuk menentukan peran
            const { data: profile, error: profileError } = await _supabase
                .from('profiles')
                .select(`
                    id, 
                    role, 
                    full_name, 
                    company_id,
                    workhour_id, 
                    workhours ( * ), 
                    companies ( status) 
                `)
                .eq('id', session.user.id)
                .single();

            if (profileError || !profile) {
                console.error("Gagal memuat profil:", profileError?.message);
                showMessage("Gagal memuat data profil. Silakan login ulang.", 'error');
                await _supabase.auth.signOut();
                loadingView.style.display = 'none';
                return changeView('loginView');
            }

            // --- LOGIKA BARU: Cek Status Perusahaan ---
            if (profile.companies && profile.companies.status === 'tidak aktif') {
                // Jika perusahaan tidak aktif, tolak login
                showMessage("Login gagal: Perusahaan Anda saat ini tidak aktif. Hubungi administrator.", 'error');
                await doLogout(); // Paksa logout
                loadingView.style.display = 'none';
                return changeView('loginView'); // Arahkan kembali ke login
            }
            
            globalProfile = profile; // Simpan profil secara global
            const userRole = profile.role;
            await loadCompanyDetails();
            
            // Inisialisasi Jam
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDateTime');
            if (timeElement && dateElement) {
                initializeClock(timeElement, dateElement);
            }
            
            // Pengalihan berdasarkan Peran
            if (userRole === 'super_admin' || userRole === 'company_admin') {
                // ADMIN: Konfigurasi & Arahkan ke Admin View
                adminRoleDisplay.textContent = `(${userRole.replace('_', ' ').toUpperCase()})`;
                karyawanAdminLink.classList.remove('hidden'); // Tampilkan tombol Admin di tampilan Karyawan

                // --- MENGISI NAMA & EMAIL ADMIN (BARU) ---
                const adminName = globalProfile.full_name;
                const adminEmail = session.user.email;
                // Format: Nama Lengkap (email)
                document.getElementById('adminInfoDisplay').textContent = `${adminName} (${adminEmail})`;
                // --- AKHIR LOGIKA HEADER ADMIN ---

                // Tampilkan menu Perusahaan HANYA untuk Super Admin
                if (userRole === 'super_admin') {
                    document.getElementById('menuCompaniesContainer').classList.remove('hidden');
                } else {
                    document.getElementById('menuCompaniesContainer').classList.add('hidden');
                }
                
                // --- SETUP ADMIN EVENT LISTENERS (DIPINDAHKAN UNTUK ROBUSTNESS) ---
                // Menggunakan .onclick sebagai pengganti addEventListener untuk kepastian
                try {
                    document.getElementById('rekapFilterButton').onclick = loadRekapData;
                    document.getElementById('reqAttFilterButton').onclick = loadRequestAttendanceData;
                } catch (e) {
                    console.warn("Tombol filter admin belum sepenuhnya dimuat atau ID salah:", e.message);
                }
                // -----------------------------------------------------------------
                              
                // Muat status absensi Karyawan jika Admin melihat halaman Karyawan
                karyawanUserName.textContent = `Halo, ${profile.full_name}`; // <-- Diperbaiki
                loadKaryawanAttendanceStatus(); 

                loadingView.style.display = 'none';
                changeView('karyawanView'); 
                showKaryawanContent('Absensi'); // <-- Default ke tampilan Karyawan
                return;

            } else if (userRole === 'karyawan') {
                // KARYAWAN: Konfigurasi & Arahkan ke Karyawan View
                karyawanUserName.textContent = `Halo, ${profile.full_name}`; // <-- Diperbaiki
                karyawanAdminLink.classList.add('hidden');
                loadKaryawanAttendanceStatus();

                loadingView.style.display = 'none';
                return changeView('karyawanView'); // Default ke tampilan Karyawan
            }
            // Fallback (Peran tidak valid)
            showMessage("Peran pengguna tidak valid. Logout.", 'error');
            await doLogout();
        }

        // FUNGSI EDIT EMPLOYEE (BARU DITAMBAHKAN)
        async function editEmployee(profileId) {
            // 1. Ambil data profil
            showMessage("Memuat data karyawan...", 'info');
            const { data: profile, error } = await _supabase
                .from('profiles')
                .select('id, full_name, user_id_number, role, user_status, company_id,email, workhour_id')
                .eq('id', profileId)
                .single();
            
            if (error) {
                showMessage(`Gagal memuat data: ${error.message}`, 'error');
                return;
            }

            // 2. Buka modal dan isi form
            await openEmployeeModal(); // Panggil openEmployeeModal untuk mengisi dropdown perusahaan
            await loadWorkhourDropdown('employeeWorkhour', profile.company_id, profile.workhour_id);
            
            document.getElementById('employeeModalTitle').textContent = 'Edit Karyawan';
            document.getElementById('employeeForm').dataset.editingId = profile.id; // Tandai mode edit

            document.getElementById('employeeFullName').value = profile.full_name;
            document.getElementById('employeeIDNumber').value = profile.user_id_number;
            document.getElementById('employeeRole').value = profile.role;
            document.getElementById('employeeStatus').value = profile.user_status;
            
            if(globalProfile.role === 'super_admin' && profile.company_id) {
                document.getElementById('employeeCompany').value = profile.company_id;
            }

            // Nonaktifkan email dan password saat edit
            // Kita tidak perlu menampilkan email/password untuk mencegah error RLS di Auth
            document.getElementById('employeeEmail').value = profile.email || 'Email tidak tersimpan'; // Placeholder
            document.getElementById('employeeEmail').disabled = true;
            document.getElementById('employeePassword').required = false; 
            document.getElementById('employeePassword').previousElementSibling.textContent = "Password (Kosongkan jika tidak berubah)";
            
            document.getElementById('saveEmployeeButton').textContent = "Simpan Perubahan";
        }

            // Jalankan pemeriksaan saat aplikasi dimuat
            checkAuthAndRole();

            const requestAttendanceModal = document.getElementById('requestAttendanceModal');
            const requestAttendanceForm = document.getElementById('requestAttendanceForm');
        
        // --- 6. EVENT LISTENER BARU ---
            requestAttendanceForm.addEventListener('submit', handleNewAttendanceRequest);

        // Event listener untuk Modal Alasan Keterlambatan (BARU)
        lateReasonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveButton = document.getElementById('lateReasonSubmitButton');
            saveButton.disabled = true;
            
            const description = lateReasonDescription.value;
            const { now, locationString } = tempClockInData;

            if (!now || !locationString) {
                showMessage("Data absensi tidak ditemukan. Silakan coba lagi.", 'error');
                saveButton.disabled = false;
                return;
            }

            // Panggil fungsi insert terpusat dengan status 'Terlambat'
            const success = await insertAttendance(now, locationString, 'Terlambat', description);

            if (success) {
                closeLateReasonModal();
            }
            // Tombol clock-in akan tetap disabled (karena sudah absen)
            // Tombol submit modal akan di-enable lagi saat modal dibuka (di openLateReasonModal)
            saveButton.disabled = false; 
        });       

        // Event listener untuk Filter Pengajuan Izin/Cuti (BARU)
        try {
            document.getElementById('reqTimeoffFilterButton').onclick = loadRequestTimeoffData;
        } catch (e) {
            console.warn("Tombol filter Izin/Cuti (reqTimeoffFilterButton) tidak ditemukan.");
        }

        // Event listener untuk Filter Pengajuan Izin/Cuti (BARU)
        try {
            document.getElementById('reqTimeoffFilterButton').onclick = loadRequestTimeoffData;
        } catch (e) {
            console.warn("Tombol filter Izin/Cuti (reqTimeoffFilterButton) tidak ditemukan.");
        }

        // (BARU) Event listener untuk Filter Pengajuan Lembur
        try {
            document.getElementById('reqOvertimeFilterButton').onclick = loadRequestOvertimeData;
        } catch (e) {
            console.warn("Tombol filter Lembur (reqOvertimeFilterButton) tidak ditemukan.");
        }

        // Event listener untuk Master Data (BARU)
        try {
            masterDataForm.addEventListener('submit', handleSaveMasterData);
            masterDeleteConfirmButton.addEventListener('click', handleDeleteMasterData);
        } catch (e) {
            console.warn("Elemen Master Data (form/modal) tidak ditemukan.");
        }

        // --- FUNGSI BARU: CRUD MANAJEMEN JAM KERJA ---

        const workhourModal = document.getElementById('workhourModal');
        const workhourForm = document.getElementById('workhourForm');
        const workhourDeleteModal = document.getElementById('workhourDeleteModal');
        const workhourDeleteText = document.getElementById('workhourDeleteText');
        const workhourDeleteConfirmButton = document.getElementById('workhourDeleteConfirmButton');
        let currentWorkhourDeleteId = null;
        const workhourDays = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];
        const workhourDayNames = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];

        // 1. Memuat Daftar Jam Kerja
        async function loadWorkhoursList() {
            const tableBody = document.getElementById('workhoursTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat data pola jam kerja...</td></tr>';

            let query = _supabase.from('workhours').select('id, name, company_id, companies(name)');
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat workhours:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada pola jam kerja.</td></tr>';
                return;
            }

            const html = data.map(item => {
                const safeName = item.name.replace(/'/g, "\\'");
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-');

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="openWorkhourModal('edit', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmWorkhourDelete('${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // 2. Membuka Modal (Add/Edit)
        async function openWorkhourModal(mode, id = null) {
            workhourForm.reset(); // Reset form
            document.getElementById('workhourModalTitle').textContent = (mode === 'add') ? 'Tambah Pola Jam Kerja' : 'Edit Pola Jam Kerja';
            workhourForm.dataset.mode = mode;
            workhourForm.dataset.id = id;

            // Atur Dropdown Perusahaan untuk Super Admin
            const companyContainer = document.getElementById('workhourCompanyContainer');
            const companySelect = document.getElementById('workhourCompanySelect');
            if (globalProfile.role === 'super_admin') {
                companyContainer.classList.remove('hidden');
                companySelect.required = false; // Boleh global (null)
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                
                const { data } = await _supabase.from('companies').select('id, name').order('name', { ascending: true });
                if (data) {
                    let options = '<option value="">-- Global (Semua Perusahaan) --</option>';
                    options += data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    companySelect.innerHTML = options;
                }
            } else {
                companyContainer.classList.add('hidden');
            }

            // Atur ulang field jadwal (default)
            workhourDays.forEach(day => {
                document.getElementById(`wh_${day}_start`).value = "08:00";
                document.getElementById(`wh_${day}_end`).value = "17:00";
                document.getElementById(`wh_${day}_is_off`).checked = (day === 'sabtu' || day === 'minggu');
                // Trigger event change untuk disable/enable input
                document.getElementById(`wh_${day}_is_off`).dispatchEvent(new Event('change'));
            });

            if (mode === 'edit') {
                showMessage("Memuat detail jam kerja...", 'info');
                const { data, error } = await _supabase.from('workhours').select('*').eq('id', id).single();
                if (error) {
                    showMessage(`Gagal memuat data: ${error.message}`, 'error');
                    return;
                }
                
                // Isi form dengan data
                document.getElementById('workhourName').value = data.name;
                if (globalProfile.role === 'super_admin') {
                    companySelect.value = data.company_id || '';
                }

                // Isi jadwal 7 hari dari JSON
                const schedule = data.schedule;
                workhourDayNames.forEach((dayName, index) => {
                    const dayKey = dayName; // Sesuai skema: "Senin", "Selasa", ...
                    const dayId = workhourDays[index]; // ID: 'senin', 'selasa', ...
                    
                    if (schedule[dayKey]) {
                        const dayData = schedule[dayKey];
                        const isOff = dayData.is_off || false;
                        document.getElementById(`wh_${dayId}_is_off`).checked = isOff;
                        if (!isOff) {
                            document.getElementById(`wh_${dayId}_start`).value = dayData.start;
                            document.getElementById(`wh_${dayId}_end`).value = dayData.end;
                        }
                        // Trigger event change untuk disable/enable input
                        document.getElementById(`wh_${dayId}_is_off`).dispatchEvent(new Event('change'));
                    }
                });
            }

            workhourModal.classList.remove('hidden');
        }

        // 3. Menutup Modal
        function closeWorkhourModal() {
            workhourModal.classList.add('hidden');
        }

        // 4. Menyimpan (Add/Edit)
        async function handleSaveWorkhour(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveWorkhourButton');
            saveButton.disabled = true;

            const { mode, id } = workhourForm.dataset;
            const name = document.getElementById('workhourName').value;

            // Bangun Objek JSON 'schedule'
            let schedule = {};
            workhourDayNames.forEach((dayName, index) => {
                const dayId = workhourDays[index]; // 'senin', 'selasa', ...
                const isOff = document.getElementById(`wh_${dayId}_is_off`).checked;
                
                if (isOff) {
                    schedule[dayName] = { is_off: true }; // dayName = "Senin", "Selasa", ...
                } else {
                    schedule[dayName] = {
                        is_off: false,
                        start: document.getElementById(`wh_${dayId}_start`).value,
                        end: document.getElementById(`wh_${dayId}_end`).value
                    };
                }
            });

            // Siapkan payload
            const payload = {
                name: name,
                schedule: schedule
            };

            // Tentukan company_id
            if (globalProfile.role === 'super_admin') {
                const selectedCompanyId = document.getElementById('workhourCompanySelect').value;
                payload.company_id = selectedCompanyId ? selectedCompanyId : null; // NULL untuk Global
            } else {
                if (mode === 'add') {
                    payload.company_id = globalProfile.company_id;
                }
            }
            
            // Lakukan Insert atau Update
            showMessage("Menyimpan pola jam kerja...", 'info');
            let query;
            if (mode === 'add') {
                query = _supabase.from('workhours').insert([payload]);
            } else {
                query = _supabase.from('workhours').update(payload).eq('id', id);
            }

            const { error } = await query;
            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage('Pola jam kerja berhasil disimpan.', 'success');
            closeWorkhourModal();
            loadWorkhoursList();
            saveButton.disabled = false;
        }

        // 5. Logika Hapus
        function openConfirmWorkhourDelete(id, name) {
            currentWorkhourDeleteId = id;
            workhourDeleteText.innerHTML = `Apakah Anda yakin ingin menghapus <strong>${name}</strong>? Karyawan yang terhubung dengan pola ini mungkin akan kehilangan jam kerjanya.`;
            workhourDeleteModal.classList.remove('hidden');
        }

        function closeConfirmWorkhourDelete() {
            workhourDeleteModal.classList.add('hidden');
            currentWorkhourDeleteId = null;
        }

        async function handleConfirmWorkhourDelete() {
            if (!currentWorkhourDeleteId) return;

            showMessage("Menghapus pola jam kerja...", 'info');
            
            const { error } = await _supabase.from('workhours').delete().eq('id', currentWorkhourDeleteId);
            
            if (error) {
                // Cek jika error karena Foreign Key (masih dipakai karyawan)
                if (error.code === '23503') { 
                    showMessage('Gagal hapus: Pola jam kerja ini masih digunakan oleh karyawan.', 'error');
                } else {
                    showMessage(`Gagal menghapus: ${error.message}`, 'error');
                }
                return;
            }

            showMessage('Pola jam kerja berhasil dihapus.', 'success');
            closeConfirmWorkhourDelete();
            loadWorkhoursList();
        }

        // --- FUNGSI BARU: CRUD MANAJEMEN SALDO CUTI ---

        const timeoffBalanceModal = document.getElementById('timeoffBalanceModal');
        const timeoffBalanceForm = document.getElementById('timeoffBalanceForm');
        
        // 1. Memuat Daftar Saldo Cuti
        async function loadTimeoffBalanceList() {
            const tableBody = document.getElementById('timeoffBalanceTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat saldo cuti...</td></tr>';

            // Ambil saldo cuti + nama karyawan + nama tipe cuti
            let query = _supabase.from('employee_timeoff_balances').select(`
                id, 
                balance_days, 
                user_id,
                profiles(full_name),
                timeoff_types(name)
            `);
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('balance_days', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat saldo cuti:", error.message);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada saldo cuti yang ditetapkan.</td></tr>';
                return;
            }

            const html = data.map(item => {
                const safeName = item.profiles ? item.profiles.full_name : 'N/A';
                const timeoffName = item.timeoff_types ? item.timeoff_types.name : 'N/A';
                const safeTimeoffName = timeoffName.replace(/'/g, "\\'");
                const balanceDisplay = new Intl.NumberFormat('id-ID', { maximumFractionDigits: 2 }).format(item.balance_days);

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${safeName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${timeoffName}</td>
                        <td class="px-4 py-3 text-center text-lg font-bold text-blue-600">${balanceDisplay}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="openTimeoffBalanceModal('edit', '${item.id}', '${item.user_id}', '${item.timeoff_type_id}', ${item.balance_days}, '${safeName}', '${safeTimeoffName}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit Saldo</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // 2. Membuka Modal (Add/Edit)
        async function openTimeoffBalanceModal(mode, id = null, userId = null, timeoffTypeId = null, balanceDays = 0, employeeName = '', timeoffTypeName = '') {
            document.getElementById('timeoffBalanceForm').reset();
            document.getElementById('timeoffBalanceModalTitle').textContent = (mode === 'add') ? 'Tetapkan Saldo Cuti Baru' : `Edit Saldo ${employeeName} (${timeoffTypeName})`;
            timeoffBalanceForm.dataset.mode = mode;
            timeoffBalanceForm.dataset.id = id;
            
            // Muat Dropdown Karyawan
            const employeeSelect = document.getElementById('balanceEmployeeSelect');
            if (allEmployees.length === 0) {
                let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data } = await query;
                allEmployees = data || [];
            }
            let employeeOptions = '<option value="">-- Pilih Karyawan --</option>';
            employeeOptions += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeSelect.innerHTML = employeeOptions;

            // Muat Dropdown Tipe Cuti
            const timeoffSelect = document.getElementById('balanceTimeoffTypeSelect');
            timeoffSelect.innerHTML = '<option value="">Memuat Tipe Cuti...</option>';
            // HANYA ambil tipe cuti di perusahaan yang sama atau global (company_id IS NULL)
            let typeQuery = _supabase.from('timeoff_types').select('id, name');
            if (globalProfile.company_id) {
                typeQuery = typeQuery.or(`company_id.eq.${globalProfile.company_id},company_id.is.null`);
            } else {
                typeQuery = typeQuery.is('company_id', null);
            }
            const { data: timeoffTypes, error } = await typeQuery;
            if (error || timeoffTypes.length === 0) {
                timeoffSelect.innerHTML = '<option value="">Gagal/Tidak Ada Tipe Cuti</option>';
            } else {
                let typeOptions = '<option value="">-- Pilih Tipe Cuti --</option>';
                typeOptions += timeoffTypes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                timeoffSelect.innerHTML = typeOptions;
            }


            if (mode === 'edit') {
                document.getElementById('balanceEmployeeSelectContainer').classList.add('hidden'); // Sembunyikan karyawan saat edit
                document.getElementById('balanceTimeoffTypeSelectContainer').classList.add('hidden'); // Sembunyikan tipe cuti saat edit

                document.getElementById('balanceEmployeeSelect').value = userId;
                document.getElementById('balanceTimeoffTypeSelect').value = timeoffTypeId;
                document.getElementById('balanceDays').value = balanceDays;
            } else {
                document.getElementById('balanceEmployeeSelectContainer').classList.remove('hidden'); // Tampilkan karyawan saat add
                document.getElementById('balanceTimeoffTypeSelectContainer').classList.remove('hidden'); // Tampilkan tipe cuti saat add
                document.getElementById('balanceDays').value = 0;
            }

            timeoffBalanceModal.classList.remove('hidden');
        }

        // 3. Menutup Modal
        function closeTimeoffBalanceModal() {
            document.getElementById('timeoffBalanceModal').classList.add('hidden');
        }

        // 4. Menyimpan (Add/Edit)
        async function handleSaveTimeoffBalance(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveTimeoffBalanceButton');
            saveButton.disabled = true;

            const { mode, id } = timeoffBalanceForm.dataset;
            const userId = document.getElementById('balanceEmployeeSelect').value;
            const timeoffTypeId = document.getElementById('balanceTimeoffTypeSelect').value;
            const balanceDays = parseFloat(document.getElementById('balanceDays').value);

            if (mode === 'add' && (!userId || !timeoffTypeId)) {
                showMessage('Harap pilih Karyawan dan Tipe Cuti.', 'error');
                saveButton.disabled = false;
                return;
            }
            if (isNaN(balanceDays) || balanceDays < 0) {
                showMessage('Saldo harus angka non-negatif.', 'error');
                saveButton.disabled = false;
                return;
            }
            
            const payload = {
                balance_days: balanceDays,
            };

            // Tambahkan FKs HANYA saat mode 'add'
            if (mode === 'add') {
                payload.user_id = userId;
                payload.timeoff_type_id = timeoffTypeId;
                payload.company_id = globalProfile.company_id; // Ambil dari admin yang login
            }
            
            showMessage("Menyimpan saldo cuti...", 'info');
            let query;
            if (mode === 'add') {
                query = _supabase.from('employee_timeoff_balances').insert([payload]);
            } else {
                query = _supabase.from('employee_timeoff_balances').update(payload).eq('id', id);
            }

            const { error } = await query;
            if (error) {
                // Error 23505 adalah constraint unik
                if (error.code === '23505') {
                    showMessage('Gagal: Saldo untuk Karyawan dan Tipe Cuti ini sudah ada.', 'error');
                } else {
                    showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                }
                saveButton.disabled = false;
                return;
            }

            showMessage('Saldo cuti berhasil disimpan.', 'success');
            closeTimeoffBalanceModal();
            loadTimeoffBalanceList();
            saveButton.disabled = false;
        }

        // (BARU) Fungsi Helper untuk memuat Dropdown Jam Kerja
        // 'companyId' = ID perusahaan yang dipilih
        // 'selectedWorkhourId' = (Opsional) ID jam kerja yang harus aktif (untuk mode edit)
        async function loadWorkhourDropdown(selectElementId, companyId, selectedWorkhourId = null) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;
            
            selectElement.innerHTML = '<option value="">Memuat...</option>';
            selectElement.disabled = true;

            // Query: Ambil jam kerja Global (company_id IS NULL) 
            // ATAU jam kerja milik perusahaan spesifik (company_id.eq(companyId))
            let whQuery = _supabase.from('workhours').select('id, name');
            
            if (companyId) {
                // Ambil Global DAN milik perusahaan
                whQuery = whQuery.or(`company_id.eq.${companyId},company_id.is.null`);
            } else {
                // Ambil HANYA Global (jika companyId null, cth: Super Admin belum pilih)
                whQuery = whQuery.is('company_id', null);
            }
            
            const { data, error } = await whQuery.order('name', { ascending: true });

            if (error) {
                console.error("Gagal memuat workhours untuk dropdown:", error.message);
                selectElement.innerHTML = '<option value="">Gagal memuat</option>';
                return;
            }
            
            if (data.length === 0 && !companyId) {
                 selectElement.innerHTML = '<option value="">-- Pilih Perusahaan Dulu --</option>';
                 return;
            }
            if (data.length === 0 && companyId) {
                 selectElement.innerHTML = '<option value="">-- Belum ada Pola Jam Kerja --</option>';
                 return;
            }

            let options = '<option value="">-- Pilih Pola Jam Kerja --</option>';
            options += data.map(wh => {
                // Cek apakah ini adalah opsi yang harus dipilih
                const isSelected = (wh.id == selectedWorkhourId) ? 'selected' : '';
                return `<option value="${wh.id}" ${isSelected}>${wh.name}</option>`;
            }).join('');
            
            selectElement.innerHTML = options;
            selectElement.disabled = false;
        }

        // (BARU) Event listener untuk modal master,
        // Tampilkan/sembunyikan field 'Trigger Status' berdasarkan 'Metode'
        try {
            const deductionMethodSelect = document.getElementById('masterDeductionMethod');
            const deductionConditionContainer = document.getElementById('masterDeductionConditionContainer');
            
            deductionMethodSelect.addEventListener('change', () => {
                if (deductionMethodSelect.value === 'Berdasarkan Absensi') {
                    deductionConditionContainer.classList.remove('hidden');
                } else {
                    deductionConditionContainer.classList.add('hidden');
                }
            });
        } catch (e) {
             console.warn("Elemen listener untuk Deductions tidak ditemukan.");
        }

        // (BARU) Event listener untuk modal master,
        // Tampilkan/sembunyikan field 'Trigger Status' untuk GAJI
        try {
            const salaryMethodSelect = document.getElementById('masterSalaryMethod');
            const salaryConditionContainer = document.getElementById('masterSalaryConditionContainer');
            
            salaryMethodSelect.addEventListener('change', () => {
                const method = salaryMethodSelect.value;
                // Tampilkan pemicu jika 'Berdasarkan Lembur' ATAU 'Berdasarkan Absensi'
                if (method === 'Berdasarkan Lembur' || method === 'Berdasarkan Absensi') {
                    salaryConditionContainer.classList.remove('hidden');
                } else {
                    salaryConditionContainer.classList.add('hidden');
                }
            });
        } catch (e) {
             console.warn("Elemen listener untuk Salary tidak ditemukan.");
        }

        // (BARU) Event listener untuk Form & Delete Modal Jam Kerja
        try {
            workhourForm.addEventListener('submit', handleSaveWorkhour);
            workhourDeleteConfirmButton.addEventListener('click', handleConfirmWorkhourDelete);
        } catch (e) {
            console.warn("Elemen Form Jam Kerja (workhourForm) tidak ditemukan.");
        }

        // (BARU) Event listener untuk 7 checkbox "Hari Libur" di modal jam kerja
        try {
            workhourDays.forEach(day => {
                const checkbox = document.getElementById(`wh_${day}_is_off`);
                const startInput = document.getElementById(`wh_${day}_start`);
                const endInput = document.getElementById(`wh_${day}_end`);

                checkbox.addEventListener('change', () => {
                    const isChecked = checkbox.checked;
                    startInput.disabled = isChecked;
                    endInput.disabled = isChecked;
                    if (isChecked) {
                        startInput.classList.add('bg-gray-200');
                        endInput.classList.add('bg-gray-200');
                    } else {
                        startInput.classList.remove('bg-gray-200');
                        endInput.classList.remove('bg-gray-200');
                    }
                });
            });
        } catch (e) {
            console.warn("Elemen checkbox jam kerja tidak ditemukan.");
        }

        // (BARU) Event listener untuk Form Saldo Cuti
        try {
            document.getElementById('timeoffBalanceForm').addEventListener('submit', handleSaveTimeoffBalance);
        } catch (e) {
            console.warn("Elemen Form Saldo Cuti (timeoffBalanceForm) tidak ditemukan.");
        }

    </script>
</body>
</html>
