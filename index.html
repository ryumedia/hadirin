<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kehadiran Karyawan (SPA)</title>
    <!-- Memuat Font Montserrat dari Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Memuat Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Menetapkan Montserrat sebagai font 'sans' default Tailwind
                        sans: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Memuat icon (Ionicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
        }
        /* Menyembunyikan tampilan secara default */
        .view {
            display: none;
        }
        .spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Kontainer Utama -->
    <div id="appContainer" class="flex flex-col min-h-screen">
        
        <!-- Layar Loading Awal -->
        <div id="loadingView" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
            <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
            <p class="mt-4 text-gray-600">Memverifikasi sesi...</p>
        </div>

        <!-- 1. Tampilan Login -->
        <div id="loginView" class="view flex flex-grow items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 sm:p-10">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-blue-600">Hadirin.org</h1>
                    <p class="text-gray-500 mt-2">Aplikasi Manajemen Kehadiran</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <div class="relative">
                            <input type="email" id="login-email" required placeholder="Email Anda"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <ion-icon name="mail-outline" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></ion-icon>
                        </div>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" required placeholder="Password"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <ion-icon name="lock-closed-outline" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></ion-icon>
                        </div>
                    </div>

                    <div id="loginMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm" role="alert"></div>

                    <button type="submit" id="loginButton"
                        class="w-full flex items-center justify-center px-4 py-2.5 rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 disabled:opacity-50">
                        <ion-icon name="log-in-outline" class="text-xl mr-2"></ion-icon>
                        <span id="loginButtonText">Masuk</span>
                        <div id="loginSpinner" class="hidden spinner w-4 h-4 border-2 border-t-transparent border-white ml-2" role="status"></div>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 2. Tampilan Karyawan -->
        <div id="karyawanView" class="view flex flex-grow items-start justify-center p-4 sm:p-6 lg:p-8 pb-20">
            <div class="w-full max-w-lg">
                <!-- Karyawan Header (Tetap sticky dan di atas) -->
                    <header id="karyawanHeader" class="flex justify-between rounded-lg items-start p-4 bg-white/70 backdrop-blur sticky top-0 z-10 border-b border-gray-200">
                        
                        <!-- KONTEN KIRI: NAMA, PERUSAHAAN, dan JAM PUSAT -->
                        <div class="flex-1 min-w-0">
                            
                            <!-- BARIS 1: NAMA KARYAWAN (Tidak Wrap) -->
                            <!-- Gunakan whitespace-nowrap, overflow-hidden, dan text-ellipsis -->
                            <p id="karyawanUserName" class="text-lg font-bold text-gray-800 transition-opacity duration-300 whitespace-nowrap overflow-hidden text-ellipsis">
                                Halo, [Nama Pengguna]
                            </p>
                            
                            <!-- BARIS 2: NAMA PERUSAHAAN -->
                            <p id="companyText" class="text-sm text-gray-600 mt-0.5 transition-opacity duration-300">
                                Company Name
                            </p>
                        </div>
                        
                        <!-- KONTEN KANAN: ICON ADMIN & LOGOUT (Tetap) -->
                        <div class="flex items-center space-x-4 ml-4">
                            <!-- Tombol Admin/Pengaturan (id="karyawanAdminLink" wajib ada untuk JS) -->
                            <!-- onclick harus memanggil changeView dan showAdminSection untuk memastikan Admin Dashboard dimuat di Ringkasan Harian -->
                            <button onclick="changeView('adminView'); showAdminSection('summary');" id="karyawanAdminLink" class="p-2 text-gray-600 hover:text-blue-600 transition duration-150 hidden">
                                <!-- Icon Admin/Pengaturan: Menggunakan Icon Gerigi (Cog) -->
                                <ion-icon name="settings-outline" class="text-2xl"></ion-icon>
                            </button>
                            <!-- Tombol Logout (Menambahkan onclick yang benar) -->
                            <button id="logoutBtn" onclick="doLogout()" class="p-2 text-red-500 hover:text-red-700 transition duration-150">
                                <!-- Icon Logout -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            </button>
                        </div>
                    </header>

                    <!-- Karyawan Absensi Section -->
                    <div id="karyawanSection_Absensi" class="mt-4 p-6 bg-white rounded-xl shadow-lg transition-all duration-300" style="display: block;">
                        
                        <!-- JAM (DIPUSATKAN) -->
                        <!-- Gunakan div dengan w-full dan text-center untuk memusatkan jam -->
                        <div class="w-full text-center mt-3 mb-3">
                            <p id="currentTime" class="text-5xl font-extrabold text-blue-600 transition-opacity duration-300">
                                00:00:00
                            </p>
                        </div>

                        <!-- Tombol Aksi Absensi -->
                        <div class="grid grid-cols-2 gap-4 mb-6 mt-6">
                            <button id="karyawanClockInButton" class="bg-green-600 text-white p-4 rounded-xl shadow-md hover:bg-green-700 transition duration-150 flex items-center justify-center font-bold text-lg disabled:opacity-50">
                                <ion-icon name="time-outline" class="text-2xl mr-2"></ion-icon>
                                Clock-In
                            </button>
                            <button id="karyawanClockOutButton" class="bg-red-600 text-white p-4 rounded-xl shadow-md hover:bg-red-700 transition duration-150 flex items-center justify-center font-bold text-lg disabled:opacity-50" disabled>
                                <ion-icon name="log-out-outline" class="text-2xl mr-2"></ion-icon>
                                Clock-Out
                            </button>
                        </div>        
                
                        <!-- KONTEN HEADER CARD: JUDUL + TANGGAL/HARI -->
                        <!-- KONTEN HEADER CARD: JUDUL, TANGGAL, DAN IKON RIWAYAT -->
                        <div class="mb-4 border-b pb-2 flex justify-between items-start">
                            <!-- KIRI: Judul dan Tanggal -->
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Presensi Hari Ini</h3>
                                <p id="currentDateTime" class="text-base text-gray-500 mt-0.5"></p> 
                            </div>
                            
                            <!-- KANAN: Tombol Riwayat (BARU) -->
                            <button onclick="showKaryawanContent('History')" class="text-gray-500 hover:text-blue-600 transition p-1 -mt-1 -mr-1">
                                <ion-icon name="clipboard-outline" class="text-2xl"></ion-icon>
                                <p class="text-base text-gray-500 mt-0.5">Riwayat Presensi</p>
                            </button>
                        </div>
                        <div id="karyawanAttendanceStatus" class="text-center p-4 rounded-lg bg-gray-100 text-gray-700 font-medium">
                            Memuat status...
                        </div>
                            <p id="karyawanLocationDisplay" class="text-center text-sm text-gray-500 mt-2">
                                Lokasi: Belum diambil
                            </p>
                        <div class="mt-6 grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">Jam Masuk</p>
                                <p id="karyawanClockInTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">Jam Pulang</p>
                                <p id="karyawanClockOutTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================== -->
                    <!-- SECTION 2: PENGAJUAN (REQUESTS) KARYAWAN (BARU) -->
                    <!-- ============================================== -->
                    <div id="karyawanSection_Requests" class="mt-4" style="display: none;">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                                <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Riwayat Pengajuan Koreksi</h2>
                                <!-- Tombol untuk membuka Modal -->
                                <button onclick="openRequestAttendanceModal()" class="w-full sm:w-auto flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                    <ion-icon name="add-outline" class="mr-1"></ion-icon> Ajukan Koreksi Baru
                                </button>
                            </div>
                            
                            <p class="text-sm text-gray-500 mb-4">Daftar ini adalah riwayat pengajuan koreksi absensi Anda (lupa clock-in/out).</p>

                            <!-- Tabel Riwayat Pengajuan Karyawan -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Absensi</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="requestListTableBody">
                                        <!-- Data riwayat pengajuan akan dimuat di sini oleh JS -->
                                        <tr><td colspan="3" class="text-center py-8 text-gray-500">Memuat riwayat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Tombol Kembali (BARU) -->
                            <button onclick="showKaryawanContent('Absensi')" class="mt-6 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                        </div>
                    </div>

            </div>
        </div>

        <!-- =============================================================== -->
        <!-- 3. TAMPILAN ADMIN (STRUKTUR DIPERBAIKI)                     -->
        <!-- =============================================================== -->
        <div id="adminView" class="view flex flex-grow w-full p-0 sm:p-0 lg:p-0">
            <!-- Kontainer Flexbox untuk Sidebar + Konten Utama -->
            <div class="w-full max-w-full mx-auto flex flex-col min-h-screen sm:flex-row">
                
                <!-- SIDEBAR (Menu Samping) -->
                <nav id="adminSidebar" class="bg-gray-800 text-white w-full sm:w-64 flex-shrink-0 p-4 sm:p-6 border-r border-gray-700 transition-all duration-300 ease-in-out">
                    <h2 class="text-xl font-bold mb-6 hidden sm:block">Menu Admin</h2>
                    
                    <ul id="adminSidebarContent" class="space-y-2">
                        <li>
                            <button id="menuSummary" onclick="showAdminSection('summary')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 bg-blue-600 hover:bg-blue-700">
                                <ion-icon name="speedometer-outline" class="text-lg mr-3"></ion-icon> Ringkasan Harian
                            </button>
                        </li>
                        <li>
                            <button id="menuEmployees" onclick="showAdminSection('employees')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="people-outline" class="text-lg mr-3"></ion-icon> Manajemen Karyawan
                            </button>
                        </li>
                        <li id="menuCompaniesContainer" class="hidden"> <!-- Kontainer untuk menu Super Admin -->
                            <button id="menuCompanies" onclick="showAdminSection('companies')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="business-outline" class="text-lg mr-3"></ion-icon> Manajemen Perusahaan
                            </button>
                        </li>
                        <li>
                            <button id="menuRekap" onclick="showAdminSection('rekap')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="calendar-outline" class="text-lg mr-3"></ion-icon> Rekap Kehadiran
                            </button>
                        </li>
                        <!-- Grup Menu PENGAJUAN (ACCORDION BARU) -->
                        <li>
                            <button id="menuRequests" onclick="toggleSubMenu('requestsSubMenu')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="document-text-outline" class="text-lg mr-3"></ion-icon> 
                                <span class="flex-1">Pengajuan (Requests)</span>
                                <ion-icon id="requestsSubMenuIcon" name="chevron-down-outline" class="text-lg transition-transform duration-300"></ion-icon>
                            </button>
                        </li>
                        
                        <!-- Sub Menu Requests (Default Hidden, overflow-hidden untuk transisi) -->
                        <ul id="requestsSubMenu" class="space-y-1 pl-4 h-0 overflow-hidden transition-all duration-300 ease-in-out">
                            <li>
                                <button id="menuReqAttendance" onclick="showAdminSection('reqattendance')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="time-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Koreksi Kehadiran
                                </button>
                            </li>
                            <li>
                                <button id="menuReqTimeoff" onclick="showAdminSection('reqtimeoff')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="calendar-number-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Izin / Cuti
                                </button>
                            </li>
                            <li>
                                <button id="menuReqOvertime" onclick="showAdminSection('reqovertime')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="stopwatch-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Lembur
                                </button>
                            </li>
                        </ul>
                        <!-- Akhir Sub Menu Requests -->
                        <!-- Akhir Grup Menu Pengajuan -->
                        <!-- Tambahkan menu-menu baru di sini di masa depan -->
                    </ul>
                </nav>

                <!-- KONTEN UTAMA (Tempat Header dan Isi Dashboard berada) -->
                <main class="flex-grow p-4 sm:p-6 lg:p-8 bg-gray-50 overflow-y-auto">
                    
                    <!-- Header Admin (Dipindahkan ke dalam <main>) -->
                    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b pb-4">
                        <div class="flex items-center"> <!-- Kolom Kiri Header (DIUBAH) -->
                            <button id="sidebarToggleButton" onclick="toggleAdminSidebar()" class="text-gray-600 hover:text-gray-900 transition mr-4 hidden sm:block">
                                <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
                            </button>
                            <div>
                                <h1 class="text-3xl font-extrabold text-gray-900">Dashboard Admin <span id="adminRoleDisplay" class="text-sm font-medium text-blue-600"></span></h1>
                                <!-- Menampilkan Nama & Email Admin yang Login (BARU) -->
                                <p id="adminInfoDisplay" class="text-gray-900 font-normal mt-1 text-sm">Nama Admin (email@domain.com)</p>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 flex items-center space-x-4"> <!-- Kolom Kanan Header -->
                            <button onclick="changeView('karyawanView')" class="flex items-center text-blue-600 hover:text-blue-800 transition text-sm font-medium">
                                <ion-icon name="person-outline" class="mr-1"></ion-icon> Halaman Karyawan
                            </button>
                            <button onclick="doLogout()" class="flex items-center text-red-500 hover:text-red-700 transition text-sm font-medium">
                                <ion-icon name="log-out-outline" class="mr-1"></ion-icon> Logout
                            </button>
                        </div>
                    </header>

                    <!-- Kontainer Konten Sesuai Sidebar -->
                    <div id="adminContentContainer">
                        <!-- SECTION 1: RINGKASAN HARIAN (ID DIPERBAIKI) -->
                        <div id="sectionSummary" style="display: none;">
                            <!-- Kartu Statistik -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Total Karyawan</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="adminTotalEmployees">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Hadir (Clock In)</p>
                                    <p class="text-3xl font-bold text-green-600 mt-1" id="adminTotalHadir">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Izin / Sakit</p>
                                    <p class="text-3xl font-bold text-yellow-600 mt-1" id="adminTotalIzin">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Alpa</p>
                                    <p class="text-3xl font-bold text-red-600 mt-1" id="adminTotalAlpa">0</p>
                                </div>
                            </div>
                        
                            <!-- Filter dan Tabel -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-3 sm:space-y-0">
                                    <h2 class="text-xl font-semibold text-gray-800">Tabel Kehadiran Harian</h2>
                                    <input type="date" id="adminAttendanceDateFilter" class="border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Tabel Responsif -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="adminAttendanceTableBody">
                                            <!-- Data akan dimasukkan di sini oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <p id="adminNoDataMessage" class="hidden text-center text-gray-500 mt-4">Tidak ada data kehadiran untuk tanggal ini.</p>
                            </div>
                        </div> <!-- End sectionSummary -->

                        <!-- SECTION 2: MANAJEMEN KARYAWAN (ID DIPERBAIKI) -->
                        <div id="sectionEmployees" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Daftar Karyawan</h2>
                                    <button onclick="openEmployeeModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="person-add-outline" class="mr-1"></ion-icon> Tambah Karyawan Baru
                                    </button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Karyawan</th>
                                                <th id="companyColumnHeader" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="employeeListTableBody">
                                            <!-- Data akan dimuat di sini oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionEmployees -->

                        <!-- SECTION 3: MANAJEMEN PERUSAHAAN (BARU) -->
                        <div id="sectionCompanies" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Daftar Perusahaan</h2>
                                    <button onclick="openCompanyModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Perusahaan Baru
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Perusahaan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Dibuat</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="companyListTableBody">
                                            <!-- Data perusahaan akan dimuat oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionCompanies -->

                        <!-- SECTION 4: REKAP KEHADIRAN (BARU) -->
                        <div id="sectionRekap" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Laporan Kehadiran</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="rekapStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="rekapStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="rekapEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="rekapEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="rekapEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="rekapEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                            <!-- Opsi akan diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="rekapStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Kehadiran</label>
                                        <select id="rekapStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Hadir">Hadir</option>
                                            <option value="Terlambat">Terlambat</option>
                                            <option value="Izin">Izin</option>
                                            <option value="Sakit">Sakit</option>
                                            <option value="Alpa">Alpa</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="rekapFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Rekap
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Hasil Rekap</h3>

                                <!-- Tabel Hasil Rekap -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="rekapTableBody">
                                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Rekap'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionRekap -->

                        <!-- SECTION 5: PENGAJUAN KOREKSI KEHADIRAN (BARU) -->
                        <div id="sectionReqattendance" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Koreksi Kehadiran</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqAttStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="reqAttStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqAttEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="reqAttEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="reqAttEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqAttEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                            <!-- Opsi akan diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="reqAttStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqAttStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqAttFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan</h3>

                                <!-- Tabel Hasil Pengajuan -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Kehadiran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi (Alasan)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status Pengajuan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqAttTableBody">
                                            <tr><td colspan="8" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionReqAttendance -->

                        <!-- SECTION 6: PENGAJUAN IZIN / CUTI (BARU) -->
                        <div id="sectionReqtimeoff" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Pengajuan Izin / Cuti</h2>
                                <p class="text-gray-500 mt-2">Daftar permintaan karyawan untuk izin atau cuti (Timeoff). Konten tabel akan diisi di langkah selanjutnya.</p>
                            </div>
                        </div>

                        <!-- SECTION 7: PENGAJUAN LEMBUR (BARU) -->
                        <div id="sectionReqovertime" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Pengajuan Lembur</h2>
                                <p class="text-gray-500 mt-2">Daftar permintaan karyawan untuk kerja lembur (Overtime). Konten tabel akan diisi di langkah selanjutnya.</p>
                            </div>
                        </div>
            
                        <!-- SECTION 8: TIMEOFF (KONTEN BARU) -->
                        <div id="karyawanSection_Timeoff" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Manajemen Cuti & Izin</h2>
                                <p class="text-gray-500 mt-2">Fitur setting cuti akan ditambahkan di sini.</p>
                            </div>
                        </div>

                        <!-- SECTION 9: OVERTIME (KONTEN BARU) -->
                        <div id="karyawanSection_Overtime" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Manajemen Lembur</h2>
                                <p class="text-gray-500 mt-2">Fitur setting lembur akan ditambahkan di sini.</p>
                            </div>
                        </div>

                        <!-- SECTION 10: SALARY (KONTEN BARU) -->
                        <div id="karyawanSection_Salary" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800">Informasi Gaji</h2>
                                <p class="text-gray-500 mt-2">setting gaji dan rincian akan ditampilkan di sini.</p>
                            </div>
                        </div>

                    </div> <!-- End adminContentContainer -->
                </main> <!-- End main -->
            </div> <!-- End flex container -->
        </div> <!-- End adminView -->

            <!-- ============================================== -->
            <!-- FOOTER NAVIGASI KARYAWAN (BARU)              -->
            <!-- ============================================== -->
            <footer id="karyawanFooterNav" class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 shadow-xl hidden">
                <div class="grid grid-cols-5 h-16 max-w-lg mx-auto">
                    
                    <!-- 1. Request Attendance (Koreksi Absensi) -->
                    <button id="tabRequestAttendance" onclick="showKaryawanContent('Requests')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="document-text-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Request</span>
                    </button>

                    <!-- 2. Request Timeoff (Cuti/Izin) -->
                    <button id="tabRequestTimeoff" onclick="showKaryawanContent('Timeoff')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="calendar-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Timeoff</span>
                    </button>

                    <!-- 3. Attendance (HOME) - Default Active -->
                    <button id="tabAttendanceHome" onclick="showKaryawanContent('Absensi')" class="flex flex-col items-center justify-center text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="home-outline" class="text-2xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Home</span>
                    </button>

                    <!-- 4. Overtime (Lembur) -->
                    <button id="tabOvertime" onclick="showKaryawanContent('Overtime')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="stopwatch-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Lembur</span>
                    </button>

                    <!-- 5. Salary (Gaji) -->
                    <button id="tabSalary" onclick="showKaryawanContent('Salary')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="wallet-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Gaji</span>
                    </button>

                </div>
            </footer>

        </div> <!-- End AppContainer -->

            <!-- =============================================================== -->
            <!-- MODALS (DIPINDAHKAN KE LUAR TAMPILAN)                         -->
            <!-- =============================================================== -->

            <!-- Modal Ubah Status Kehadiran -->
            <div id="statusModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Ubah Status Kehadiran
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500 mb-4">Karyawan: <span id="modalEmployeeName" class="font-semibold text-gray-700"></span></p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label for="modalStatus" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="modalStatus" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                            <option value="Hadir">Hadir</option>
                                            <option value="Terlambat">Terlambat</option>
                                            <option value="Izin">Izin</option>
                                            <option value="Sakit">Sakit</option>
                                            <option value="Alpa">Alpa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="modalClockIn" class="block text-sm font-medium text-gray-700">Jam Masuk (Jika Hadir)</label>
                                        <input type="time" id="modalClockIn" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled>
                                    </div>
                                    <div>
                                        <label for="modalClockOut" class="block text-sm font-medium text-gray-700">Jam Pulang (Jika Hadir)</label>
                                        <input type="time" id="modalClockOut" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="modalSaveButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Simpan
                            </button>
                            <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Tambah/Edit Karyawan -->
            <div id="employeeModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeEmployeeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
                        <form id="employeeForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="employeeModalTitle">
                                    Tambah Karyawan Baru
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Input Email & Password -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                            <input type="email" id="employeeEmail" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="employeePassword" class="block text-sm font-medium text-gray-700">Password</label>
                                            <input type="password" id="employeePassword" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>

                                    <!-- Nama & ID Karyawan -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeFullName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                            <input type="text" id="employeeFullName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="employeeIDNumber" class="block text-sm font-medium text-gray-700">ID Karyawan</label>
                                            <input type="text" id="employeeIDNumber" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>
                                    
                                    <!-- Pilih Perusahaan (Hanya untuk Super Admin) -->
                                    <div id="companySelectContainer" class="hidden">
                                        <label for="employeeCompany" class="block text-sm font-medium text-gray-700">Perusahaan</label>
                                        <select id="employeeCompany" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <!-- Opsi perusahaan akan dimuat oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Role & Status -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeRole" class="block text-sm font-medium text-gray-700">Peran (Role)</label>
                                            <select id="employeeRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="karyawan">Karyawan</option>
                                                <option value="company_admin">Company Admin</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="employeeStatus" class="block text-sm font-medium text-gray-700">Status</label>
                                            <select id="employeeStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="Percobaan">Percobaan</option>
                                                <option value="Kontrak">Kontrak</option>
                                                <option value="Tetap">Tetap</option>
                                                <option value="Freelance">Freelance</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Note: Kolom Workhour ID (workhour_id) perlu diisi, nanti bisa ditambahkan dropdown setelah Anda membuat data workhours di Supabase. Untuk sementara, kita biarkan kosong. -->
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveEmployeeButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan & Daftarkan
                                </button>
                                <button type="button" onclick="closeEmployeeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>    

            <!-- Modal Tambah/Edit Perusahaan -->
            <div id="companyModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeCompanyModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="companyForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="companyModalTitle">
                                    Tambah Perusahaan Baru
                                </h3>
                                <div class="mt-4">
                                    <div>
                                        <label for="companyName" class="block text-sm font-medium text-gray-700">Nama Perusahaan</label>
                                        <input type="text" id="companyName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveCompanyButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan
                                </button>
                                <button type="button" onclick="closeCompanyModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Ajukan Koreksi Kehadiran (BARU) -->
            <div id="requestAttendanceModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <!-- Latar belakang overlay -->
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeRequestAttendanceModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <!-- Konten Modal -->
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="requestAttendanceForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="requestModalTitle">
                                    Ajukan Koreksi Kehadiran
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Tanggal Absensi -->
                                    <div>
                                        <label for="reqAttDate" class="block text-sm font-medium text-gray-700">Tanggal Absensi yang Dikoreksi</label>
                                        <input type="date" id="reqAttDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    
                                    <!-- Jam Masuk & Pulang -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="reqAttClockIn" class="block text-sm font-medium text-gray-700">Jam Masuk (Seharusnya)</label>
                                            <input type="time" id="reqAttClockIn" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="reqAttClockOut" class="block text-sm font-medium text-gray-700">Jam Pulang (Seharusnya)</label>
                                            <input type="time" id="reqAttClockOut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>

                                    <!-- Alasan -->
                                    <div>
                                        <label for="reqAttDescription" class="block text-sm font-medium text-gray-700">Alasan Koreksi</label>
                                        <textarea id="reqAttDescription" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Lupa absen pulang karena meeting mendadak di luar kantor."></textarea>
                                    </div>
                                    
                                    <p class="text-xs text-gray-500">Penting: Anda harus mengisi setidaknya salah satu Jam Masuk atau Jam Pulang.</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveRequestButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Kirim Pengajuan
                                </button>
                                <button type="button" onclick="closeRequestAttendanceModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Kotak Pesan Global -->
            <div id="messageBox" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

    <script>
        // ===============================================================
        // KONFIGURASI SUPABASE
        // ===============================================================
        const SUPABASE_URL = 'https://fmknmegucccckdivoslm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZta25tZWd1Y2NjY2tkaXZvc2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzAyMTUsImV4cCI6MjA3ODQ0NjIxNX0.usJdg1Pcl_UezylR09srX_-Z0W9Vo4Xxn1XAWWhCOhI';
        // ===============================================================

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // GLOBAL STATE
        let globalProfile = null; // Menyimpan data profil pengguna yang sedang login
        let currentAttendanceId = null; // ID absensi hari ini yang sedang aktif (untuk Karyawan)
        let modalAttendanceData = {}; // Data absensi yang sedang diedit di modal Admin
        let allEmployees = []; // Digunakan untuk mengisi dropdown filter
        
        // DOM ELEMENTS
        const loadingView = document.getElementById('loadingView');
        const loginView = document.getElementById('loginView');
        const karyawanView = document.getElementById('karyawanView');
        const adminView = document.getElementById('adminView');
        const messageBox = document.getElementById('messageBox');
        
        // --- KARYAWAN ELEMENTS ---
        const karyawanUserName = document.getElementById('karyawanUserName');
        const karyawanAttendanceStatus = document.getElementById('karyawanAttendanceStatus');
        const karyawanClockInTime = document.getElementById('karyawanClockInTime');
        const karyawanClockOutTime = document.getElementById('karyawanClockOutTime');
        const karyawanClockInButton = document.getElementById('karyawanClockInButton');
        const karyawanClockOutButton = document.getElementById('karyawanClockOutButton');
        const karyawanAdminLink = document.getElementById('karyawanAdminLink');
        
        // --- ADMIN ELEMENTS ---
        const adminRoleDisplay = document.getElementById('adminRoleDisplay');
        const adminAttendanceTableBody = document.getElementById('adminAttendanceTableBody');
        const adminAttendanceDateFilter = document.getElementById('adminAttendanceDateFilter');
        const employeeListTableBody = document.getElementById('employeeListTableBody');

        // --- MODAL ELEMENTS ---
        const statusModal = document.getElementById('statusModal');
        const modalEmployeeName = document.getElementById('modalEmployeeName');
        const modalStatus = document.getElementById('modalStatus');
        const modalClockIn = document.getElementById('modalClockIn');
        const modalClockOut = document.getElementById('modalClockOut');
        const modalSaveButton = document.getElementById('modalSaveButton');
        
        // ===============================================================
        // HELPER FUNCTIONS (UTILITY)
        // ===============================================================

        // --- FUNGSI BARU: MEMUAT NAMA PERUSAHAAN ---
        async function loadCompanyDetails() {
            if (!globalProfile || !globalProfile.company_id) {
                document.getElementById('companyText').textContent = 'Tidak Terikat Perusahaan';
                return;
            }

            const { data, error } = await _supabase
                .from('companies')
                .select('name')
                .eq('id', globalProfile.company_id)
                .single();

            if (error || !data) {
                console.error("Gagal memuat nama perusahaan:", error?.message || 'Data tidak ditemukan');
                document.getElementById('companyText').textContent = 'Perusahaan Tidak Ditemukan';
                return;
            }

            // SET NAMA PERUSAHAAN DI HEADER KARYAWAN
            document.getElementById('companyText').textContent = data.name;
        }
        
        // FUNGSI NAVIGASI SIDEBAR ADMIN (DIPERBAIKI UNTUK ACCORDION)
        function showAdminSection(sectionName) {
            // Daftar semua section 
            const sections = ['summary', 'employees', 'companies', 'rekap', 'reqattendance', 'reqtimeoff', 'reqovertime'];
            
            // Daftar semua tombol menu (termasuk sub-menu)
            const menus = ['menuSummary', 'menuEmployees', 'menuCompanies', 'menuRekap', 'menuReqAttendance', 'menuReqTimeoff', 'menuReqOvertime', 'menuRequests'];
            
            // Elemen Accordion
            const requestsMenu = document.getElementById('menuRequests');
            const requestsSubMenu = document.getElementById('requestsSubMenu');
            const requestsSubMenuIcon = document.getElementById('requestsSubMenuIcon');

            // 1. Reset semua section dan menu
            sections.forEach(name => {
                const sectionId = 'section' + name.charAt(0).toUpperCase() + name.slice(1);
                const sectionElement = document.getElementById(sectionId);
                if (sectionElement) sectionElement.style.display = 'none';
            });

            menus.forEach(menuId => {
                const menuElement = document.getElementById(menuId);
                if (menuElement) {
                    menuElement.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'bg-gray-700');
                    menuElement.classList.add('text-white', 'hover:bg-gray-700'); // Atur ulang warna default sidebar
                }
            });

            // 2. Tampilkan section yang dipilih
            const selectedSectionId = 'section' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            const selectedMenuId = 'menu' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            
            const selectedSection = document.getElementById(selectedSectionId);
            const selectedMenu = document.getElementById(selectedMenuId);

            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            if (selectedMenu) {
                selectedMenu.classList.remove('hover:bg-gray-700');
                selectedMenu.classList.add('bg-blue-600', 'hover:bg-blue-700'); // Tandai menu aktif
            }
            
            // 3. LOGIKA ACCORDION: Atur status menu Pengajuan jika sub-menu dipilih
            if (sectionName.startsWith('req')) {
                // Jika sub-menu dipilih, pastikan menu Requests (parent) terlihat aktif dan terbuka
                if(requestsMenu) {
                    requestsMenu.classList.remove('hover:bg-gray-700');
                    requestsMenu.classList.add('bg-gray-700'); // Beri warna aktif ke parent
                }
                if(requestsSubMenu && !requestsSubMenu.classList.contains('active')) {
                    // Buka Accordion jika belum terbuka
                    requestsSubMenu.style.height = requestsSubMenu.scrollHeight + 'px';
                    requestsSubMenu.classList.add('active');
                    requestsSubMenuIcon.classList.add('rotate-180');
                }
            } else {
                // Jika menu non-Request yang dipilih, pastikan sub-menu Requests tertutup
                if(requestsSubMenu && requestsSubMenu.classList.contains('active')) {
                    requestsSubMenu.style.height = '0';
                    requestsSubMenu.classList.remove('active');
                    requestsSubMenuIcon.classList.remove('rotate-180');
                }
                if(requestsMenu) {
                    requestsMenu.classList.remove('bg-gray-700');
                    requestsMenu.classList.add('hover:bg-gray-700');
                }
            }

            // 4. Panggil fungsi pemuatan data
            if (sectionName === 'summary') {
                loadAdminAttendanceData(adminAttendanceDateFilter.value);
            } else if (sectionName === 'employees') {
                loadEmployeeList(); 
            } else if (sectionName === 'companies') { 
                loadCompanyList();
            } else if (sectionName === 'rekap') { 
                initializeRekapFilters();
                document.getElementById('rekapTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Silakan atur filter dan klik "Tampilkan Rekap".</td></tr>';
            } else if (sectionName === 'reqattendance') { 
                initializeReqAttFilters(); 
            } else if (sectionName === 'reqtimeoff') { 
                // loadRequestTimeoffData(); 
            } else if (sectionName === 'reqovertime') { 
                // loadRequestOvertimeData(); 
            }
        }

        // --- FUNGSI TOGGLE SUB-MENU (ACCORDION) (BARU) ---
        function toggleSubMenu(subMenuId) {
            const subMenu = document.getElementById(subMenuId);
            const icon = document.getElementById(subMenuId + 'Icon');
            
            if (subMenu.classList.contains('active')) {
                // Tutup Sub-Menu
                subMenu.style.height = '0';
                subMenu.classList.remove('active');
                icon.classList.remove('rotate-180');
            } else {
                // Buka Sub-Menu
                // Set height ke nilai scrollHeight untuk transisi yang dinamis
                subMenu.style.height = subMenu.scrollHeight + 'px';
                subMenu.classList.add('active');
                icon.classList.add('rotate-180');
            }
        }

        // --- FUNGSI TOGGLE SIDEBAR ADMIN (BARU) ---
        function toggleAdminSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const content = document.getElementById('adminSidebarContent');
            
            isSidebarOpen = !isSidebarOpen;

            if (isSidebarOpen) {
                // STATE TERTUTUP -> TERBUKA
                sidebar.classList.remove('sm:w-0', 'p-0', 'overflow-hidden');
                sidebar.classList.add('sm:w-64', 'p-4', 'sm:p-6');
                content.classList.remove('hidden');
            } else {
                // STATE TERBUKA -> TERTUTUP
                sidebar.classList.remove('sm:w-64', 'p-4', 'sm:p-6');
                sidebar.classList.add('sm:w-0', 'p-0', 'overflow-hidden'); 
                // Tunda penyembunyian konten agar transisi lebar terlihat
                setTimeout(() => {
                    content.classList.add('hidden');
                }, 300); // Sesuai dengan durasi transisi Tailwind (duration-300)
            }
        }

        const employeeModal = document.getElementById('employeeModal');
        const employeeForm = document.getElementById('employeeForm');

        async function openEmployeeModal() {
            employeeModal.classList.remove('hidden');
            document.getElementById('employeeModalTitle').textContent = 'Tambah Karyawan Baru';
            employeeForm.reset(); // Kosongkan form
            delete employeeForm.dataset.editingId; // Hapus mode edit
            
            document.getElementById('employeeEmail').disabled = false;
            document.getElementById('employeePassword').required = true;
            document.getElementById('employeePassword').previousElementSibling.textContent = "Password";
            document.getElementById('saveEmployeeButton').textContent = "Simpan & Daftarkan";

            // Logika untuk Dropdown Perusahaan
            const companySelectContainer = document.getElementById('companySelectContainer');
            const companySelect = document.getElementById('employeeCompany');
            
            if (globalProfile.role === 'super_admin') {
                // Super Admin: Tampilkan dropdown dan isi dengan perusahaan
                companySelectContainer.classList.remove('hidden');
                companySelect.required = true;
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                
                const { data, error } = await _supabase
                    .from('companies')
                    .select('id, name')
                    .order('name', { ascending: true });
                    
                if (data) {
                    companySelect.innerHTML = '<option value="">-- Pilih Perusahaan --</option>' + 
                                            data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } else {
                // Company Admin: Sembunyikan dropdown
                companySelectContainer.classList.add('hidden');
                companySelect.required = false;
            }
        }

        function closeEmployeeModal() {
            employeeModal.classList.add('hidden');
        }

        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Logika untuk 'Edit' vs 'Tambah Baru'
            const currentEditId = employeeForm.dataset.editingId;

            if (currentEditId) {
                await handleEditEmployee(currentEditId);
            } else {
                await handleAddNewEmployee();
            }
        });
        
        function openRequestAttendanceModal() {
            requestAttendanceForm.reset(); // Kosongkan form
            document.getElementById('saveRequestButton').disabled = false;
            // Set tanggal default ke hari ini
            document.getElementById('reqAttDate').value = getTodayDateString(); 
            requestAttendanceModal.classList.remove('hidden');
        }

        function closeRequestAttendanceModal() {
            requestAttendanceModal.classList.add('hidden');
        }

        async function handleAddNewEmployee() {
            const email = document.getElementById('employeeEmail').value;
            const password = document.getElementById('employeePassword').value;
            const fullName = document.getElementById('employeeFullName').value;
            const idNumber = document.getElementById('employeeIDNumber').value;
            const role = document.getElementById('employeeRole').value;
            const status = document.getElementById('employeeStatus').value;

            document.getElementById('saveEmployeeButton').disabled = true;
            showMessage("Mendaftarkan pengguna baru...", 'info');
            
            // 1. BUAT AKUN DI AUTH.USERS (Supabase Auth)
            const { data: authData, error: authError } = await _supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { 
                        full_name: fullName // Simpan nama di metadata Auth
                    }
                }
            });

            if (authError) {
                showMessage(`Gagal membuat akun: ${authError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }
            
            const newUser = authData.user;
            
            // 2. BUAT PROFIL DI TABEL 'profiles'
            // Tentukan company_id:
            // Jika Super Admin, ambil dari dropdown. Jika Company Admin, ambil dari profilnya.
            let selectedCompanyId = (globalProfile.role === 'super_admin')
                ? document.getElementById('employeeCompany').value
                : globalProfile.company_id;

            if (!selectedCompanyId) {
                 showMessage('Gagal: Super Admin harus memilih perusahaan.', 'error');
                 document.getElementById('saveEmployeeButton').disabled = false;
                 return;
            }

            const newProfile = {
                id: newUser.id,
                company_id: selectedCompanyId, // Wajib diisi dari Admin yang login
                full_name: fullName,
                email: email,
                user_id_number: idNumber,
                role: role,
                user_status: status,
                workhour_id: null, // Sementara NULL, karena belum ada data workhour
            };
            
            const { error: profileError } = await _supabase
                .from('profiles')
                .insert([newProfile]);
            
            if (profileError) {
                console.error("Gagal membuat profil, namun akun Auth sudah terbuat:", profileError.message);
                showMessage(`Peringatan: Akun dibuat tapi gagal menyimpan detail profil: ${profileError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }
            
            // 3. SELESAI
            showMessage(`Karyawan ${fullName} berhasil didaftarkan.`, 'success');
            closeEmployeeModal();
            loadEmployeeList(); // Muat ulang daftar karyawan
            document.getElementById('saveEmployeeButton').disabled = false;
        }
        // (Fungsi handleEditEmployee akan ditambahkan di langkah selanjutnya)
        async function handleEditEmployee(profileId) {
            const fullName = document.getElementById('employeeFullName').value;
            const idNumber = document.getElementById('employeeIDNumber').value;
            const role = document.getElementById('employeeRole').value;
            const status = document.getElementById('employeeStatus').value;
            
            // Tentukan company_id: Ambil dari dropdown jika Super Admin, dari globalProfile jika Company Admin
            const companyId = (globalProfile.role === 'super_admin')
                ? document.getElementById('employeeCompany').value // Nilai dari dropdown
                : globalProfile.company_id; // Nilai dari profil Admin yang login

            document.getElementById('saveEmployeeButton').disabled = true;
            showMessage("Menyimpan perubahan...", 'info');

            const profilePayload = {
                full_name: fullName,
                user_id_number: idNumber,
                role: role,
                user_status: status,
                company_id: companyId,
                // workhour_id akan ditambahkan di sini nanti
            };

            // 1. Update data di tabel 'profiles'
            const { error: profileError } = await _supabase
                .from('profiles')
                .update(profilePayload)
                .eq('id', profileId);

            if (profileError) {
                showMessage(`Gagal menyimpan profil: ${profileError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }

            // 2. Update password (Tidak didukung di sini; harus menggunakan Supabase Admin SDK)
            const password = document.getElementById('employeePassword').value;
            if (password) {
                showMessage(`Peringatan: Perubahan password harus dilakukan menggunakan Supabase Admin API.`, 'error');
            }

            showMessage('Perubahan berhasil disimpan.', 'success');
            closeEmployeeModal();
            loadEmployeeList(); // Muat ulang daftar karyawan
            document.getElementById('saveEmployeeButton').disabled = false;
        }

        const companyModal = document.getElementById('companyModal');
        const companyForm = document.getElementById('companyForm');
        let currentCompanyId = null; // Untuk edit nanti
        let isSidebarOpen = true;

        function openCompanyModal() {
            companyModal.classList.remove('hidden');
            companyForm.reset();
            document.getElementById('companyModalTitle').textContent = 'Tambah Perusahaan Baru';
            currentCompanyId = null; // Mode 'Tambah Baru'
        }

        function closeCompanyModal() {
            companyModal.classList.add('hidden');
        }

        async function loadCompanyList() {
            const tableBody = document.getElementById('companyListTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat daftar perusahaan...</td></tr>';
            
            // RLS sudah diatur agar hanya Super Admin yang bisa memanggil ini
            const { data, error } = await _supabase
                .from('companies')
                .select('id, name, created_at')
                .order('name', { ascending: true });

            if (error) {
                console.error("Gagal memuat perusahaan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada perusahaan terdaftar.</td></tr>';
                return;
            }

            let html = data.map(company => {
                const createdDate = new Date(company.created_at).toLocaleDateString('id-ID');
                return `
                    <tr data-id="${company.id}">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${company.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${createdDate}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="editCompany('${company.id}', '${company.name}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        companyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyName = document.getElementById('companyName').value;
            
            document.getElementById('saveCompanyButton').disabled = true;
            showMessage("Menyimpan perusahaan...", 'info');

            let query;
            if (currentCompanyId) {
                // Mode EDIT
                query = _supabase.from('companies').update({ name: companyName }).eq('id', currentCompanyId);
            } else {
                // Mode TAMBAH BARU (RLS memastikan hanya Super Admin)
                query = _supabase.from('companies').insert([{ name: companyName }]);
            }

            const { error } = await query;

            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                document.getElementById('saveCompanyButton').disabled = false;
                return;
            }

            showMessage('Data perusahaan berhasil disimpan.', 'success');
            closeCompanyModal();
            loadCompanyList(); // Muat ulang daftar
            document.getElementById('saveCompanyButton').disabled = false;
        });

        function editCompany(id, name) {
            // Membuka modal dalam mode Edit
            currentCompanyId = id;
            document.getElementById('companyModalTitle').textContent = 'Edit Nama Perusahaan';
            document.getElementById('companyName').value = name;
            companyModal.classList.remove('hidden');
        }

        function showMessage(message, type = 'success') {
            const box = document.createElement('div');
            box.className = `p-4 mb-2 rounded-lg shadow-md transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
                type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
                'bg-blue-100 border border-blue-400 text-blue-700'
            }`;
            box.innerHTML = `<p class="font-medium">${message}</p>`;
            messageBox.appendChild(box);

            setTimeout(() => {
                box.style.opacity = '0';
                box.addEventListener('transitionend', () => box.remove());
            }, 5000);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            // Ubah timestampz (UTC) ke waktu lokal (tanpa detik)
            const date = new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        function formatTimeForInput(timestamp) {
             if (!timestamp) return '';
             const date = new Date(timestamp);
             const hours = String(date.getHours()).padStart(2, '0');
             const minutes = String(date.getMinutes()).padStart(2, '0');
             return `${hours}:${minutes}`;
        }

        function getTodayDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

       function changeView(viewId) {
            const footer = document.getElementById('karyawanFooterNav');
            
            // Sembunyikan semua tampilan
            [loginView, karyawanView, adminView].forEach(v => v.style.display = 'none');
            
            // Tampilkan tampilan yang diminta
            document.getElementById(viewId).style.display = 'flex';

            // Logika baru: Tampilkan footer HANYA di tampilan Karyawan
            if (viewId === 'karyawanView') {
                footer.classList.remove('hidden');
            } else {
                // Sembunyikan footer di tampilan Admin dan Login
                footer.classList.add('hidden');
            }
        }
        
        function initializeClock(timeElement, dateElement) {
            function updateTime() {
                const now = new Date();
                
                // Format Waktu
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                timeElement.textContent = now.toLocaleTimeString('id-ID', timeOptions);

                // Format Tanggal
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('id-ID', dateOptions);
            }

            updateTime();
            setInterval(updateTime, 1000);
        }

        // ===============================================================
        // 1. LOGIKA LOGIN (loginView)
        // ===============================================================
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            setLoginLoading(true);
            
            const { error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showMessage(`Gagal masuk: ${error.message}`, 'error');
                setLoginLoading(false);
                return;
            }

            // Jika berhasil, panggil checkAuthAndRole untuk memuat profil dan mengarahkan
            await checkAuthAndRole();
            setLoginLoading(false);
        });

        function setLoginLoading(isLoading) {
            document.getElementById('loginButton').disabled = isLoading;
            document.getElementById('loginButtonText').textContent = isLoading ? 'Memproses...' : 'Masuk';
            document.getElementById('loginSpinner').classList.toggle('hidden', !isLoading);
        }


        // ===============================================================
        // 2. LOGIKA KARYAWAN (karyawanView)
        // ===============================================================
        
        // --- FUNGSI HELPER LOKASI (BARU) ---
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                // Periksa apakah browser mendukung Geolocation
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation tidak didukung oleh browser ini."));
                    return;
                }

                // Opsi untuk akurasi dan timeout
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 detik
                    maximumAge: 0 // Tidak menggunakan cache
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        resolve({ latitude, longitude });
                    },
                    (error) => {
                        // Tangani error izin (Permission Denied) atau timeout
                        let errorMessage = "Gagal mengambil lokasi.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Izin lokasi ditolak. Harap izinkan GPS untuk absen.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Timeout: Gagal mendapatkan lokasi akurat.";
                        }
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        }

        // --- FUNGSI KARYAWAN (ABSENSI) ---
        async function loadKaryawanAttendanceStatus() {
            const todayDate = getTodayDateString();
            const startOfDay = new Date(todayDate).toISOString();
            const endOfDay = new Date(new Date(todayDate).getTime() + 24 * 60 * 60 * 1000).toISOString();
            
            karyawanAttendanceStatus.textContent = 'Memuat status...';

            const { data, error } = await _supabase
                .from('attendance')
                .select('*')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startOfDay)
                .lt('created_at', endOfDay)
                .limit(1);

            if (error) {
                console.error("Gagal memuat status absensi:", error.message);
                karyawanAttendanceStatus.textContent = 'Gagal memuat status.';
                return;
            }

            if (data && data.length > 0) {
                const attendance = data[0];
                currentAttendanceId = attendance.id; 

                karyawanClockInTime.textContent = formatTime(attendance.clock_in);
                karyawanClockOutTime.textContent = formatTime(attendance.clock_out);
                
                let statusText = attendance.attendance_status;
                let statusClass = 'bg-green-100 text-green-700';
                
                if (statusText === 'Alpa' || statusText === 'Terlambat') {
                    statusClass = 'bg-red-100 text-red-700';
                } else if (statusText === 'Izin' || statusText === 'Sakit') {
                    statusClass = 'bg-yellow-100 text-yellow-700';
                }

                karyawanAttendanceStatus.textContent = `Status hari ini: ${statusText}.`;
                karyawanAttendanceStatus.className = `text-center p-4 rounded-lg ${statusClass} font-medium`;

                // Atur status tombol
                karyawanClockInButton.disabled = true;
                if (!attendance.clock_out && (statusText === 'Hadir' || statusText === 'Terlambat')) {
                    karyawanClockOutButton.disabled = false;
                } else {
                    karyawanClockOutButton.disabled = true;
                }
            } else {
                // Belum ada absensi hari ini
                karyawanAttendanceStatus.textContent = 'Anda belum melakukan Clock-in hari ini.';
                karyawanAttendanceStatus.className = 'text-center p-4 rounded-lg bg-yellow-50 text-yellow-700 font-medium';
                karyawanClockInTime.textContent = '-';
                karyawanClockOutTime.textContent = '-';
                karyawanClockInButton.disabled = false;
                karyawanClockOutButton.disabled = true;
                currentAttendanceId = null;
            }
        }

        // FUNGSI NAVIGASI KARYAWAN BARU (menggantikan showKaryawanSection)
        function showKaryawanContent(sectionName) {
            const sections = {
                'Absensi': document.getElementById('karyawanSection_Absensi'),
                'Requests': document.getElementById('karyawanSection_Requests'),
                'History': document.getElementById('karyawanSection_History'),
                'Timeoff': document.getElementById('karyawanSection_Timeoff'),
                'Overtime': document.getElementById('karyawanSection_Overtime'),
                'Salary': document.getElementById('karyawanSection_Salary')
            };
            const karyawanViewWrapper = document.querySelector('#karyawanView > div');
            
            // 1. Sembunyikan semua section dan atur lebar default
            Object.values(sections).forEach(sec => {
                if(sec) sec.style.display = 'none';
            });
            karyawanViewWrapper.classList.add('max-w-lg'); 
            karyawanViewWrapper.classList.remove('max-w-full');

            // 2. Tampilkan section yang dipilih
            if (sections[sectionName]) {
                sections[sectionName].style.display = 'block';

                // Jika tabel (Requests) yang dibuka, buat lebar penuh
                if (sectionName === 'Requests') {
                    karyawanViewWrapper.classList.remove('max-w-lg');
                    karyawanViewWrapper.classList.add('max-w-full'); 
                    loadAttendanceRequests(); // Muat data
                } else if (sectionName === 'History') { 
                    karyawanViewWrapper.classList.remove('max-w-lg');
                    karyawanViewWrapper.classList.add('max-w-full'); 
                    loadKaryawanHistory(); // <-- FUNGSI BARU
                } else if (sectionName === 'Timeoff' || sectionName === 'Overtime' || sectionName === 'Salary') {
                    // Muat data spesifik di sini nanti
                    // loadTimeoffData();
                }
            }
            
            // 3. Atur tombol footer yang aktif
            // Catatan: Karena History bukan di footer, ia akan mengatur Absensi jika kembali, atau tidak mengubah state footer
            if (sectionName !== 'History') {
               setActiveFooterTab(sectionName);
            }
        }

        // FUNGSI UNTUK MENGATUR TOMBOL FOOTER AKTIF
        function setActiveFooterTab(activeSection) {
            const tabIds = ['tabRequestAttendance', 'tabRequestTimeoff', 'tabAttendanceHome', 'tabOvertime', 'tabSalary'];
            let activeId;

            // Tentukan ID tombol yang harus aktif berdasarkan nama section
            if (activeSection === 'Absensi') activeId = 'tabAttendanceHome';
            else if (activeSection === 'Requests') activeId = 'tabRequestAttendance';
            else if (activeSection === 'Timeoff') activeId = 'tabRequestTimeoff';
            else if (activeSection === 'Overtime') activeId = 'tabOvertime';
            else if (activeSection === 'Salary') activeId = 'tabSalary';

            tabIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    const isActive = id === activeId;
                    // Hapus kelas aktif dari semua
                    button.classList.remove('text-blue-600');
                    button.classList.add('text-gray-500');
                    // Tambahkan kelas aktif pada yang dipilih
                    if (isActive) {
                        button.classList.remove('text-gray-500');
                        button.classList.add('text-blue-600');
                    }
                }
            });
        }

        // --- FUNGSI KARYAWAN (RIWAYAT KEHADIRAN) ---
        async function loadKaryawanHistory() {
            const historyBody = document.getElementById('historyListTableBody');
            historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat riwayat kehadiran...</td></tr>';
            
            // Tentukan rentang waktu (misal, 60 hari ke belakang)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 60);

            const startISO = startDate.toISOString();
            const endISO = endDate.toISOString();

            const { data, error } = await _supabase
                .from('attendance')
                .select('*')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startISO)
                .lt('created_at', endISO)
                .order('created_at', { ascending: false }); // Terbaru di atas

            if (error) {
                console.error("Gagal memuat riwayat:", error.message);
                historyBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat riwayat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Tidak ada riwayat kehadiran dalam 60 hari terakhir.</td></tr>';
                return;
            }

            let html = data.map(att => {
                const dateDisplay = new Date(att.created_at).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                const statusClass = getStatusClass(att.attendance_status); // Menggunakan helper Admin yang sudah ada

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${dateDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatTime(att.clock_in)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatTime(att.clock_out)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${att.attendance_status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            historyBody.innerHTML = html;
        }

        // --- 3. FUNGSI BARU: MEMUAT DAFTAR REQUEST KARYAWAN ---
        async function loadAttendanceRequests() {
            // Fungsi ini dipanggil oleh showKaryawanContent('Requests')
            const tableBody = document.getElementById('requestListTableBody');
            if (!tableBody) {
                console.error("Elemen requestListTableBody tidak ditemukan!");
                return; 
            }
            
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat riwayat pengajuan...</td></tr>';
            
            // Ambil data HANYA untuk karyawan yang login
            const { data, error } = await _supabase
                .from('attendance_requests')
                .select('created_at, attendance_date, requests_status')
                .eq('user_id', globalProfile.id)
                .order('created_at', { ascending: false }); // Terbaru di atas

            if (error) {
                console.error("Gagal memuat riwayat pengajuan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Anda belum memiliki riwayat pengajuan.</td></tr>';
                return;
            }

            let html = data.map(req => {
                // Tgl Diajukan (Kapan request dibuat)
                const submittedDate = new Date(req.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                // Tgl Absensi (Tanggal yang dikoreksi)
                const attendanceDate = new Date(req.attendance_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                const status = req.requests_status;
                
                let statusClass;
                if (status === 'Diajukan') statusClass = 'bg-yellow-100 text-yellow-800';
                else if (status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                else statusClass = 'bg-red-100 text-red-800'; // Ditolak

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${submittedDate}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${attendanceDate}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        async function doClockIn() {
            karyawanClockInButton.disabled = true;
            showMessage("Meminta izin lokasi dan memproses Absen Masuk...", 'info');

            let locationString = 'Lokasi gagal didapatkan';
            let locationCoords = null;
            const locationDisplayElement = document.getElementById('karyawanLocationDisplay');
            
            try {
                // Panggil fungsi pengambilan lokasi (akan memicu permintaan izin)
                locationCoords = await getCurrentLocation();
                locationString = `${locationCoords.latitude}, ${locationCoords.longitude}`;
                locationDisplayElement.textContent = `Lokasi: ${locationString}`;
                showMessage("Lokasi berhasil didapatkan. Melanjutkan presensi.", 'info');

            } catch (e) {
                // Jika pengambilan lokasi gagal (izin ditolak/timeout)
                showMessage(`Gagal Absen: ${e.message}`, 'error');
                karyawanClockInButton.disabled = false;
                locationDisplayElement.textContent = `Lokasi: ${e.message.split('.')[0]}`; // Tampilkan pesan error
                return;
            }

            const now = new Date();
            const newAttendance = {
                user_id: globalProfile.id,
                company_id: globalProfile.company_id,
                attendance_status: 'Hadir', 
                clock_in: now.toISOString(),
                location: locationString, // <-- Menggunakan koordinat yang diambil
            };
            
            const { error } = await _supabase
                .from('attendance')
                .insert([newAttendance]);

            if (error) {
                console.error('Gagal Absen Masuk:', error.message);
                showMessage(`Gagal Absen Masuk: ${error.message}.`, 'error');
                karyawanClockInButton.disabled = false;
                return;
            }
            
            showMessage('Absen Masuk Berhasil! Selamat bekerja.', 'success');
            loadKaryawanAttendanceStatus(); 
            // Pastikan lokasi tetap terlihat setelah absen berhasil
            locationDisplayElement.textContent = `Lokasi: ${locationString}`;
        }

        async function doClockOut() {
            if (!currentAttendanceId) {
                showMessage("Gagal Absen Pulang: Data Absen Masuk tidak ditemukan.", 'error');
                return;
            }
            
            karyawanClockOutButton.disabled = true;
            showMessage("Memproses Absen Pulang...", 'info');
            
            const now = new Date().toISOString();

            const { error } = await _supabase
                .from('attendance')
                .update({ clock_out: now })
                .eq('id', currentAttendanceId);

            if (error) {
                console.error('Gagal Absen Pulang:', error.message);
                showMessage(`Gagal Absen Pulang: ${error.message}.`, 'error');
                karyawanClockOutButton.disabled = false;
                return;
            }

            showMessage('Absen Pulang Berhasil! Terima kasih.', 'success');
            loadKaryawanAttendanceStatus();
        }

        karyawanClockInButton.addEventListener('click', doClockIn);
        karyawanClockOutButton.addEventListener('click', doClockOut);

        // ===============================================================
        // 3. LOGIKA ADMIN (adminView)
        // ===============================================================
        
        function getStatusClass(status) {
            if (status === 'Hadir' || status === 'Terlambat') return 'bg-green-100 text-green-800';
            if (status === 'Izin' || status === 'Sakit') return 'bg-yellow-100 text-yellow-800';
            if (status === 'Alpa' || !status) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        async function loadAdminAttendanceData(dateString) {
            adminAttendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
            
            const startOfDay = new Date(dateString).toISOString();
            const endOfDay = new Date(new Date(dateString).getTime() + 24 * 60 * 60 * 1000).toISOString();
            
            // 1. Ambil semua karyawan di perusahaan admin
            let profilesQuery = _supabase
                .from('profiles')
                .select('id, full_name');
            
            // Tambahkan filter HANYA jika yang login BUKAN Super Admin
            if (globalProfile.role !== 'super_admin') {
                profilesQuery = profilesQuery.eq('company_id', globalProfile.company_id);
            }
            
            // Jalankan query yang sudah dimodifikasi
            const { data: profiles, error: profilesError } = await profilesQuery;

            if (profilesError) {
                console.error("Gagal memuat daftar karyawan:", profilesError.message);
                return;
            }

            const employeeIds = profiles.map(p => p.id);
            if (employeeIds.length === 0) {
                 adminAttendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada karyawan di perusahaan ini.</td></tr>';
                 document.getElementById('adminNoDataMessage').classList.add('hidden');
                 return;
            }

            // 2. Ambil data absensi untuk tanggal dan user ID yang sesuai
            const { data: attendanceData, error: attendanceError } = await _supabase
                .from('attendance')
                .select('*')
                .in('user_id', employeeIds)
                .gte('created_at', startOfDay)
                .lt('created_at', endOfDay);
            
            if (attendanceError) {
                console.error("Gagal memuat data absensi:", attendanceError.message);
                return;
            }
            
            const attendanceMap = attendanceData.reduce((map, att) => {
                map[att.user_id] = att;
                return map;
            }, {});

            // 3. Gabungkan dan Render Data
            adminAttendanceTableBody.innerHTML = ''; // Kosongkan tabel
            
            let html = '';
            let totalHadir = 0, totalIzin = 0, totalAlpa = 0;

            profiles.forEach(profile => {
                const att = attendanceMap[profile.id];
                let status = att ? att.attendance_status : 'Alpa';
                
                // Hitung statistik
                if (status === 'Hadir' || status === 'Terlambat') totalHadir++;
                else if (status === 'Izin' || status === 'Sakit') totalIzin++;
                else if (status === 'Alpa') totalAlpa++;

                html += `
                    <tr data-id="${att ? att.id : 'new'}" data-user-id="${profile.id}">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${profile.full_name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${att ? formatTime(att.clock_in) : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${att ? formatTime(att.clock_out) : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(status)}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="openModal('${att ? att.id : null}', '${profile.id}', '${profile.full_name}', '${status}', '${att ? formatTimeForInput(att.clock_in) : ''}', '${att ? formatTimeForInput(att.clock_out) : ''}')" class="text-blue-600 hover:text-blue-900">Ubah Status</button>
                        </td>
                    </tr>
                `;
            });
            
            adminAttendanceTableBody.innerHTML = html;
            document.getElementById('adminTotalEmployees').textContent = employeeIds.length;
            document.getElementById('adminTotalHadir').textContent = totalHadir;
            document.getElementById('adminTotalIzin').textContent = totalIzin;
            document.getElementById('adminTotalAlpa').textContent = totalAlpa;

            document.getElementById('adminNoDataMessage').classList.toggle('hidden', employeeIds.length > 0);
        }

        async function loadEmployeeList() {
            employeeListTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat daftar karyawan...</td></tr>';
            
            // 1. Mulai query dasar
            let query = _supabase
                .from('profiles')
                .select('id, full_name, user_id_number, role, user_status, companies(name)'); // Ambil juga nama perusahaan

            // 2. Tambahkan filter HANYA jika yang login BUKAN Super Admin
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            
            // 3. Tambahkan pengurutan dan jalankan query
            query = query.order('full_name', { ascending: true });
            const { data: profiles, error } = await query;

            if (error) {
                console.error("Gagal memuat daftar karyawan:", error.message);
                employeeListTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (profiles.length === 0) {
                employeeListTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada karyawan terdaftar di perusahaan ini.</td></tr>';
                return;
            }

            // Sembunyikan kolom "Perusahaan" jika bukan Super Admin
            const companyHeader = document.getElementById('companyColumnHeader');
            if (companyHeader) {
                 companyHeader.style.display = (globalProfile.role === 'super_admin') ? 'table-cell' : 'none';
            }

            let html = profiles.map(profile => {
                const roleText = profile.role.replace('_', ' ');
                const statusClass = (profile.user_status === 'Percobaan' || profile.user_status === 'Kontrak') ? 'bg-yellow-100 text-yellow-800' : 
                                    (profile.user_status === 'Tetap' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');

                // Tampilkan nama perusahaan (jika ada)
                const companyName = profile.companies ? profile.companies.name : 'N/A';
                const companyCell = (globalProfile.role === 'super_admin') 
                    ? `<td class="px-4 py-3 text-sm text-gray-500">${companyName}</td>` 
                    : ''; // Sembunyikan sel jika Company Admin

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${profile.full_name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${profile.user_id_number || 'N/A'}</td>
                        ${companyCell} <!-- Sel Perusahaan -->
                        <td class="px-4 py-3 text-sm text-blue-600">${roleText.toUpperCase()}</td>
                        <td class="px-4 py-3 text-left">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${profile.user_status ? profile.user_status.toUpperCase() : 'N/A'}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="editEmployee('${profile.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');

            employeeListTableBody.innerHTML = html;
        }

        // --- LOGIKA REKAP KEHADIRAN ---

        async function initializeRekapFilters() {
            const employeeFilter = document.getElementById('rekapEmployeeFilter');

            // HANYA muat jika belum pernah dimuat
            if (allEmployees.length === 0) {
                 // 1. Ambil daftar karyawan (mirip loadEmployeeList)
                let query = _supabase
                    .from('profiles')
                    .select('id, full_name')
                    .order('full_name', { ascending: true });

                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter rekap:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // 2. Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // 3. Atur tanggal default ke 30 hari ke belakang
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('rekapEndDate').value = today;
            document.getElementById('rekapStartDate').value = getTodayDateString(thirtyDaysAgo);
        }

        async function loadRekapData() {
            const rekapTableBody = document.getElementById('rekapTableBody');
            const startDate = document.getElementById('rekapStartDate').value;
            const endDate = document.getElementById('rekapEndDate').value;
            const employeeId = document.getElementById('rekapEmployeeFilter').value;
            const statusFilter = document.getElementById('rekapStatusFilter').value;

            if (!startDate || !endDate) {
                showMessage("Harap isi rentang tanggal.", 'error');
                return;
            }

            rekapTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Mencari data...</td></tr>';

            // Menyesuaikan rentang tanggal (Supabase menggunakan created_at)
            const startISO = new Date(startDate).toISOString();
            // Tambahkan 24 jam ke tanggal akhir agar inklusif
            const endOfDay = new Date(new Date(endDate).getTime() + 24 * 60 * 60 * 1000);
            const endISO = endOfDay.toISOString();

            let query = _supabase
                .from('attendance')
                .select(`
                    *,
                    profiles(full_name)
                `)
                .gte('created_at', startISO)
                .lt('created_at', endISO);

            // Filter berdasarkan Perusahaan (Penting untuk RLS, tapi kita filter lagi di sini)
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            
            // Filter berdasarkan Nama Karyawan
            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }

            // Filter berdasarkan Status
            if (statusFilter) {
                query = query.eq('attendance_status', statusFilter);
            }

            // Urutkan berdasarkan tanggal terbaru
            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data rekap:", error.message);
                rekapTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                rekapTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data kehadiran yang cocok dengan filter yang Anda pilih.</td></tr>';
                return;
            }

            // --- LOGIKA PENGUMPULAN KETERANGAN DARI TABEL REQUESTS ---
            const employeeIdsInRekap = [...new Set(data.map(att => att.user_id))];
            const uniqueAttendanceDates = [...new Set(data.map(att => getTodayDateString(new Date(att.created_at))))];
            let requestsMap = {}; // Key: user_id|YYYY-MM-DD, Value: description

            // Helper untuk memuat request yang SUDAH DISETUJUI
            const loadRequests = async (tableName, dateColumn, statusColumn) => {
                const { data: requests, error } = await _supabase
                    .from(tableName)
                    .select(`user_id, description, ${dateColumn}, ${statusColumn}`) 
                    .in('user_id', employeeIdsInRekap)
                    .eq(statusColumn, 'Disetujui') // HANYA ambil yang disetujui
                    .in(dateColumn, uniqueAttendanceDates);
                
                if (error) {
                    console.error(`Gagal memuat data ${tableName}:`, error.message);
                    return;
                }

                if (requests) {
                    requests.forEach(req => {
                        const dateValue = req[dateColumn];
                        const key = `${req.user_id}|${dateValue}`;
                        // Simpan deskripsi pengajuan
                        requestsMap[key] = req.description; 
                    });
                }
            };
            
            if (employeeIdsInRekap.length > 0 && uniqueAttendanceDates.length > 0) {
                // 1. Ambil dari attendance_requests (Koreksi Absensi)
                await loadRequests('attendance_requests', 'attendance_date', 'requests_status');
                
                // 2. Ambil dari overtime_requests (Lembur)
                await loadRequests('overtime_requests', 'overtime_date', 'overtime_status'); 
                
                // 3. (Tambahkan di sini jika ada timeoff_requests)
                // await loadRequests('timeoff_requests', 'timeoff_date', 'timeoff_status'); 
            }
            // --- AKHIR LOGIKA KETERANGAN ---

            let html = data.map(att => {
                const date = new Date(att.created_at);
                const dateDisplay = date.toLocaleDateString('id-ID'); 
                const dateKey = getTodayDateString(date); 

                const requestKey = `${att.user_id}|${dateKey}`;
                
                // Ambil keterangan: HANYA dari requestsMap. Defaultkan ke '-' jika tidak ada.
                const keterangan = requestsMap[requestKey] || '-'; // <-- PERBAIKAN UTAMA

                const name = att.profiles ? att.profiles.full_name : 'N/A';
                const statusClass = getStatusClass(att.attendance_status);
                
                return `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dateDisplay}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(att.clock_in)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(att.clock_out)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${att.attendance_status}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">${keterangan}</td>
                    </tr>
                `;
            }).join('');
            rekapTableBody.innerHTML = html;
        }
        
        // --- FUNGSI BARU: INIT FILTER PENGAJUAN KOREKSI KEHADIRAN (DITINGKATKAN) ---
        async function initializeReqAttFilters() {
            const employeeFilter = document.getElementById('reqAttEmployeeFilter');
            const tableBody = document.getElementById('reqAttTableBody'); // Tambahkan ini

            // BARIS KRITIS: Cek apakah elemen filter ditemukan sebelum melanjutkan
            if (!employeeFilter || !tableBody) {
                const sectionContainer = document.getElementById('sectionReqAttendance');
                if (sectionContainer) {
                    sectionContainer.innerHTML = '<div class="p-8 bg-red-100 border border-red-400 text-red-700 rounded-xl">Kesalahan! Elemen HTML Koreksi Kehadiran (Filter/Tabel) tidak ditemukan. Mohon periksa kembali struktur HTML pada SECTION 5.</div>';
                }
                return;
            }

            // Reuse allEmployees data if already loaded by Rekap feature
            // Variabel allEmployees didefinisikan di logic Rekap Kehadiran
            if (allEmployees.length === 0) { 
                 // 1. Ambil daftar karyawan
                let query = _supabase
                    .from('profiles')
                    .select('id, full_name')
                    .order('full_name', { ascending: true });

                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter pengajuan:", error.message);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat daftar karyawan.</td></tr>';
                    loadRequestAttendanceData(); // Kita tetap panggil loader agar tampilan tidak kosong total
                    return;
                }
                allEmployees = data;
            }

            // 2. Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // 3. Atur tanggal default ke 30 hari ke belakang
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqAttEndDate').value = today;
            document.getElementById('reqAttStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // 4. Muat data setelah filter siap
            loadRequestAttendanceData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN KOREKSI KEHADIRAN ---
        async function loadRequestAttendanceData() {
            const tableBody = document.getElementById('reqAttTableBody');
            const startDate = document.getElementById('reqAttStartDate').value;
            const endDate = document.getElementById('reqAttEndDate').value;
            const employeeId = document.getElementById('reqAttEmployeeFilter').value;
            const statusFilter = document.getElementById('reqAttStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Mencari pengajuan...</td></tr>';

            // Filter oleh RLS sudah berjalan otomatis berdasarkan company_id

            let query = _supabase
                .from('attendance_requests')
                .select(`
                    id, 
                    attendance_date, 
                    clock_in, 
                    clock_out, 
                    description, 
                    requests_status,
                    user_id,
                    profiles(full_name)
                `)
                // Filter Tanggal Kehadiran (attendance_date)
                .gte('attendance_date', startDate) 
                .lte('attendance_date', endDate); 

            // Filter berdasarkan Nama Karyawan
            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }

            // Filter berdasarkan Status
            if (statusFilter) {
                query = query.eq('requests_status', statusFilter);
            }

            // Urutkan berdasarkan tanggal diajukan (terbaru di atas)
            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan koreksi:", error.message);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada pengajuan koreksi yang cocok dengan filter.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const dateDisplay = new Date(req.attendance_date).toLocaleDateString('id-ID');
                // Catatan: Gunakan req.clock_in / req.clock_out karena ini adalah data yang diajukan
                const clockInTime = req.clock_in ? formatTime(req.clock_in) : '-'; 
                const clockOutTime = req.clock_out ? formatTime(req.clock_out) : '-';
                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const description = req.description || '-';
                const status = req.requests_status;
                
                let statusClass;
                let actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveRequest('${req.id}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectRequest('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${dateDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${clockInTime}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${clockOutTime}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI ADMIN: AKSI PENGAJUAN (PLACEHOLDER) ---
        async function handleApproveRequest(requestId) {
            showMessage(`Fitur Setujui untuk ID ${requestId} akan diimplementasikan.`, 'info');
        }

        async function handleRejectRequest(requestId) {
            showMessage(`Fitur Tolak untuk ID ${requestId} akan diimplementasikan.`, 'info');
        }

        // Atur filter tanggal ke hari ini saat inisialisasi admin
        adminAttendanceDateFilter.value = getTodayDateString();
        adminAttendanceDateFilter.addEventListener('change', (e) => loadAdminAttendanceData(e.target.value));
        
        // --- LOGIKA MODAL ADMIN ---

        function openModal(attendanceId, userId, name, status, clockIn, clockOut) {
            modalAttendanceData = {
                id: attendanceId,
                user_id: userId,
                name: name
            };

            modalEmployeeName.textContent = name;
            
            modalStatus.value = status;
            modalClockIn.value = clockIn || '';
            modalClockOut.value = clockOut || '';

            const isHadir = status === 'Hadir' || status === 'Terlambat';
            modalClockIn.disabled = !isHadir;
            modalClockOut.disabled = !isHadir;

            modalStatus.onchange = () => {
                const newStatus = modalStatus.value;
                const newIsHadir = newStatus === 'Hadir' || newStatus === 'Terlambat';
                modalClockIn.disabled = !newIsHadir;
                modalClockOut.disabled = !newIsHadir;

                if (!newIsHadir) {
                    modalClockIn.value = '';
                    modalClockOut.value = '';
                }
            };

            statusModal.classList.remove('hidden');
        }

        function closeModal() {
            statusModal.classList.add('hidden');
            modalAttendanceData = {};
        }

        modalSaveButton.addEventListener('click', async () => {
            const status = modalStatus.value;
            const clockInTime = modalClockIn.value; // format HH:MM
            const clockOutTime = modalClockOut.value; // format HH:MM
            const dateString = adminAttendanceDateFilter.value;
            
            showMessage("Menyimpan perubahan...", 'info');
            
            // Konversi HH:MM menjadi ISO string pada tanggal yang difilter
            const combineDateTime = (time) => {
                if (!time) return null;
                const [hours, minutes] = time.split(':');
                const date = new Date(dateString);
                // Penting: Set jam dalam WAKTU LOKAL
                date.setHours(parseInt(hours, 10));
                date.setMinutes(parseInt(minutes, 10));
                date.setSeconds(0);
                date.setMilliseconds(0);
                return date.toISOString();
            };
            
            const payload = {
                attendance_status: status,
                clock_in: combineDateTime(clockInTime),
                clock_out: combineDateTime(clockOutTime),
                updated_at: new Date().toISOString()
            };

            if (modalAttendanceData.id && modalAttendanceData.id !== 'null') {
                // KASUS 1: UPDATE ABSENSI YANG SUDAH ADA
                const { error } = await _supabase
                    .from('attendance')
                    .update(payload)
                    .eq('id', modalAttendanceData.id);

                if (error) {
                    showMessage(`Gagal update: ${error.message}`, 'error');
                    return;
                }
                
            } else {
                // KASUS 2: BUAT ABSENSI BARU (Misal mengubah Alpa menjadi Hadir)
                const newPayload = {
                    ...payload,
                    user_id: modalAttendanceData.user_id,
                    company_id: globalProfile.company_id,
                    created_at: combineDateTime(clockInTime) || new Date(dateString).toISOString(), 
                };
                
                const { error } = await _supabase
                    .from('attendance')
                    .insert([newPayload]);

                if (error) {
                    showMessage(`Gagal insert baru: ${error.message}`, 'error');
                    return;
                }
            }
            
            showMessage('Perubahan berhasil disimpan.', 'success');
            closeModal();
            loadAdminAttendanceData(dateString); // Muat ulang tabel
        });

        // --- 4. FUNGSI BARU: HELPER KONVERSI WAKTU ---
        function combineDateAndTime(dateString, timeString) {
            if (!dateString || !timeString) return null;
            
            const [hours, minutes] = timeString.split(':');
            
            // Buat tanggal baru berdasarkan dateString (PENTING: gunakan 'T00:00:00' untuk memastikan interpretasi lokal)
            // Ini memperbaiki bug timezone jika pengguna menginput tanggal kemarin
            const date = new Date(dateString + 'T00:00:00'); 
            
            // Set jam dan menit dalam WAKTU LOKAL
            date.setHours(parseInt(hours, 10));
            date.setMinutes(parseInt(minutes, 10));
            date.setSeconds(0);
            date.setMilliseconds(0);
            
            // Kembalikan sebagai ISO string
            return date.toISOString();
        }


        // --- 5. FUNGSI BARU: KIRIM PENGAJUAN ---
        // (Letakkan setelah fungsi helper di atas, sekitar baris 1815)

        async function handleNewAttendanceRequest(e) {
            e.preventDefault(); // Mencegah form reload halaman
            const saveButton = document.getElementById('saveRequestButton');
            saveButton.disabled = true;

            const attDate = document.getElementById('reqAttDate').value;
            const clockInTime = document.getElementById('reqAttClockIn').value;
            const clockOutTime = document.getElementById('reqAttClockOut').value;
            const description = document.getElementById('reqAttDescription').value;

            // Validasi constraint dari Supabase: Minimal 1 jam harus diisi
            if (!clockInTime && !clockOutTime) {
                showMessage("Gagal: Harap isi Jam Masuk atau Jam Pulang.", 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Mengirim pengajuan...", 'info');

            // Siapkan payload sesuai skema 'attendance_requests'
            const newRequest = {
                user_id: globalProfile.id,
                company_id: globalProfile.company_id,
                attendance_date: attDate,
                // Gunakan helper baru untuk konversi waktu
                clock_in: combineDateAndTime(attDate, clockInTime),
                clock_out: combineDateAndTime(attDate, clockOutTime),
                description: description,
                requests_status: 'Diajukan' // Default saat insert
            };

            const { error } = await _supabase
                .from('attendance_requests')
                .insert([newRequest]);

            if (error) {
                console.error("Gagal mengirim pengajuan:", error.message);
                showMessage(`Gagal: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Pengajuan koreksi berhasil dikirim.", 'success');
            closeRequestAttendanceModal();
            loadAttendanceRequests(); // Muat ulang daftar request di belakang modal
        }

        // ===============================================================
        // 4. LOGIKA AUTHENTIKASI UTAMA (GLOBAL)
        // ===============================================================
        
        async function doLogout() {
            const { error } = await _supabase.auth.signOut();
            if (!error) {
                globalProfile = null;
                changeView('loginView');
                showMessage('Anda telah logout.', 'info');
            } else {
                showMessage('Gagal logout: ' + error.message, 'error');
            }
        }

        async function checkAuthAndRole() {
            loadingView.style.display = 'flex'; // Tampilkan loading
            
            const { data: { session } } = await _supabase.auth.getSession();
            
            if (!session) {
                loadingView.style.display = 'none';
                return changeView('loginView'); // BUG FIX: Arahkan ke login jika tidak ada sesi
            }

            // Ambil data profil untuk menentukan peran
            const { data: profile, error: profileError } = await _supabase
                .from('profiles')
                .select('id, role, full_name, company_id')
                .eq('id', session.user.id)
                .single();

            if (profileError || !profile) {
                console.error("Gagal memuat profil:", profileError?.message);
                showMessage("Gagal memuat data profil. Silakan login ulang.", 'error');
                await _supabase.auth.signOut();
                loadingView.style.display = 'none';
                return changeView('loginView');
            }
            
            globalProfile = profile; // Simpan profil secara global
            const userRole = profile.role;
            await loadCompanyDetails();
            
            // Inisialisasi Jam
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDateTime');
            if (timeElement && dateElement) {
                initializeClock(timeElement, dateElement);
            }
            
            // Pengalihan berdasarkan Peran
            if (userRole === 'super_admin' || userRole === 'company_admin') {
                // ADMIN: Konfigurasi & Arahkan ke Admin View
                adminRoleDisplay.textContent = `(${userRole.replace('_', ' ').toUpperCase()})`;
                karyawanAdminLink.classList.remove('hidden'); // Tampilkan tombol Admin di tampilan Karyawan

                // --- MENGISI NAMA & EMAIL ADMIN (BARU) ---
                const adminName = globalProfile.full_name;
                const adminEmail = session.user.email;
                // Format: Nama Lengkap (email)
                document.getElementById('adminInfoDisplay').textContent = `${adminName} (${adminEmail})`;
                // --- AKHIR LOGIKA HEADER ADMIN ---

                // Tampilkan menu Perusahaan HANYA untuk Super Admin
                if (userRole === 'super_admin') {
                    document.getElementById('menuCompaniesContainer').classList.remove('hidden');
                } else {
                    document.getElementById('menuCompaniesContainer').classList.add('hidden');
                }
                
                // --- SETUP ADMIN EVENT LISTENERS (DIPINDAHKAN UNTUK ROBUSTNESS) ---
                // Menggunakan .onclick sebagai pengganti addEventListener untuk kepastian
                try {
                    document.getElementById('rekapFilterButton').onclick = loadRekapData;
                    document.getElementById('reqAttFilterButton').onclick = loadRequestAttendanceData;
                } catch (e) {
                    console.warn("Tombol filter admin belum sepenuhnya dimuat atau ID salah:", e.message);
                }
                // -----------------------------------------------------------------
                              
                // Muat status absensi Karyawan jika Admin melihat halaman Karyawan
                karyawanUserName.textContent = `Halo, ${profile.full_name}`; // <-- Diperbaiki
                loadKaryawanAttendanceStatus(); 

                loadingView.style.display = 'none';
                changeView('karyawanView'); 
                showKaryawanContent('Absensi'); // <-- Default ke tampilan Karyawan
                return;

            } else if (userRole === 'karyawan') {
                // KARYAWAN: Konfigurasi & Arahkan ke Karyawan View
                karyawanUserName.textContent = `Halo, ${profile.full_name}`; // <-- Diperbaiki
                karyawanAdminLink.classList.add('hidden');
                loadKaryawanAttendanceStatus();

                loadingView.style.display = 'none';
                return changeView('karyawanView'); // Default ke tampilan Karyawan
            }
            // Fallback (Peran tidak valid)
            showMessage("Peran pengguna tidak valid. Logout.", 'error');
            await doLogout();
        }

        // FUNGSI EDIT EMPLOYEE (BARU DITAMBAHKAN)
        async function editEmployee(profileId) {
            // 1. Ambil data profil
            showMessage("Memuat data karyawan...", 'info');
            const { data: profile, error } = await _supabase
                .from('profiles')
                .select('id, full_name, user_id_number, role, user_status, company_id,email')
                .eq('id', profileId)
                .single();
            
            if (error) {
                showMessage(`Gagal memuat data: ${error.message}`, 'error');
                return;
            }

            // 2. Buka modal dan isi form
            await openEmployeeModal(); // Panggil openEmployeeModal untuk mengisi dropdown perusahaan
            
            document.getElementById('employeeModalTitle').textContent = 'Edit Karyawan';
            document.getElementById('employeeForm').dataset.editingId = profile.id; // Tandai mode edit

            document.getElementById('employeeFullName').value = profile.full_name;
            document.getElementById('employeeIDNumber').value = profile.user_id_number;
            document.getElementById('employeeRole').value = profile.role;
            document.getElementById('employeeStatus').value = profile.user_status;
            
            if(globalProfile.role === 'super_admin' && profile.company_id) {
                document.getElementById('employeeCompany').value = profile.company_id;
            }

            // Nonaktifkan email dan password saat edit
            // Kita tidak perlu menampilkan email/password untuk mencegah error RLS di Auth
            document.getElementById('employeeEmail').value = profile.email || 'Email tidak tersimpan'; // Placeholder
            document.getElementById('employeeEmail').disabled = true;
            document.getElementById('employeePassword').required = false; 
            document.getElementById('employeePassword').previousElementSibling.textContent = "Password (Kosongkan jika tidak berubah)";
            
            document.getElementById('saveEmployeeButton').textContent = "Simpan Perubahan";
        }

            // Jalankan pemeriksaan saat aplikasi dimuat
            checkAuthAndRole();

            const requestAttendanceModal = document.getElementById('requestAttendanceModal');
            const requestAttendanceForm = document.getElementById('requestAttendanceForm');
        
        // --- 6. EVENT LISTENER BARU ---
            requestAttendanceForm.addEventListener('submit', handleNewAttendanceRequest);   

    </script>
</body>
</html>
