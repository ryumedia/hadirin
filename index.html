<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hadirin-Aplikasi Kehadiran Lengkap</title>
    <!-- ===== TAMBAHKAN KODE FAVICON DI SINI ===== -->
    <link rel="icon" href="https://blogger.googleusercontent.com/img/a/AVvXsEhfFNn0L9WN_NL0oZqPDAt1J8eC6CoXfHYNNf5idh9IpCt6TAWsPpSIg64pXtaxz5n2oZ0cKgIYjPNRvEpc_NwoZjcFKfmMCf_kii467EUQpOBzSCOiR1ELJ1dRyj75INwPfKYasAS79IEDbnQ-08yqEGE5UsHrzTBbWGC32SAfUVmSconpUsAO7vDxifs" type="image/png">
    <link rel="apple-touch-icon" href="https://blogger.googleusercontent.com/img/a/AVvXsEhfFNn0L9WN_NL0oZqPDAt1J8eC6CoXfHYNNf5idh9IpCt6TAWsPpSIg64pXtaxz5n2oZ0cKgIYjPNRvEpc_NwoZjcFKfmMCf_kii467EUQpOBzSCOiR1ELJ1dRyj75INwPfKYasAS79IEDbnQ-08yqEGE5UsHrzTBbWGC32SAfUVmSconpUsAO7vDxifs">
    <!-- Memuat Font Montserrat dari Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Memuat Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Library untuk konversi data ke XLSX (Excel) -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Menetapkan Montserrat sebagai font 'sans' default Tailwind
                        sans: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- ===== SKRIP KEAMANAN (LAPIS PERTAMA) ===== -->
    <script>
        // 1. Blokir Klik Kanan (Context Menu)
        document.addEventListener('contextmenu', event => event.preventDefault());

        // 2. Blokir Kombinasi Tombol Keyboard
        document.onkeydown = function(e) {
            // Blokir F12 (Developer Tools default)
            if(e.keyCode == 123) {
                return false;
            }

            // Blokir Ctrl+Shift+I (Inspect Element)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }

            // Blokir Ctrl+Shift+J (Console)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }

            // Blokir Ctrl+Shift+C (Inspect Element selection)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
                return false;
            }

            // Blokir Ctrl+U (View Source)
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }

            // Blokir Ctrl+S (Save Page)
            if(e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) {
                return false;
            }

            // Blokir Ctrl+P (Print)
            if(e.ctrlKey && e.keyCode == 'P'.charCodeAt(0)) {
                return false;
            }
        }
    </script>
    <!-- ========================================== -->

    <!-- Memuat icon (Ionicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
        }
        /* Menyembunyikan tampilan secara default */
        .view {
            display: none;
        }
        .spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Gaya Kalender BARU (List View) */
        .calendar-list {
            display: flex;
            flex-direction: column;
            gap: 6px; /* Spasi antar item hari */
        }
        .list-day-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 10px;
            transition: background-color 0.1s;
        }
        /* Style khusus untuk 'Hari Ini' (dari JS) */
        .list-day-item.border-blue-500 {
            border-width: 2px;
            padding: 10px 14px; /* Sesuaikan padding jika ada border */
        }
        .list-day-info {
            display: flex;
            align-items: baseline; /* Agar tanggal dan nama hari rapi */
        }
        .list-day-date {
            font-weight: 700; /* bold */
            font-size: 1.125rem; /* text-lg */
            min-width: 28px; /* Agar tanggal 1-9 sejajar */
        }
        .list-day-name {
            font-weight: 500; /* medium */
            font-size: 0.875rem; /* text-sm */
            margin-left: 12px;
            opacity: 0.9;
        }
        .list-day-status {
            font-weight: 600; /* semibold */
            font-size: 0.875rem; /* text-sm */
            text-align: right;
        }
        /* Status Colors - Sesuai dengan Legenda */
        .status-Hadir { background-color: #d1fae5; border: 1px solid #10b981; color: #065f46; } /* Green */
        .status-Terlambat, .status-Izin { background-color: #fef3c7; border: 1px solid #f59e0b; color: #92400e; } /* Yellow */
        .status-Alpa { background-color: #e0e7ff; border: 1px solid #6366f1; color: #3730a3; } /* Indigo */
        .status-Weekend { background-color: #fee2e2; border: 1px solid #ef4444; color: #991b1b; } /* Red * (Hari Libur/Weekend) */
        .status-Future, .status-Empty { background-color: #f9fafb; color: #9ca3af; } /* Gray (Tanggal masa depan atau sel kosong) */
        /* Gaya untuk tab bulan yang aktif (Background Menyala) */
        .tab-active-bg {
             background-color: #eff6ff; /* bg-blue-50 */
             border-radius: 6px 6px 0 0;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Kontainer Utama -->
    <div id="appContainer" class="flex flex-col min-h-screen">
        
        <!-- Layar Loading Awal -->
        <div id="loadingView" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
            <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
            <p class="mt-4 text-gray-600">Memverifikasi sesi...</p>
        </div>

        <!-- 1. Tampilan Login -->
        <div id="loginView" class="view flex flex-grow items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 sm:p-10">
                <div class="text-center mb-8">
                    <div class="w-48 h-48 mx-auto mb-2 relative flex items-center justify-center">
                    <!-- ===== TAMBAHKAN KODE LOGO DI SINI ===== -->
                    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEhvDQZgkpGf7o30SDvC64poshBYUS6yjJ3FzjqVnZn7XGaRY8GaQPzJbCWyMoTfhJr9uEgmpEtYqyYNKAxHjCNpBlAwD9auAaAmtINZXWwII_1etFThbEEkvFQzKjRjC6XCHMV3S7bYYHtTk4q0AuoSinxmIGeCRkpYYrW57dGmvJlwqvuwhDXkUuv6Uk4" alt="Logo Hadirin.org" class="w-full h-full object-contain">
                    </div>
                    <p class="text-gray-500 mt-2">Aplikasi Manajemen Kehadiran</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <div class="relative">
                            <input type="email" id="login-email" required placeholder="Email Anda"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <ion-icon name="mail-outline" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></ion-icon>
                        </div>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" required placeholder="Password"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <ion-icon name="lock-closed-outline" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></ion-icon>
                        </div>
                    </div>

                    <div id="loginMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm" role="alert"></div>

                    <button type="submit" id="loginButton"
                        class="w-full flex items-center justify-center px-4 py-2.5 rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 disabled:opacity-50">
                        <ion-icon name="log-in-outline" class="text-xl mr-2"></ion-icon>
                        <span id="loginButtonText">Masuk</span>
                        <div id="loginSpinner" class="hidden spinner w-4 h-4 border-2 border-t-transparent border-white ml-2" role="status"></div>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 2. Tampilan Karyawan -->
        <div id="karyawanView" class="view flex flex-grow items-start justify-center p-4 sm:p-6 lg:p-8 pb-20">
            <div class="w-full max-w-lg">
                <!-- Karyawan Header (Tetap sticky dan di atas) -->
                    <header id="karyawanHeader" class="flex justify-between rounded-lg items-start p-4 bg-white/70 backdrop-blur sticky top-0 z-10 border-b border-gray-200">
                        
                        <!-- KONTEN KIRI: NAMA, PERUSAHAAN, dan JAM PUSAT -->
                        <div class="flex-1 min-w-0">
                            
                            <!-- BARIS 1: NAMA KARYAWAN (Tidak Wrap) -->
                            <!-- Gunakan whitespace-nowrap, overflow-hidden, dan text-ellipsis -->
                            <p id="karyawanUserName" class="text-lg font-bold text-gray-800 transition-opacity duration-300 whitespace-nowrap overflow-hidden text-ellipsis">
                                Halo, [Nama Pengguna]
                            </p>
                            
                            <!-- BARIS 2: NAMA PERUSAHAAN -->
                            <p id="companyText" class="text-sm text-gray-600 mt-0.5 transition-opacity duration-300">
                                Company Name
                            </p>
                        </div>
                        
                        <!-- KONTEN KANAN: ICON ADMIN & LOGOUT (Tetap) -->
                        <div class="flex items-center space-x-4 ml-4">
                            <!-- Tombol Admin/Pengaturan (id="karyawanAdminLink" wajib ada untuk JS) -->
                            <!-- onclick harus memanggil changeView dan showAdminSection untuk memastikan Admin Dashboard dimuat di Ringkasan Harian -->
                            <button onclick="changeView('adminView'); showAdminSection('summary');" id="karyawanAdminLink" class="p-2 text-gray-600 hover:text-blue-600 transition duration-150 hidden">
                                <!-- Icon Admin/Pengaturan: Menggunakan Icon Gerigi (Cog) -->
                                <ion-icon name="settings-outline" class="text-2xl"></ion-icon>
                            </button>
                            <!-- ===== TOMBOL PROFIL BARU ===== -->
                            <button onclick="showKaryawanContent('Profile')" class="p-2 text-gray-600 hover:text-blue-600 transition duration-150">
                                <ion-icon name="person-circle-outline" class="text-2xl"></ion-icon>
                            </button>
                            <!-- Tombol Logout (Menambahkan onclick yang benar) -->
                            <button id="logoutBtn" onclick="doLogout()" class="p-2 text-red-500 hover:text-red-700 transition duration-150">
                                <!-- Icon Logout -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            </button>
                        </div>
                    </header>

                    <!-- Karyawan Absensi Section -->
                    <div id="karyawanSection_Absensi" class="mt-2 p-6 bg-white rounded-xl shadow-lg transition-all duration-300" style="display: block;">
                        
                        <!-- ===== TAMBAHKAN KODE LOGO DI SINI ===== -->
                            <img src="https://blogger.googleusercontent.com/img/a/AVvXsEhvDQZgkpGf7o30SDvC64poshBYUS6yjJ3FzjqVnZn7XGaRY8GaQPzJbCWyMoTfhJr9uEgmpEtYqyYNKAxHjCNpBlAwD9auAaAmtINZXWwII_1etFThbEEkvFQzKjRjC6XCHMV3S7bYYHtTk4q0AuoSinxmIGeCRkpYYrW57dGmvJlwqvuwhDXkUuv6Uk4" alt="Logo Hadirin.org" class="w-24 mx-auto mb-4">
                            <!-- ======================================= -->
                        <!-- JAM (DIPUSATKAN) -->
                        <!-- Gunakan div dengan w-full dan text-center untuk memusatkan jam -->
                        <div class="w-full text-center mt-3 mb-3">
                            <p id="currentTime" class="text-5xl font-extrabold text-blue-600 transition-opacity duration-300">
                                00:00:00
                            </p>
                        </div>

                        <!-- Tombol Aksi Absensi -->
                        <div class="grid grid-cols-2 gap-4 mb-6 mt-6">
                            <button id="karyawanClockInButton" class="bg-green-600 text-white p-4 rounded-xl shadow-md hover:bg-green-700 transition duration-150 flex items-center justify-center font-bold text-lg disabled:opacity-50">
                                Clock-In
                            </button>
                            <button id="karyawanClockOutButton" class="bg-red-600 text-white p-4 rounded-xl shadow-md hover:bg-red-700 transition duration-150 flex items-center justify-center font-bold text-lg disabled:opacity-50" disabled>
                                Clock-Out
                            </button>
                        </div>        
                
                        <!-- KONTEN HEADER CARD: JUDUL + TANGGAL/HARI -->
                        <!-- KONTEN HEADER CARD: JUDUL, TANGGAL, DAN IKON RIWAYAT -->
                        <div class="mb-4 border-b pb-2 flex justify-between items-start">
                            <!-- KIRI: Judul dan Tanggal -->
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Presensi Hari Ini</h3>
                                <p id="currentDateTime" class="text-base text-gray-500 mt-0.5"></p> 
                            </div>
                            
                            <!-- KANAN: Tombol Riwayat (BARU) -->
                            <button onclick="showKaryawanContent('History')" class="text-gray-500 hover:text-blue-600 transition p-1 -mt-1 -mr-1">
                                <ion-icon name="clipboard-outline" class="text-2xl"></ion-icon>
                                <p class="text-base text-gray-500 mt-0.5">Riwayat Presensi</p>
                            </button>
                        </div>
                        <div id="karyawanAttendanceStatus" class="text-center p-4 rounded-lg bg-gray-100 text-gray-700 font-medium">
                            Memuat status...
                        </div>
                            <p id="karyawanLocationDisplay" class="text-center text-sm text-gray-500 mt-2">
                                Lokasi: Belum diambil
                            </p>
                        <div class="mt-6 grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">Jam Masuk</p>
                                <p id="karyawanClockInTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-500">Jam Pulang</p>
                                <p id="karyawanClockOutTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================== -->
                    <!-- SECTION 1 KARYAWAN: PENGAJUAN (REQUESTS) KARYAWAN (BARU) -->
                    <!-- ============================================== -->
                    <div id="karyawanSection_Requests" class="mt-2" style="display: none;">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            
                            <!-- Tombol Kembali -->
                            <button onclick="showKaryawanContent('Absensi')" class="mb-4 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                                
                            <h2 class="text-xl font-semibold text-gray-800 mb-6">Pengajuan Koreksi Kehadiran</h2>

                            <!-- Form Pengajuan Koreksi BARU (DIPINDAH DARI MODAL) -->
                            <form id="requestAttendanceForm" class="space-y-4 border-b pb-6 mb-6">
                                <div>
                                    <label for="reqAttDate" class="block text-sm font-medium text-gray-700">Tanggal Absensi yang Dikoreksi</label>
                                    <input type="date" id="reqAttDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="reqAttClockIn" class="block text-sm font-medium text-gray-700">Jam Masuk (Seharusnya)</label>
                                        <input type="time" id="reqAttClockIn" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <div>
                                        <label for="reqAttClockOut" class="block text-sm font-medium text-gray-700">Jam Pulang (Seharusnya)</label>
                                        <input type="time" id="reqAttClockOut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>

                                <div>
                                    <label for="reqAttDescription" class="block text-sm font-medium text-gray-700">Alasan Koreksi</label>
                                    <textarea id="reqAttDescription" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Lupa absen pulang karena meeting mendadak di luar kantor."></textarea>
                                </div>
                                    
                                <p class="text-xs text-gray-500">Penting: Anda harus mengisi setidaknya salah satu Jam Masuk atau Jam Pulang.</p>
                                    
                                <button type="submit" id="saveRequestButton" class="w-full flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                    Kirim Pengajuan Koreksi
                                </button>
                            </form>
                            <!-- Akhir Form Pengajuan Koreksi -->
                                
                            <!-- Riwayat Pengajuan -->
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Pengajuan Koreksi</h3>
                            <p class="text-sm text-gray-500 mb-4">Daftar ini adalah riwayat pengajuan koreksi absensi Anda (lupa clock-in/out).</p>

                            <!-- Tabel Riwayat Pengajuan Karyawan -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Absensi</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="requestListTableBody">
                                        <!-- Data riwayat pengajuan akan dimuat di sini oleh JS -->
                                        <tr><td colspan="3" class="text-center py-8 text-gray-500">Memuat riwayat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================== -->
                    <!-- SECTION 2 KARYWAN: PENGAJUAN IZIN / CUTI (TIMEOFF) -->
                    <!-- ============================================== -->
                    <div id="karyawanSection_Timeoff" style="display: none;">
                        <div class="mt-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                
                            <!-- Tombol Kembali -->
                            <button onclick="showKaryawanContent('Absensi')" class="mb-4 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                                
                            <h2 class="text-xl font-semibold text-gray-800 mb-6">Pengajuan Izin / Cuti (Timeoff)</h2>

                            <!-- Form Pengajuan Baru -->
                            <form id="timeoffRequestForm" class="space-y-4 border-b pb-6 mb-6">
                                <div>
                                    <label for="timeoffTypeSelect" class="block text-sm font-medium text-gray-700">Jenis Pengajuan</label>
                                    <select id="timeoffTypeSelect" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Memuat jenis izin/cuti...</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="timeoffStartDate" class="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                                        <input type="date" id="timeoffStartDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <div>
                                        <label for="timeoffEndDate" class="block text-sm font-medium text-gray-700">Tanggal Akhir</label>
                                        <input type="date" id="timeoffEndDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                                    
                                <div>
                                    <label for="timeoffDescription" class="block text-sm font-medium text-gray-700">Keterangan / Alasan</label>
                                    <textarea id="timeoffDescription" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Keperluan keluarga mendadak..."></textarea>
                                </div>
                                    
                                <button type="submit" id="saveTimeoffRequestButton" class="w-full flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                    Kirim Pengajuan Izin/Cuti
                                </button>
                            </form>
                                
                            <!-- Riwayat Pengajuan Timeoff -->
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Pengajuan Izin / Cuti</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rentang Tanggal</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="timeoffHistoryTableBody">
                                        <!-- Data riwayat pengajuan timeoff akan dimuat di sini oleh JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: OVERTIME (KONTEN BARU) -->
                    <div id="karyawanSection_Overtime" style="display: none;">
                        <div class="mt-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            
                            <!-- Tombol Kembali -->
                            <button onclick="showKaryawanContent('Absensi')" class="mb-4 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                                
                            <h2 class="text-xl font-semibold text-gray-800 mb-6">Pengajuan Lembur (Overtime)</h2>

                            <!-- Form Pengajuan Lembur Baru -->
                            <form id="overtimeRequestForm" class="space-y-4 border-b pb-6 mb-6">
                                <div>
                                    <label for="overtimeDate" class="block text-sm font-medium text-gray-700">Tanggal Lembur</label>
                                    <input type="date" id="overtimeDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="overtimeStartTime" class="block text-sm font-medium text-gray-700">Waktu Mulai</label>
                                        <input type="time" id="overtimeStartTime" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <div>
                                        <label for="overtimeEndTime" class="block text-sm font-medium text-gray-700">Waktu Akhir</label>
                                        <input type="time" id="overtimeEndTime" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                                    
                                <div>
                                    <label for="overtimeDescription" class="block text-sm font-medium text-gray-700">Tujuan / Deskripsi Lembur</label>
                                    <textarea id="overtimeDescription" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Menyelesaikan laporan akhir Q3..."></textarea>
                                </div>
                                    
                                <button type="submit" id="saveOvertimeRequestButton" class="w-full flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                    Kirim Pengajuan Lembur
                                </button>
                            </form>
                                
                            <!-- Riwayat Pengajuan Lembur -->
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Pengajuan Lembur</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Lembur</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="overtimeHistoryTableBody">
                                        <!-- Data riwayat pengajuan lembur akan dimuat di sini oleh JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: SALARY (KONTEN BARU) -->
                    <div id="karyawanSection_Salary" style="display: none;">
                        <div class="mt-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            
                            <!-- Tombol Kembali -->
                            <button onclick="showKaryawanContent('Absensi')" class="mb-4 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>

                            <h2 class="text-xl font-semibold text-gray-800 mb-6">Riwayat Payslip Anda</h2>

                            <!-- Tabel Riwayat Gaji -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Periode Gaji</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gaji Bersih (Rp)</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="karyawanPayslipTableBody">
                                        <!-- Data riwayat payslip akan dimuat di sini oleh JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================== -->
                    <!-- SECTION 5 KARYAWAN: RIWAYAT PRESENSI (HISTORY) -->
                    <!-- ============================================== -->
                    <div id="karyawanSection_History" style="display: none;">
                        <div class="mt-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <!-- Tombol Kembali -->
                            <button onclick="showKaryawanContent('Absensi')" class="mb-4 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                                
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Riwayat Presensi Bulanan</h2>

                            <!-- Tab Navigasi Bulan -->
                            <div class="flex border-b mb-4 justify-between" id="monthTabs">
                                <button id="tabPreviousMonth" onclick="switchHistoryTab('previous')" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                                    Memuat Bulan...
                                </button>
                                <button id="tabCurrentMonth" onclick="switchHistoryTab('current')" class="py-2 px-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
                                    Memuat Bulan...
                                </button>
                                <button id="tabNextMonth" onclick="switchHistoryTab('next')" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-blue-600 transition duration-150">
                                    Memuat Bulan...
                                </button>
                            </div>

                            <!-- Kontainer Kalender -->
                            <div id="calendarContainer">
                                <div id="calendarCurrentMonth" class="tab-content" style="display: block;">
                                    <!-- Kalender Bulan Ini akan dirender di sini -->
                                </div>
                                <div id="calendarPreviousMonth" class="tab-content" style="display: none;">
                                    <!-- Kalender Bulan Lalu akan dirender di sini -->
                                </div>
                                <!-- BARU: Kontainer Bulan Depan -->
                                <div id="calendarNextMonth" class="tab-content" style="display: none;">
                                    <!-- Kalender Bulan Depan akan dirender di sini -->
                                </div>
                            </div>

                            <!-- Legenda -->
                            <div class="mt-6 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-x-4 gap-y-2 text-xs">
                                <p class="font-semibold text-gray-700">Legenda:</p>
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-green-500"></span> Hadir</span>
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-yellow-500"></span> Terlambat / Izin</span>
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-red-500"></span> Alpa / Tidak Hadir</span>
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-gray-300 border border-gray-400"></span> Belum Absen</span>
                                <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-indigo-100 border border-indigo-500"></span> Hari Libur / Weekend</span>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================== -->
                    <!-- SECTION 6 KARYAWAN: PROFIL PENGGUNA (BARU) -->
                    <!-- ============================================== -->
                    <div id="karyawanSection_Profile" class="mt-2" style="display: none;">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            
                            <!-- Tombol Kembali -->
                            <button onclick="showKaryawanContent('Absensi')" class="mb-4 text-sm text-gray-600 hover:text-blue-600 transition flex items-center">
                                <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon> Kembali ke Home
                            </button>
                                
                            <h2 class="text-xl font-semibold text-gray-800 mb-6">Profil Saya</h2>

                            <!-- Info Pengguna (Read-only) -->
                            <div class="space-y-4 border-b pb-6 mb-6">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Nama Lengkap</label>
                                    <p id="profileInfoNama" class="mt-1 text-sm text-gray-900 font-medium">Memuat...</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Email</label>
                                    <p id="profileInfoEmail" class="mt-1 text-sm text-gray-900">Memuat...</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Perusahaan</label>
                                    <p id="profileInfoPerusahaan" class="mt-1 text-sm text-gray-900">Memuat...</p>
                                </div>
                            </div>
                            
                            <!-- Form Ubah Password -->
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Ubah Password</h3>
                            <form id="changePasswordForm" class="space-y-4">
                                <div>
                                    <label for="profileNewPassword" class="block text-sm font-medium text-gray-700">Password Baru</label>
                                    <input type="password" id="profileNewPassword" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Masukkan password baru Anda (min. 6 karakter)">
                                </div>
                                <div>
                                    <label for="profileConfirmPassword" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                                    <input type="password" id="profileConfirmPassword" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Ketik ulang password baru">
                                </div>
                                    
                                <button type="submit" id="savePasswordButton" class="w-full flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                    Simpan Password Baru
                                </button>
                            </form>
                        </div>
                    </div>
    

            </div>
        </div>

        <!-- =============================================================== -->
        <!-- TAMPILAN ADMIN (STRUKTUR DIPERBAIKI)                     -->
        <!-- =============================================================== -->
        <div id="adminView" class="view flex flex-grow w-full p-0 sm:p-0 lg:p-0">
            <!-- Kontainer Flexbox untuk Sidebar + Konten Utama -->
            <div class="w-full max-w-full mx-auto flex flex-col min-h-screen sm:flex-row">
                
                <!-- SIDEBAR (Menu Samping) -->
                <nav id="adminSidebar" class="bg-gray-800 text-white w-full sm:w-64 flex-shrink-0 p-4 sm:p-6 border-r border-gray-700 transition-all duration-300 ease-in-out hidden sm:block">
                    <h2 class="text-xl font-bold mb-6 hidden sm:block">Menu Admin</h2>
                    
                    <ul id="adminSidebarContent" class="space-y-2">
                        <li>
                            <button id="menuSummary" onclick="showAdminSection('summary')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 bg-blue-600 hover:bg-blue-700">
                                <ion-icon name="speedometer-outline" class="text-lg mr-3"></ion-icon> Ringkasan Harian
                            </button>
                        </li>
                        <li>
                            <button id="menuRekap" onclick="showAdminSection('rekap')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="calendar-outline" class="text-lg mr-3"></ion-icon> Rekap Kehadiran
                            </button>
                        </li>
                        <li class="mb-1">
                            <a href="#" onclick="showAdminSection('statistics')" id="menuStatistics" class="flex items-center p-3 rounded-lg hover:bg-blue-700 hover:text-white transition duration-150">
                                <ion-icon name="stats-chart-outline" class="mr-3 text-2xl"></ion-icon>
                                Statistik Kehadiran
                            </a>
                        </li>
                        <li>
                            <button id="menuWorkhours" onclick="showAdminSection('workhours')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="briefcase-outline" class="text-lg mr-3"></ion-icon> Manajemen Jam Kerja
                            </button>
                        </li>
                        <li>
                            <button id="menuEmployees" onclick="showAdminSection('employees')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="people-outline" class="text-lg mr-3"></ion-icon> Manajemen Karyawan
                            </button>
                        </li>
                        <li>
                            <button id="menuMasters" onclick="showAdminSection('masters')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="archive-outline" class="text-lg mr-3"></ion-icon> Master Data
                            </button>
                        </li>
                                                <li>
                            <button id="menuTimeoffBalance" onclick="showAdminSection('timeoffbalance')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="today-outline" class="text-lg mr-3"></ion-icon> Saldo Cuti Karyawan
                            </button>
                        </li>
                        <!-- Grup Menu PENGAJUAN (ACCORDION BARU) -->
                        <li>
                            <button id="menuRequests" onclick="toggleSubMenu('requestsSubMenu')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="document-text-outline" class="text-lg mr-3"></ion-icon> 
                                <span class="flex-1">Pengajuan (Requests)</span>
                                <ion-icon id="requestsSubMenuIcon" name="chevron-down-outline" class="text-lg transition-transform duration-300"></ion-icon>
                            </button>
                        </li>
                        <!-- Sub Menu Requests (Default Hidden, overflow-hidden untuk transisi) -->
                        <ul id="requestsSubMenu" class="space-y-1 pl-4 h-0 overflow-hidden transition-all duration-300 ease-in-out">
                            <li>
                                <button id="menuReqAttendance" onclick="showAdminSection('reqattendance')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="time-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Koreksi Kehadiran
                                </button>
                            </li>
                            <li>
                                <button id="menuReqTimeoff" onclick="showAdminSection('reqtimeoff')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="calendar-number-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Izin / Cuti
                                </button>
                            </li>
                            <li>
                                <button id="menuReqOvertime" onclick="showAdminSection('reqovertime')" class="w-full flex items-center p-2 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                    <ion-icon name="stopwatch-outline" class="text-lg mr-3 text-gray-400"></ion-icon> Lembur
                                </button>
                            </li>
                        </ul>
                        <!-- Akhir Sub Menu Requests -->
                        <!-- Akhir Grup Menu Pengajuan -->
                        <li id="menuCompaniesContainer" class="hidden"> <!-- Kontainer untuk menu Super Admin -->
                            <button id="menuCompanies" onclick="showAdminSection('companies')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="business-outline" class="text-lg mr-3"></ion-icon> Manajemen Perusahaan
                            </button>
                        </li>
                        <li>
                            <button id="menuEmployeeSalaries" onclick="showAdminSection('employeesalaries')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="wallet-outline" class="text-lg mr-3"></ion-icon> Gaji Karyawan
                            </button>
                        </li>
                        <li>
                            <button id="menuPayroll" onclick="showAdminSection('payroll')" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium transition duration-150 hover:bg-gray-700">
                                <ion-icon name="cash-outline" class="text-lg mr-3"></ion-icon> Payroll & Gaji
                            </button>
                        </li>
                        <!-- Tambahkan menu-menu baru di sini di masa depan -->
                    </ul>
                </nav>

                <!-- KONTEN UTAMA (Tempat Header dan Isi Dashboard berada) -->
                <main class="flex-grow p-4 sm:p-6 lg:p-8 bg-gray-50 overflow-y-auto">
                    
                    <!-- Header Admin (Dipindahkan ke dalam <main>) -->
                    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b pb-4">
                        <div class="flex items-center"> <!-- Kolom Kiri Header (DIUBAH) -->
                            <button id="sidebarToggleButton" onclick="toggleAdminSidebar()" class="text-gray-600 hover:text-gray-900 transition mr-4 block sm:hidden">
                                <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
                            </button>
                            <div>
                                <h1 id="adminHeaderTitle" class="text-3xl font-extrabold text-gray-900">Dashboard Admin <span id="adminRoleDisplay" class="text-sm font-medium text-blue-600"></span></h1>
                                <!-- Menampilkan Nama & Email Admin yang Login (BARU) -->
                                <p id="adminInfoDisplay" class="text-gray-900 font-normal mt-1 text-sm">Nama Admin (email@domain.com)</p>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 flex items-center space-x-4"> <!-- Kolom Kanan Header -->
                            <button onclick="changeView('karyawanView')" class="flex items-center text-blue-600 hover:text-blue-800 transition text-sm font-medium">
                                <ion-icon name="person-outline" class="mr-1"></ion-icon> Halaman Karyawan
                            </button>
                            <button onclick="doLogout()" class="flex items-center text-red-500 hover:text-red-700 transition text-sm font-medium">
                                <ion-icon name="log-out-outline" class="mr-1"></ion-icon> Logout
                            </button>
                        </div>
                    </header>

                    <!-- Kontainer Konten Sesuai Sidebar -->
                    <div id="adminContentContainer">
                        <!-- SECTION 1: RINGKASAN HARIAN (ID DIPERBAIKI) -->
                        <div id="sectionSummary" style="display: none;">
                            <!-- Kartu Statistik -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Total Karyawan</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="adminTotalEmployees">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Hadir (Clock In)</p>
                                    <p class="text-3xl font-bold text-green-600 mt-1" id="adminTotalHadir">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Izin / Sakit</p>
                                    <p class="text-3xl font-bold text-yellow-600 mt-1" id="adminTotalIzin">0</p>
                                </div>
                                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 text-center">
                                    <p class="text-sm font-medium text-gray-500">Alpa</p>
                                    <p class="text-3xl font-bold text-red-600 mt-1" id="adminTotalAlpa">0</p>
                                </div>
                            </div>
                        
                            <!-- Filter dan Tabel -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-3 sm:space-y-0">
                                    <h2 class="text-xl font-semibold text-gray-800">Tabel Kehadiran Harian</h2>
                                    <input type="date" id="adminAttendanceDateFilter" class="border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Tabel Responsif -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="adminAttendanceTableBody">
                                            <!-- Data akan dimasukkan di sini oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <p id="adminNoDataMessage" class="hidden text-center text-gray-500 mt-4">Tidak ada data kehadiran untuk tanggal ini.</p>
                            </div>
                        </div> <!-- End sectionSummary -->

                        <!-- SECTION 2: MANAJEMEN KARYAWAN (ID DIPERBAIKI) -->
                        <div id="sectionEmployees" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Daftar Karyawan</h2>
                                    <button onclick="openEmployeeModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="person-add-outline" class="mr-1"></ion-icon> Tambah Karyawan Baru
                                    </button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Karyawan</th>
                                                <th id="companyColumnHeader" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="employeeListTableBody">
                                            <!-- Data akan dimuat di sini oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionEmployees -->

                        <!-- ============================================= -->
                        <!-- SECTION 2.1: MANAJEMEN GAJI KARYAWAN (BARU) -->
                        <!-- ============================================= -->
                        <div id="sectionEmployeesalaries" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Pengaturan Komponen Gaji Karyawan</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <!-- Filter Karyawan -->
                                    <div class="md:col-span-2">
                                        <label for="salaryEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Pilih Karyawan</label>
                                        <!-- ID ini akan diisi dengan semua karyawan -->
                                        <select id="salaryEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Pilih Karyawan untuk Mulai --</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Tombol Tambah Komponen -->
                                    <div class="md:col-span-2 flex items-end">
                                        <button onclick="openEmployeeSalaryModal('add')" id="addSalaryComponentButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium text-sm disabled:opacity-50" disabled>
                                            <ion-icon name="add-outline" class="text-lg mr-1"></ion-icon> Tambah Komponen Gaji
                                        </button>
                                    </div>
                                </div>
                                
                                <h3 id="salaryComponentName" class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4 hidden">Komponen Gaji untuk [Nama Karyawan]</h3>

                                <!-- Tabel Hasil Pengaturan Gaji -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe Gaji</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Nominal (Rp)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="employeeSalariesTableBody">
                                            <tr><td colspan="4" class="text-center py-8 text-gray-500">Silakan pilih karyawan dari daftar di atas.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionEmployeeSalaries -->

                        <!-- SECTION 3: MANAJEMEN PERUSAHAAN (BARU) -->
                        <div id="sectionCompanies" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Daftar Perusahaan</h2>
                                    <button onclick="openCompanyModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Perusahaan Baru
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Perusahaan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Dibuat</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="companyListTableBody">
                                            <!-- Data perusahaan akan dimuat oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionCompanies -->

                        <!-- SECTION 4: REKAP KEHADIRAN (BARU) -->
                        <div id="sectionRekap" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Laporan Kehadiran</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal -->
                                    <!-- Filter Periode Bulan (BARU) -->
                                    <div class="md:col-span-2">
                                        <label for="rekapMonthFilter" class="block text-xs font-medium text-gray-700 mb-1">Pilih Periode Bulan</label>
                                        <input type="month" id="rekapMonthFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="rekapEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="rekapEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                            <!-- Opsi akan diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="rekapStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Kehadiran</label>
                                        <select id="rekapStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Hadir">Hadir</option>
                                            <option value="Terlambat">Terlambat</option>
                                            <option value="Izin / Cuti">Izin / Cuti</option>
                                            <option value="Alpa">Alpa</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                                    <button id="rekapFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-2">
                                        <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Rekap
                                    </button>
                                    <button id="rekapDownloadButton" onclick="exportAttendanceData()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition font-medium mb-2 disabled:opacity-50" disabled>
                                        <ion-icon name="download-outline" class="text-lg mr-1"></ion-icon> Download Data (.xlsx)
                                    </button>
                                </div>    
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-2">Hasil Rekap</h3>
                                <!-- KARTU STATISTIK REKAP (BARU) -->
                                <!-- Container ini akan 'hidden' dan baru muncul setelah data dimuat -->
                                <div id="rekapSummaryContainer" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 hidden">
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Total Hadir</p>
                                        <p class="text-2xl font-bold text-green-600 mt-1" id="rekapTotalHadir">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Terlambat</p>
                                        <p class="text-2xl font-bold text-yellow-600 mt-1" id="rekapTotalTerlambat">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Izin / Cuti</p>
                                        <p class="text-2xl font-medium text-gray-500" id="rekapTotalIzin">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 text-center">
                                        <p class="text-sm font-medium text-gray-500">Alpa</p>
                                        <p class="text-2xl font-bold text-red-600 mt-1" id="rekapTotalAlpa">0</p>
                                    </div>
                                </div>

                                <!-- Tabel Hasil Rekap -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="rekapTableBody">
                                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Rekap'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionRekap -->

                        <!-- SECTION 5: STATISTIK KEHADIRAN KUMULATIF (BARU) -->
                        <!-- ============================================== -->
                        <div id="sectionStatistics" class="hidden">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Statistik Kehadiran Karyawan</h2>

                                <!-- Filter Tanggal -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6 border-b pb-4">
                                    <div class="md:col-span-1">
                                        <label for="statsStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                        <input type="date" id="statsStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="statsEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                        <input type="date" id="statsEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="md:col-span-1 flex items-end">
                                        <button id="statsFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                                            <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Statistik
                                        </button>
                                    </div>
                                </div>

                                <!-- Tabel Statistik Hasil -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky-col">Karyawan</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Terlambat</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Izin / Cuti</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Alpa</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Hari Kerja</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="statsTableBody">
                                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Pilih rentang tanggal untuk melihat statistik.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 5: PENGAJUAN KOREKSI KEHADIRAN (BARU) -->
                        <div id="sectionReqattendance" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Koreksi Kehadiran</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqAttStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="reqAttStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqAttEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="reqAttEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="reqAttEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqAttEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                            <!-- Opsi akan diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="reqAttStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqAttStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqAttFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan</h3>

                                <!-- Tabel Hasil Pengajuan -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Kehadiran</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Pulang</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi (Alasan)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status Pengajuan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqAttTableBody">
                                            <tr><td colspan="8" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionReqAttendance -->

                        <!-- SECTION 6: PENGAJUAN IZIN / CUTI (BARU) -->
                        <div id="sectionReqtimeoff" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Izin / Cuti</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal (Gunakan ID unik) -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqTimeoffStartDate" class="block text-xs font-medium text-gray-700 mb-1">Dari Tanggal</label>
                                            <input type="date" id="reqTimeoffStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqTimeoffEndDate" class="block text-xs font-medium text-gray-700 mb-1">Sampai Tanggal</label>
                                            <input type="date" id="reqTimeoffEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan (Gunakan ID unik) -->
                                    <div>
                                        <label for="reqTimeoffEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqTimeoffEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                        </select>
                                    </div>

                                    <!-- Filter Status (Gunakan ID unik) -->
                                    <div>
                                        <label for="reqTimeoffStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqTimeoffStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqTimeoffFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan Izin/Cuti
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan</h3>

                                <!-- Tabel Hasil Pengajuan (Gunakan ID unik) -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Pengajuan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Timeoff</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Mulai</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Akhir</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqTimeoffTableBody">
                                            <tr><td colspan="9" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 7: PENGAJUAN LEMBUR (BARU) -->
                        <div id="sectionReqovertime" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Filter Pengajuan Lembur</h2>

                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    
                                    <!-- Filter Rentang Tanggal Lembur -->
                                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="reqOvertimeStartDate" class="block text-xs font-medium text-gray-700 mb-1">Tgl Lembur Dari</label>
                                            <input type="date" id="reqOvertimeStartDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="reqOvertimeEndDate" class="block text-xs font-medium text-gray-700 mb-1">Tgl Lembur Sampai</label>
                                            <input type="date" id="reqOvertimeEndDate" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>

                                    <!-- Filter Karyawan -->
                                    <div>
                                        <label for="reqOvertimeEmployeeFilter" class="block text-xs font-medium text-gray-700 mb-1">Nama Karyawan</label>
                                        <select id="reqOvertimeEmployeeFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Karyawan --</option>
                                        </select>
                                    </div>

                                    <!-- Filter Status -->
                                    <div>
                                        <label for="reqOvertimeStatusFilter" class="block text-xs font-medium text-gray-700 mb-1">Status Pengajuan</label>
                                        <select id="reqOvertimeStatusFilter" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- Semua Status --</option>
                                            <option value="Diajukan">Diajukan</option>
                                            <option value="Disetujui">Disetujui</option>
                                            <option value="Ditolak">Ditolak</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="reqOvertimeFilterButton" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-8">
                                    <ion-icon name="search-outline" class="text-lg mr-1"></ion-icon> Tampilkan Pengajuan Lembur
                                </button>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Daftar Pengajuan Lembur</h3>

                                <!-- Tabel Hasil Pengajuan -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Diajukan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Lembur</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mulai - Akhir</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="reqOvertimeTableBody">
                                            <tr><td colspan="8" class="text-center py-8 text-gray-500">Silakan atur filter dan klik 'Tampilkan Pengajuan Lembur'.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionReqovertime -->

                        <!-- ============================================= -->
                        <!-- SECTION 8: MASTER DATA (BARU)               -->
                        <!-- ============================================= -->
                        <div id="sectionMasters" style="display: none;">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manajemen Master Data</h2>

                            <!-- Kontainer Tab -->
                            <div class="mb-4 border-b border-gray-200">
                                <nav class="flex -mb-px space-x-8" aria-label="Tabs">
                                    <!-- Tab 1: Tipe Izin/Cuti (Aktif) -->
                                    <button id="tabMasterTimeoff" onclick="showMasterTab('timeoff')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                                        Tipe Izin/Cuti
                                    </button>
                                    <!-- Tab 2: Tipe Gaji -->
                                    <button id="tabMasterSalary" onclick="showMasterTab('salary')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        Tipe Gaji
                                    </button>
                                    <!-- Tab 3: Tipe Potongan -->
                                    <button id="tabMasterDeduction" onclick="showMasterTab('deduction')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        Tipe Potongan
                                    </button>
                                    <!-- BARU: Tab 4: Hari Libur Nasional -->
                                    <button id="tabMasterHoliday" onclick="showMasterTab('holiday')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        Hari Libur
                                    </button>
                                </nav>
                            </div>

                            <!-- Konten Tab -->
                            <div>
                                <!-- Konten 1: Tipe Izin/Cuti -->
                                <div id="masterContentTimeoff">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Tipe Izin/Cuti</h3>
                                            <button onclick="openMasterModal('add', 'timeoff')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Tipe Baru
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tipe Izin/Cuti</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi (Opsional)</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="timeoffTypesTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Konten 2: Tipe Gaji (Aktif) -->
                                <div id="masterContentSalary" class="hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Tipe Gaji</h3>
                                            <!-- (PENTING) 'salary' merujuk ke tipe di JS -->
                                            <button onclick="openMasterModal('add', 'salary')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Tipe Gaji
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tipe Gaji</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai (Rp/%)</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="salaryTypesTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Konten 3: Tipe Potongan (Aktif) -->
                                <div id="masterContentDeduction" class="hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Tipe Potongan</h3>
                                            <!-- (PENTING) 'deduction' merujuk ke tipe di JS -->
                                            <button onclick="openMasterModal('add', 'deduction')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Tipe Potongan
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Tipe Potongan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai (Rp/%)</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="deductionTypesTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- Konten 4: Hari Libur Nasional (BARU) -->
                                <div id="masterContentHoliday" class="hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-6">
                                            <h3 class="text-xl font-semibold text-gray-800">Daftar Hari Libur Nasional/Khusus</h3>
                                            <button onclick="openHolidayModal('add')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                                <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Hari Libur
                                            </button>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-4">
                                            Hari libur yang ditetapkan di sini akan membebaskan karyawan dari kewajiban clock-in.
                                        </p>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Hari Libur</th>
                                                        <th id="holidayCompanyHeader" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200" id="holidayListTableBody">
                                                    <!-- Data diisi oleh JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End sectionMasters -->

                        <!-- ============================================= -->
                        <!-- SECTION 9: MANAJEMEN JAM KERJA (BARU)       -->
                        <!-- ============================================= -->
                        <div id="sectionWorkhours" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Manajemen Jam Kerja</h2>
                                    <button onclick="openWorkhourModal('add')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Pola Jam Kerja
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Buat pola jam kerja (cth: "Shift Pagi", "Full-time") lalu tugaskan karyawan ke pola ini di menu "Manajemen Karyawan".
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pola Jam Kerja</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="workhoursTableBody">
                                            <!-- Data diisi oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionWorkhours -->

                        <!-- ============================================= -->
                        <!-- SECTION 10: MANAJEMEN SALDO CUTI (BARU)     -->
                        <!-- ============================================= -->
                        <div id="sectionTimeoffbalance" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800">Manajemen Saldo Cuti Tahunan</h2>
                                    <button onclick="openTimeoffBalanceModal('add')" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-medium">
                                        <ion-icon name="add-outline" class="mr-1"></ion-icon> Tambah Saldo Baru
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Atur jatah hari cuti tahunan (atau cuti berbatas lainnya) untuk setiap karyawan.
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Karyawan</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe Cuti</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Sisa (Hari)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="timeoffBalanceTableBody">
                                            <!-- Data diisi oleh JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div> <!-- End sectionTimeoffbalance -->

                        <!-- SECTION 11: PAYROLL & GAJI (BARU) -->
                        <div id="sectionPayroll" style="display: none;">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                                    <ion-icon name="cash-outline" class="text-2xl mr-2 text-blue-600"></ion-icon>
                                    Perhitungan & Riwayat Payroll
                                </h2>

                                <!-- KARTU PERHITUNGAN BARU -->
                                <div class="p-4 sm:p-6 bg-blue-50 border border-blue-200 rounded-xl mb-8">
                                    <h3 class="text-lg font-bold text-blue-700 mb-4">Proses Gaji Bulanan</h3>
                                    <p class="text-sm text-gray-600 mb-4">Pilih periode, hitung data kehadiran dan komponen gaji, lalu simpan hasil payroll.</p>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <!-- Filter Bulan -->
                                        <div>
                                            <label for="payrollMonthFilter" class="block text-xs font-medium text-gray-700 mb-1">Periode Gaji (Bulan)</label>
                                            <!-- Input month format: YYYY-MM -->
                                            <input type="month" id="payrollMonthFilter" required class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        
                                        <!-- Tombol Proses -->
                                        <div class="md:col-span-2 flex items-end">
                                            <button id="calculatePayrollButton" onclick="calculateAndSavePayroll()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition font-medium text-sm disabled:opacity-50 flex items-center justify-center">
                                                <ion-icon name="calculator-outline" class="text-lg mr-2"></ion-icon> Hitung & Proses Payroll
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- RIWAYAT PAYROLL -->
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">Riwayat Payroll Tersimpan</h3>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Periode</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Karyawan</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gaji Bersih (Rp)</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Proses</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="payrollHistoryTableBody">
                                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Memuat riwayat penggajian...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End adminContentContainer -->
                </main> <!-- End main -->
            </div> <!-- End flex container -->
        </div> <!-- End adminView -->

            <!-- ============================================== -->
            <!-- FOOTER NAVIGASI KARYAWAN (BARU)              -->
            <!-- ============================================== -->
            <footer id="karyawanFooterNav" class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 shadow-xl hidden">
                <div class="grid grid-cols-5 h-16 max-w-lg mx-auto">
                    
                    <!-- 1. Request Attendance (Koreksi Absensi) -->
                    <button id="tabRequestAttendance" onclick="showKaryawanContent('Requests')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="document-text-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Request</span>
                    </button>

                    <!-- 2. Request Timeoff (Cuti/Izin) -->
                    <button id="tabRequestTimeoff" onclick="showKaryawanContent('Timeoff')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="calendar-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Timeoff</span>
                    </button>

                    <!-- 3. Attendance (HOME) - Default Active -->
                    <button id="tabAttendanceHome" onclick="showKaryawanContent('Absensi')" class="flex flex-col items-center justify-center text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="home-outline" class="text-2xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Home</span>
                    </button>

                    <!-- 4. Overtime (Lembur) -->
                    <button id="tabOvertime" onclick="showKaryawanContent('Overtime')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="stopwatch-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Lembur</span>
                    </button>

                    <!-- 5. Salary (Gaji) -->
                    <button id="tabSalary" onclick="showKaryawanContent('Salary')" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150 text-xs">
                        <ion-icon name="wallet-outline" class="text-xl"></ion-icon>
                        <span class="mt-1 text-xs sm:inline">Gaji</span>
                    </button>

                </div>
            </footer>

        </div> <!-- End AppContainer -->

            <!-- =============================================================== -->
            <!-- MODALS (DIPINDAHKAN KE LUAR TAMPILAN)                         -->
            <!-- =============================================================== -->

            <!-- Modal Konfirmasi Lokasi Absen (BARU) -->
            <div id="locationConfirmModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeLocationConfirmModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="locationConfirmModalTitle">
                                Konfirmasi Lokasi Absensi
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600 mb-4">
                                    Lokasi Anda saat ini telah didapatkan. Mohon pastikan titik pada peta sudah sesuai dengan posisi Anda.
                                </p>

                                <!-- Kontainer Peta -->
                                <div class="mb-4">
                                    <div id="mapIframeContainer" class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
                                        <!-- Google Maps Iframe akan dimasukkan di sini oleh JS -->
                                        <p class="text-gray-500">Memuat peta...</p>
                                    </div>
                                </div>

                                <!-- Info Lokasi -->
                                <p class="text-xs text-gray-500 mb-4">
                                    Koordinat: <strong id="locationConfirmCoords">Memuat...</strong>
                                </p>

                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="confirmClockInButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Lanjutkan Clock-In
                            </button>
                            <button type="button" onclick="closeLocationConfirmModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                Batalkan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Ubah Status Kehadiran -->
            <div id="statusModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Ubah Status Kehadiran
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500 mb-4">Karyawan: <span id="modalEmployeeName" class="font-semibold text-gray-700"></span></p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label for="modalStatus" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="modalStatus" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                            <option value="Hadir">Hadir</option>
                                            <option value="Terlambat">Terlambat</option>
                                            <option value="Izin / Cuti">Izin / Cuti</option>
                                            <option value="Alpa">Alpa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="modalClockIn" class="block text-sm font-medium text-gray-700">Jam Masuk (Jika Hadir)</label>
                                        <input type="time" id="modalClockIn" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled>
                                    </div>
                                    <div>
                                        <label for="modalClockOut" class="block text-sm font-medium text-gray-700">Jam Pulang (Jika Hadir)</label>
                                        <input type="time" id="modalClockOut" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="modalSaveButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Simpan
                            </button>
                            <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Tambah/Edit Karyawan -->
            <div id="employeeModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeEmployeeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
                        <form id="employeeForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="employeeModalTitle">
                                    Tambah Karyawan Baru
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Input Email & Password -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                            <input type="email" id="employeeEmail" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="employeePassword" class="block text-sm font-medium text-gray-700">Password</label>
                                            <input type="password" id="employeePassword" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>

                                    <!-- Nama & ID Karyawan -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeFullName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                            <input type="text" id="employeeFullName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                        <div>
                                            <label for="employeeIDNumber" class="block text-sm font-medium text-gray-700">ID Karyawan</label>
                                            <input type="text" id="employeeIDNumber" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                        </div>
                                    </div>
                                    
                                    <!-- Pilih Perusahaan (Hanya untuk Super Admin) -->
                                    <div id="companySelectContainer" class="hidden">
                                        <label for="employeeCompany" class="block text-sm font-medium text-gray-700">Perusahaan</label>
                                        <select id="employeeCompany" onchange="loadWorkhourDropdown('employeeWorkhour', this.value)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <!-- Opsi perusahaan akan dimuat oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Role & Status -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="employeeRole" class="block text-sm font-medium text-gray-700">Peran (Role)</label>
                                            <select id="employeeRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="karyawan">Karyawan</option>
                                                <option value="company_admin">Company Admin</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="employeeStatus" class="block text-sm font-medium text-gray-700">Status</label>
                                            <select id="employeeStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="Percobaan">Percobaan</option>
                                                <option value="Kontrak">Kontrak</option>
                                                <option value="Tetap">Tetap</option>
                                                <option value="Freelance">Freelance</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- (BARU) PILIH POLA JAM KERJA -->
                                    <div id="workhourSelectContainer">
                                        <label for="employeeWorkhour" class="block text-sm font-medium text-gray-700">Pola Jam Kerja</label>
                                        <select id="employeeWorkhour" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Pola Jam Kerja --</option>
                                            <!-- Opsi akan dimuat oleh JS dari tabel workhours -->
                                        </select>
                                    </div>

                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveEmployeeButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan & Daftarkan
                                </button>
                                <button type="button" onclick="closeEmployeeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Tambah/Edit Gaji Karyawan (BARU) -->
            <div id="employeeSalaryModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeEmployeeSalaryModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="employeeSalaryForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="employeeSalaryModalTitle">
                                    Tambahkan Komponen Gaji
                                </h3>
                                <div class="mt-4 space-y-4">
                                    
                                    <!-- Display Nama Karyawan yang sedang diedit -->
                                    <p class="text-sm text-gray-600 mb-2">Untuk Karyawan: <strong id="modalSalaryEmployeeName"></strong></p>

                                    <!-- Pilih Tipe Gaji (Hanya mode ADD) -->
                                    <div id="salaryTypeSelectContainer">
                                        <label for="modalSalaryTypeSelect" class="block text-sm font-medium text-gray-700">Tipe Komponen Gaji</label>
                                        <select id="modalSalaryTypeSelect" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Tipe Gaji --</option>
                                            <!-- Opsi diisi oleh JS dari salary_types -->
                                        </select>
                                    </div>
                                    
                                    <!-- Display Metode Perhitungan -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Metode Perhitungan</label>
                                        <p id="modalSalaryMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm bg-gray-100 text-gray-700">Nominal Tetap</p>
                                    </div>

                                    <!-- Jumlah Nominal -->
                                    <div>
                                        <label for="modalSalaryAmount" class="block text-sm font-medium text-gray-700">Nominal (Rp.)</label>
                                        <input type="number" id="modalSalaryAmount" step="1" required min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Masukkan jumlah nominal (cth: 5000000)">
                                        <p id="modalSalaryInfo" class="text-xs text-gray-500 mt-1 hidden">Informasi: Tipe gaji ini akan menggunakan nominal di atas sebagai patokan per jam lembur/per hari absensi, bukan nominal tetap bulanan.</p>
                                    </div>

                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveEmployeeSalaryButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan Komponen Gaji
                                </button>
                                <button type="button" onclick="closeEmployeeSalaryModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>    

            <!-- Modal Tambah/Edit Perusahaan -->
            <div id="companyModal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeCompanyModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="companyForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="companyModalTitle">
                                    Tambah Perusahaan Baru
                                </h3>
                                <div class="mt-4">
                                    <div>
                                        <label for="companyName" class="block text-sm font-medium text-gray-700">Nama Perusahaan</label>
                                        <input type="text" id="companyName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                                <!-- (BARU) Tanggal Mulai Penggajian -->
                                <div>
                                    <label for="companyPayrollStartDay" class="block text-sm font-medium text-gray-700">Tgl Mulai Penggajian Bulanan</label>
                                    <input type="number" id="companyPayrollStartDay" min="1" max="28" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Contoh: 1 atau 21" value="1">
                                    <p class="text-xs text-gray-500 mt-1">Gaji dihitung dari tanggal ini hingga H-1 di bulan pembayaran.</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveCompanyButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan
                                </button>
                                <button type="button" onclick="closeCompanyModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Status Perusahaan (BARU) -->
            <div id="companyStatusModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmStatusModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="companyStatusModalTitle">
                                Konfirmasi Perubahan Status
                                </h3>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600" id="companyStatusModalText">
                                    Apakah Anda yakin ingin mengubah status perusahaan ini?
                                    </p>
                                </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="companyStatusConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Ubah Status
                            </button>
                            <button type="button" onclick="closeConfirmStatusModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Alasan Keterlambatan (BARU) -->
            <div id="lateReasonModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <!-- Konten Modal -->
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="lateReasonForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="lateReasonModalTitle">
                                    Anda Terlambat
                                </h3>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600 mb-4">
                                        Waktu clock-in Anda melewati batas toleransi. Silakan isi alasan keterlambatan Anda di bawah ini.
                                    </p>
                                    <div>
                                        <label for="lateReasonDescription" class="block text-sm font-medium text-gray-700">Alasan Keterlambatan</label>
                                        <textarea id="lateReasonDescription" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Terjebak macet di jalan..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="lateReasonSubmitButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Kirim Alasan & Clock-In
                                </button>
                                <button type="button" onclick="closeLateReasonModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batalkan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Add/Edit Master Data (BARU) -->
            <div id="masterDataModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeMasterModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="masterDataForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="masterModalTitle">
                                    Tambah Data Master
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div>
                                        <label for="masterName" class="block text-sm font-medium text-gray-700">Nama</label>
                                        <input type="text" id="masterName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <!-- DROPDOWN PERUSAHAAN (BARU) -->
                                    <div id="masterCompanySelectContainer" class="hidden">
                                        <label for="masterCompanySelect" class="block text-sm font-medium text-gray-700">Perusahaan</label>
                                        <select id="masterCompanySelect" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="masterDescription" class="block text-sm font-medium text-gray-700">Deskripsi (Opsional)</label>
                                        <textarea id="masterDescription" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"></textarea>
                                    </div>
                                    <!-- (BARU) Field Khusus Tipe Potongan -->
                                    <div id="masterDeductionFields" class="hidden space-y-4 pt-4 border-t">
                                        <h4 class="text-sm font-medium text-gray-500">Aturan Potongan</h4>
                                        <div>
                                            <label for="masterDeductionMethod" class="block text-sm font-medium text-gray-700">Metode Perhitungan</label>
                                            <select id="masterDeductionMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="Nominal Tetap">Nominal Tetap</option>
                                                <option value="Persentase">Persentase</option>
                                                <option value="Berdasarkan Absensi">Berdasarkan Absensi</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="masterDeductionValue" class="block text-sm font-medium text-gray-700">Nilai (Rp. atau %)</label>
                                            <input type="number" id="masterDeductionValue" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Contoh: 10000 atau 5 (untuk 5%)">
                                        </div>
                                        <!-- (BARU) DROPDOWN KONDISI (PEMICU) -->
                                        <div id="masterDeductionConditionContainer" class="hidden"> 
                                            <label for="masterDeductionCondition" class="block text-sm font-medium text-gray-700">Terapkan Jika Status Absensi</label>
                                            <select id="masterDeductionCondition" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="">-- Pilih Pemicu --</option>
                                                <option value="Terlambat">Terlambat</option>
                                                <option value="Alpa">Alpa</option>
                                                <option value="Izin / Cuti">Izin / Cuti</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- (BARU) Field Khusus Tipe Gaji -->
                                    <div id="masterSalaryFields" class="hidden space-y-4 pt-4 border-t">
                                        <h4 class="text-sm font-medium text-gray-500">Aturan Tunjangan/Gaji</h4>
                                        <div>
                                            <label for="masterSalaryMethod" class="block text-sm font-medium text-gray-700">Metode Perhitungan</label>
                                            <select id="masterSalaryMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <!-- Opsi dari ENUM 'salary_method_enum' -->
                                                <option value="Nominal Tetap">Nominal Tetap</option>
                                                <option value="Berdasarkan Lembur">Berdasarkan Lembur</option>
                                                <option value="Berdasarkan Absensi">Berdasarkan Absensi</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="masterSalaryValue" class="block text-sm font-medium text-gray-700">Nilai (Rp)</label>
                                            <input type="number" id="masterSalaryValue" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: 25000 (untuk per jam lembur)">
                                        </div>
                                        
                                        <!-- (BARU) DROPDOWN KONDISI (PEMICU) UNTUK GAJI -->
                                        <div id="masterSalaryConditionContainer" class="hidden"> 
                                            <label for="masterSalaryCondition" class="block text-sm font-medium text-gray-700">Pemicu Aturan</label>
                                            <select id="masterSalaryCondition" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <option value="">-- Pilih Pemicu --</option>
                                                <!-- Pemicu untuk 'Berdasarkan Lembur' -->
                                                <option value="overtime_approved">Lembur Disetujui</option>
                                                <!-- Pemicu untuk 'Berdasarkan Absensi' -->
                                                <option value="Hadir">Bonus Kehadiran (Hadir)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- (BARU) Field Khusus Tipe Izin/Cuti -->
                                    <div id="masterTimeoffFields" class="hidden space-y-4 pt-4 border-t">
                                        <h4 class="text-sm font-medium text-gray-500">Aturan Cuti</h4>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="masterTimeoffDeductible" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                            <label for="masterTimeoffDeductible" class="ml-2 block text-sm text-gray-700">Kurangi Saldo Cuti Karyawan</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveMasterButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan
                                </button>
                                <button type="button" onclick="closeMasterModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Delete Master Data (BARU) -->
            <div id="masterDeleteModal" class="fixed z-40 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmDeleteModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Konfirmasi Hapus
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600" id="masterDeleteText">
                                    Apakah Anda yakin ingin menghapus data ini?
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="masterDeleteConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Hapus
                            </button>
                            <button type="button" onclick="closeConfirmDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Add/Edit Jam Kerja (BARU) -->
            <div id="workhourModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeWorkhourModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <!-- Konten Modal (Dibuat lebih lebar: sm:max-w-3xl) -->
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                        <form id="workhourForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="workhourModalTitle">
                                    Tambah Pola Jam Kerja
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Nama Pola dan Perusahaan (jika Super Admin) -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="workhourName" class="block text-sm font-medium text-gray-700">Nama Pola Jam Kerja</label>
                                            <input type="text" id="workhourName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Full-time (08-17)">
                                        </div>
                                        <div id="workhourCompanyContainer" class="hidden">
                                            <label for="workhourCompanySelect" class="block text-sm font-medium text-gray-700">Perusahaan</tabel>
                                            <select id="workhourCompanySelect" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                                <!-- Opsi diisi oleh JS -->
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Pengaturan Jadwal 7 Hari -->
                                    <div class="space-y-3 pt-4 border-t">
                                        <h4 class="text-md font-medium text-gray-800">Atur Jadwal Mingguan</h4>
                                        <!-- (JS akan digunakan untuk enable/disable time input) -->
                                        <!-- Nama hari (cth: 'senin') HARUS lowercase untuk ID -->
                                        
                                        <!-- HARI (Dibuat sebagai Grid) -->
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4">
                                            <!-- Contoh 1 Hari: Senin -->
                                            <div id="wh_day_senin" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Senin</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_senin_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_senin_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_senin_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_senin_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Selasa -->
                                            <div id="wh_day_selasa" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Selasa</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_selasa_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_selasa_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_selasa_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_selasa_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Rabu -->
                                            <div id="wh_day_rabu" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Rabu</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_rabu_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_rabu_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_rabu_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_rabu_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Kamis -->
                                            <div id="wh_day_kamis" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Kamis</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_kamis_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_kamis_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_kamis_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_kamis_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Jumat -->
                                            <div id="wh_day_jumat" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Jumat</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_jumat_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                                        <label for="wh_jumat_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_jumat_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="08:00">
                                                    <input type="time" id="wh_jumat_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="17:00">
                                                </div>
                                            </div>
                                            <!-- Sabtu -->
                                            <div id="wh_day_sabtu" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Sabtu</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_sabtu_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
                                                        <label for="wh_sabtu_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_sabtu_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="09:00" disabled>
                                                    <input type="time" id="wh_sabtu_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="14:00" disabled>
                                                </div>
                                            </div>
                                            <!-- Minggu -->
                                            <div id="wh_day_minggu" class="p-3 bg-gray-50 rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <label class="text-sm font-medium text-gray-900">Minggu</label>
                                                    <div class="flex items-center">
                                                        <input type="checkbox" id="wh_minggu_is_off" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
                                                        <label for="wh_minggu_is_off" class="ml-2 block text-xs text-gray-700">Hari Libur</label>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <input type="time" id="wh_minggu_start" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="09:00" disabled>
                                                    <input type="time" id="wh_minggu_end" class="wh_time_input w-full border border-gray-300 rounded-md p-1.5 text-sm" value="14:00" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveWorkhourButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan Pola Jam Kerja
                                </button>
                                <button type="button" onclick="closeWorkhourModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Delete Jam Kerja (BARU) -->
            <div id="workhourDeleteModal" class="fixed z-40 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmWorkhourDelete()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Konfirmasi Hapus Jam Kerja
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600" id="workhourDeleteText">
                                    Apakah Anda yakin ingin menghapus pola jam kerja ini?
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="workhourDeleteConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Hapus
                            </button>
                            <button type="button" onclick="closeConfirmWorkhourDelete()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Add/Edit Saldo Cuti (BARU) -->
            <div id="timeoffBalanceModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeTimeoffBalanceModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="timeoffBalanceForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="timeoffBalanceModalTitle">
                                    Tetapkan Saldo Cuti Baru
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <!-- Pilih Karyawan (Hanya mode ADD) -->
                                    <div id="balanceEmployeeSelectContainer">
                                        <label for="balanceEmployeeSelect" class="block text-sm font-medium text-gray-700">Karyawan</label>
                                        <select id="balanceEmployeeSelect" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Karyawan --</option>
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>

                                    <!-- Pilih Tipe Cuti (Hanya mode ADD) -->
                                    <div id="balanceTimeoffTypeSelectContainer">
                                        <label for="balanceTimeoffTypeSelect" class="block text-sm font-medium text-gray-700">Tipe Cuti (Berbatas)</label>
                                        <select id="balanceTimeoffTypeSelect" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <option value="">-- Pilih Tipe Cuti --</option>
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>
                                    
                                    <!-- Jumlah Hari Saldo -->
                                    <div>
                                        <label for="balanceDays" class="block text-sm font-medium text-gray-700">Jumlah Saldo Hari (Cth: 12)</label>
                                        <input type="number" id="balanceDays" step="0.5" required min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Masukkan jumlah hari cuti">
                                    </div>

                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveTimeoffBalanceButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan Saldo
                                </button>
                                <button type="button" onclick="closeTimeoffBalanceModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Tambah/Edit Hari Libur (BARU) -->
            <div id="holidayModal" class="fixed z-30 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeHolidayModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form id="holidayForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="holidayModalTitle">
                                    Tambah Hari Libur
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div>
                                        <label for="holidayNameInput" class="block text-sm font-medium text-gray-700">Nama Hari Libur</label>
                                        <input type="text" id="holidayNameInput" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="Cth: Hari Raya Natal">
                                    </div>
                                    <div>
                                        <label for="holidayDateInput" class="block text-sm font-medium text-gray-700">Tanggal Libur</label>
                                        <input type="date" id="holidayDateInput" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <!-- DROPDOWN PERUSAHAAN (Hanya untuk Super Admin) -->
                                    <div id="holidayCompanySelectContainer" class="hidden">
                                        <label for="holidayCompanySelect" class="block text-sm font-medium text-gray-700">Perusahaan</label>
                                        <select id="holidayCompanySelect" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                            <!-- Opsi diisi oleh JS -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" id="saveHolidayButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                                    Simpan Hari Libur
                                </button>
                                <button type="button" onclick="closeHolidayModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Konfirmasi Delete Payroll -->
            <div id="payrollDeleteModal" class="fixed z-40 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeConfirmPayrollDelete()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Konfirmasi Hapus Payroll
                            </h3>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600" id="payrollDeleteText">
                                    Apakah Anda yakin ingin menghapus hasil payroll periode ini? Tindakan ini tidak bisa dibatalkan.
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" id="payrollDeleteConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                                Ya, Hapus Permanen
                            </button>
                            <button type="button" onclick="closeConfirmPayrollDelete()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Lihat Payslip (Lihat Payslip) -->
            <div id="payslipModal" class="fixed z-40 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closePayslipModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                        <div class="bg-white px-6 pt-5 pb-4 sm:p-8 sm:pb-6">
                            <h3 class="text-2xl font-bold text-blue-600 mb-2">Slip Gaji <span id="payslipPeriod"></span></h3>
                            <p class="text-sm text-gray-600 mb-4">Karyawan: <strong id="payslipEmployeeName"></strong></p>

                            <div class="space-y-6">
                                
                                <!-- RINGKASAN GAJI -->
                                <div class="border rounded-xl p-4 bg-green-50">
                                    <h4 class="text-lg font-semibold text-green-700 mb-2">Ringkasan Pembayaran</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-500">Total Penghasilan Kotor</p>
                                            <p id="payslipGross" class="text-lg font-bold text-gray-800">Rp 0</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Total Potongan</p>
                                            <p id="payslipDeduction" class="text-lg font-bold text-red-600">Rp 0</p>
                                        </div>
                                        <div class="col-span-2 border-t pt-2">
                                            <p class="text-sm text-gray-500">Gaji Bersih (Take Home Pay)</p>
                                            <p id="payslipNet" class="text-2xl font-extrabold text-blue-700">Rp 0</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- RINCIAN PENGHASILAN -->
                                <div class="border rounded-xl p-4">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Rincian Penghasilan</h4>
                                    <table class="w-full text-left text-sm">
                                        <tbody id="payslipSalaryDetailBody">
                                            <tr><td colspan="2" class="py-2 text-gray-500">Memuat rincian...</td></tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- RINCIAN POTONGAN -->
                                <div class="border rounded-xl p-4">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Rincian Potongan</h4>
                                    <table class="w-full text-left text-sm">
                                        <tbody id="payslipDeductionDetailBody">
                                            <tr><td colspan="2" class="py-2 text-gray-500">Belum ada rincian potongan.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <p id="payslipProcessedAt" class="mt-6 text-xs text-right text-gray-500">Diproses oleh [Admin Name] pada [Tanggal]</p>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" onclick="closePayslipModal()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:w-auto sm:text-sm">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kotak Pesan Global -->
            <div id="messageBox" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

    <script>
        // ===============================================================
        // KONFIGURASI SUPABASE
        // ===============================================================
        const SUPABASE_URL = 'https://fmknmegucccckdivoslm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZta25tZWd1Y2NjY2tkaXZvc2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzAyMTUsImV4cCI6MjA3ODQ0NjIxNX0.usJdg1Pcl_UezylR09srX_-Z0W9Vo4Xxn1XAWWhCOhI';
        // ===============================================================

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // GLOBAL STATE
        let globalProfile = null; // Menyimpan data profil pengguna yang sedang login
        let currentAttendanceId = null; // ID absensi hari ini yang sedang aktif (untuk Karyawan)
        let modalAttendanceData = {}; // Data absensi yang sedang diedit di modal Admin
        let allEmployees = []; // Digunakan untuk mengisi dropdown filter
        let timeoffBalancesCache = {}; // (BARU) Cache untuk saldo cuti karyawan
        let currentRekapData = [];
        
        // DOM ELEMENTS
        const loadingView = document.getElementById('loadingView');
        const loginView = document.getElementById('loginView');
        const karyawanView = document.getElementById('karyawanView');
        const adminView = document.getElementById('adminView');
        const messageBox = document.getElementById('messageBox');
        
        // --- KARYAWAN ELEMENTS ---
        const karyawanUserName = document.getElementById('karyawanUserName');
        const karyawanAttendanceStatus = document.getElementById('karyawanAttendanceStatus');
        const karyawanClockInTime = document.getElementById('karyawanClockInTime');
        const karyawanClockOutTime = document.getElementById('karyawanClockOutTime');
        const karyawanClockInButton = document.getElementById('karyawanClockInButton');
        const karyawanClockOutButton = document.getElementById('karyawanClockOutButton');
        const karyawanAdminLink = document.getElementById('karyawanAdminLink');
        
        // --- ADMIN ELEMENTS ---
        const adminRoleDisplay = document.getElementById('adminRoleDisplay');
        const adminAttendanceTableBody = document.getElementById('adminAttendanceTableBody');
        const adminAttendanceDateFilter = document.getElementById('adminAttendanceDateFilter');
        const employeeListTableBody = document.getElementById('employeeListTableBody');

        // --- MODAL ELEMENTS ---
        const statusModal = document.getElementById('statusModal');
        const modalEmployeeName = document.getElementById('modalEmployeeName');
        const modalStatus = document.getElementById('modalStatus');
        const modalClockIn = document.getElementById('modalClockIn');
        const modalClockOut = document.getElementById('modalClockOut');
        const modalSaveButton = document.getElementById('modalSaveButton');
        const lateReasonModal = document.getElementById('lateReasonModal');
        const lateReasonForm = document.getElementById('lateReasonForm');
        const lateReasonDescription = document.getElementById('lateReasonDescription');

        let tempClockInData = {};
        
        // ===============================================================
        // HELPER FUNCTIONS (UTILITY)
        // ===============================================================

        // --- FUNGSI BARU: CRUD HARI LIBUR NASIONAL/KHUSUS ---

        const holidayModal = document.getElementById('holidayModal');
        const holidayForm = document.getElementById('holidayForm');
        const holidayListTableBody = document.getElementById('holidayListTableBody');

        // 1. Memuat Daftar Hari Libur
        async function loadHolidays() {
            const tableBody = holidayListTableBody;
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data hari libur...</td></tr>';
            document.getElementById('holidayCompanyHeader').style.display = (globalProfile.role === 'super_admin') ? 'table-cell' : 'none';

            let query = _supabase.from('holidays').select('id, holiday_name, holiday_date, company_id, companies(name)');
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('holiday_date', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat holidays:", error.message);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada hari libur yang ditetapkan.</td></tr>';
                return;
            }

            const html = data.map(item => {
                const dateDisplay = new Date(item.holiday_date + 'T00:00:00').toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: '2-digit' });
                const safeName = item.holiday_name.replace(/'/g, "\\'");

                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global</span>') 
                    : (item.companies ? item.companies.name : '-');
                    
                const companyCell = (globalProfile.role === 'super_admin') 
                    ? `<td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>` 
                    : '';

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${dateDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.holiday_name}</td>
                        ${companyCell}
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="openHolidayModal('edit', '${item.id}', '${item.holiday_date}', '${safeName}', '${item.company_id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('holiday', '${item.id}', '${safeName} (${dateDisplay})')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // 2. Membuka Modal (Add/Edit)
        async function openHolidayModal(mode, id = null, date = '', name = '', companyId = null) {
            holidayForm.reset();
            document.getElementById('holidayModalTitle').textContent = (mode === 'add') ? 'Tambah Hari Libur Baru' : `Edit Hari Libur: ${name}`;
            holidayForm.dataset.mode = mode;
            holidayForm.dataset.id = id;
            
            document.getElementById('holidayNameInput').value = name;
            document.getElementById('holidayDateInput').value = date;

            // Atur Dropdown Perusahaan untuk Super Admin
            const companySelectContainer = document.getElementById('holidayCompanySelectContainer');
            const companySelect = document.getElementById('holidayCompanySelect');

            if (globalProfile.role === 'super_admin') {
                companySelectContainer.classList.remove('hidden');
                companySelect.required = false; 
                
                const { data } = await _supabase.from('companies').select('id, name').order('name', { ascending: true });
                if (data) {
                    let options = '<option value="">-- Global (Semua Perusahaan) --</option>';
                    options += data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    companySelect.innerHTML = options;
                }
                companySelect.value = companyId || ''; 
            } else {
                companySelectContainer.classList.add('hidden');
                companySelect.required = false;
            }

            holidayModal.classList.remove('hidden');
        }

        // 3. Menutup Modal
        function closeHolidayModal() {
            holidayModal.classList.add('hidden');
        }

        // 4. Menyimpan (Add/Edit)
        holidayForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveButton = document.getElementById('saveHolidayButton');
            saveButton.disabled = true;

            const { mode, id } = holidayForm.dataset;
            const name = document.getElementById('holidayNameInput').value;
            const date = document.getElementById('holidayDateInput').value;
            
            let companyId = null;
            if (globalProfile.role === 'super_admin') {
                companyId = document.getElementById('holidayCompanySelect').value || null;
            } else {
                companyId = globalProfile.company_id;
            }

            const payload = {
                holiday_name: name,
                holiday_date: date,
                company_id: companyId
            };

            showMessage("Menyimpan hari libur...", 'info');
            
            let query;
            if (mode === 'add') {
                query = _supabase.from('holidays').insert([payload]);
            } else {
                query = _supabase.from('holidays').update(payload).eq('id', id);
            }

            const { error } = await query;
            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage('Hari libur berhasil disimpan.', 'success');
            closeHolidayModal();
            loadHolidays();
            saveButton.disabled = false;
        });

        // --- FUNGSI BARU: MEMUAT NAMA PERUSAHAAN ---
        async function loadCompanyDetails() {
            if (!globalProfile || !globalProfile.company_id) {
                document.getElementById('companyText').textContent = 'Tidak Terikat Perusahaan';
                return;
            }

            const { data, error } = await _supabase
                .from('companies')
                .select('name')
                .eq('id', globalProfile.company_id)
                .single();

            if (error || !data) {
                console.error("Gagal memuat nama perusahaan:", error?.message || 'Data tidak ditemukan');
                document.getElementById('companyText').textContent = 'Perusahaan Tidak Ditemukan';
                return;
            }

            // SET NAMA PERUSAHAAN DI HEADER KARYAWAN
            document.getElementById('companyText').textContent = data.name;
            
            // (BARU) SET NAMA PERUSAHAAN DI HEADER ADMIN
            try {
                // Mengganti teks "Dashboard Admin " dengan nama perusahaan
                document.getElementById('adminHeaderTitle').childNodes[0].nodeValue = data.name + " ";
            } catch(e) {
                console.warn("Gagal set header admin, elemen tidak ditemukan.");
            }
        }
        
        // FUNGSI NAVIGASI SIDEBAR ADMIN (DIPERBAIKI UNTUK ACCORDION)
        function showAdminSection(sectionName) {
            // Daftar semua section 
            const sections = ['summary', 'employees', 'employeesalaries', 'companies', 'rekap', 'reqattendance', 'reqtimeoff', 'reqovertime', 'masters', 'workhours', 'timeoffbalance', 'payroll', 'statistics'];
            
            // Daftar semua tombol menu (termasuk sub-menu)
            const menus = ['menuSummary', 'menuEmployees', 'menuEmployeeSalaries', 'menuCompanies', 'menuRekap', 'menuReqAttendance', 'menuReqTimeoff', 'menuReqOvertime', 'menuRequests', 'menuMasters', 'menuWorkhours', 'menuTimeoffBalance', 'menuPayroll', 'menuStatistics'];
            
            // Elemen Accordion
            const requestsMenu = document.getElementById('menuRequests');
            const requestsSubMenu = document.getElementById('requestsSubMenu');
            const requestsSubMenuIcon = document.getElementById('requestsSubMenuIcon');

            // 1. Reset semua section dan menu
            sections.forEach(name => {
                const sectionId = 'section' + name.charAt(0).toUpperCase() + name.slice(1);
                const sectionElement = document.getElementById(sectionId);
                if (sectionElement) sectionElement.style.display = 'none';
            });

            menus.forEach(menuId => {
                const menuElement = document.getElementById(menuId);
                if (menuElement) {
                    menuElement.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'bg-gray-700');
                    menuElement.classList.add('text-white', 'hover:bg-gray-700'); // Atur ulang warna default sidebar
                }
            });

            // 2. Tampilkan section yang dipilih
            const selectedSectionId = 'section' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            const selectedMenuId = 'menu' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            
            const selectedSection = document.getElementById(selectedSectionId);
            const selectedMenu = document.getElementById(selectedMenuId);

            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            if (selectedMenu) {
                selectedMenu.classList.remove('hover:bg-gray-700');
                selectedMenu.classList.add('bg-blue-600', 'hover:bg-blue-700'); // Tandai menu aktif
            }
            
            // 3. LOGIKA ACCORDION: Atur status menu Pengajuan jika sub-menu dipilih
            if (sectionName.startsWith('req')) {
                // Jika sub-menu dipilih, pastikan menu Requests (parent) terlihat aktif dan terbuka
                if(requestsMenu) {
                    requestsMenu.classList.remove('hover:bg-gray-700');
                    requestsMenu.classList.add('bg-gray-700'); // Beri warna aktif ke parent
                }
                if(requestsSubMenu && !requestsSubMenu.classList.contains('active')) {
                    // Buka Accordion jika belum terbuka
                    requestsSubMenu.style.height = requestsSubMenu.scrollHeight + 'px';
                    requestsSubMenu.classList.add('active');
                    requestsSubMenuIcon.classList.add('rotate-180');
                }
            } else {
                // Jika menu non-Request yang dipilih, pastikan sub-menu Requests tertutup
                if(requestsSubMenu && requestsSubMenu.classList.contains('active')) {
                    requestsSubMenu.style.height = '0';
                    requestsSubMenu.classList.remove('active');
                    requestsSubMenuIcon.classList.remove('rotate-180');
                }
                if(requestsMenu) {
                    requestsMenu.classList.remove('bg-gray-700');
                    requestsMenu.classList.add('hover:bg-gray-700');
                }
            }

            // 4. Panggil fungsi pemuatan data
            if (sectionName === 'summary') {
                loadAdminAttendanceData(adminAttendanceDateFilter.value);
            } else if (sectionName === 'employees') {
                loadEmployeeList();
            } else if (sectionName === 'employeesalaries') { // <--- TAMBAHKAN BLOK INI
                initializeEmployeeSalary();     
            } else if (sectionName === 'companies') { 
                loadCompanyList();
            } else if (sectionName === 'rekap') { 
                initializeRekapFilters();
                document.getElementById('rekapTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Silakan atur filter dan klik "Tampilkan Rekap".</td></tr>';
            } else if (sectionName === 'statistics') {
                initializeStatsFilters();
            } else if (sectionName === 'reqattendance') { 
                initializeReqAttFilters(); 
            } else if (sectionName === 'reqtimeoff') { 
                initializeReqTimeoffFilters(); 
            } else if (sectionName === 'reqovertime') { 
                initializeReqOvertimeFilters();
            } else if (sectionName === 'masters') { // <-- TAMBAHKAN BLOK INI
                // Tampilkan tab default (timeoff) dan muat datanya
                showMasterTab('timeoff');
                loadTimeoffTypes(); 
            } else if (sectionName === 'workhours') { // <-- TAMBAHKAN BLOK INI
                loadWorkhoursList();
            } else if (sectionName === 'timeoffbalance') { // <-- TAMBAHKAN BLOK INI
                loadTimeoffBalanceList();
            } else if (sectionName === 'payroll') { // <-- BLOK BARU
                initializePayroll();
                loadPayrollHistory();
            }
        }

        // --- FUNGSI BARU: CRUD MANAJEMEN GAJI KARYAWAN (EMPLOYEE SALARIES) ---
        
        const employeeSalaryModal = document.getElementById('employeeSalaryModal');
        const employeeSalaryForm = document.getElementById('employeeSalaryForm');
        let selectedEmployeeIdForSalary = null; // ID karyawan yang sedang dilihat gajinya
        let salaryTypesCache = []; // Cache untuk dropdown Tipe Gaji

        // 1. Inisialisasi Halaman & Filter Karyawan
        async function initializeEmployeeSalary() {
            const employeeFilter = document.getElementById('salaryEmployeeFilter');

            // Muat karyawan jika belum ada
            if (allEmployees.length === 0) { 
                 let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data } = await query;
                allEmployees = data || [];
            }

            // Isi Dropdown Karyawan
            let options = '<option value="">-- Pilih Karyawan untuk Mulai --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // Jika ada karyawan yang sedang dipilih, muat gajinya
            if (selectedEmployeeIdForSalary) {
                loadEmployeeSalaries(selectedEmployeeIdForSalary);
            }
        }
        
        // 2. Memuat Daftar Komponen Gaji Karyawan
        async function loadEmployeeSalaries(userId) {
            selectedEmployeeIdForSalary = userId;
            const tableBody = document.getElementById('employeeSalariesTableBody');
            const addButton = document.getElementById('addSalaryComponentButton');
            const nameHeader = document.getElementById('salaryComponentName');
            
            // Tampilkan nama karyawan yang dipilih
            const employee = allEmployees.find(e => e.id === userId);
            nameHeader.innerHTML = `Komponen Gaji untuk <strong>${employee ? employee.full_name : 'N/A'}</strong>`;
            nameHeader.classList.remove('hidden');

            if (!userId) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">Silakan pilih karyawan dari daftar di atas.</td></tr>';
                addButton.disabled = true;
                return;
            }

            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat komponen gaji...</td></tr>';
            addButton.disabled = false; // Aktifkan tombol tambah

            // Ambil data gaji karyawan + detail dari tipe gaji
            const { data, error } = await _supabase.from('employee_salaries').select(`
                id, 
                salary_amount, 
                salary_type_id,
                salary_types(name, method, description)
            `).eq('user_id', userId).order('salary_amount', { ascending: false });

            if (error) {
                console.error("Gagal memuat gaji karyawan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Karyawan ini belum memiliki komponen gaji yang ditetapkan.</td></tr>';
                return;
            }

            const html = data.map(item => {
                const typeName = item.salary_types ? item.salary_types.name : 'N/A';
                const method = item.salary_types ? item.salary_types.method : 'Nominal Tetap';
                const nominal = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.salary_amount);
                
                // Siapkan data untuk edit
                const safeName = typeName.replace(/'/g, "\\'");

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${typeName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${method}</td>
                        <td class="px-4 py-3 text-right text-lg font-bold text-green-600">${nominal}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="openEmployeeSalaryModal('edit', '${item.id}', ${item.salary_type_id}, ${item.salary_amount}, '${safeName}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('employee_salary', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // 3. Membuka Modal (Add/Edit)
        async function openEmployeeSalaryModal(mode, id = null, salaryTypeId = null, amount = 0, salaryTypeName = '') {
            if (!selectedEmployeeIdForSalary) {
                showMessage("Harap pilih karyawan terlebih dahulu.", 'error');
                return;
            }
            
            const employee = allEmployees.find(e => e.id === selectedEmployeeIdForSalary);
            document.getElementById('modalSalaryEmployeeName').textContent = employee ? employee.full_name : 'N/A';
            employeeSalaryForm.reset(); 
            
            document.getElementById('employeeSalaryModalTitle').textContent = (mode === 'add') ? 'Tambahkan Komponen Gaji Baru' : `Edit Nominal ${salaryTypeName}`;
            employeeSalaryForm.dataset.mode = mode;
            employeeSalaryForm.dataset.id = id;
            
            const typeSelectContainer = document.getElementById('salaryTypeSelectContainer');
            const typeSelect = document.getElementById('modalSalaryTypeSelect');
            const salaryMethodDisplay = document.getElementById('modalSalaryMethod');
            const salaryInfo = document.getElementById('modalSalaryInfo');

            // Muat Tipe Gaji (jika belum di-cache)
            if (salaryTypesCache.length === 0) {
                let typeQuery = _supabase.from('salary_types').select('id, name, method, value');
                if (globalProfile.company_id) {
                    typeQuery = typeQuery.or(`company_id.eq.${globalProfile.company_id},company_id.is.null`);
                } else {
                    typeQuery = typeQuery.is('company_id', null);
                }
                const { data } = await typeQuery;
                salaryTypesCache = data || [];
            }
            
            // Helper untuk mengupdate tampilan metode/info
            const updateMethodDisplay = (selectedTypeId) => {
                const selectedType = salaryTypesCache.find(t => t.id == selectedTypeId);
                const method = selectedType ? selectedType.method : 'Nominal Tetap';
                salaryMethodDisplay.textContent = method;
                salaryInfo.classList.toggle('hidden', method === 'Nominal Tetap');
                
                // Atur placeholder input nominal
                const nominalInput = document.getElementById('modalSalaryAmount');
                if (method !== 'Nominal Tetap') {
                     nominalInput.placeholder = `Masukkan nilai per ${method === 'Berdasarkan Lembur' ? 'jam' : 'hari'} (cth: ${selectedType.value || 0})`;
                } else {
                    nominalInput.placeholder = "Masukkan jumlah nominal (cth: 5000000)";
                }
            };

            // Logika mode ADD vs EDIT
            if (mode === 'add') {
                typeSelectContainer.classList.remove('hidden');
                
                let options = '<option value="">-- Pilih Tipe Gaji --</option>';
                options += salaryTypesCache.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                typeSelect.innerHTML = options;
                
                // Tambahkan listener untuk perubahan tipe gaji di mode ADD
                typeSelect.onchange = (e) => updateMethodDisplay(e.target.value);
                updateMethodDisplay(null); // Reset tampilan awal

            } else { // mode EDIT
                typeSelectContainer.classList.add('hidden');
                // Isi input nominal dan display metode
                document.getElementById('modalSalaryAmount').value = amount;
                updateMethodDisplay(salaryTypeId); // Muat metode dari ID tipe yang sudah ada
            }

            employeeSalaryModal.classList.remove('hidden');
        }

        // 4. Menutup Modal
        function closeEmployeeSalaryModal() {
            employeeSalaryModal.classList.add('hidden');
            // Hapus listener onchange agar tidak menumpuk saat modal dibuka lagi
            document.getElementById('modalSalaryTypeSelect').onchange = null;
        }

        // 5. Menyimpan (Add/Edit)
        async function handleSaveEmployeeSalary(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveEmployeeSalaryButton');
            saveButton.disabled = true;

            const { mode, id } = employeeSalaryForm.dataset;
            const amount = parseFloat(document.getElementById('modalSalaryAmount').value);
            
            let typeId = null;
            if (mode === 'add') {
                typeId = document.getElementById('modalSalaryTypeSelect').value;
                if (!typeId) {
                    showMessage('Harap pilih Tipe Gaji.', 'error');
                    saveButton.disabled = false;
                    return;
                }
            } else {
                // Di mode EDIT, kita harus mencari ID Tipe Gaji yang sedang diedit
                // Kita ambil dari data gaji karyawan yang sudah dimuat. Ini lebih rumit
                // Sebagai solusi sementara, kita akan mengambil ID dari item di table body
                // (Ini perlu perbaikan, tapi untuk prototype cepat, kita bisa mengambil dari data yang dikirim ke openEmployeeSalaryModal)
                
                // Untuk EDIT, kita harus mengambil ID Tipe Gaji dari elemen yang ada di tabel, 
                // karena kita hanya mengirim ID employee_salaries. Karena data aslinya tidak ada di form, 
                // kita harus melakukan query balik.
                
                // NOTE: Untuk penyederhanaan prototype, kita akan rely pada ID dari item yang diklik (yang tidak tersimpan di form)
                // Solusi prototype: Buat input hidden untuk typeId di modal edit
                const typeSelect = document.getElementById('modalSalaryTypeSelect');
                if (typeSelect.classList.contains('hidden') && id) {
                    // Jika mode edit, ambil typeId dari cache jika mode edit
                    const currentSalary = await _supabase.from('employee_salaries').select('salary_type_id').eq('id', id).single();
                    typeId = currentSalary?.data?.salary_type_id;
                }
            }


            if (isNaN(amount) || amount < 0) {
                showMessage('Nominal harus angka non-negatif.', 'error');
                saveButton.disabled = false;
                return;
            }
            
            const payload = {
                salary_amount: amount,
            };

            if (mode === 'add') {
                payload.user_id = selectedEmployeeIdForSalary;
                payload.salary_type_id = typeId;
                payload.company_id = globalProfile.company_id; 
            }
            
            showMessage("Menyimpan komponen gaji...", 'info');
            let query;
            if (mode === 'add') {
                query = _supabase.from('employee_salaries').insert([payload]);
            } else {
                query = _supabase.from('employee_salaries').update(payload).eq('id', id);
            }

            const { error } = await query;
            if (error) {
                // Error 23505 adalah constraint unik
                if (error.code === '23505') {
                    showMessage('Gagal: Komponen gaji ini sudah ada untuk karyawan ini.', 'error');
                } else {
                    showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                }
                saveButton.disabled = false;
                return;
            }

            showMessage('Komponen gaji berhasil disimpan.', 'success');
            closeEmployeeSalaryModal();
            loadEmployeeSalaries(selectedEmployeeIdForSalary);
            saveButton.disabled = false;
        }
        
        // --- EVENT LISTENERS (BARU) ---

        try {
            document.getElementById('salaryEmployeeFilter').addEventListener('change', (e) => {
                if (e.target.value) {
                    loadEmployeeSalaries(e.target.value);
                } else {
                    loadEmployeeSalaries(null); // Muat tampilan kosong jika filter direset
                }
            });
            employeeSalaryForm.addEventListener('submit', handleSaveEmployeeSalary);
        } catch (e) {
            console.warn("Elemen Filter Gaji Karyawan tidak ditemukan.");
        }

        // --- FUNGSI TOGGLE SUB-MENU (ACCORDION) (BARU) ---
        function toggleSubMenu(subMenuId) {
            const subMenu = document.getElementById(subMenuId);
            const icon = document.getElementById(subMenuId + 'Icon');
            
            if (subMenu.classList.contains('active')) {
                // Tutup Sub-Menu
                subMenu.style.height = '0';
                subMenu.classList.remove('active');
                icon.classList.remove('rotate-180');
            } else {
                // Buka Sub-Menu
                // Set height ke nilai scrollHeight untuk transisi yang dinamis
                subMenu.style.height = subMenu.scrollHeight + 'px';
                subMenu.classList.add('active');
                icon.classList.add('rotate-180');
            }
        }

        // --- FUNGSI TOGGLE SIDEBAR ADMIN (BARU) ---
        function toggleAdminSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            
            // Cek apakah sidebar sedang mengandung class 'hidden'
            if (sidebar.classList.contains('hidden')) {
                // JIKA TERTUTUP -> BUKA
                sidebar.classList.remove('hidden');
            } else {
                // JIKA TERBUKA -> TUTUP
                sidebar.classList.add('hidden');
            }
        }

        const employeeModal = document.getElementById('employeeModal');
        const employeeForm = document.getElementById('employeeForm');

        async function openEmployeeModal() {
            employeeModal.classList.remove('hidden');
            document.getElementById('employeeModalTitle').textContent = 'Tambah Karyawan Baru';
            employeeForm.reset(); // Kosongkan form
            delete employeeForm.dataset.editingId; // Hapus mode edit
            
            document.getElementById('employeeEmail').disabled = false;
            document.getElementById('employeePassword').required = true;
            document.getElementById('employeePassword').previousElementSibling.textContent = "Password";
            document.getElementById('saveEmployeeButton').textContent = "Simpan & Daftarkan";

            // Logika untuk Dropdown Perusahaan
            const companySelectContainer = document.getElementById('companySelectContainer');
            const companySelect = document.getElementById('employeeCompany');
            
            if (globalProfile.role === 'super_admin') {
                // Super Admin: Tampilkan dropdown dan isi dengan perusahaan
                companySelectContainer.classList.remove('hidden');
                companySelect.required = true;
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                
                const { data, error } = await _supabase
                    .from('companies')
                    .select('id, name')
                    .order('name', { ascending: true });
                    
                if (data) {
                    companySelect.innerHTML = '<option value="">-- Pilih Perusahaan --</option>' + 
                                            data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } else {
                // Company Admin: Sembunyikan dropdown
                companySelectContainer.classList.add('hidden');
                companySelect.required = false;
            }
            // Muat dropdown jam kerja berdasarkan peran
            if (globalProfile.role === 'company_admin') {
                // Company Admin: Langsung muat jam kerja untuk perusahaannya + Global
                await loadWorkhourDropdown('employeeWorkhour', globalProfile.company_id);
            } else {
                // Super Admin: Muat jam kerja Global dulu (jika ada)
                // Dropdown akan di-reload jika dia memilih perusahaan (lihat Langkah 4)
                await loadWorkhourDropdown('employeeWorkhour', null); 
            }
            // (AKHIR BLOK BARU)

            employeeModal.classList.remove('hidden');
        }

        function closeEmployeeModal() {
            employeeModal.classList.add('hidden');
        }

        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Logika untuk 'Edit' vs 'Tambah Baru'
            const currentEditId = employeeForm.dataset.editingId;

            if (currentEditId) {
                await handleEditEmployee(currentEditId);
            } else {
                await handleAddNewEmployee();
            }
        });

        async function handleAddNewEmployee() {
            const email = document.getElementById('employeeEmail').value;
            const password = document.getElementById('employeePassword').value;
            const fullName = document.getElementById('employeeFullName').value;
            const idNumber = document.getElementById('employeeIDNumber').value;
            const role = document.getElementById('employeeRole').value;
            const status = document.getElementById('employeeStatus').value;

            document.getElementById('saveEmployeeButton').disabled = true;
            showMessage("Mendaftarkan pengguna baru...", 'info');
            
            // 1. BUAT AKUN DI AUTH.USERS (Supabase Auth)
            const { data: authData, error: authError } = await _supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { 
                        full_name: fullName // Simpan nama di metadata Auth
                    }
                }
            });

            if (authError) {
                showMessage(`Gagal membuat akun: ${authError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }
            
            const newUser = authData.user;
            
            // 2. BUAT PROFIL DI TABEL 'profiles'
            // Tentukan company_id:
            // Jika Super Admin, ambil dari dropdown. Jika Company Admin, ambil dari profilnya.
            let selectedCompanyId = (globalProfile.role === 'super_admin')
                ? document.getElementById('employeeCompany').value
                : globalProfile.company_id;

            if (!selectedCompanyId) {
                 showMessage('Gagal: Super Admin harus memilih perusahaan.', 'error');
                 document.getElementById('saveEmployeeButton').disabled = false;
                 return;
            }

            const newProfile = {
                id: newUser.id,
                company_id: selectedCompanyId, // Wajib diisi dari Admin yang login
                full_name: fullName,
                email: email,
                user_id_number: idNumber,
                role: role,
                user_status: status,
                workhour_id: document.getElementById('employeeWorkhour').value || null,
            };
            
            const { error: profileError } = await _supabase
                .from('profiles')
                .insert([newProfile]);
            
            if (profileError) {
                console.error("Gagal membuat profil, namun akun Auth sudah terbuat:", profileError.message);
                showMessage(`Peringatan: Akun dibuat tapi gagal menyimpan detail profil: ${profileError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }
            
            // 3. SELESAI
            showMessage(`Karyawan ${fullName} berhasil didaftarkan.`, 'success');
            closeEmployeeModal();
            loadEmployeeList(); // Muat ulang daftar karyawan
            document.getElementById('saveEmployeeButton').disabled = false;
        }
        // (Fungsi handleEditEmployee akan ditambahkan di langkah selanjutnya)
        async function handleEditEmployee(profileId) {
            const fullName = document.getElementById('employeeFullName').value;
            const idNumber = document.getElementById('employeeIDNumber').value;
            const role = document.getElementById('employeeRole').value;
            const status = document.getElementById('employeeStatus').value;
            
            // Tentukan company_id: Ambil dari dropdown jika Super Admin, dari globalProfile jika Company Admin
            const companyId = (globalProfile.role === 'super_admin')
                ? document.getElementById('employeeCompany').value // Nilai dari dropdown
                : globalProfile.company_id; // Nilai dari profil Admin yang login

            document.getElementById('saveEmployeeButton').disabled = true;
            showMessage("Menyimpan perubahan...", 'info');

            const profilePayload = {
                full_name: fullName,
                user_id_number: idNumber,
                role: role,
                user_status: status,
                company_id: companyId,
                workhour_id: document.getElementById('employeeWorkhour').value || null,
            };

            // 1. Update data di tabel 'profiles'
            const { error: profileError } = await _supabase
                .from('profiles')
                .update(profilePayload)
                .eq('id', profileId);

            if (profileError) {
                showMessage(`Gagal menyimpan profil: ${profileError.message}`, 'error');
                document.getElementById('saveEmployeeButton').disabled = false;
                return;
            }

            // 2. Update password (Tidak didukung di sini; harus menggunakan Supabase Admin SDK)
            const password = document.getElementById('employeePassword').value;
            if (password) {
                showMessage(`Peringatan: Perubahan password harus dilakukan menggunakan Supabase Admin API.`, 'error');
            }

            showMessage('Perubahan berhasil disimpan.', 'success');
            closeEmployeeModal();
            loadEmployeeList(); // Muat ulang daftar karyawan
            document.getElementById('saveEmployeeButton').disabled = false;
        }

        const companyModal = document.getElementById('companyModal');
        const companyForm = document.getElementById('companyForm');
        let currentCompanyId = null; // Untuk edit nanti
        let isSidebarOpen = true;

        function openCompanyModal() {
            companyModal.classList.remove('hidden');
            companyForm.reset();
            document.getElementById('companyModalTitle').textContent = 'Tambah Perusahaan Baru';
            currentCompanyId = null; // Mode 'Tambah Baru'
        }

        function closeCompanyModal() {
            companyModal.classList.add('hidden');
        }

        async function loadCompanyList() {
            const tableBody = document.getElementById('companyListTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat daftar perusahaan...</td></tr>';
            
            // RLS sudah diatur agar hanya Super Admin yang bisa memanggil ini
            const { data, error } = await _supabase
                .from('companies')
                .select('id, name, created_at, status')
                .order('name', { ascending: true });

            if (error) {
                console.error("Gagal memuat perusahaan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada perusahaan terdaftar.</td></tr>';
                return;
            }

            let html = data.map(company => {
                const createdDate = new Date(company.created_at).toLocaleDateString('id-ID');
                const status = company.status; // 'aktif' atau 'tidak aktif'
                const statusClass = status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                // Tentukan status baru (kebalikannya) untuk dikirim ke fungsi
                const newStatus = status === 'aktif' ? 'tidak aktif' : 'aktif'; 

                return `
                    <tr data-id="${company.id}">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${company.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${createdDate}</td>
                        <td class="px-4 py-3 text-left">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="editCompany('${company.id}', '${company.name}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit Nama</button>
                            <button onclick="openConfirmStatusModal('${company.id}', '${company.name}', '${newStatus}')" class="text-yellow-600 hover:text-yellow-900">Ubah Status</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        companyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyName = document.getElementById('companyName').value;
            const payrollStartDay = parseInt(document.getElementById('companyPayrollStartDay').value);
            
            // Validasi nilai baru (wajib 1-28)
            if (isNaN(payrollStartDay) || payrollStartDay < 1 || payrollStartDay > 28) {
                showMessage('Tanggal mulai penggajian harus antara 1 sampai 28.', 'error');
                document.getElementById('saveCompanyButton').disabled = false;
                return;
            }

            document.getElementById('saveCompanyButton').disabled = true;
            showMessage("Menyimpan perusahaan...", 'info');

            const payload = { 
                name: companyName,
                payroll_start_day: payrollStartDay // <--- Tambahkan kolom ini
            };

            let query;
            if (currentCompanyId) {
                // Mode EDIT: Update kedua kolom
                query = _supabase.from('companies').update(payload).eq('id', currentCompanyId);
            } else {
                // Mode TAMBAH BARU: Insert kedua kolom
                 query = _supabase.from('companies').insert([payload]);
            }

            const { error } = await query;

            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                document.getElementById('saveCompanyButton').disabled = false;
                return;
            }

            showMessage('Data perusahaan berhasil disimpan.', 'success');
            closeCompanyModal();
            loadCompanyList(); // Muat ulang daftar
            document.getElementById('saveCompanyButton').disabled = false;
        });

        async function editCompany(id, name) {
            showMessage("Memuat data perusahaan...", 'info');

            // 1. Ambil data lengkap perusahaan
            const { data, error } = await _supabase
                .from('companies')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !data) {
                showMessage(`Gagal memuat detail perusahaan: ${error?.message || 'Data tidak ditemukan.'}`, 'error');
                return;
            }

            // 2. Tetapkan ID global untuk mode edit
            currentCompanyId = id;

            // 3. Isi field di Modal
            document.getElementById('companyModalTitle').textContent = `Edit Perusahaan: ${data.name}`;
            document.getElementById('companyName').value = data.name;
            
            // --> INI YANG PALING PENTING: Isi kolom baru
            document.getElementById('companyPayrollStartDay').value = data.payroll_start_day || 1; 

            // 4. Tampilkan modal
            companyModal.classList.remove('hidden');
        }

        // --- FUNGSI BARU: LOGIKA MODAL STATUS PERUSAHAAN ---
        const companyStatusModal = document.getElementById('companyStatusModal');
        const companyStatusConfirmButton = document.getElementById('companyStatusConfirmButton');
        const companyStatusModalText = document.getElementById('companyStatusModalText');

        let statusChangeData = {}; // Menyimpan data sementara

        function openConfirmStatusModal(companyId, companyName, newStatus) {
            statusChangeData = { id: companyId, status: newStatus };
            
            // Tampilkan pesan konfirmasi yang spesifik
            companyStatusModalText.innerHTML = `Apakah Anda yakin ingin mengubah status perusahaan <strong>${companyName}</strong> menjadi <strong>${newStatus}</strong>?`;
            
            // Ubah warna tombol konfirmasi
            companyStatusConfirmButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
            if (newStatus === 'tidak aktif') {
                companyStatusConfirmButton.textContent = 'Ya, Nonaktifkan';
                companyStatusConfirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                companyStatusConfirmButton.textContent = 'Ya, Aktifkan';
                companyStatusConfirmButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }

            companyStatusModal.classList.remove('hidden');
        }

        function closeConfirmStatusModal() {
            companyStatusModal.classList.add('hidden');
            statusChangeData = {};
        }

        // Logika saat tombol konfirmasi di modal diklik
        companyStatusConfirmButton.addEventListener('click', async () => {
            const { id, status } = statusChangeData;
            if (!id || !status) return;

            showMessage("Memperbarui status perusahaan...", 'info');
            
            // Hanya Super Admin yang bisa melakukan ini (RLS sudah diatur)
            const { error } = await _supabase
                .from('companies')
                .update({ status: status }) // Menggunakan enum 'aktif' atau 'tidak aktif'
                .eq('id', id);

            if (error) {
                showMessage(`Gagal memperbarui status: ${error.message}`, 'error');
                return;
            }

            showMessage('Status perusahaan berhasil diperbarui.', 'success');
            closeConfirmStatusModal();
            loadCompanyList(); // Muat ulang daftar perusahaan untuk melihat perubahan
        });

        function showMessage(message, type = 'success') {
            const box = document.createElement('div');
            box.className = `p-4 mb-2 rounded-lg shadow-md transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
                type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
                'bg-blue-100 border border-blue-400 text-blue-700'
            }`;
            box.innerHTML = `<p class="font-medium">${message}</p>`;
            messageBox.appendChild(box);

            setTimeout(() => {
                box.style.opacity = '0';
                box.addEventListener('transitionend', () => box.remove());
            }, 5000);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            // Ubah timestampz (UTC) ke waktu lokal (tanpa detik)
            const date = new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        function formatTimeForInput(timestamp) {
             if (!timestamp) return '';
             const date = new Date(timestamp);
             const hours = String(date.getHours()).padStart(2, '0');
             const minutes = String(date.getMinutes()).padStart(2, '0');
             return `${hours}:${minutes}`;
        }

        function getTodayDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

       function changeView(viewId) {
            const footer = document.getElementById('karyawanFooterNav');
            
            // Sembunyikan semua tampilan
            [loginView, karyawanView, adminView].forEach(v => v.style.display = 'none');
            
            // Tampilkan tampilan yang diminta
            document.getElementById(viewId).style.display = 'flex';

            // Logika baru: Tampilkan footer HANYA di tampilan Karyawan
            if (viewId === 'karyawanView') {
                footer.classList.remove('hidden');
            } else {
                // Sembunyikan footer di tampilan Admin dan Login
                footer.classList.add('hidden');
            }
        }
        
        function initializeClock(timeElement, dateElement) {
            function updateTime() {
                const now = new Date();
                
                // Format Waktu
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                timeElement.textContent = now.toLocaleTimeString('id-ID', timeOptions);

                // Format Tanggal
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('id-ID', dateOptions);
            }

            updateTime();
            setInterval(updateTime, 1000);
        }

        // ===============================================================
        // 1. LOGIKA LOGIN (loginView)
        // ===============================================================
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            setLoginLoading(true);
            
            const { error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showMessage(`Gagal masuk: ${error.message}`, 'error');
                setLoginLoading(false);
                return;
            }

            // Jika berhasil, panggil checkAuthAndRole untuk memuat profil dan mengarahkan
            await checkAuthAndRole();
            setLoginLoading(false);
        });

        function setLoginLoading(isLoading) {
            document.getElementById('loginButton').disabled = isLoading;
            document.getElementById('loginButtonText').textContent = isLoading ? 'Memproses...' : 'Masuk';
            document.getElementById('loginSpinner').classList.toggle('hidden', !isLoading);
        }


        // ===============================================================
        // 2. LOGIKA KARYAWAN (karyawanView)
        // ===============================================================
        
        // --- FUNGSI HELPER LOKASI (BARU) ---
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                // Periksa apakah browser mendukung Geolocation
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation tidak didukung oleh browser ini."));
                    return;
                }

                // Opsi untuk akurasi dan timeout
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 detik
                    maximumAge: 0 // Tidak menggunakan cache
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        resolve({ latitude, longitude });
                    },
                    (error) => {
                        // Tangani error izin (Permission Denied) atau timeout
                        let errorMessage = "Gagal mengambil lokasi.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Izin lokasi ditolak. Harap izinkan GPS untuk absen.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Timeout: Gagal mendapatkan lokasi akurat.";
                        }
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        }

        // --- FUNGSI BARU: MUAT DAN RENDER KALENDER BULANAN ---

        // Helper: Mendapatkan hari terakhir bulan
        function getDaysInMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        }

        // 1. Ambil data dari Supabase dan siapkan untuk kalender
        async function loadMonthlyHistory(targetDate, targetElementId) {
            const container = document.getElementById(targetElementId);
            container.innerHTML = '<p class="text-center py-4 text-gray-500">Memuat data...</p>';

            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();
            const daysInMonth = getDaysInMonth(targetDate);
            
            // Tentukan rentang ISO untuk query Supabase (dari tgl 1 s/d tgl akhir bulan)
            const startDate = new Date(year, month, 1).toISOString();
            const endDate = new Date(year, month, daysInMonth, 23, 59, 59).toISOString();
            
            // 1. Ambil data kehadiran karyawan untuk bulan ini
            const { data, error } = await _supabase
                .from('attendance')
                .select('created_at, attendance_status')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startDate)
                .lte('created_at', endDate);

            if (error) {
                container.innerHTML = `<p class="text-center py-4 text-red-500">Gagal memuat riwayat: ${error.message}</p>`;
                return;
            }

            // 2. Peta data absensi berdasarkan tanggal (YYYY-MM-DD)
            const attendanceMap = {};
            if (data) {
                data.forEach(att => {
                    // (REVISI) Konversi timestamp UTC (cth: 2025-11-16T17:00Z) 
                    // ke objek Tanggal Lokal (cth: 17 Nov 2025 00:00 WIB)
                    const localDate = new Date(att.created_at);
                    
                    // Gunakan helper untuk mendapatkan YYYY-MM-DD yang benar (cth: "2025-11-17")
                    const dateKey = getTodayDateString(localDate); 
                    
                    attendanceMap[dateKey] = att.attendance_status;
                });
            }

            // 3. Ambil data Hari Libur Nasional/Khusus untuk bulan ini (BARU)
            let holidayQuery = _supabase.from('holidays')
                .select('holiday_date, holiday_name')
                .gte('holiday_date', targetDate.toISOString().substring(0, 10))
                .lte('holiday_date', new Date(year, month, daysInMonth).toISOString().substring(0, 10));

            if (globalProfile.company_id) {
                // Ambil Global (NULL) atau milik perusahaan karyawan
                holidayQuery = holidayQuery.or(`company_id.eq.${globalProfile.company_id},company_id.is.null`);
            } else {
                // Karyawan tidak terikat perusahaan (hanya ambil Global)
                holidayQuery = holidayQuery.is('company_id', null);
            }

            const { data: holidayData } = await holidayQuery;

            // Peta data Hari Libur (Key: YYYY-MM-DD, Value: Nama Hari Libur)
            const holidayMap = {};
            if (holidayData) {
                holidayData.forEach(item => {
                    holidayMap[item.holiday_date] = item.holiday_name;
                });
            }
            // ----------------------------------------------------

            // 4. Panggil Render Kalender (Ubah pemanggilan ini)
            // Ubah: renderCalendarGrid(targetDate, attendanceMap, container);
            // Menjadi:
            renderCalendarGrid(targetDate, attendanceMap, container, holidayMap);
        }

        // 2. Merender grid kalender ke dalam kontainer
        function renderCalendarGrid(date, attendanceMap, container, holidayMap) {
            const today = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            const daysInMonth = getDaysInMonth(date);
            
            // (BARU) Mulai kontainer list
            let html = '<div class="calendar-list">';

            // (DIUBAH) Loop hanya untuk tanggal, tanpa header atau padding
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                // (BARU) Ambil nama hari
                const dayName = currentDate.toLocaleDateString('id-ID', { weekday: 'long' });
                
                // --- Logika Penentuan Status (INI TIDAK BERUBAH) ---
                const dateKey = getTodayDateString(currentDate);
                const status = attendanceMap[dateKey];
                const isFuture = currentDate > today; 
                const holidayName = holidayMap[dateKey];
                
                let statusClass = '';
                let statusInfo = '';
                
                if (holidayName) { // 1. Prioritas: Hari Libur Nasional
                    statusClass = 'status-Weekend'; 
                    statusInfo = holidayName; 
                
                } else if (status) { // 2. Prioritas: Cek data absensi (Hadir, Izin, Terlambat)
                    if (status === 'Hadir') {
                        statusClass = 'status-Hadir';
                        statusInfo = 'Hadir';
                    } else if (status === 'Terlambat' || status === 'Izin / Cuti' || status === 'Sakit') {
                        statusClass = 'status-Terlambat'; 
                        statusInfo = status;
                    } else { // Alpa (atau status tidak dikenal lainnya)
                        statusClass = 'status-Alpa';
                        statusInfo = 'Alpa';
                    }

                } else if (currentDate.getDay() === 0 || currentDate.getDay() === 6) { // 3. Prioritas: Weekend
                    statusClass = 'status-Weekend';
                    statusInfo = 'Libur';
                
                } else if (isFuture) { // 4. Prioritas: Masa Depan (jika tidak ada data)
                    statusClass = 'status-Future';
                    statusInfo = 'Masa Depan';

                } else if (!isFuture) { // 5. Prioritas: Belum Absen / Alpa (jika bukan masa depan & tidak ada data)
                    statusClass = 'status-Alpa';
                    statusInfo = 'Belum Absen';
                }
                
                const isTodayClass = (currentDate.toDateString() === today.toDateString()) ? 'border-4 border-blue-500' : '';
                // --- Akhir Logika Status ---

                // (DIUBAH) Render HTML sebagai list item
                html += `
                    <div class="list-day-item ${statusClass} ${isTodayClass}" title="${statusInfo}">
                        <!-- Bagian Kiri: Tanggal dan Hari -->
                        <div class="list-day-info">
                            <span class="list-day-date">${String(day).padStart(2, '0')}</span>
                            <span class="list-day-name">${dayName}</span>
                        </div>
                        <!-- Bagian Kanan: Status -->
                        <div class="list-day-status">
                            <span>${statusInfo}</span>
                        </div>
                    </div>
                `;
            }

            html += '</div>'; // Tutup .calendar-list
            container.innerHTML = html;
        }

        // --- FUNGSI KARYAWAN (ABSENSI) ---
        async function loadKaryawanAttendanceStatus() {
            const todayDate = getTodayDateString();
            const isMasterHoliday = await isTodayHoliday(todayDate); // Gunakan tanggal hari ini
            // (REVISI) Buat rentang ISO dari string tanggal LOKAL
            const startOfDay = new Date(todayDate + 'T00:00:00').toISOString();
            const endOfDay = new Date(todayDate + 'T23:59:59').toISOString();
            
            karyawanAttendanceStatus.textContent = 'Memuat status...';

            const { data, error } = await _supabase
                .from('attendance')
                .select('*')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startOfDay)
                .lt('created_at', endOfDay)
                .limit(1);

            if (error) {
                console.error("Gagal memuat status absensi:", error.message);
                karyawanAttendanceStatus.textContent = 'Gagal memuat status.';
                return;
            }

            if (data && data.length > 0) {
                const attendance = data[0];
                currentAttendanceId = attendance.id; 

                karyawanClockInTime.textContent = formatTime(attendance.clock_in);
                karyawanClockOutTime.textContent = formatTime(attendance.clock_out);
                
                let statusText = attendance.attendance_status;
                let statusClass = 'bg-green-100 text-green-700';
                
                if (statusText === 'Alpa' || statusText === 'Terlambat') {
                    statusClass = 'bg-red-100 text-red-700';
                } else if (statusText === 'Izin' || statusText === 'Sakit') {
                    statusClass = 'bg-yellow-100 text-yellow-700';
                }

                karyawanAttendanceStatus.textContent = `Status hari ini: ${statusText}.`;
                karyawanAttendanceStatus.className = `text-center p-4 rounded-lg ${statusClass} font-medium`;

                // Atur status tombol
                karyawanClockInButton.disabled = true;
                if (!attendance.clock_out && (statusText === 'Hadir' || statusText === 'Terlambat')) {
                    karyawanClockOutButton.disabled = false;
                } else {
                    karyawanClockOutButton.disabled = true;
                }
            } else {
                // BARU: Cek Hari Libur
                if (isMasterHoliday) {
                    karyawanAttendanceStatus.textContent = 'Hari Libur Nasional/Khusus. Clock-in tidak diperlukan.';
                    karyawanAttendanceStatus.className = 'text-center p-4 rounded-lg bg-indigo-100 text-indigo-700 font-medium';
                    karyawanClockInTime.textContent = '-';
                    karyawanClockOutTime.textContent = '-';
                    karyawanClockInButton.disabled = true; // Nonaktifkan Clock-In
                    karyawanClockOutButton.disabled = true;
                    currentAttendanceId = null;
                    return; // Hentikan proses jika hari libur
                }

                // (existing logic for setting initial status)
                karyawanAttendanceStatus.textContent = 'Anda belum melakukan Clock-in hari ini.';
                karyawanAttendanceStatus.className = 'text-center p-4 rounded-lg bg-yellow-50 text-yellow-700 font-medium';
                karyawanClockInTime.textContent = '-';
                karyawanClockOutTime.textContent = '-';
                karyawanClockInButton.disabled = false;
                karyawanClockOutButton.disabled = true;
                currentAttendanceId = null;
            }
        }

        // --- (BARU) FUNGSI UNTUK HALAMAN TIMEOFF KARYAWAN ---
        
        // Memuat Tipe Izin/Cuti dan Saldo ke Form
        async function loadTimeoffForm() {
            const select = document.getElementById('timeoffTypeSelect');
            select.innerHTML = '<option value="">Memuat...</option>';
            select.disabled = true;
            timeoffBalancesCache = {}; // Reset cache

            // 1. Ambil Tipe Cuti (Global atau Perusahaan)
            let typeQuery = _supabase.from('timeoff_types').select('id, name, is_deductible');
            if (globalProfile.company_id) {
                typeQuery = typeQuery.or(`company_id.eq.${globalProfile.company_id},company_id.is.null`);
            } else {
                typeQuery = typeQuery.is('company_id', null);
            }
            const { data: types, error: typeError } = await typeQuery;
            
            if (typeError) {
                select.innerHTML = '<option value="">Gagal memuat tipe</option>';
                return;
            }
            
            // 2. Ambil Saldo Cuti Karyawan (HANYA untuk yang login)
            const { data: balances, error: balanceError } = await _supabase
                .from('employee_timeoff_balances')
                .select('timeoff_type_id, balance_days')
                .eq('user_id', globalProfile.id);

            if (balanceError) {
                console.warn("Gagal memuat saldo cuti:", balanceError.message);
            }
            
            // 3. Masukkan saldo ke cache
            if (balances) {
                balances.forEach(b => {
                    timeoffBalancesCache[b.timeoff_type_id] = b.balance_days;
                });
            }

            // 4. Bangun Opsi Dropdown
            let options = '<option value="">-- Pilih Jenis Pengajuan --</option>';
            types.forEach(type => {
                let displayName = type.name;
                if (type.is_deductible) {
                    const sisa = timeoffBalancesCache[type.id] || 0;
                    displayName += ` (Sisa: ${sisa} hari)`;
                }
                // Simpan data di dataset untuk validasi
                options += `<option value="${type.id}" data-deductible="${type.is_deductible}">${displayName}</option>`;
            });
            
            select.innerHTML = options;
            select.disabled = false;
        }

        // Memuat Riwayat Pengajuan Izin/Cuti Karyawan
        async function loadTimeoffHistory() {
            const tableBody = document.getElementById('timeoffHistoryTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat riwayat...</td></tr>';

            const { data, error } = await _supabase
                .from('timeoff_requests')
                .select(`
                    created_at, 
                    start_date, 
                    end_date, 
                    timeoff_status,
                    timeoff_types ( name )
                `)
                .eq('user_id', globalProfile.id)
                .order('created_at', { ascending: false });

            if (error) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada riwayat pengajuan.</td></tr>';
                return;
            }

            const html = data.map(req => {
                const submittedDate = new Date(req.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                const typeName = req.timeoff_types ? req.timeoff_types.name : 'N/A';
                const dateRange = `${new Date(req.start_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })} - ${new Date(req.end_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })}`;
                const status = req.timeoff_status;

                let statusClass;
                if (status === 'Diajukan') statusClass = 'bg-yellow-100 text-yellow-800';
                else if (status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                else statusClass = 'bg-red-100 text-red-800'; // Ditolak

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${submittedDate}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${typeName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${dateRange}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // Helper untuk menghitung hari kerja (skip Sabtu/Minggu)
        function getWorkingDays(startDate, endDate) {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Bukan Minggu (0) atau Sabtu (6)
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        // Menangani Submit Form Pengajuan Izin/Cuti
        async function handleNewTimeoffRequest(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveTimeoffRequestButton');
            saveButton.disabled = true;

            const typeSelect = document.getElementById('timeoffTypeSelect');
            const selectedOption = typeSelect.options[typeSelect.selectedIndex];
            
            const timeoffTypeId = selectedOption.value;
            const isDeductible = selectedOption.dataset.deductible === 'true';
            const startDateStr = document.getElementById('timeoffStartDate').value;
            const endDateStr = document.getElementById('timeoffEndDate').value;
            const description = document.getElementById('timeoffDescription').value;

            if (!timeoffTypeId || !startDateStr || !endDateStr) {
                showMessage('Harap lengkapi Jenis, Tgl Mulai, dan Tgl Akhir.', 'error');
                saveButton.disabled = false;
                return;
            }
            
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');

            if (endDate < startDate) {
                showMessage('Tanggal Akhir tidak boleh sebelum Tanggal Mulai.', 'error');
                saveButton.disabled = false;
                return;
            }

            // Validasi Saldo Cuti
            if (isDeductible) {
                const sisa = timeoffBalancesCache[timeoffTypeId] || 0;
                // Hitung hari kerja
                const totalDays = getWorkingDays(startDate, endDate); 

                if (totalDays <= 0) {
                    showMessage('Jumlah hari pengajuan (hari kerja) adalah 0. Silakan cek tanggal Anda.', 'error');
                    saveButton.disabled = false;
                    return;
                }
                
                if (sisa < totalDays) {
                    showMessage(`Gagal: Saldo cuti tidak mencukupi. Sisa: ${sisa} hari, Dibutuhkan: ${totalDays} hari.`, 'error');
                    saveButton.disabled = false;
                    return;
                }
            }

            // Kirim ke Supabase
            showMessage("Mengirim pengajuan Izin/Cuti...", 'info');
            
            const { error } = await _supabase
                .from('timeoff_requests')
                .insert([{
                    user_id: globalProfile.id,
                    company_id: globalProfile.company_id,
                    timeoff_type_id: timeoffTypeId,
                    start_date: startDateStr,
                    end_date: endDateStr,
                    description: description,
                    timeoff_status: 'Diajukan'
                }]);

            if (error) {
                showMessage(`Gagal mengirim pengajuan: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage('Pengajuan Izin/Cuti berhasil dikirim.', 'success');
            document.getElementById('timeoffRequestForm').reset();
            loadTimeoffForm(); // Muat ulang form untuk update saldo
            loadTimeoffHistory(); // Muat ulang riwayat
            saveButton.disabled = false;
        }
        // --- AKHIR FUNGSI HALAMAN TIMEOFF ---

        // --- FUNGSI BARU: MEMUAT FORM & RIWAYAT LEMBUR KARYAWAN ---
        // Memuat Riwayat Pengajuan Lembur Karyawan
        async function loadOvertimeHistory() {
            const tableBody = document.getElementById('overtimeHistoryTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat riwayat...</td></tr>';

            const { data, error } = await _supabase
                .from('overtime_requests')
                .select(`
                    created_at, 
                    overtime_date, 
                    start_time, 
                    end_time,
                    overtime_status
                `)
                .eq('user_id', globalProfile.id)
                .order('created_at', { ascending: false });

            if (error) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada riwayat pengajuan lembur.</td></tr>';
                return;
            }

            const html = data.map(req => {
                const submittedDate = new Date(req.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                const overtimeDate = new Date(req.overtime_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                const startTime = formatTime(req.start_time);
                const endTime = formatTime(req.end_time);
                const status = req.overtime_status;

                let statusClass;
                if (status === 'Diajukan') statusClass = 'bg-yellow-100 text-yellow-800';
                else if (status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                else statusClass = 'bg-red-100 text-red-800'; // Ditolak

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${submittedDate}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${overtimeDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${startTime} - ${endTime}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // Menangani Submit Form Pengajuan Lembur
        async function handleNewOvertimeRequest(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveOvertimeRequestButton');
            saveButton.disabled = true;

            const overtimeDateStr = document.getElementById('overtimeDate').value;
            const startTimeStr = document.getElementById('overtimeStartTime').value;
            const endTimeStr = document.getElementById('overtimeEndTime').value;
            const description = document.getElementById('overtimeDescription').value;

            if (!overtimeDateStr || !startTimeStr || !endTimeStr) {
                showMessage('Harap lengkapi semua kolom waktu dan tanggal.', 'error');
                saveButton.disabled = false;
                return;
            }
            
            // Helper untuk menggabungkan tanggal dan waktu menjadi ISO String
            const combineDateTimeForOvertime = (dateStr, timeStr) => {
                if (!dateStr || !timeStr) return null;
                // Supabase akan menginterpretasikannya sebagai timestampz (UTC)
                return new Date(`${dateStr}T${timeStr}:00`).toISOString(); 
            };
            
            // Gabungkan waktu ke tanggal untuk membuat timestampz
            const startTimeISO = combineDateTimeForOvertime(overtimeDateStr, startTimeStr);
            const endTimeISO = combineDateTimeForOvertime(overtimeDateStr, endTimeStr);
            
            // Validasi Waktu Akhir > Waktu Mulai
            if (new Date(endTimeISO) <= new Date(startTimeISO)) {
                showMessage('Waktu Akhir harus setelah Waktu Mulai.', 'error');
                saveButton.disabled = false;
                return;
            }

            // Kirim ke Supabase
            showMessage("Mengirim pengajuan Lembur...", 'info');
            
            const { error } = await _supabase
                .from('overtime_requests')
                .insert([{
                    user_id: globalProfile.id,
                    company_id: globalProfile.company_id,
                    overtime_date: overtimeDateStr, // Tanggal saja (YYYY-MM-DD)
                    start_time: startTimeISO,
                    end_time: endTimeISO,
                    description: description,
                    overtime_status: 'Diajukan'
                }]);

            if (error) {
                showMessage(`Gagal mengirim pengajuan: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage('Pengajuan Lembur berhasil dikirim. Menunggu persetujuan Admin.', 'success');
            document.getElementById('overtimeRequestForm').reset();
            loadOvertimeHistory(); // Muat ulang riwayat
            saveButton.disabled = false;
        }

        // --- FUNGSI BARU: MEMUAT RIWAYAT GAJI KARYAWAN ---

        async function loadKaryawanPayslipHistory() {
            const tableBody = document.getElementById('karyawanPayslipTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat riwayat payslip...</td></tr>';

            const { data, error } = await _supabase
                .from('payroll')
                .select(`id, pay_period_month, takehomepay, status`)
                .eq('user_id', globalProfile.id)
                .order('pay_period_month', { ascending: false });

            if (error) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada riwayat payslip yang tersedia.</td></tr>';
                return;
            }

            const formatRupiah = (amount) => 
                new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

            const html = data.map(item => {
                const periodDate = new Date(item.pay_period_month);
                // Tampilkan Bulan dan Tahun (cth: November 2025)
                const periodDisplay = periodDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                const netPay = formatRupiah(item.takehomepay);
                const status = item.status;

                let statusClass;
                if (status === 'Paid') statusClass = 'bg-green-100 text-green-800';
                else if (status === 'Processed') statusClass = 'bg-blue-100 text-blue-800';
                else statusClass = 'bg-yellow-100 text-yellow-800'; // Pending/Other

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${periodDisplay}</td>
                        <td class="px-4 py-3 text-right text-lg font-bold">${netPay}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status.toUpperCase()}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- Gunakan fungsi viewPayslip yang sudah ada di Admin untuk menampilkan modal payslip -->
                            <button onclick="viewPayslip('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-2">Lihat Payslip</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        async function loadKaryawanProfileData() {
            if (!globalProfile) return;

            document.getElementById('profileInfoNama').textContent = globalProfile.full_name || 'N/A';
            
            // Ambil email dari sesi auth (lebih pasti daripada profil)
            const { data: { user } } = await _supabase.auth.getUser();
            document.getElementById('profileInfoEmail').textContent = user ? user.email : 'N/A';
            
            // Ambil nama perusahaan dari header (sudah di-load oleh loadCompanyDetails)
            document.getElementById('profileInfoPerusahaan').textContent = document.getElementById('companyText').textContent || 'N/A';
            
            // Reset form password setiap kali dibuka
            document.getElementById('changePasswordForm').reset();
            document.getElementById('savePasswordButton').disabled = false;
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const saveButton = document.getElementById('savePasswordButton');
            saveButton.disabled = true;

            const newPassword = document.getElementById('profileNewPassword').value;
            const confirmPassword = document.getElementById('profileConfirmPassword').value;

            if (newPassword.length < 6) {
                showMessage('Password baru harus minimal 6 karakter.', 'error');
                saveButton.disabled = false;
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('Password baru dan konfirmasi tidak cocok.', 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Memperbarui password Anda...", 'info');
            
            // Panggil API Auth Supabase
            const { error } = await _supabase.auth.updateUser({
                password: newPassword
            });

            if (error) {
                showMessage(`Gagal memperbarui password: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage('Password Anda telah berhasil diperbarui.', 'success');
            document.getElementById('changePasswordForm').reset();
            saveButton.disabled = false;
        }

        // FUNGSI NAVIGASI KARYAWAN BARU (menggantikan showKaryawanSection)
        function showKaryawanContent(sectionName) {
            const sections = {
                'Absensi': document.getElementById('karyawanSection_Absensi'),
                'Requests': document.getElementById('karyawanSection_Requests'),
                'History': document.getElementById('karyawanSection_History'),
                'Timeoff': document.getElementById('karyawanSection_Timeoff'),
                'Overtime': document.getElementById('karyawanSection_Overtime'),
                'Salary': document.getElementById('karyawanSection_Salary'),
                'Profile': document.getElementById('karyawanSection_Profile')
            };
            const karyawanViewWrapper = document.querySelector('#karyawanView > div');
            
            // 1. Sembunyikan semua section dan atur lebar default
            Object.values(sections).forEach(sec => {
                if(sec) sec.style.display = 'none';
            });
            karyawanViewWrapper.classList.add('max-w-lg');

            // 2. Tampilkan section yang dipilih
            if (sections[sectionName]) {
                sections[sectionName].style.display = 'block';

                // Muat data spesifik tanpa mengubah lebar wrapper
                if (sectionName === 'Requests') {
                    document.getElementById('requestAttendanceForm').reset(); // BARU: Reset form
                    document.getElementById('reqAttDate').value = getTodayDateString(); // BARU: Set tanggal hari ini
                    loadAttendanceRequests(); // Muat data Koreksi Kehadiran
                } else if (sectionName === 'History') { 
                    loadKaryawanHistory();
                } else if (sectionName === 'Timeoff') { // <-- LOGIKA BARU UNTUK TIMEOFF
                    loadTimeoffForm();
                    loadTimeoffHistory();
                } else if (sectionName === 'Overtime') { // <-- PERUBAHAN LOGIKA UNTUK LEMBUR
                    loadOvertimeHistory();
                } else if (sectionName === 'Salary') {
                    loadKaryawanPayslipHistory();
                } else if (sectionName === 'Profile') { // <-- (TAMBAHKAN 2)
                    loadKaryawanProfileData(); // Panggil fungsi baru
                }
            }
            
            // 3. Atur tombol footer yang aktif
            if (sectionName !== 'History' && sectionName !== 'Profile') {
               setActiveFooterTab(sectionName);
            }
        }

        // FUNGSI UNTUK MENGATUR TOMBOL FOOTER AKTIF
        function setActiveFooterTab(activeSection) {
            const tabIds = ['tabRequestAttendance', 'tabRequestTimeoff', 'tabAttendanceHome', 'tabOvertime', 'tabSalary'];
            let activeId;

            // Tentukan ID tombol yang harus aktif berdasarkan nama section
            if (activeSection === 'Absensi') activeId = 'tabAttendanceHome';
            else if (activeSection === 'Requests') activeId = 'tabRequestAttendance';
            else if (activeSection === 'Timeoff') activeId = 'tabRequestTimeoff';
            else if (activeSection === 'Overtime') activeId = 'tabOvertime';
            else if (activeSection === 'Salary') activeId = 'tabSalary';

            tabIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    const isActive = id === activeId;
                    // Hapus kelas aktif dari semua
                    button.classList.remove('text-blue-600');
                    button.classList.add('text-gray-500');
                    // Tambahkan kelas aktif pada yang dipilih
                    if (isActive) {
                        button.classList.remove('text-gray-500');
                        button.classList.add('text-blue-600');
                    }
                }
            });
        }

        // --- FUNGSI KARYAWAN (RIWAYAT KEHADIRAN) ---
        async function loadKaryawanHistory() {
            // 1. Tentukan bulan saat ini dan bulan sebelumnya
            const today = new Date();
            const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1); // Tanggal 1 bulan ini
            const previousMonth = new Date(currentMonth);
            previousMonth.setMonth(currentMonth.getMonth() - 1); // Tanggal 1 bulan lalu
            const nextMonth = new Date(currentMonth);
            nextMonth.setMonth(currentMonth.getMonth() + 1); // Bulan Depan

            // 2. Format Nama Bulan untuk Tab
            const currentMonthName = currentMonth.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
            const previousMonthName = previousMonth.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
            const nextMonthName = nextMonth.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' }); // BARU
            
            // 3. Update Nama Tab
            document.getElementById('tabCurrentMonth').textContent = currentMonthName;
            document.getElementById('tabPreviousMonth').textContent = previousMonthName;
            document.getElementById('tabNextMonth').textContent = nextMonthName; // BARU
            
            // 4. Muat data untuk kedua bulan secara bersamaan
            await Promise.all([
                loadMonthlyHistory(currentMonth, 'calendarCurrentMonth'),
                loadMonthlyHistory(previousMonth, 'calendarPreviousMonth'),
                loadMonthlyHistory(nextMonth, 'calendarNextMonth') // BARU
            ]);
            
            // 5. Pastikan tab bulan ini yang aktif secara default
            switchHistoryTab('current');
        }

        // FUNGSI NAVIGASI TAB BULAN
        function switchHistoryTab(period) {
            const tabs = {
                'previous': document.getElementById('tabPreviousMonth'),
                'current': document.getElementById('tabCurrentMonth'),
                'next': document.getElementById('tabNextMonth') // BARU
            };
            const contents = {
                'previous': document.getElementById('calendarPreviousMonth'),
                'current': document.getElementById('calendarCurrentMonth'),
                'next': document.getElementById('calendarNextMonth') // BARU
            };

            // Reset semua Tab Styles dan Konten
            Object.keys(tabs).forEach(key => {
                const tab = tabs[key];
                const content = contents[key];

                // 1. Reset Border & Text Color
                tab.classList.remove('border-blue-600', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
                
                // 2. Reset Background Menyala
                tab.classList.remove('tab-active-bg'); // Hapus background menyala
                
                // 3. Sembunyikan Konten
                content.style.display = 'none';
            });

            // Set Active Tab and Content
            const activeTab = tabs[period];
            const activeContent = contents[period];

            if (activeTab && activeContent) {
                // 1. Set Border & Text Color Aktif
                activeTab.classList.add('border-blue-600', 'text-blue-600');
                activeTab.classList.remove('border-transparent', 'text-gray-500');

                // 2. Set Background Menyala Aktif
                activeTab.classList.add('tab-active-bg'); 
                
                // 3. Tampilkan Konten
                activeContent.style.display = 'block';
            }
        }

        // --- 3. FUNGSI BARU: MEMUAT DAFTAR REQUEST KARYAWAN ---
        async function loadAttendanceRequests() {
            // Fungsi ini dipanggil oleh showKaryawanContent('Requests')
            const tableBody = document.getElementById('requestListTableBody');
            if (!tableBody) {
                console.error("Elemen requestListTableBody tidak ditemukan!");
                return; 
            }
            
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat riwayat pengajuan...</td></tr>';
            
            // Ambil data HANYA untuk karyawan yang login
            const { data, error } = await _supabase
                .from('attendance_requests')
                .select('created_at, attendance_date, requests_status')
                .eq('user_id', globalProfile.id)
                .order('created_at', { ascending: false }); // Terbaru di atas

            if (error) {
                console.error("Gagal memuat riwayat pengajuan:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Anda belum memiliki riwayat pengajuan.</td></tr>';
                return;
            }

            let html = data.map(req => {
                // Tgl Diajukan (Kapan request dibuat)
                const submittedDate = new Date(req.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                // Tgl Absensi (Tanggal yang dikoreksi)
                const attendanceDate = new Date(req.attendance_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                const status = req.requests_status;
                
                let statusClass;
                if (status === 'Diajukan') statusClass = 'bg-yellow-100 text-yellow-800';
                else if (status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                else statusClass = 'bg-red-100 text-red-800'; // Ditolak

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${submittedDate}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${attendanceDate}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        async function doClockIn() {
            karyawanClockInButton.disabled = true; // Nonaktifkan tombol saat memulai
            showMessage("Memeriksa jadwal dan status kehadiran...", 'info');
            
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const now = new Date();
            const todayName = dayNames[now.getDay()];
            const todayDate = getTodayDateString();

            // 1. Cek Data Absensi Hari Ini (Jika sudah clock-in, hentikan)
            const isAlreadyClockedIn = await checkExistingAttendance(todayDate);
            if (isAlreadyClockedIn) {
                showMessage(`Anda sudah Clock-In hari ini!`, 'error');
                karyawanClockInButton.disabled = true;
                return;
            }

            // 2. Cek Hari Libur Nasional (Prioritas Tertinggi)
            const isMasterHoliday = await isTodayHoliday(todayDate);
            if (isMasterHoliday) {
                showMessage(`Gagal Clock-In: Hari ini adalah Hari Libur Nasional/Khusus.`, 'error');
                karyawanClockInButton.disabled = false; 
                return;
            }

            // 3. Cek Jadwal Kerja (Workhours)
            const schedule = globalProfile.workhours?.schedule;
            if (schedule && schedule[todayName]?.is_off) {
                showMessage(`Gagal Clock-In: Hari ini (${todayName}) adalah Hari Libur sesuai jadwal Anda.`, 'error');
                karyawanClockInButton.disabled = false; 
                return;
            }
            
            // 4. Cek Keterlambatan (DAPATKAN STATUS HADIR / TERLAMBAT)
            let isLate = false;
            let attendanceStatus = 'Hadir'; // Default
            
            try {
                if (!globalProfile.workhours || !schedule || !schedule[todayName] || !schedule[todayName].start) {
                    console.warn(`Tidak ada jadwal kerja (workhour) ditemukan untuk hari ${todayName}. Keterlambatan tidak dihitung.`);
                } else {
                    const todayRule = schedule[todayName];
                    const [hours, minutes] = todayRule.start.split(':').map(Number);
                    const deadline = new Date(now); 
                    deadline.setHours(hours, minutes, 0, 0); 
                    
                    if (now > deadline) {
                        isLate = true; 
                        attendanceStatus = 'Terlambat';
                    }
                }
            } catch (e) {
                console.error("Gagal memproses logika jam kerja (workhours):", e.message);
            }
            
            // 5. Jika Terlambat, buka Modal Alasan
            if (isLate) {
                // Simpan data status (Terlambat) untuk digunakan saat modal alasan di-submit
                tempClockInData = { status: attendanceStatus }; 
                openLateReasonModal();
                // Tombol Clock-In tetap disabled (akan di-handle oleh modal alasan)
                return; 
            }
            
            // 6. Jika Hadir Tepat Waktu, langsung ke Tahap 2: Lokasi
            await processClockInLocation(attendanceStatus); 
        }
        
        // FUNGSI BARU: TAHAP 2: PROSES LOKASI DAN TAMPILKAN PETA
        async function processClockInLocation(status, description = null) { // (BARU) Tambahkan argumen description
            showMessage("Meminta izin lokasi untuk peta...", 'info');
            const locationDisplayElement = document.getElementById('karyawanLocationDisplay');
            locationDisplayElement.textContent = `Lokasi: Mencari...`;

            let locationCoords = null;
            try {
                locationCoords = await getCurrentLocation();
                
                // Tampilkan koordinat di display
                locationDisplayElement.textContent = `Lokasi: ${locationCoords.latitude}, ${locationCoords.longitude}`;
                
                // Buka modal konfirmasi lokasi
                openLocationConfirmModal(locationCoords, status, description); // (BARU) Kirim description
                
            } catch (e) {
                showMessage(`Gagal Absen: ${e.message}`, 'error');
                karyawanClockInButton.disabled = false; // Aktifkan kembali
                locationDisplayElement.textContent = `Lokasi: ${e.message.split('.')[0]}`;
                return;
            }
        }
        
        // FUNGSI BARU: Cek Kehadiran (Helper)
        async function checkExistingAttendance(dateString) {
            const startOfDay = new Date(dateString + 'T00:00:00').toISOString();
            const endOfDay = new Date(dateString + 'T23:59:59').toISOString();
            
            const { data, error } = await _supabase
                .from('attendance')
                .select('id')
                .eq('user_id', globalProfile.id)
                .gte('created_at', startOfDay)
                .lt('created_at', endOfDay)
                .limit(1);
            
            return data && data.length > 0;
        }

        async function doClockOut() {
            if (!currentAttendanceId) {
                showMessage("Gagal Absen Pulang: Data Absen Masuk tidak ditemukan.", 'error');
                return;
            }
            
            karyawanClockOutButton.disabled = true;
            showMessage("Memproses Absen Pulang...", 'info');
            
            const now = new Date().toISOString();

            const { error } = await _supabase
                .from('attendance')
                .update({ clock_out: now })
                .eq('id', currentAttendanceId);

            if (error) {
                console.error('Gagal Absen Pulang:', error.message);
                showMessage(`Gagal Absen Pulang: ${error.message}.`, 'error');
                karyawanClockOutButton.disabled = false;
                return;
            }

            showMessage('Absen Pulang Berhasil! Terima kasih.', 'success');
            loadKaryawanAttendanceStatus();
        }

        karyawanClockInButton.addEventListener('click', doClockIn);
        karyawanClockOutButton.addEventListener('click', doClockOut);

        // Data sementara untuk Konfirmasi Lokasi (BARU)
        let tempLocationData = {}; 

        // 1. Membuka Modal Konfirmasi Lokasi
        function openLocationConfirmModal(coords, status, description = null) {
            // Simpan koordinat dan status (Hadir/Terlambat) sementara
            tempLocationData = {
                latitude: coords.latitude,
                longitude: coords.longitude,
                status: status,
                now: new Date(),
                description: description // Termasuk alasan jika datang dari modal Keterlambatan
            };

            const coordsString = `${coords.latitude}, ${coords.longitude}`;
            document.getElementById('locationConfirmCoords').textContent = coordsString;

            // Buat URL embed Google Maps 
            const mapUrl = `https://maps.google.com/maps?q=${coords.latitude},${coords.longitude}&z=15&output=embed`;
            
            // Masukkan iframe ke dalam container
            document.getElementById('mapIframeContainer').innerHTML = `
                <iframe
                    width="100%"
                    height="100%"
                    frameborder="0"
                    style="border:0"
                    referrerpolicy="no-referrer-when-downgrade"
                    src="${mapUrl}"
                    allowfullscreen
                ></iframe>
            `;

            document.getElementById('locationConfirmModal').classList.remove('hidden');
        }

        // 2. Menutup Modal Konfirmasi Lokasi
        function closeLocationConfirmModal() {
            document.getElementById('locationConfirmModal').classList.add('hidden');
            tempLocationData = {}; // Hapus data sementara
            karyawanClockInButton.disabled = false; // Aktifkan lagi tombol Clock-In
        }

        // 3. Menangani Tombol 'Lanjutkan Clock-In' (Final Action)
        async function handleConfirmClockIn() {
            const { latitude, longitude, status, now, description } = tempLocationData;
            
            if (!now || !latitude) {
                showMessage("Gagal: Data lokasi tidak lengkap.", 'error');
                closeLocationConfirmModal();
                return;
            }
            
            const locationString = `${latitude}, ${longitude}`;
            
            showMessage(`Lokasi dikonfirmasi. Memproses Clock-In (${status})...`, 'info');
            document.getElementById('confirmClockInButton').disabled = true;

            // Panggil fungsi insertAttendance dengan status yang sudah ditentukan
            const success = await insertAttendance(now, locationString, status, description);

            if (success) {
                closeLocationConfirmModal();
            } else {
                 document.getElementById('confirmClockInButton').disabled = false;
            }
        }

        // ===============================================================
        // 3. LOGIKA ADMIN (adminView)
        // ===============================================================
        
        function getStatusClass(status) {
            if (status === 'Hadir' || status === 'Terlambat') return 'bg-green-100 text-green-800';
            if (status === 'Izin' || status === 'Sakit') return 'bg-yellow-100 text-yellow-800';
            if (status === 'Alpa' || !status) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        async function loadAdminAttendanceData(dateString) {
            adminAttendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
            
            // Tentukan rentang hari (00:00 - 23:59 LOKAL)
            const startOfDay = new Date(dateString + 'T00:00:00').toISOString();
            const endOfDay = new Date(dateString + 'T23:59:59').toISOString();
            
            // 1. Ambil semua karyawan di perusahaan admin + JADWAL KERJA
            let profilesQuery = _supabase
                .from('profiles')
                .select('id, full_name, workhours( schedule )'); // Ambil jadwal kerja
            
            if (globalProfile.role !== 'super_admin') {
                profilesQuery = profilesQuery.eq('company_id', globalProfile.company_id);
            }
            
            const { data: profiles, error: profilesError } = await profilesQuery;

            if (profilesError || profiles.length === 0) {
                adminAttendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada karyawan di perusahaan ini.</td></tr>';
                document.getElementById('adminNoDataMessage').classList.add('hidden');
                return;
            }

            const employeeIds = profiles.map(p => p.id);

            // 2. Ambil data absensi untuk tanggal dan user ID yang sesuai
            const { data: attendanceData, error: attendanceError } = await _supabase
                .from('attendance')
                .select('id, user_id, clock_in, clock_out, attendance_status, location')
                .in('user_id', employeeIds)
                .gte('created_at', startOfDay) // Gunakan rentang ISO
                .lte('created_at', endOfDay); // Gunakan rentang ISO
            
            if (attendanceError) {
                console.error("Gagal memuat data absensi:", attendanceError.message);
                return;
            }
            
            // 3. (BARU) Cek apakah hari ini Hari Libur Nasional
            const isMasterHoliday = await isTodayHoliday(dateString);
            
            // 4. (BARU) Tentukan nama hari (Senin, Selasa, dll)
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const todayName = dayNames[new Date(dateString + 'T00:00:00').getDay()];

            // 5. Buat Peta (Map) data absensi
            const attendanceMap = attendanceData.reduce((map, att) => {
                map[att.user_id] = att;
                return map;
            }, {});

            // 6. Gabungkan dan Render Data (LOGIKA DIPERBARUI)
            adminAttendanceTableBody.innerHTML = ''; // Kosongkan tabel
            
            let html = '';
            let totalHadir = 0, totalIzin = 0, totalAlpa = 0;

            profiles.forEach(profile => {
                const att = attendanceMap[profile.id];
                
                // (LOGIKA BARU) Tentukan status default
                let status = 'Alpa';
                let clockIn = '-', clockOut = '-', location = '-', statusClass = getStatusClass('Alpa');

                if (att) {
                    // Karyawan punya data absensi
                    status = att.attendance_status;
                    statusClass = getStatusClass(status);
                    clockIn = formatTime(att.clock_in);
                    clockOut = formatTime(att.clock_out);
                    location = att.location || '-';
                } else {
                    // Karyawan tidak ada data (Cek Libur/Shift)
                    const schedule = profile.workhours?.schedule;
                    const isShiftOff = (schedule && schedule[todayName] && schedule[todayName].is_off === true);
                    
                    if (isMasterHoliday || isShiftOff) {
                        status = 'Libur';
                        statusClass = getStatusClass('Izin'); // Tampilan visual seperti Izin
                    }
                }
                
                // Hitung statistik
                if (status === 'Hadir' || status === 'Terlambat') totalHadir++;
                else if (status === 'Izin / Cuti' || status === 'Sakit') totalIzin++;
                else if (status === 'Alpa') totalAlpa++;
                // 'Libur' tidak dihitung di statistik

                // (BARU) Siapkan data untuk modal
                const safeName = profile.full_name.replace(/'/g, "\\'");
                const attId = att ? `'${att.id}'` : 'null'; // ID absensi (jika ada)
                const clockInVal = att ? formatTimeForInput(att.clock_in) : ''; // Waktu clock-in (jika ada)
                const clockOutVal = att ? formatTimeForInput(att.clock_out) : ''; // Waktu clock-out (jika ada)

                html += `
                    <tr class="cursor-pointer hover:bg-gray-50 transition-colors" 
                        onclick="openModal(${attId}, '${profile.id}', '${safeName}', '${status}', '${clockInVal}', '${clockOutVal}')"
                    >
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${profile.full_name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${clockIn}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${clockOut}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                            ${location}
                        </td>
                    </tr>
                `;
            });
            
            adminAttendanceTableBody.innerHTML = html;
            document.getElementById('adminTotalEmployees').textContent = employeeIds.length;
            document.getElementById('adminTotalHadir').textContent = totalHadir;
            document.getElementById('adminTotalIzin').textContent = totalIzin;
            document.getElementById('adminTotalAlpa').textContent = totalAlpa;

            document.getElementById('adminNoDataMessage').classList.toggle('hidden', employeeIds.length > 0);
        }

        async function loadEmployeeList() {
            employeeListTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat daftar karyawan...</td></tr>';
            
            // 1. Mulai query dasar
            let query = _supabase
                .from('profiles')
                .select('id, full_name, user_id_number, role, user_status, companies(name)'); // Ambil juga nama perusahaan

            // 2. Tambahkan filter HANYA jika yang login BUKAN Super Admin
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            
            // 3. Tambahkan pengurutan dan jalankan query
            query = query.order('full_name', { ascending: true });
            const { data: profiles, error } = await query;

            if (error) {
                console.error("Gagal memuat daftar karyawan:", error.message);
                employeeListTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (profiles.length === 0) {
                employeeListTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada karyawan terdaftar di perusahaan ini.</td></tr>';
                return;
            }

            // Sembunyikan kolom "Perusahaan" jika bukan Super Admin
            const companyHeader = document.getElementById('companyColumnHeader');
            if (companyHeader) {
                 companyHeader.style.display = (globalProfile.role === 'super_admin') ? 'table-cell' : 'none';
            }

            let html = profiles.map(profile => {
                const roleText = profile.role.replace('_', ' ');
                const statusClass = (profile.user_status === 'Percobaan' || profile.user_status === 'Kontrak') ? 'bg-yellow-100 text-yellow-800' : 
                                    (profile.user_status === 'Tetap' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');

                // Tampilkan nama perusahaan (jika ada)
                const companyName = profile.companies ? profile.companies.name : 'N/A';
                const companyCell = (globalProfile.role === 'super_admin') 
                    ? `<td class="px-4 py-3 text-sm text-gray-500">${companyName}</td>` 
                    : ''; // Sembunyikan sel jika Company Admin

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${profile.full_name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${profile.user_id_number || 'N/A'}</td>
                        ${companyCell} <!-- Sel Perusahaan -->
                        <td class="px-4 py-3 text-sm text-blue-600">${roleText.toUpperCase()}</td>
                        <td class="px-4 py-3 text-left">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${profile.user_status ? profile.user_status.toUpperCase() : 'N/A'}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="editEmployee('${profile.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');

            employeeListTableBody.innerHTML = html;
        }

        // --- FUNGSI BARU: CEK APAKAH HARI INI HARI LIBUR (DARI MASTER DATA) ---
        async function isTodayHoliday(dateString) {
            const today = dateString || getTodayDateString();
            
            // Query untuk mencari hari libur yang cocok dengan tanggal hari ini
            let query = _supabase.from('holidays')
                .select('id')
                .eq('holiday_date', today);

            // Filter: Hari libur harus global (company_id IS NULL) 
            // ATAU milik perusahaan karyawan yang sedang login
            if (globalProfile.company_id) {
                query = query.or(`company_id.eq.${globalProfile.company_id},company_id.is.null`);
            } else {
                query = query.is('company_id', null);
            }
            
            const { data, error } = await query.limit(1);

            if (error) {
                console.error("Gagal cek hari libur:", error.message);
                return false; // Anggap bukan hari libur jika gagal query
            }

            // Jika ada data (data.length > 0), berarti hari ini hari libur
            return data && data.length > 0;
        }
                
        // --- LOGIKA REKAP KEHADIRAN ---

        async function initializeRekapFilters() {
            const employeeFilter = document.getElementById('rekapEmployeeFilter');

            // HANYA muat jika belum pernah dimuat
            if (allEmployees.length === 0) {
                 // 1. Ambil daftar karyawan (mirip loadEmployeeList)
                let query = _supabase
                    .from('profiles')
                    .select('id, full_name')
                    .order('full_name', { ascending: true });

                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter rekap:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // 2. Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // 3. Atur tanggal default ke bulan ini
            const today = new Date();
            const year = today.getFullYear();
            // Format YYYY-MM
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            document.getElementById('rekapMonthFilter').value = `${year}-${month}`;
        }

        async function loadRekapData() {
            const rekapTableBody = document.getElementById('rekapTableBody');
            const monthYear = document.getElementById('rekapMonthFilter').value; // Cth: "2025-11"
            const employeeIdFilter = document.getElementById('rekapEmployeeFilter').value;
            const statusFilter = document.getElementById('rekapStatusFilter').value;
            const summaryContainer = document.getElementById('rekapSummaryContainer');
            const downloadButton = document.getElementById('rekapDownloadButton'); // BARU

            if (!monthYear) {
                showMessage("Harap pilih periode bulan.", 'error');
                return;
            }

            rekapTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Mencari data...</td></tr>';
            summaryContainer.classList.add('hidden'); 
            downloadButton.disabled = true; // Nonaktifkan tombol download saat mencari
            currentRekapData = []; // Reset data
            
            // 1. Tentukan rentang tanggal dari input bulan
            const [year, monthIdx] = monthYear.split('-').map(n => parseInt(n, 10));
            const month = monthIdx - 1; // JavaScript month index (0-11)
            
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0); // Tgl 0 bulan depan = hari terakhir bulan ini
            const daysInMonth = endDate.getDate();

            const startISO = startDate.toISOString();
            const endISO = new Date(year, month + 1, 1).toISOString(); 

            // 2. Ambil SEMUA karyawan yang relevan (sesuai filter)
            let employeeQuery = _supabase.from('profiles')
                .select('id, full_name, workhours( schedule )'); 
                
            if (globalProfile.role !== 'super_admin') {
                employeeQuery = employeeQuery.eq('company_id', globalProfile.company_id);
            }
            if (employeeIdFilter) {
                employeeQuery = employeeQuery.eq('id', employeeIdFilter);
            }
            const { data: profiles, error: profilesError } = await employeeQuery;

            if (profilesError || !profiles || profiles.length === 0) {
                rekapTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada karyawan ditemukan.</td></tr>';
                return;
            }

            // 3. Ambil SEMUA data absensi di rentang bulan ini
            const { data: attendanceData, error: attendanceError } = await _supabase
                .from('attendance')
                .select('created_at, user_id, clock_in, clock_out, attendance_status, description')
                .in('user_id', profiles.map(p => p.id))
                .gte('created_at', startISO)
                .lt('created_at', endISO);

            if (attendanceError) {
                rekapTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat absensi: ${attendanceError.message}</td></tr>`;
                return;
            }
            
            // 4. Ambil SEMUA Hari Libur Nasional di rentang bulan ini
            const { data: holidays } = await _supabase.from('holidays')
                .select('holiday_date')
                .gte('holiday_date', `${year}-${monthIdx}-01`)
                .lte('holiday_date', `${year}-${monthIdx}-${daysInMonth}`);
                
            const holidayMap = {};
            if (holidays) {
                holidays.forEach(h => { holidayMap[h.holiday_date] = true; });
            }

            // 5. Buat Peta (Map) data absensi untuk pencarian cepat
            // Key: "USER_ID|YYYY-MM-DD"
            const attendanceMap = new Map();
            attendanceData.forEach(att => {
                const dateKey = getTodayDateString(new Date(att.created_at));
                attendanceMap.set(`${att.user_id}|${dateKey}`, {
                    status: att.attendance_status,
                    clock_in: formatTime(att.clock_in),
                    clock_out: formatTime(att.clock_out),
                    ket: att.description || '-'
                });
            });

            // 6. Loop (Hari -> Karyawan) untuk membangun tabel
            let html = '';
            let countHadir = 0, countTerlambat = 0, countIzin = 0, countAlpa = 0;
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const rekapDataForExport = []; // Array untuk export

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateKey = getTodayDateString(currentDate); // "YYYY-MM-DD"
                const dayOfWeek = currentDate.getDay(); // 0=Minggu, 6=Sabtu
                
                const isMasterHoliday = holidayMap[dateKey] === true;

                profiles.forEach(profile => {
                    const schedule = profile.workhours?.schedule;
                    const todayName = dayNames[dayOfWeek]; // "Senin", "Selasa", ...
                    
                    const isShiftOff = (schedule && schedule[todayName] && schedule[todayName].is_off === true);
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    
                    const att = attendanceMap.get(`${profile.id}|${dateKey}`);
                    
                    let status = 'Alpa';
                    let statusClass = getStatusClass('Alpa');
                    let clockIn = '-', clockOut = '-', ket = '-';

                    if (att) {
                        status = att.status;
                        statusClass = getStatusClass(status);
                        clockIn = att.clock_in;
                        clockOut = att.clock_out;
                        ket = att.ket;
                    } else if (isMasterHoliday || isShiftOff || isWeekend) {
                        status = 'Libur';
                        statusClass = getStatusClass('Izin'); 
                    }
                    
                    // Logika Penghitungan Statistik
                    if (status === 'Hadir') countHadir++;
                    else if (status === 'Terlambat') countTerlambat++;
                    else if (status === 'Izin / Cuti') countIzin++;
                    else if (status === 'Alpa') countAlpa++;

                    // Simpan data mentah untuk Export
                    const rowData = {
                        tanggal: dateKey,
                        nama_karyawan: profile.full_name,
                        jam_masuk: clockIn,
                        jam_pulang: clockOut,
                        status: status,
                        keterangan: ket
                    };
                    
                    // Hanya simpan data yang memenuhi filter status (untuk tombol download)
                    if (statusFilter === '' || statusFilter === status) {
                        rekapDataForExport.push(rowData); 
                    }

                    // Logika Filter Status (Tampilkan di tabel jika cocok)
                    if (statusFilter === '' || statusFilter === status) {
                        html += `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dateKey}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${profile.full_name}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${clockIn}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${clockOut}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500">${ket}</td>
                            </tr>
                        `;
                    }
                });
            }
            
            // 7. Update UI Akhir
            if (html === '') {
                 html = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data ditemukan untuk filter status ini.</td></tr>';
                 summaryContainer.classList.add('hidden');
                 downloadButton.disabled = true;
            } else {
                document.getElementById('rekapTotalHadir').textContent = countHadir;
                document.getElementById('rekapTotalTerlambat').textContent = countTerlambat;
                document.getElementById('rekapTotalIzin').textContent = countIzin;
                document.getElementById('rekapTotalAlpa').textContent = countAlpa;
                summaryContainer.classList.remove('hidden');
                
                // Aktifkan tombol download dan simpan data
                downloadButton.disabled = false;
                currentRekapData = rekapDataForExport; // Simpan data yang sudah difilter
            }

            rekapTableBody.innerHTML = html;
        }

        // --- FUNGSI BARU: EXPORT KE EXCEL/XLSX ---
        function exportAttendanceData() {
            if (currentRekapData.length === 0) {
                showMessage("Tidak ada data untuk diunduh.", 'error');
                return;
            }
            
            showMessage("Mempersiapkan data untuk diunduh...", 'info');

            // 1. Konversi array JSON ke format Sheet (menggunakan xlsx.js)
            const ws = XLSX.utils.json_to_sheet(currentRekapData);
            
            // 2. Buat Workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap_Kehadiran");
            
            // 3. Tentukan Nama File
            const monthYear = document.getElementById('rekapMonthFilter').value;
            const employeeFilter = document.getElementById('rekapEmployeeFilter');
            const employeeName = employeeFilter.value 
                ? employeeFilter.options[employeeFilter.selectedIndex].text.replace('-- ', '') 
                : 'Semua_Karyawan';
            
            const fileName = `Rekap_Absensi_${employeeName}_${monthYear}.xlsx`;
            
            // 4. Unduh File
            XLSX.writeFile(wb, fileName);
            showMessage(`File ${fileName} berhasil diunduh.`, 'success');
        }
        
        // --- LOGIKA STATISTIK KEHADIRAN KUMULATIF (BARU) ---

        // Helper: Inisialisasi filter tanggal dan event listener
        function initializeStatsFilters() {
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('statsEndDate').value = today;
            document.getElementById('statsStartDate').value = getTodayDateString(thirtyDaysAgo);

            // Tambahkan event listener untuk tombol filter
            document.getElementById('statsFilterButton').removeEventListener('click', loadStatsData);
            document.getElementById('statsFilterButton').addEventListener('click', loadStatsData);
        }

        // Fungsi utama untuk memuat dan menghitung statistik
        async function loadStatsData() {
            const statsTableBody = document.getElementById('statsTableBody');
            const startDateStr = document.getElementById('statsStartDate').value;
            const endDateStr = document.getElementById('statsEndDate').value;
            const filterButton = document.getElementById('statsFilterButton');

            if (!startDateStr || !endDateStr) {
                showMessage("Harap isi tanggal mulai dan tanggal akhir.", 'error');
                return;
            }

            filterButton.disabled = true;
            statsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Mencari data statistik...</td></tr>';
            
            // Konversi tanggal ke objek Date (menggunakan format lokal untuk menghindari TZ issue)
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            
            // Pastikan tanggal akhir tidak lebih awal dari tanggal mulai
            if (startDate > endDate) {
                showMessage("Tanggal Mulai tidak boleh setelah Tanggal Akhir.", 'error');
                filterButton.disabled = false;
                return;
            }

            // 1. Tentukan rentang ISO untuk query
            const startISO = startDate.toISOString();
            const endISO = new Date(endDate.getTime() + 24 * 60 * 60 * 1000).toISOString(); // Sampai akhir hari terakhir

            // 2. Ambil Semua Karyawan (Admin Company/Super Admin)
            let employeeQuery = _supabase.from('profiles')
                .select('id, full_name, role, workhours( schedule )')
                .in('role', ['karyawan', 'company_admin']) // Termasuk Admin Company
                .order('full_name', { ascending: true });
                
            if (globalProfile.role !== 'super_admin') {
                employeeQuery = employeeQuery.eq('company_id', globalProfile.company_id);
            }
            const { data: profiles, error: profilesError } = await employeeQuery;

            if (profilesError || !profiles || profiles.length === 0) {
                statsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada karyawan ditemukan.</td></tr>';
                filterButton.disabled = false;
                return;
            }
            const employeeIds = profiles.map(p => p.id);

            // 3. Ambil Semua Data Absensi dalam rentang
            const { data: attendanceData, error: attendanceError } = await _supabase
                .from('attendance')
                .select('user_id, attendance_status, created_at')
                .in('user_id', employeeIds)
                .gte('created_at', startISO)
                .lt('created_at', endISO);

            if (attendanceError) {
                statsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat absensi: ${attendanceError.message}</td></tr>`;
                filterButton.disabled = false;
                return;
            }

            // 4. Ambil Semua Hari Libur Nasional
            const { data: holidays } = await _supabase.from('holidays')
                .select('holiday_date')
                .or(`company_id.eq.${globalProfile.company_id},company_id.is.null`)
                .gte('holiday_date', startDateStr)
                .lte('holiday_date', endDateStr);
                
            const holidayMap = {};
            if (holidays) holidays.forEach(h => { holidayMap[h.holiday_date] = true; });

            // 5. Hitung Statistik Kumulatif
            const employeeStats = profiles.reduce((acc, profile) => {
                acc[profile.id] = { 
                    name: profile.full_name,
                    hadir: 0, 
                    terlambat: 0, 
                    izinCuti: 0, 
                    alpa: 0, 
                    totalWorkDays: 0,
                    schedule: profile.workhours?.schedule
                };
                return acc;
            }, {});

            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            
            // Loop Harian: Lakukan loop dari tanggal mulai sampai tanggal akhir
            const loopDate = new Date(startDate.getTime());
            while (loopDate <= endDate) {
                const dateKey = getTodayDateString(loopDate);
                const dayOfWeek = loopDate.getDay(); 
                const todayName = dayNames[dayOfWeek];
                
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                const isMasterHoliday = holidayMap[dateKey] === true;

                profiles.forEach(profile => {
                    const employeeId = profile.id;
                    const stats = employeeStats[employeeId];
                    const schedule = stats.schedule;
                    
                    const isShiftOff = (schedule && schedule[todayName] && schedule[todayName].is_off === true);
                    
                    // Cek apakah ini seharusnya HARI KERJA
                    if (!isMasterHoliday && !isShiftOff && !isWeekend) {
                        stats.totalWorkDays++;
                    }
                });

                loopDate.setDate(loopDate.getDate() + 1); // Lanjut ke hari berikutnya
            }

            // Loop Absensi: Ambil data absensi yang ada
            attendanceData.forEach(att => {
                const stats = employeeStats[att.user_id];
                if (!stats) return; // Skip jika profil tidak ditemukan (data usang)
                
                if (att.attendance_status === 'Hadir') {
                    stats.hadir++;
                } else if (att.attendance_status === 'Terlambat') {
                    stats.terlambat++;
                } else if (att.attendance_status === 'Izin / Cuti' || att.attendance_status === 'Sakit') {
                    stats.izinCuti++;
                }
            });

            // Hitung Alpa: Alpa = Total Hari Kerja - (Hadir + Terlambat + Izin/Cuti)
            Object.values(employeeStats).forEach(stats => {
                const totalPresentDays = stats.hadir + stats.terlambat + stats.izinCuti;
                stats.alpa = Math.max(0, stats.totalWorkDays - totalPresentDays);
            });

            // 6. Render Tabel
            let html = '';
            Object.values(employeeStats).forEach(stats => {
                html += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky-col">${stats.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">${stats.hadir}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">${stats.terlambat}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">${stats.izinCuti}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right font-semibold text-red-600">${stats.alpa}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${stats.totalWorkDays}</td>
                    </tr>
                `;
            });
            
            statsTableBody.innerHTML = html;
            filterButton.disabled = false;
        }

        // --- FUNGSI BARU: INIT FILTER PENGAJUAN KOREKSI KEHADIRAN (DITINGKATKAN) ---
        async function initializeReqAttFilters() {
            const employeeFilter = document.getElementById('reqAttEmployeeFilter');
            const tableBody = document.getElementById('reqAttTableBody'); // Tambahkan ini

            // BARIS KRITIS: Cek apakah elemen filter ditemukan sebelum melanjutkan
            if (!employeeFilter || !tableBody) {
                const sectionContainer = document.getElementById('sectionReqAttendance');
                if (sectionContainer) {
                    sectionContainer.innerHTML = '<div class="p-8 bg-red-100 border border-red-400 text-red-700 rounded-xl">Kesalahan! Elemen HTML Koreksi Kehadiran (Filter/Tabel) tidak ditemukan. Mohon periksa kembali struktur HTML pada SECTION 5.</div>';
                }
                return;
            }

            // Reuse allEmployees data if already loaded by Rekap feature
            // Variabel allEmployees didefinisikan di logic Rekap Kehadiran
            if (allEmployees.length === 0) { 
                 // 1. Ambil daftar karyawan
                let query = _supabase
                    .from('profiles')
                    .select('id, full_name')
                    .order('full_name', { ascending: true });

                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter pengajuan:", error.message);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat daftar karyawan.</td></tr>';
                    loadRequestAttendanceData(); // Kita tetap panggil loader agar tampilan tidak kosong total
                    return;
                }
                allEmployees = data;
            }

            // 2. Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // 3. Atur tanggal default ke 30 hari ke belakang
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqAttEndDate').value = today;
            document.getElementById('reqAttStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // 4. Muat data setelah filter siap
            loadRequestAttendanceData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN KOREKSI KEHADIRAN ---
        async function loadRequestAttendanceData() {
            const tableBody = document.getElementById('reqAttTableBody');
            const startDate = document.getElementById('reqAttStartDate').value;
            const endDate = document.getElementById('reqAttEndDate').value;
            const employeeId = document.getElementById('reqAttEmployeeFilter').value;
            const statusFilter = document.getElementById('reqAttStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Mencari pengajuan...</td></tr>';

            // Filter oleh RLS sudah berjalan otomatis berdasarkan company_id

            let query = _supabase
                .from('attendance_requests')
                .select(`
                    id, 
                    attendance_date, 
                    clock_in, 
                    clock_out, 
                    description, 
                    requests_status,
                    user_id,
                    company_id,
                    profiles(full_name)
                `)
                // Filter Tanggal Kehadiran (attendance_date)
                .gte('attendance_date', startDate) 
                .lte('attendance_date', endDate); 

            // Filter berdasarkan Nama Karyawan
            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }

            // Filter berdasarkan Status
            if (statusFilter) {
                query = query.eq('requests_status', statusFilter);
            }

            // Urutkan berdasarkan tanggal diajukan (terbaru di atas)
            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan koreksi:", error.message);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada pengajuan koreksi yang cocok dengan filter.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const dateDisplay = new Date(req.attendance_date).toLocaleDateString('id-ID');
                // Catatan: Gunakan req.clock_in / req.clock_out karena ini adalah data yang diajukan
                const clockInTime = req.clock_in ? formatTime(req.clock_in) : '-'; 
                const clockOutTime = req.clock_out ? formatTime(req.clock_out) : '-';
                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const description = req.description || '-';
                const status = req.requests_status;
                
                let statusClass;
                let actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveRequest('${req.id}', '${req.user_id}', '${req.company_id}', '${req.attendance_date}', '${req.clock_in}', '${req.clock_out}', '${req.description}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectRequest('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${dateDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${clockInTime}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${clockOutTime}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI ADMIN: AKSI PENGAJUAN (IMPLEMENTASI BARU) ---
        async function handleApproveRequest(requestId, userId, companyId, attendanceDate, clockIn, clockOut, description) {
            showMessage("Memproses persetujuan...", 'info');
            
            // 1. Konversi string 'null' atau undefined ke null literal
            const clockInISO = (clockIn === 'null' || !clockIn) ? null : clockIn;
            const clockOutISO = (clockOut === 'null' || !clockOut) ? null : clockOut;
            
            // 2. Tentukan rentang tanggal (mulai dan akhir hari)
            // Penting: Gunakan 'T00:00:00' untuk memastikan interpretasi tanggal lokal
            const startOfDay = new Date(attendanceDate + 'T00:00:00').toISOString();
            const endOfDay = new Date(new Date(attendanceDate + 'T00:00:00').getTime() + 24 * 60 * 60 * 1000).toISOString();

            // 3. Cek apakah sudah ada data absensi di 'attendance' pada tanggal itu
            //    (Misalnya, jika statusnya 'Alpa' atau 'Izin')
            const { data: existingAtt, error: findError } = await _supabase
                .from('attendance')
                .select('id')
                .eq('user_id', userId)
                .gte('created_at', startOfDay) // Gunakan created_at untuk mencocokkan tanggal
                .lt('created_at', endOfDay)
                .limit(1)
                .single(); // Ambil satu saja

            // Abaikan error 'PGRST116' (No rows found), karena itu yang kita harapkan jika 'Alpa'
            if (findError && findError.code !== 'PGRST116') { 
                showMessage(`Gagal mencari absensi: ${findError.message}`, 'error');
                return;
            }

            // 4. Siapkan payload untuk tabel 'attendance'
            // Kita asumsikan statusnya menjadi 'Hadir'.
            const attendancePayload = {
                user_id: userId,
                company_id: companyId,
                attendance_status: 'Hadir', 
                clock_in: clockInISO,
                clock_out: clockOutISO,
                description: (description !== 'null' && description !== 'undefined' ? description : null),
                updated_at: new Date().toISOString()
            };

            let attendanceError = null;

            if (existingAtt) {
                // 5a. JIKA ADA: UPDATE data absensi yang ada
                const { error } = await _supabase
                    .from('attendance')
                    .update(attendancePayload)
                    .eq('id', existingAtt.id);
                attendanceError = error;
            } else {
                // 5b. JIKA TIDAK ADA: INSERT data absensi baru (kasus 'Alpa')
                const insertPayload = {
                    ...attendancePayload,
                    // Set created_at ke jam clock_in, atau awal hari jika clock_in null
                    created_at: clockInISO || startOfDay 
                };
                const { error } = await _supabase
                    .from('attendance')
                    .insert([insertPayload]);
                attendanceError = error;
            }

            if (attendanceError) {
                showMessage(`Gagal menyimpan ke absensi: ${attendanceError.message}`, 'error');
                return;
            }

            // 6. Update status di 'attendance_requests' menjadi 'Disetujui'
            const { error: requestError } = await _supabase
                .from('attendance_requests')
                .update({ requests_status: 'Disetujui' })
                .eq('id', requestId);

            if (requestError) {
                showMessage(`Absensi diperbarui, tapi status request gagal diubah: ${requestError.message}`, 'error');
            } else {
                showMessage('Pengajuan koreksi berhasil disetujui dan data absensi telah diperbarui.', 'success');
            }

            loadRequestAttendanceData(); // Muat ulang tabel pengajuan
        }

        async function handleRejectRequest(requestId) {
            showMessage("Memproses penolakan...", 'info');

            // Cukup update status request menjadi 'Ditolak'
            const { error } = await _supabase
                .from('attendance_requests')
                .update({ requests_status: 'Ditolak' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menolak pengajuan: ${error.message}`, 'error');
                return;
            }

            showMessage('Pengajuan koreksi telah ditolak.', 'success');
            loadRequestAttendanceData(); // Muat ulang tabel pengajuan
        }

        // --- FUNGSI BARU: INIT FILTER PENGAJUAN IZIN/CUTI ---
        async function initializeReqTimeoffFilters() {
            const employeeFilter = document.getElementById('reqTimeoffEmployeeFilter');
            const tableBody = document.getElementById('reqTimeoffTableBody');

            if (!employeeFilter || !tableBody) {
                console.error("Elemen filter Izin/Cuti tidak ditemukan!");
                return;
            }

            // (Gunakan data allEmployees yang sudah dimuat)
            if (allEmployees.length === 0) { 
                 let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data, error } = await query;
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter izin:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // Atur tanggal default
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqTimeoffEndDate').value = today;
            document.getElementById('reqTimeoffStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // Muat data awal
            loadRequestTimeoffData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN IZIN/CUTI ---
        async function loadRequestTimeoffData() {
            const tableBody = document.getElementById('reqTimeoffTableBody');
            const startDate = document.getElementById('reqTimeoffStartDate').value;
            const endDate = document.getElementById('reqTimeoffEndDate').value;
            const employeeId = document.getElementById('reqTimeoffEmployeeFilter').value;
            const statusFilter = document.getElementById('reqTimeoffStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Mencari pengajuan izin/cuti...</td></tr>';

            let query = _supabase
                .from('timeoff_requests')
                .select(`
                    id, 
                    created_at,
                    user_id,
                    timeoff_type_id, 
                    timeoff_types ( name ), 
                    start_date,
                    end_date,
                    description, 
                    timeoff_status,
                    profiles(full_name)
                `)
                // Filter Tanggal Mulai Izin (start_date)
                .gte('start_date', startDate) 
                .lte('start_date', endDate); 

            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }
            if (statusFilter) {
                query = query.eq('timeoff_status', statusFilter);
            }
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }

            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan izin:", error.message);
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Tidak ada pengajuan izin/cuti yang cocok.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const tglPengajuan = new Date(req.created_at).toLocaleDateString('id-ID');
                const tglMulai = new Date(req.start_date).toLocaleDateString('id-ID');
                const tglAkhir = new Date(req.end_date).toLocaleDateString('id-ID');
                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const timeoffName = (req.timeoff_types && req.timeoff_types.name) ? req.timeoff_types.name : 'N/A';
                const description = req.description || '-';
                const status = req.timeoff_status;
                
                let statusClass, actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveTimeoff('${req.id}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectTimeoff('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglPengajuan}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${timeoffName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglMulai}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglAkhir}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI BARU: AKSI SETUJUI / TOLAK IZIN/CUTI ---
        async function handleApproveTimeoff(requestId) {
            showMessage("Memproses persetujuan (Timeoff)...", 'info');
            
            // 1. Ambil data pengajuan (termasuk jenis cuti dan data perusahaan)
            const { data: request, error: requestError } = await _supabase
                .from('timeoff_requests')
                .select(`
                    *,
                    timeoff_types ( name, is_deductible )
                `)
                .eq('id', requestId)
                .single();

            if (requestError || !request) {
                showMessage(`Gagal memuat data pengajuan: ${requestError?.message || 'Tidak ditemukan.'}`, 'error');
                return;
            }

            // 2. Logika Pengurangan Saldo Cuti (JIKA DIPERLUKAN)
            if (request.timeoff_types && request.timeoff_types.is_deductible) {
                const startDate = new Date(request.start_date);
                const endDate = new Date(request.end_date);
                
                // Hitung jumlah hari kerja (skip Sabtu/Minggu)
                let totalDays = 0;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0=Minggu, 6=Sabtu
                        totalDays++;
                    }
                }

                if (totalDays > 0) {
                    // Ambil saldo karyawan
                    const { data: balance, error: balanceError } = await _supabase
                        .from('employee_timeoff_balances')
                        .select('id, balance_days')
                        .eq('user_id', request.user_id)
                        .eq('timeoff_type_id', request.timeoff_type_id)
                        .single();

                    if (balanceError || !balance) {
                        showMessage(`Gagal: Karyawan ini tidak memiliki data saldo untuk "${request.timeoff_types.name}".`, 'error');
                        return;
                    }
                    
                    if (balance.balance_days < totalDays) {
                        showMessage(`Gagal: Saldo cuti karyawan tidak mencukupi (Sisa: ${balance.balance_days}, Dibutuhkan: ${totalDays}).`, 'error');
                        return;
                    }

                    // Kurangi saldo
                    const newBalance = balance.balance_days - totalDays;
                    const { error: updateBalanceError } = await _supabase
                        .from('employee_timeoff_balances')
                        .update({ balance_days: newBalance })
                        .eq('id', balance.id);

                    if (updateBalanceError) {
                        showMessage(`Gagal mengurangi saldo cuti: ${updateBalanceError.message}`, 'error');
                        return;
                    }
                    showMessage(`Saldo cuti dikurangi: ${totalDays} hari. Sisa: ${newBalance} hari.`, 'info');
                }
            }

            // 3. Masukkan data ke tabel 'attendance' (Logika UPSERT per hari)
            const startDate = new Date(request.start_date + 'T00:00:00'); // Tgl Mulai (Lokal)
            const endDate = new Date(request.end_date + 'T00:00:00'); // Tgl Akhir (Lokal)

            try {
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    // Skip jika Sabtu (6) atau Minggu (0)
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        continue; 
                    }
                    
                    // (REVISI) Gunakan string lokal YYYY-MM-DD
                    const localDateString = getTodayDateString(d); // Cth: "2025-11-17"
                    
                    // (REVISI) Buat rentang ISO dari string lokal untuk memastikan akurasi zona waktu
                    const startOfDay = new Date(localDateString + 'T00:00:00').toISOString(); // 17 Nov 00:00:00 Lokal -> ISO UTC
                    const endOfDay = new Date(localDateString + 'T23:59:59').toISOString(); // 17 Nov 23:59:59 Lokal -> ISO UTC

                    // Cek apakah sudah ada data absensi di hari itu
                    const { data: existingAtt, error: findError } = await _supabase
                        .from('attendance')
                        .select('id')
                        .eq('user_id', request.user_id)
                        .gte('created_at', startOfDay) // (REVISI) Gunakan rentang ISO yang baru
                        .lte('created_at', endOfDay) // (REVISI) Gunakan rentang ISO yang baru
                        .limit(1)
                        .single();
                    
                    if (findError && findError.code !== 'PGRST116') { // Abaikan 'No rows found'
                        throw new Error(`Gagal cek absensi: ${findError.message}`);
                    }

                    // Siapkan payload (Gunakan ENUM baru 'Izin / Cuti')
                    const attendancePayload = {
                        user_id: request.user_id,
                        company_id: request.company_id,
                        attendance_status: 'Izin / Cuti', 
                        clock_in: null,
                        clock_out: null,
                        description: request.description || (request.timeoff_types ? request.timeoff_types.name : 'Izin'),
                        updated_at: new Date().toISOString()
                    };
                    
                    if (existingAtt) {
                        // UPDATE jika sudah ada (cth: 'Alpa' diganti 'Izin')
                        const { error } = await _supabase
                            .from('attendance')
                            .update(attendancePayload)
                            .eq('id', existingAtt.id);
                        if(error) throw new Error(`Gagal update absensi: ${error.message}`);
                    } else {
                        // INSERT jika belum ada ('Alpa' tidak tercatat)
                        const insertPayload = {
                            ...attendancePayload,
                            created_at: startOfDay // (REVISI) Tetap gunakan startOfDay (ISO 17 Nov 00:00 Lokal)
                        };
                        const { error } = await _supabase
                            .from('attendance')
                            .insert([insertPayload]);
                        if(error) throw new Error(`Gagal insert absensi: ${error.message}`);
                    }
                }
            } catch (e) {
                showMessage(`Error saat memproses absensi: ${e.message}`, 'error');
                return; // Hentikan proses jika gagal di tengah jalan
            }

            // 4. Update status pengajuan timeoff
            const { error } = await _supabase
                .from('timeoff_requests')
                .update({ timeoff_status: 'Disetujui' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Absensi diperbarui, tapi status request gagal diubah: ${error.message}`, 'error');
            } else {
                showMessage('Pengajuan Izin/Cuti disetujui dan data absensi telah diperbarui.', 'success');
            }
            
            loadRequestTimeoffData();
        }

        async function handleRejectTimeoff(requestId) {
            // (FUNGSI INI SEKARANG HANYA MENGUBAH STATUS)
            showMessage("Memproses penolakan (Timeoff)...", 'info');
            
            // TODO: Jika pengajuan sudah 'Disetujui' lalu 'Ditolak', 
            // kita harus mengembalikan saldo cuti. (Logika masa depan)
            
            const { error } = await _supabase
                .from('timeoff_requests')
                .update({ timeoff_status: 'Ditolak' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menolak: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Izin/Cuti ditolak.', 'success');
            loadRequestTimeoffData();
        }

        // --- FUNGSI BARU: INIT FILTER PENGAJUAN LEMBUR ---
        async function initializeReqOvertimeFilters() {
            const employeeFilter = document.getElementById('reqOvertimeEmployeeFilter');
            const tableBody = document.getElementById('reqOvertimeTableBody');

            if (!employeeFilter || !tableBody) {
                console.error("Elemen filter Lembur tidak ditemukan!");
                return;
            }

            // (Gunakan data allEmployees yang sudah dimuat, atau muat jika kosong)
            if (allEmployees.length === 0) { 
                let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data, error } = await query;
                if (error) {
                    console.error("Gagal memuat karyawan untuk filter lembur:", error.message);
                    return;
                }
                allEmployees = data;
            }

            // Isi Dropdown Karyawan
            let options = '<option value="">-- Semua Karyawan --</option>';
            options += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeFilter.innerHTML = options;

            // Atur tanggal default
            const today = getTodayDateString();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('reqOvertimeEndDate').value = today;
            document.getElementById('reqOvertimeStartDate').value = getTodayDateString(thirtyDaysAgo);
            
            // Muat data awal
            loadRequestOvertimeData();
        }

        // --- FUNGSI BARU: MEMUAT DATA PENGAJUAN LEMBUR ---
        async function loadRequestOvertimeData() {
            const tableBody = document.getElementById('reqOvertimeTableBody');
            const startDate = document.getElementById('reqOvertimeStartDate').value;
            const endDate = document.getElementById('reqOvertimeEndDate').value;
            const employeeId = document.getElementById('reqOvertimeEmployeeFilter').value;
            const statusFilter = document.getElementById('reqOvertimeStatusFilter').value;

            if (!startDate || !endDate) return;

            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Mencari pengajuan lembur...</td></tr>';

            let query = _supabase
                .from('overtime_requests')
                .select(`
                    id, 
                    created_at,
                    user_id,
                    overtime_date, 
                    start_time,
                    end_time,
                    description, 
                    overtime_status,
                    profiles(full_name)
                `)
                // Filter Tanggal Lembur (overtime_date)
                .gte('overtime_date', startDate) 
                .lte('overtime_date', endDate); 

            if (employeeId) {
                query = query.eq('user_id', employeeId);
            }
            if (statusFilter) {
                query = query.eq('overtime_status', statusFilter);
            }
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }

            query = query.order('created_at', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat data pengajuan lembur:", error.message);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada pengajuan lembur yang cocok.</td></tr>';
                return;
            }

            let html = data.map((req, index) => {
                const tglDiajukan = new Date(req.created_at).toLocaleDateString('id-ID');
                const tglLembur = new Date(req.overtime_date).toLocaleDateString('id-ID');
                
                // Format waktu untuk start_time dan end_time (karena itu timestamp with time zone)
                const waktuMulai = formatTime(req.start_time);
                const waktuAkhir = formatTime(req.end_time);

                const name = req.profiles ? req.profiles.full_name : 'N/A';
                const description = req.description || '-';
                const status = req.overtime_status;
                
                let statusClass, actionButtons;

                if (status === 'Diajukan') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    actionButtons = `
                        <button onclick="handleApproveOvertime('${req.id}')" class="text-green-600 hover:text-green-800 mr-2">Setujui</button>
                        <button onclick="handleRejectOvertime('${req.id}')" class="text-red-600 hover:text-red-800">Tolak</button>
                    `;
                } else if (status === 'Disetujui') {
                    statusClass = 'bg-green-100 text-green-800';
                    actionButtons = `<span class="text-green-600">Selesai</span>`;
                } else { // Ditolak
                    statusClass = 'bg-red-100 text-red-800';
                    actionButtons = `<span class="text-red-600">Selesai</span>`;
                }

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${tglDiajukan}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${tglLembur}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${waktuMulai} - ${waktuAkhir}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // --- FUNGSI BARU: AKSI SETUJUI / TOLAK LEMBUR ---

        async function handleApproveOvertime(requestId) {
            showMessage("Memproses persetujuan (Lembur)...", 'info');
            
            // Logika persetujuan lembur: hanya update status menjadi 'Disetujui'
            // Data lembur yang disetujui akan dihitung oleh sistem Payroll di masa depan
            const { error } = await _supabase
                .from('overtime_requests')
                .update({ overtime_status: 'Disetujui' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menyetujui lembur: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Lembur disetujui.', 'success');
            loadRequestOvertimeData();
        }

        async function handleRejectOvertime(requestId) {
            showMessage("Memproses penolakan (Lembur)...", 'info');
            
            const { error } = await _supabase
                .from('overtime_requests')
                .update({ overtime_status: 'Ditolak' })
                .eq('id', requestId);

            if (error) {
                showMessage(`Gagal menolak lembur: ${error.message}`, 'error');
                return;
            }
            showMessage('Pengajuan Lembur ditolak.', 'success');
            loadRequestOvertimeData();
        }

        // --- FUNGSI BARU: MASTER DATA (TAB, MODAL, CRUD) ---

        const masterDataModal = document.getElementById('masterDataModal');
        const masterDataForm = document.getElementById('masterDataForm');
        const masterModalTitle = document.getElementById('masterModalTitle');
        const masterName = document.getElementById('masterName');
        const masterDescription = document.getElementById('masterDescription');
        
        const masterDeleteModal = document.getElementById('masterDeleteModal');
        const masterDeleteText = document.getElementById('masterDeleteText');
        const masterDeleteConfirmButton = document.getElementById('masterDeleteConfirmButton');
        
        let currentMasterDelete = {}; // { type: 'timeoff', id: 123 }
        let currentMasterType = 'timeoff'; // 'timeoff', 'salary', 'deduction'

        // Mengatur Tab Aktif di Halaman Master Data
        function showMasterTab(tabName) {
            currentMasterType = tabName;
            
            // Definisikan tombol dan konten
            const tabs = ['timeoff', 'salary', 'deduction', 'holiday'];
            
            tabs.forEach(tab => {
                const tabButton = document.getElementById(`tabMaster${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                const tabContent = document.getElementById(`masterContent${tab.charAt(0).toUpperCase() + tab.slice(1)}`);

                if (tab === tabName) {
                    // Aktifkan tab
                    tabButton.classList.add('border-blue-500', 'text-blue-600');
                    tabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    tabContent.classList.remove('hidden');
                } else {
                    // Nonaktifkan tab
                    tabButton.classList.remove('border-blue-500', 'text-blue-600');
                    tabButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    tabContent.classList.add('hidden');
                }
            });

            // Muat data untuk tab yang dipilih (jika diperlukan)
            if (tabName === 'timeoff') {
                loadTimeoffTypes();
            } else if (tabName === 'salary') {
                loadSalaryTypes();
            } else if (tabName === 'deduction') {
                loadDeductionTypes();
            } else if (tabName === 'holiday') { // <-- BARU
                loadHolidays();
            }
        }

        // Membuka Modal Add/Edit
        async function openMasterModal(mode, type, id = null, name = '', description = '', companyId = null, method = 'Nominal Tetap', value = 0, conditionRuleString = '{}', isDeductible = false) {
            masterDataForm.reset();
            currentMasterType = type;
            
            let titlePrefix = (mode === 'add') ? 'Tambah' : 'Edit';
            let tableName = '';
            
            if (type === 'timeoff') tableName = 'Tipe Izin/Cuti';
            else if (type === 'salary') tableName = 'Tipe Gaji';
            else if (type === 'deduction') tableName = 'Tipe Potongan';

            masterModalTitle.textContent = `${titlePrefix} ${tableName}`;
            masterName.value = name;
            masterDescription.value = (description && description !== 'null') ? description : '';

            // --- (LOGIKA DROPDOWN SUPER ADMIN - Tidak berubah) ---
            const companySelectContainer = document.getElementById('masterCompanySelectContainer');
            const companySelect = document.getElementById('masterCompanySelect');
            if (globalProfile.role === 'super_admin') {
                companySelectContainer.classList.remove('hidden');
                companySelect.required = false; 
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                const { data } = await _supabase.from('companies').select('id, name').order('name', { ascending: true });
                if (data) {
                    let options = '<option value="">-- Global (Semua Perusahaan) --</option>';
                    options += data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    companySelect.innerHTML = options;
                }
                companySelect.value = companyId || ''; 
            } else {
                companySelectContainer.classList.add('hidden');
                companySelect.required = false;
            }
            
            // --- (LOGIKA BARU) SEMBUNYIKAN/TAMPILKAN FIELD KHUSUS ---
            
            // 1. Ambil semua elemen field khusus
            const deductionFields = document.getElementById('masterDeductionFields');
            const salaryFields = document.getElementById('masterSalaryFields');
            const timeoffFields = document.getElementById('masterTimeoffFields'); // <-- BARU
            const deductionConditionContainer = document.getElementById('masterDeductionConditionContainer');
            const salaryConditionContainer = document.getElementById('masterSalaryConditionContainer');

            // 2. Sembunyikan semua field khusus terlebih dahulu
            deductionFields.classList.add('hidden');
            salaryFields.classList.add('hidden');
            timeoffFields.classList.add('hidden');
            deductionConditionContainer.classList.add('hidden');
            salaryConditionContainer.classList.add('hidden');

            // 3. Parse aturan kondisi
            const conditionRule = JSON.parse(conditionRuleString.replace(/\\'/g, "'") || '{}');

            if (type === 'timeoff') { // <-- BARU
                // Tampilkan field CUTI
                timeoffFields.classList.remove('hidden');
                document.getElementById('masterTimeoffDeductible').checked = (isDeductible === 'true' || isDeductible === true);

            } else if (type === 'deduction') {
                // Tampilkan field POTONGAN
                deductionFields.classList.remove('hidden');
                document.getElementById('masterDeductionMethod').value = method;
                document.getElementById('masterDeductionValue').value = value;
                
                // Tampilkan pemicu jika 'Berdasarkan Absensi'
                if (method === 'Berdasarkan Absensi') {
                    deductionConditionContainer.classList.remove('hidden');
                    document.getElementById('masterDeductionCondition').value = conditionRule?.trigger_status || '';
                }
            
            } else if (type === 'salary') {
                // Tampilkan field GAJI
                salaryFields.classList.remove('hidden');
                document.getElementById('masterSalaryMethod').value = method;
                document.getElementById('masterSalaryValue').value = value;

                // Tampilkan pemicu jika 'Berdasarkan Lembur' atau 'Berdasarkan Absensi'
                if (method === 'Berdasarkan Lembur') {
                    salaryConditionContainer.classList.remove('hidden');
                    // Tentukan nilai pemicu berdasarkan 'trigger_source'
                    document.getElementById('masterSalaryCondition').value = (conditionRule?.trigger_source === 'overtime_requests') ? 'overtime_approved' : '';
                } else if (method === 'Berdasarkan Absensi') {
                    salaryConditionContainer.classList.remove('hidden');
                    // Tentukan nilai pemicu berdasarkan 'trigger_status'
                    document.getElementById('masterSalaryCondition').value = conditionRule?.trigger_status || '';
                }
            }
            // --- (AKHIR LOGIKA BARU) ---

            // Simpan data di form dataset
            masterDataForm.dataset.mode = mode;
            masterDataForm.dataset.id = id; 
            
            masterDataModal.classList.remove('hidden');
        }

        function closeMasterModal() {
            masterDataModal.classList.add('hidden');
        }

        // Membuka Modal Konfirmasi Hapus
        function openConfirmDeleteModal(type, id, name) {
            currentMasterDelete = { type, id };
            masterDeleteText.innerHTML = `Apakah Anda yakin ingin menghapus <strong>${name}</strong>? Data ini mungkin tidak bisa dipulihkan.`;
            masterDeleteModal.classList.remove('hidden');
        }

        function closeConfirmDeleteModal() {
            masterDeleteModal.classList.add('hidden');
            currentMasterDelete = {};
        }

        // CRUD: Memuat data Tipe Izin/Cuti
        async function loadTimeoffTypes() {
            const tableBody = document.getElementById('timeoffTypesTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data...</td></tr>'; // <-- Colspan diubah jadi 4

            // (PERBAIKAN 1) Ambil nama perusahaan
            let query = _supabase.from('timeoff_types').select('id, name, description, company_id, is_deductible, companies(name)');
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat timeoff_types:", error.message);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`; // <-- Colspan diubah jadi 4
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada data Tipe Izin/Cuti.</td></tr>'; // <-- Colspan diubah jadi 4
                return;
            }

            const html = data.map(item => {
                const description = item.description || '-';
                // Gunakan backslash untuk escape kutipan di dalam string
                const safeName = item.name.replace(/'/g, "\\'");
                const safeDesc = (item.description || '').replace(/'/g, "\\'");

                // (PERBAIKAN 2) Tentukan nama perusahaan
                // Jika Super Admin, tampilkan nama. Jika tidak ada, tampilkan 'Global'.
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-'); // Company admin tidak seharusnya melihat 'Global'

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td> <!-- (BARU) Kolom Perusahaan -->
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- (PERBAIKAN 3) Kirim item.company_id ke modal -->
                            <button onclick="openMasterModal('edit', 'timeoff', '${item.id}', '${safeName}', '${safeDesc}', '${item.company_id}', 'Nominal Tetap', 0, '{}', ${item.is_deductible})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('timeoff', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // CRUD: Memuat data Tipe Gaji (BARU)
        async function loadSalaryTypes() {
            const tableBody = document.getElementById('salaryTypesTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data...</td></tr>'; // Colspan jadi 6

            // (PERBAIKAN 1) Ambil 'method', 'value', 'condition_rule'
            let query = _supabase.from('salary_types').select('id, name, description, company_id, method, value, condition_rule, companies(name)');
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat salary_types:", error.message);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`; // Colspan 6
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada data Tipe Gaji.</td></tr>'; // Colspan 6
                return;
            }

            const html = data.map(item => {
                const description = item.description || '-';
                const safeName = item.name.replace(/'/g, "\\'");
                const safeDesc = (item.description || '').replace(/'/g, "\\'");
                // (PERBAIKAN 2) Siapkan method, value, companyId, dan condition
                const safeMethod = (item.method || 'Nominal Tetap').replace(/'/g, "\\'");
                const safeValue = item.value || 0;
                const safeCompanyId = item.company_id || '';
                const safeCondition = JSON.stringify(item.condition_rule || {}).replace(/'/g, "\\'");

                // Tentukan nama perusahaan
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-');
                
                // Format nilai
                const valueDisplay = (item.method === 'Berdasarkan Lembur') ? `Rp ${new Intl.NumberFormat('id-ID').format(item.value)} /jam` : 
                                     (item.method === 'Berdasarkan Absensi') ? `Rp ${new Intl.NumberFormat('id-ID').format(item.value)}` : 
                                     '-'; // Nominal Tetap tidak tampil nilai di sini

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${item.method}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${valueDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- (PERBAIKAN 3) Kirim data baru (method, value, condition) ke modal -->
                            <button onclick="openMasterModal('edit', 'salary', '${item.id}', '${safeName}', '${safeDesc}', '${safeCompanyId}', '${safeMethod}', ${safeValue}, '${safeCondition}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('salary', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // CRUD: Memuat data Tipe Potongan (BARU)
        async function loadDeductionTypes() {
            const tableBody = document.getElementById('deductionTypesTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data...</td></tr>'; // Colspan jadi 6

            // (PERBAIKAN 1) Ambil 'method' dan 'value'
            let query = _supabase.from('deduction_types').select('id, name, description, company_id, method, value, companies(name)');
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat deduction_types:", error.message);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`; // Colspan 6
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada data Tipe Potongan.</td></tr>'; // Colspan 6
                return;
            }

            const html = data.map(item => {
                const description = item.description || '-';
                const safeName = item.name.replace(/'/g, "\\'");
                const safeDesc = (item.description || '').replace(/'/g, "\\'");
                // (PERBAIKAN 2) Siapkan method, value, dan companyId
                const safeMethod = (item.method || 'Nominal Tetap').replace(/'/g, "\\'");
                const safeValue = item.value || 0;
                const safeCompanyId = item.company_id || '';
                const safeCondition = JSON.stringify(item.condition_rule || {}).replace(/'/g, "\\'");

                // Tentukan nama perusahaan
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-');
                
                // Format nilai
                const valueDisplay = (item.method === 'Persentase') ? `${item.value}%` : `Rp ${new Intl.NumberFormat('id-ID').format(item.value)}`;

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${item.method}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${valueDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${description}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <!-- (PERBAIKAN 3) Kirim data baru ke modal -->
                            <button onclick="openMasterModal('edit', 'deduction', '${item.id}', '${safeName}', '${safeDesc}', '${safeCompanyId}', '${safeMethod}', ${safeValue})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmDeleteModal('deduction', '${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // CRUD: Simpan data (Add/Edit)
        async function handleSaveMasterData(e) {
            e.preventDefault();
            
            const { mode, id } = masterDataForm.dataset;
            const tableName = (currentMasterType === 'timeoff') ? 'timeoff_types' : 
                              (currentMasterType === 'salary') ? 'salary_types' : 'deduction_types';

            // (Payload dasar)
            const payload = {
                name: masterName.value,
                description: masterDescription.value || null
            };

            // (Tentukan company_id - Tidak berubah)
            if (globalProfile.role === 'super_admin') {
                const selectedCompanyId = document.getElementById('masterCompanySelect').value;
                payload.company_id = selectedCompanyId ? selectedCompanyId : null; 
            } else {
                if (mode === 'add') {
                    payload.company_id = globalProfile.company_id;
                }
            }

            // (LOGIKA BARU) Tambahkan data khusus berdasarkan TIPE

            if (currentMasterType === 'timeoff') { 
                // Ambil data dari field Timeoff
                payload.is_deductible = document.getElementById('masterTimeoffDeductible').checked;
            
            } else if (currentMasterType === 'deduction') {
                // Ambil data dari field Potongan
                payload.method = document.getElementById('masterDeductionMethod').value;
                payload.value = parseFloat(document.getElementById('masterDeductionValue').value) || 0;
                
                payload.condition_rule = null; // <-- PINDAHKAN KE SINI
                if (payload.method === 'Berdasarkan Absensi') {
                    const triggerStatus = document.getElementById('masterDeductionCondition').value;
                    if (triggerStatus) {
                        payload.condition_rule = { trigger_status: triggerStatus };
                    }
                }
            
            } else if (currentMasterType === 'salary') {
                // Ambil data dari field Gaji
                payload.method = document.getElementById('masterSalaryMethod').value;
                payload.value = parseFloat(document.getElementById('masterSalaryValue').value) || 0;

                payload.condition_rule = null; // <-- TAMBAHKAN JUGA DI SINI
                const trigger = document.getElementById('masterSalaryCondition').value;
                
                if (payload.method === 'Berdasarkan Lembur' && trigger === 'overtime_approved') {
                    // Simpan aturan untuk lembur
                    payload.condition_rule = { 
                        trigger_source: 'overtime_requests', 
                        trigger_status: 'Disetujui' 
                    };
                } else if (payload.method === 'Berdasarkan Absensi' && trigger) {
                    // Simpan aturan untuk absensi (cth: bonus 'Hadir')
                    payload.condition_rule = { 
                        trigger_status: trigger 
                    };
                }
            }

            let query;
            if (mode === 'add') {
                query = _supabase.from(tableName).insert([payload]);
            } else {
                // Mode Edit
                query = _supabase.from(tableName).update(payload).eq('id', id);
            }

            showMessage("Menyimpan data...", 'info');
            const { error } = await query;

            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                return;
            }

            showMessage('Data master berhasil disimpan.', 'success');
            closeMasterModal();
            
            // Muat ulang data tabel yang sesuai
            if (currentMasterType === 'timeoff') loadTimeoffTypes();
            else if (currentMasterType === 'salary') loadSalaryTypes();
            else if (currentMasterType === 'deduction') loadDeductionTypes();
        }

        // CRUD: Hapus data (FUNGSI YANG HILANG)
        async function handleDeleteMasterData() {
            const { type, id } = currentMasterDelete;
            if (!type || !id) {
                console.error("Data delete master tidak ditemukan.");
                closeConfirmDeleteModal();
                return;
            }

            let tableName = '';
            if (type === 'timeoff') tableName = 'timeoff_types';
            else if (type === 'salary') tableName = 'salary_types';
            else if (type === 'deduction') tableName = 'deduction_types';
            else if (type === 'employee_salary') {
                tableName = 'employee_salaries';
            }
            else {
                console.error('Tipe master tidak dikenal:', type);
                return;
            }

            showMessage("Menghapus data...", 'info');
            
            const { error } = await _supabase.from(tableName).delete().eq('id', id);

            if (error) {
                // Cek error foreign key (jika data masih terpakai)
                if (error.code === '23503') { 
                    showMessage('Gagal: Data ini masih digunakan (cth: oleh Karyawan atau Gaji).', 'error');
                } else {
                    showMessage(`Gagal menghapus: ${error.message}`, 'error');
                }
                return;
            }

            showMessage('Data master berhasil dihapus.', 'success');
            closeConfirmDeleteModal();
            
            // Muat ulang tabel yang sesuai
            if (type === 'timeoff') loadTimeoffTypes();
            else if (type === 'salary') loadSalaryTypes();
            else if (type === 'deduction') loadDeductionTypes();
            
        }

        function openLateReasonModal() {
            lateReasonDescription.value = ''; // Kosongkan textarea
            lateReasonModal.classList.remove('hidden');
        }

        function closeLateReasonModal() {
            lateReasonModal.classList.add('hidden');
            tempClockInData = {}; // Hapus data sementara
            karyawanClockInButton.disabled = false;
        }

        // Fungsi baru untuk menangani INSERT (dipanggil oleh doClockIn atau submit modal)
        async function insertAttendance(clockInTime, location, status, description) {
            const newAttendance = {
                user_id: globalProfile.id,
                company_id: globalProfile.company_id,
                attendance_status: status, 
                clock_in: clockInTime.toISOString(),
                location: location,
                description: description // (BARU) Akan berisi alasan jika terlambat
            };
            
            const { error } = await _supabase
                .from('attendance')
                .insert([newAttendance]);

            if (error) {
                console.error(`Gagal Absen Masuk (${status}):`, error.message);
                showMessage(`Gagal Absen Masuk: ${error.message}.`, 'error');
                karyawanClockInButton.disabled = false; // Aktifkan lagi jika gagal
                return false;
            }
            
            const successMessage = (status === 'Terlambat') 
                ? 'Clock-In (Terlambat) Berhasil! Alasan Anda tersimpan.' 
                : 'Absen Masuk Berhasil! Selamat bekerja.';
                
            showMessage(successMessage, 'success');
            loadKaryawanAttendanceStatus(); // Muat ulang status (penting!)
            return true;
        }

        // Atur filter tanggal ke hari ini saat inisialisasi admin
        adminAttendanceDateFilter.value = getTodayDateString();
        adminAttendanceDateFilter.addEventListener('change', (e) => loadAdminAttendanceData(e.target.value));
        
        // --- LOGIKA MODAL ADMIN ---

        function openModal(attendanceId, userId, name, status, clockIn, clockOut) {
            modalAttendanceData = {
                id: attendanceId,
                user_id: userId,
                name: name
            };

            modalEmployeeName.textContent = name;
            
            modalStatus.value = status;
            modalClockIn.value = clockIn || '';
            modalClockOut.value = clockOut || '';

            const isHadir = status === 'Hadir' || status === 'Terlambat';
            modalClockIn.disabled = !isHadir;
            modalClockOut.disabled = !isHadir;

            modalStatus.onchange = () => {
                const newStatus = modalStatus.value;
                const newIsHadir = newStatus === 'Hadir' || newStatus === 'Terlambat';
                modalClockIn.disabled = !newIsHadir;
                modalClockOut.disabled = !newIsHadir;

                if (!newIsHadir) {
                    modalClockIn.value = '';
                    modalClockOut.value = '';
                }
            };

            statusModal.classList.remove('hidden');
        }

        function closeModal() {
            statusModal.classList.add('hidden');
            modalAttendanceData = {};
        }

        modalSaveButton.addEventListener('click', async () => {
            const status = modalStatus.value;
            const clockInTime = modalClockIn.value; // format HH:MM
            const clockOutTime = modalClockOut.value; // format HH:MM
            const dateString = adminAttendanceDateFilter.value;
            
            showMessage("Menyimpan perubahan...", 'info');
            
            // Konversi HH:MM menjadi ISO string pada tanggal yang difilter
            const combineDateTime = (time) => {
                if (!time) return null;
                const [hours, minutes] = time.split(':');
                const date = new Date(dateString);
                // Penting: Set jam dalam WAKTU LOKAL
                date.setHours(parseInt(hours, 10));
                date.setMinutes(parseInt(minutes, 10));
                date.setSeconds(0);
                date.setMilliseconds(0);
                return date.toISOString();
            };
            
            const payload = {
                attendance_status: status,
                clock_in: combineDateTime(clockInTime),
                clock_out: combineDateTime(clockOutTime),
                updated_at: new Date().toISOString()
            };

            if (modalAttendanceData.id && modalAttendanceData.id !== 'null') {
                // KASUS 1: UPDATE ABSENSI YANG SUDAH ADA
                const { error } = await _supabase
                    .from('attendance')
                    .update(payload)
                    .eq('id', modalAttendanceData.id);

                if (error) {
                    showMessage(`Gagal update: ${error.message}`, 'error');
                    return;
                }
                
            } else {
                // KASUS 2: BUAT ABSENSI BARU (Misal mengubah Alpa menjadi Hadir)
                const newPayload = {
                    ...payload,
                    user_id: modalAttendanceData.user_id,
                    company_id: globalProfile.company_id,
                    created_at: combineDateTime(clockInTime) || new Date(dateString).toISOString(), 
                };
                
                const { error } = await _supabase
                    .from('attendance')
                    .insert([newPayload]);

                if (error) {
                    showMessage(`Gagal insert baru: ${error.message}`, 'error');
                    return;
                }
            }
            
            showMessage('Perubahan berhasil disimpan.', 'success');
            closeModal();
            loadAdminAttendanceData(dateString); // Muat ulang tabel
        });

        // --- 4. FUNGSI BARU: HELPER KONVERSI WAKTU ---
        function combineDateAndTime(dateString, timeString) {
            if (!dateString || !timeString) return null;
            
            const [hours, minutes] = timeString.split(':');
            
            // Buat tanggal baru berdasarkan dateString (PENTING: gunakan 'T00:00:00' untuk memastikan interpretasi lokal)
            // Ini memperbaiki bug timezone jika pengguna menginput tanggal kemarin
            const date = new Date(dateString + 'T00:00:00'); 
            
            // Set jam dan menit dalam WAKTU LOKAL
            date.setHours(parseInt(hours, 10));
            date.setMinutes(parseInt(minutes, 10));
            date.setSeconds(0);
            date.setMilliseconds(0);
            
            // Kembalikan sebagai ISO string
            return date.toISOString();
        }


        // --- 5. FUNGSI BARU: KIRIM PENGAJUAN ---
        // (Letakkan setelah fungsi helper di atas, sekitar baris 1815)

        async function handleNewAttendanceRequest(e) {
            e.preventDefault(); // Mencegah form reload halaman
            const saveButton = document.getElementById('saveRequestButton');
            saveButton.disabled = true;

            const attDate = document.getElementById('reqAttDate').value;
            const clockInTime = document.getElementById('reqAttClockIn').value;
            const clockOutTime = document.getElementById('reqAttClockOut').value;
            const description = document.getElementById('reqAttDescription').value;

            // Validasi constraint dari Supabase: Minimal 1 jam harus diisi
            if (!clockInTime && !clockOutTime) {
                showMessage("Gagal: Harap isi Jam Masuk atau Jam Pulang.", 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Mengirim pengajuan...", 'info');

            // Siapkan payload sesuai skema 'attendance_requests'
            const newRequest = {
                user_id: globalProfile.id,
                company_id: globalProfile.company_id,
                attendance_date: attDate,
                // Gunakan helper baru untuk konversi waktu
                clock_in: combineDateAndTime(attDate, clockInTime),
                clock_out: combineDateAndTime(attDate, clockOutTime),
                description: description,
                requests_status: 'Diajukan' // Default saat insert
            };

            const { error } = await _supabase
                .from('attendance_requests')
                .insert([newRequest]);

            if (error) {
                console.error("Gagal mengirim pengajuan:", error.message);
                showMessage(`Gagal: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage("Pengajuan koreksi berhasil dikirim.", 'success');
            closeRequestAttendanceModal();
            loadAttendanceRequests(); // Muat ulang daftar request di belakang modal
        }

        // ===============================================================
        // 4. LOGIKA AUTHENTIKASI UTAMA (GLOBAL)
        // ===============================================================
        
        async function doLogout() {
            const { error } = await _supabase.auth.signOut();
            if (!error) {
                globalProfile = null;
                changeView('loginView');
                showMessage('Anda telah logout.', 'info');
            } else {
                showMessage('Gagal logout: ' + error.message, 'error');
            }
        }

        async function checkAuthAndRole() {
            loadingView.style.display = 'flex'; // Tampilkan loading
            
            const { data: { session } } = await _supabase.auth.getSession();
            
            if (!session) {
                loadingView.style.display = 'none';
                return changeView('loginView'); // BUG FIX: Arahkan ke login jika tidak ada sesi
            }

            // Ambil data profil untuk menentukan peran
            const { data: profile, error: profileError } = await _supabase
                .from('profiles')
                .select(`
                    id, 
                    role, 
                    full_name, 
                    company_id,
                    workhour_id, 
                    workhours ( * ), 
                    companies ( status, payroll_start_day ) 
                `)
                .eq('id', session.user.id)
                .single();

            if (profileError || !profile) {
                console.error("Gagal memuat profil:", profileError?.message);
                showMessage("Gagal memuat data profil. Silakan login ulang.", 'error');
                await _supabase.auth.signOut();
                loadingView.style.display = 'none';
                return changeView('loginView');
            }

            // --- LOGIKA BARU: Cek Status Perusahaan ---
            if (profile.companies && profile.companies.status === 'tidak aktif') {
                // Jika perusahaan tidak aktif, tolak login
                showMessage("Login gagal: Perusahaan Anda saat ini tidak aktif. Hubungi administrator.", 'error');
                await doLogout(); // Paksa logout
                loadingView.style.display = 'none';
                return changeView('loginView'); // Arahkan kembali ke login
            }
            
            globalProfile = profile; // Simpan profil secara global
            const userRole = profile.role;
            await loadCompanyDetails();
            
            // Inisialisasi Jam
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDateTime');
            if (timeElement && dateElement) {
                initializeClock(timeElement, dateElement);
            }
            
            // Pengalihan berdasarkan Peran
            if (userRole === 'super_admin' || userRole === 'company_admin') {
                // ADMIN: Konfigurasi & Arahkan ke Admin View
                adminRoleDisplay.textContent = `(${userRole.replace('_', ' ').toUpperCase()})`;
                karyawanAdminLink.classList.remove('hidden'); // Tampilkan tombol Admin di tampilan Karyawan

                // --- MENGISI NAMA & EMAIL ADMIN (BARU) ---
                const adminName = globalProfile.full_name;
                const adminEmail = session.user.email;
                // Format: Nama Lengkap (email)
                document.getElementById('adminInfoDisplay').textContent = `${adminName} (${adminEmail})`;
                // --- AKHIR LOGIKA HEADER ADMIN ---

                // Tampilkan menu Perusahaan HANYA untuk Super Admin
                if (userRole === 'super_admin') {
                    document.getElementById('menuCompaniesContainer').classList.remove('hidden');
                } else {
                    document.getElementById('menuCompaniesContainer').classList.add('hidden');
                }
                
                // --- SETUP ADMIN EVENT LISTENERS (DIPINDAHKAN UNTUK ROBUSTNESS) ---
                // Menggunakan .onclick sebagai pengganti addEventListener untuk kepastian
                try {
                    document.getElementById('rekapFilterButton').onclick = loadRekapData;
                    document.getElementById('reqAttFilterButton').onclick = loadRequestAttendanceData;
                    document.getElementById('reqOvertimeFilterButton').onclick = loadRequestOvertimeData;
                    document.getElementById('reqTimeoffFilterButton').onclick = loadRequestTimeoffData;
                } catch (e) {
                    console.warn("Tombol filter admin belum sepenuhnya dimuat atau ID salah:", e.message);
                }
                // -----------------------------------------------------------------
                              
                // Muat status absensi Karyawan jika Admin melihat halaman Karyawan
                karyawanUserName.textContent = `Halo, ${profile.full_name}`; // <-- Diperbaiki
                loadKaryawanAttendanceStatus(); 

                loadingView.style.display = 'none';
                changeView('karyawanView'); 
                showKaryawanContent('Absensi'); // <-- Default ke tampilan Karyawan
                return;

            } else if (userRole === 'karyawan') {
                // KARYAWAN: Konfigurasi & Arahkan ke Karyawan View
                karyawanUserName.textContent = `Halo, ${profile.full_name}`; // <-- Diperbaiki
                karyawanAdminLink.classList.add('hidden');
                loadKaryawanAttendanceStatus();

                loadingView.style.display = 'none';
                return changeView('karyawanView'); // Default ke tampilan Karyawan
            }
            // Fallback (Peran tidak valid)
            showMessage("Peran pengguna tidak valid. Logout.", 'error');
            await doLogout();
        }

        // FUNGSI EDIT EMPLOYEE (BARU DITAMBAHKAN)
        async function editEmployee(profileId) {
            // 1. Ambil data profil
            showMessage("Memuat data karyawan...", 'info');
            const { data: profile, error } = await _supabase
                .from('profiles')
                .select('id, full_name, user_id_number, role, user_status, company_id,email, workhour_id')
                .eq('id', profileId)
                .single();
            
            if (error) {
                showMessage(`Gagal memuat data: ${error.message}`, 'error');
                return;
            }

            // 2. Buka modal dan isi form
            await openEmployeeModal(); // Panggil openEmployeeModal untuk mengisi dropdown perusahaan
            await loadWorkhourDropdown('employeeWorkhour', profile.company_id, profile.workhour_id);
            
            document.getElementById('employeeModalTitle').textContent = 'Edit Karyawan';
            document.getElementById('employeeForm').dataset.editingId = profile.id; // Tandai mode edit

            document.getElementById('employeeFullName').value = profile.full_name;
            document.getElementById('employeeIDNumber').value = profile.user_id_number;
            document.getElementById('employeeRole').value = profile.role;
            document.getElementById('employeeStatus').value = profile.user_status;
            
            if(globalProfile.role === 'super_admin' && profile.company_id) {
                document.getElementById('employeeCompany').value = profile.company_id;
            }

            // Nonaktifkan email dan password saat edit
            // Kita tidak perlu menampilkan email/password untuk mencegah error RLS di Auth
            document.getElementById('employeeEmail').value = profile.email || 'Email tidak tersimpan'; // Placeholder
            document.getElementById('employeeEmail').disabled = true;
            document.getElementById('employeePassword').required = false; 
            document.getElementById('employeePassword').previousElementSibling.textContent = "Password (Kosongkan jika tidak berubah)";
            
            document.getElementById('saveEmployeeButton').textContent = "Simpan Perubahan";
        }

            // Jalankan pemeriksaan saat aplikasi dimuat
            checkAuthAndRole();
        
        // --- 6. EVENT LISTENER BARU ---
            requestAttendanceForm.addEventListener('submit', handleNewAttendanceRequest);

        // Event listener untuk Modal Alasan Keterlambatan (BARU)
        lateReasonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('lateReasonSubmitButton');
            submitButton.disabled = true;
            
            const description = lateReasonDescription.value;
            const { status } = tempClockInData; // Ambil status yang sudah divalidasi (Terlambat)

            if (!status) {
                showMessage("Kesalahan alur: Status tidak ditemukan.", 'error');
                submitButton.disabled = false;
                return;
            }
            
            // 1. Lanjut ke Tahap 2 (Pencarian Lokasi/Peta), dengan membawa STATUS dan DESKRIPSI
            showMessage("Alasan diterima. Melanjutkan ke Tahap 2 (Pencarian Lokasi)...", 'info');
            closeLateReasonModal(); // Tutup modal alasan
            await processClockInLocation(status, description); // Lanjut ke proses lokasi
            
            // Tombol submit akan diaktifkan lagi jika ada error di processClockInLocation
            submitButton.disabled = false;
        });

        // Event listener untuk Filter Pengajuan Izin/Cuti (BARU)
        try {
            document.getElementById('reqTimeoffFilterButton').onclick = loadRequestTimeoffData;
        } catch (e) {
            console.warn("Tombol filter Izin/Cuti (reqTimeoffFilterButton) tidak ditemukan.");
        }

        // (BARU) Event listener untuk Form Pengajuan Izin/Cuti Karyawan
        try {
            document.getElementById('timeoffRequestForm').addEventListener('submit', handleNewTimeoffRequest);
        } catch (e) {
            console.warn("Form pengajuan timeoff (timeoffRequestForm) tidak ditemukan.");
        }

        // (BARU) Event listener untuk Filter Pengajuan Lembur
        try {
            document.getElementById('reqOvertimeFilterButton').onclick = loadRequestOvertimeData;
        } catch (e) {
            console.warn("Tombol filter Lembur (reqOvertimeFilterButton) tidak ditemukan.");
        }

        // Event listener untuk Master Data (BARU)
        try {
            masterDataForm.addEventListener('submit', handleSaveMasterData);
            masterDeleteConfirmButton.addEventListener('click', handleDeleteMasterData);
        } catch (e) {
            console.warn("Elemen Master Data (form/modal) tidak ditemukan.");
        }

        // --- FUNGSI BARU: CRUD MANAJEMEN JAM KERJA ---

        const workhourModal = document.getElementById('workhourModal');
        const workhourForm = document.getElementById('workhourForm');
        const workhourDeleteModal = document.getElementById('workhourDeleteModal');
        const workhourDeleteText = document.getElementById('workhourDeleteText');
        const workhourDeleteConfirmButton = document.getElementById('workhourDeleteConfirmButton');
        let currentWorkhourDeleteId = null;
        const workhourDays = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];
        const workhourDayNames = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];

        // 1. Memuat Daftar Jam Kerja
        async function loadWorkhoursList() {
            const tableBody = document.getElementById('workhoursTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat data pola jam kerja...</td></tr>';

            let query = _supabase.from('workhours').select('id, name, company_id, companies(name)');
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('name', { ascending: true });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat workhours:", error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada pola jam kerja.</td></tr>';
                return;
            }

            const html = data.map(item => {
                const safeName = item.name.replace(/'/g, "\\'");
                const companyName = (globalProfile.role === 'super_admin') 
                    ? (item.companies ? item.companies.name : '<span class="italic text-gray-500">Global (Semua)</span>') 
                    : (item.companies ? item.companies.name : '-');

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${companyName}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="openWorkhourModal('edit', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="openConfirmWorkhourDelete('${item.id}', '${safeName}')" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // 2. Membuka Modal (Add/Edit)
        async function openWorkhourModal(mode, id = null) {
            workhourForm.reset(); // Reset form
            document.getElementById('workhourModalTitle').textContent = (mode === 'add') ? 'Tambah Pola Jam Kerja' : 'Edit Pola Jam Kerja';
            workhourForm.dataset.mode = mode;
            workhourForm.dataset.id = id;

            // Atur Dropdown Perusahaan untuk Super Admin
            const companyContainer = document.getElementById('workhourCompanyContainer');
            const companySelect = document.getElementById('workhourCompanySelect');
            if (globalProfile.role === 'super_admin') {
                companyContainer.classList.remove('hidden');
                companySelect.required = false; // Boleh global (null)
                companySelect.innerHTML = '<option value="">Memuat perusahaan...</option>';
                
                const { data } = await _supabase.from('companies').select('id, name').order('name', { ascending: true });
                if (data) {
                    let options = '<option value="">-- Global (Semua Perusahaan) --</option>';
                    options += data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    companySelect.innerHTML = options;
                }
            } else {
                companyContainer.classList.add('hidden');
            }

            // Atur ulang field jadwal (default)
            workhourDays.forEach(day => {
                document.getElementById(`wh_${day}_start`).value = "08:00";
                document.getElementById(`wh_${day}_end`).value = "17:00";
                document.getElementById(`wh_${day}_is_off`).checked = (day === 'sabtu' || day === 'minggu');
                // Trigger event change untuk disable/enable input
                document.getElementById(`wh_${day}_is_off`).dispatchEvent(new Event('change'));
            });

            if (mode === 'edit') {
                showMessage("Memuat detail jam kerja...", 'info');
                const { data, error } = await _supabase.from('workhours').select('*').eq('id', id).single();
                if (error) {
                    showMessage(`Gagal memuat data: ${error.message}`, 'error');
                    return;
                }
                
                // Isi form dengan data
                document.getElementById('workhourName').value = data.name;
                if (globalProfile.role === 'super_admin') {
                    companySelect.value = data.company_id || '';
                }

                // Isi jadwal 7 hari dari JSON
                const schedule = data.schedule;
                workhourDayNames.forEach((dayName, index) => {
                    const dayKey = dayName; // Sesuai skema: "Senin", "Selasa", ...
                    const dayId = workhourDays[index]; // ID: 'senin', 'selasa', ...
                    
                    if (schedule[dayKey]) {
                        const dayData = schedule[dayKey];
                        const isOff = dayData.is_off || false;
                        document.getElementById(`wh_${dayId}_is_off`).checked = isOff;
                        if (!isOff) {
                            document.getElementById(`wh_${dayId}_start`).value = dayData.start;
                            document.getElementById(`wh_${dayId}_end`).value = dayData.end;
                        }
                        // Trigger event change untuk disable/enable input
                        document.getElementById(`wh_${dayId}_is_off`).dispatchEvent(new Event('change'));
                    }
                });
            }

            workhourModal.classList.remove('hidden');
        }

        // 3. Menutup Modal
        function closeWorkhourModal() {
            workhourModal.classList.add('hidden');
        }

        // 4. Menyimpan (Add/Edit)
        async function handleSaveWorkhour(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveWorkhourButton');
            saveButton.disabled = true;

            const { mode, id } = workhourForm.dataset;
            const name = document.getElementById('workhourName').value;

            // Bangun Objek JSON 'schedule'
            let schedule = {};
            workhourDayNames.forEach((dayName, index) => {
                const dayId = workhourDays[index]; // 'senin', 'selasa', ...
                const isOff = document.getElementById(`wh_${dayId}_is_off`).checked;
                
                if (isOff) {
                    schedule[dayName] = { is_off: true }; // dayName = "Senin", "Selasa", ...
                } else {
                    schedule[dayName] = {
                        is_off: false,
                        start: document.getElementById(`wh_${dayId}_start`).value,
                        end: document.getElementById(`wh_${dayId}_end`).value
                    };
                }
            });

            // Siapkan payload
            const payload = {
                name: name,
                schedule: schedule
            };

            // Tentukan company_id
            if (globalProfile.role === 'super_admin') {
                const selectedCompanyId = document.getElementById('workhourCompanySelect').value;
                payload.company_id = selectedCompanyId ? selectedCompanyId : null; // NULL untuk Global
            } else {
                if (mode === 'add') {
                    payload.company_id = globalProfile.company_id;
                }
            }
            
            // Lakukan Insert atau Update
            showMessage("Menyimpan pola jam kerja...", 'info');
            let query;
            if (mode === 'add') {
                query = _supabase.from('workhours').insert([payload]);
            } else {
                query = _supabase.from('workhours').update(payload).eq('id', id);
            }

            const { error } = await query;
            if (error) {
                showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                saveButton.disabled = false;
                return;
            }

            showMessage('Pola jam kerja berhasil disimpan.', 'success');
            closeWorkhourModal();
            loadWorkhoursList();
            saveButton.disabled = false;
        }

        // 5. Logika Hapus
        function openConfirmWorkhourDelete(id, name) {
            currentWorkhourDeleteId = id;
            workhourDeleteText.innerHTML = `Apakah Anda yakin ingin menghapus <strong>${name}</strong>? Karyawan yang terhubung dengan pola ini mungkin akan kehilangan jam kerjanya.`;
            workhourDeleteModal.classList.remove('hidden');
        }

        function closeConfirmWorkhourDelete() {
            workhourDeleteModal.classList.add('hidden');
            currentWorkhourDeleteId = null;
        }

        async function handleConfirmWorkhourDelete() {
            if (!currentWorkhourDeleteId) return;

            showMessage("Menghapus pola jam kerja...", 'info');
            
            const { error } = await _supabase.from('workhours').delete().eq('id', currentWorkhourDeleteId);
            
            if (error) {
                // Cek jika error karena Foreign Key (masih dipakai karyawan)
                if (error.code === '23503') { 
                    showMessage('Gagal hapus: Pola jam kerja ini masih digunakan oleh karyawan.', 'error');
                } else {
                    showMessage(`Gagal menghapus: ${error.message}`, 'error');
                }
                return;
            }

            showMessage('Pola jam kerja berhasil dihapus.', 'success');
            closeConfirmWorkhourDelete();
            loadWorkhoursList();
        }

        // --- FUNGSI BARU: CRUD MANAJEMEN SALDO CUTI ---

        const timeoffBalanceModal = document.getElementById('timeoffBalanceModal');
        const timeoffBalanceForm = document.getElementById('timeoffBalanceForm');
        
        // 1. Memuat Daftar Saldo Cuti
        async function loadTimeoffBalanceList() {
            const tableBody = document.getElementById('timeoffBalanceTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat saldo cuti...</td></tr>';

            // Ambil saldo cuti + nama karyawan + nama tipe cuti
            let query = _supabase.from('employee_timeoff_balances').select(`
                id, 
                balance_days, 
                user_id,
                profiles(full_name),
                timeoff_types(name)
            `);
            
            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            query = query.order('balance_days', { ascending: false });

            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat saldo cuti:", error.message);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada saldo cuti yang ditetapkan.</td></tr>';
                return;
            }

            const html = data.map(item => {
                const safeName = item.profiles ? item.profiles.full_name : 'N/A';
                const timeoffName = item.timeoff_types ? item.timeoff_types.name : 'N/A';
                const safeTimeoffName = timeoffName.replace(/'/g, "\\'");
                const balanceDisplay = new Intl.NumberFormat('id-ID', { maximumFractionDigits: 2 }).format(item.balance_days);

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${safeName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${timeoffName}</td>
                        <td class="px-4 py-3 text-center text-lg font-bold text-blue-600">${balanceDisplay}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="openTimeoffBalanceModal('edit', '${item.id}', '${item.user_id}', '${item.timeoff_type_id}', ${item.balance_days}, '${safeName}', '${safeTimeoffName}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit Saldo</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // 2. Membuka Modal (Add/Edit)
        async function openTimeoffBalanceModal(mode, id = null, userId = null, timeoffTypeId = null, balanceDays = 0, employeeName = '', timeoffTypeName = '') {
            document.getElementById('timeoffBalanceForm').reset();
            document.getElementById('timeoffBalanceModalTitle').textContent = (mode === 'add') ? 'Tetapkan Saldo Cuti Baru' : `Edit Saldo ${employeeName} (${timeoffTypeName})`;
            timeoffBalanceForm.dataset.mode = mode;
            timeoffBalanceForm.dataset.id = id;
            
            // Muat Dropdown Karyawan
            const employeeSelect = document.getElementById('balanceEmployeeSelect');
            if (allEmployees.length === 0) {
                let query = _supabase.from('profiles').select('id, full_name').order('full_name', { ascending: true });
                if (globalProfile.role !== 'super_admin') {
                    query = query.eq('company_id', globalProfile.company_id);
                }
                const { data } = await query;
                allEmployees = data || [];
            }
            let employeeOptions = '<option value="">-- Pilih Karyawan --</option>';
            employeeOptions += allEmployees.map(emp => `<option value="${emp.id}">${emp.full_name}</option>`).join('');
            employeeSelect.innerHTML = employeeOptions;

            // Muat Dropdown Tipe Cuti
            const timeoffSelect = document.getElementById('balanceTimeoffTypeSelect');
            timeoffSelect.innerHTML = '<option value="">Memuat Tipe Cuti...</option>';
            // HANYA ambil tipe cuti di perusahaan yang sama atau global (company_id IS NULL)
            let typeQuery = _supabase.from('timeoff_types').select('id, name');
            if (globalProfile.company_id) {
                typeQuery = typeQuery.or(`company_id.eq.${globalProfile.company_id},company_id.is.null`);
            } else {
                typeQuery = typeQuery.is('company_id', null);
            }
            const { data: timeoffTypes, error } = await typeQuery;
            if (error || timeoffTypes.length === 0) {
                timeoffSelect.innerHTML = '<option value="">Gagal/Tidak Ada Tipe Cuti</option>';
            } else {
                let typeOptions = '<option value="">-- Pilih Tipe Cuti --</option>';
                typeOptions += timeoffTypes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                timeoffSelect.innerHTML = typeOptions;
            }


            if (mode === 'edit') {
                document.getElementById('balanceEmployeeSelectContainer').classList.add('hidden'); // Sembunyikan karyawan saat edit
                document.getElementById('balanceTimeoffTypeSelectContainer').classList.add('hidden'); // Sembunyikan tipe cuti saat edit

                document.getElementById('balanceEmployeeSelect').value = userId;
                document.getElementById('balanceTimeoffTypeSelect').value = timeoffTypeId;
                document.getElementById('balanceDays').value = balanceDays;
            } else {
                document.getElementById('balanceEmployeeSelectContainer').classList.remove('hidden'); // Tampilkan karyawan saat add
                document.getElementById('balanceTimeoffTypeSelectContainer').classList.remove('hidden'); // Tampilkan tipe cuti saat add
                document.getElementById('balanceDays').value = 0;
            }

            timeoffBalanceModal.classList.remove('hidden');
        }

        // 3. Menutup Modal
        function closeTimeoffBalanceModal() {
            document.getElementById('timeoffBalanceModal').classList.add('hidden');
        }

        // 4. Menyimpan (Add/Edit)
        async function handleSaveTimeoffBalance(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveTimeoffBalanceButton');
            saveButton.disabled = true;

            const { mode, id } = timeoffBalanceForm.dataset;
            const userId = document.getElementById('balanceEmployeeSelect').value;
            const timeoffTypeId = document.getElementById('balanceTimeoffTypeSelect').value;
            const balanceDays = parseFloat(document.getElementById('balanceDays').value);

            if (mode === 'add' && (!userId || !timeoffTypeId)) {
                showMessage('Harap pilih Karyawan dan Tipe Cuti.', 'error');
                saveButton.disabled = false;
                return;
            }
            if (isNaN(balanceDays) || balanceDays < 0) {
                showMessage('Saldo harus angka non-negatif.', 'error');
                saveButton.disabled = false;
                return;
            }
            
            const payload = {
                balance_days: balanceDays,
            };

            // Tambahkan FKs HANYA saat mode 'add'
            if (mode === 'add') {
                payload.user_id = userId;
                payload.timeoff_type_id = timeoffTypeId;
                payload.company_id = globalProfile.company_id; // Ambil dari admin yang login
            }
            
            showMessage("Menyimpan saldo cuti...", 'info');
            let query;
            if (mode === 'add') {
                query = _supabase.from('employee_timeoff_balances').insert([payload]);
            } else {
                query = _supabase.from('employee_timeoff_balances').update(payload).eq('id', id);
            }

            const { error } = await query;
            if (error) {
                // Error 23505 adalah constraint unik
                if (error.code === '23505') {
                    showMessage('Gagal: Saldo untuk Karyawan dan Tipe Cuti ini sudah ada.', 'error');
                } else {
                    showMessage(`Gagal menyimpan: ${error.message}`, 'error');
                }
                saveButton.disabled = false;
                return;
            }

            showMessage('Saldo cuti berhasil disimpan.', 'success');
            closeTimeoffBalanceModal();
            loadTimeoffBalanceList();
            saveButton.disabled = false;
        }

        // (BARU) Fungsi Helper untuk memuat Dropdown Jam Kerja
        // 'companyId' = ID perusahaan yang dipilih
        // 'selectedWorkhourId' = (Opsional) ID jam kerja yang harus aktif (untuk mode edit)
        async function loadWorkhourDropdown(selectElementId, companyId, selectedWorkhourId = null) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;
            
            selectElement.innerHTML = '<option value="">Memuat...</option>';
            selectElement.disabled = true;

            // Query: Ambil jam kerja Global (company_id IS NULL) 
            // ATAU jam kerja milik perusahaan spesifik (company_id.eq(companyId))
            let whQuery = _supabase.from('workhours').select('id, name');
            
            if (companyId) {
                // Ambil Global DAN milik perusahaan
                whQuery = whQuery.or(`company_id.eq.${companyId},company_id.is.null`);
            } else {
                // Ambil HANYA Global (jika companyId null, cth: Super Admin belum pilih)
                whQuery = whQuery.is('company_id', null);
            }
            
            const { data, error } = await whQuery.order('name', { ascending: true });

            if (error) {
                console.error("Gagal memuat workhours untuk dropdown:", error.message);
                selectElement.innerHTML = '<option value="">Gagal memuat</option>';
                return;
            }
            
            if (data.length === 0 && !companyId) {
                 selectElement.innerHTML = '<option value="">-- Pilih Perusahaan Dulu --</option>';
                 return;
            }
            if (data.length === 0 && companyId) {
                 selectElement.innerHTML = '<option value="">-- Belum ada Pola Jam Kerja --</option>';
                 return;
            }

            let options = '<option value="">-- Pilih Pola Jam Kerja --</option>';
            options += data.map(wh => {
                // Cek apakah ini adalah opsi yang harus dipilih
                const isSelected = (wh.id == selectedWorkhourId) ? 'selected' : '';
                return `<option value="${wh.id}" ${isSelected}>${wh.name}</option>`;
            }).join('');
            
            selectElement.innerHTML = options;
            selectElement.disabled = false;
        }

        // (BARU) Event listener untuk modal master,
        // Tampilkan/sembunyikan field 'Trigger Status' berdasarkan 'Metode'
        try {
            const deductionMethodSelect = document.getElementById('masterDeductionMethod');
            const deductionConditionContainer = document.getElementById('masterDeductionConditionContainer');
            
            deductionMethodSelect.addEventListener('change', () => {
                if (deductionMethodSelect.value === 'Berdasarkan Absensi') {
                    deductionConditionContainer.classList.remove('hidden');
                } else {
                    deductionConditionContainer.classList.add('hidden');
                }
            });
        } catch (e) {
             console.warn("Elemen listener untuk Deductions tidak ditemukan.");
        }

        // (BARU) Event listener untuk modal master,
        // Tampilkan/sembunyikan field 'Trigger Status' untuk GAJI
        try {
            const salaryMethodSelect = document.getElementById('masterSalaryMethod');
            const salaryConditionContainer = document.getElementById('masterSalaryConditionContainer');
            
            salaryMethodSelect.addEventListener('change', () => {
                const method = salaryMethodSelect.value;
                // Tampilkan pemicu jika 'Berdasarkan Lembur' ATAU 'Berdasarkan Absensi'
                if (method === 'Berdasarkan Lembur' || method === 'Berdasarkan Absensi') {
                    salaryConditionContainer.classList.remove('hidden');
                } else {
                    salaryConditionContainer.classList.add('hidden');
                }
            });
        } catch (e) {
             console.warn("Elemen listener untuk Salary tidak ditemukan.");
        }

        // (BARU) Event listener untuk Form & Delete Modal Jam Kerja
        try {
            workhourForm.addEventListener('submit', handleSaveWorkhour);
            workhourDeleteConfirmButton.addEventListener('click', handleConfirmWorkhourDelete);
        } catch (e) {
            console.warn("Elemen Form Jam Kerja (workhourForm) tidak ditemukan.");
        }

        // (BARU) Event listener untuk 7 checkbox "Hari Libur" di modal jam kerja
        try {
            workhourDays.forEach(day => {
                const checkbox = document.getElementById(`wh_${day}_is_off`);
                const startInput = document.getElementById(`wh_${day}_start`);
                const endInput = document.getElementById(`wh_${day}_end`);

                checkbox.addEventListener('change', () => {
                    const isChecked = checkbox.checked;
                    startInput.disabled = isChecked;
                    endInput.disabled = isChecked;
                    if (isChecked) {
                        startInput.classList.add('bg-gray-200');
                        endInput.classList.add('bg-gray-200');
                    } else {
                        startInput.classList.remove('bg-gray-200');
                        endInput.classList.remove('bg-gray-200');
                    }
                });
            });
        } catch (e) {
            console.warn("Elemen checkbox jam kerja tidak ditemukan.");
        }

        // (BARU) Event listener untuk Form Saldo Cuti
        try {
            document.getElementById('timeoffBalanceForm').addEventListener('submit', handleSaveTimeoffBalance);
        } catch (e) {
            console.warn("Elemen Form Saldo Cuti (timeoffBalanceForm) tidak ditemukan.");
        }

        // --- FUNGSI BARU: LOGIKA PAYROLL & GAJI ---

        // Inisialisasi awal menu Payroll
        function initializePayroll() {
            const today = new Date();
            const year = today.getFullYear();
            // Set default filter ke bulan lalu
            const month = today.getMonth() === 0 ? 12 : today.getMonth(); // Bulan lalu (1-12)
            const yearFilter = today.getMonth() === 0 ? year - 1 : year;
            const monthString = String(month).padStart(2, '0');
            
            // Format input month (YYYY-MM)
            document.getElementById('payrollMonthFilter').value = `${yearFilter}-${monthString}`;
        }

        // 1. Memuat Riwayat Payroll yang Sudah Diproses
        async function loadPayrollHistory() {
            const tableBody = document.getElementById('payrollHistoryTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat riwayat penggajian...</td></tr>';
            
            let query = _supabase
                .from('payroll')
                .select(`
                    *,
                    user_id(full_name)
                `)
                .order('pay_period_month', { ascending: false });

            if (globalProfile.role !== 'super_admin') {
                query = query.eq('company_id', globalProfile.company_id);
            }
            
            const { data, error } = await query;

            if (error) {
                console.error("Gagal memuat riwayat payroll:", error.message);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat: ${error.message}</td></tr>`;
                return;
            }
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada riwayat penggajian yang tersimpan.</td></tr>';
                return;
            }
            
            const html = data.map(item => {
                const periodDate = new Date(item.pay_period_month);
                const periodDisplay = periodDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                const name = item.user_id ? item.user_id.full_name : 'N/A';
                const netPay = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.takehomepay);
                const processedAt = item.processed_at ? new Date(item.processed_at).toLocaleDateString('id-ID') : '-';
                
                let statusClass;
                if (item.status === 'Paid') statusClass = 'bg-green-100 text-green-800';
                else if (item.status === 'Processed') statusClass = 'bg-blue-100 text-blue-800';
                else if (item.status === 'Cancelled') statusClass = 'bg-red-100 text-red-800';
                else statusClass = 'bg-yellow-100 text-yellow-800'; // Pending

                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${periodDisplay}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${name}</td>
                        <td class="px-4 py-3 text-right text-sm font-bold">${netPay}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${item.status.toUpperCase()}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">${processedAt}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button onclick="viewPayslip('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-2">Lihat</button>
                            ${item.status !== 'Paid' ? `<button onclick="openConfirmPayrollDelete('${item.id}', '${periodDisplay}')" class="text-red-600 hover:text-red-800">Hapus</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // ===============================================================
        // FUNGSI UTAMA PAYROLL (REVISI LENGKAP)
        // ===============================================================

        async function calculateAndSavePayroll() {
            // 1. Ambil Filter & UI Elements
            const monthYear = document.getElementById('payrollMonthFilter').value; // Format: YYYY-MM
            const calculateButton = document.getElementById('calculatePayrollButton');
            const companyId = globalProfile.company_id;
            const payPeriodMonth = `${monthYear}-01`; // Cth: 2025-11-01

            if (!monthYear) {
                showMessage("Harap pilih periode bulan dan tahun.", 'error');
                return;
            }

            calculateButton.disabled = true;
            calculateButton.innerHTML = `<div class="spinner w-4 h-4 border-2 border-t-transparent border-white mr-2" role="status"></div> Sedang memproses...`;
            showMessage(`Memulai kalkulasi payroll untuk periode ${monthYear}...`, 'info');

            // 2. Tentukan Rentang Tanggal Absensi
            // (Logika ini sudah benar dari kode Anda sebelumnya, mengambil dari setting perusahaan)
            const startDay = globalProfile.companies?.payroll_start_day || 1; 

            let endAttendanceDate;
            if (startDay === 1) {
                endAttendanceDate = new Date(`${monthYear}-01`);
                endAttendanceDate.setMonth(endAttendanceDate.getMonth() + 1);
                endAttendanceDate.setDate(0);
            } else {
                endAttendanceDate = new Date(`${monthYear}-${String(startDay).padStart(2, '0')}`);
                endAttendanceDate.setDate(endAttendanceDate.getDate() - 1);
            }
            
            let startAttendanceDate;
            if (startDay === 1) {
                startAttendanceDate = new Date(`${monthYear}-01`);
            } else {
                startAttendanceDate = new Date(`${monthYear}-01`);
                startAttendanceDate.setMonth(startAttendanceDate.getMonth() - 1); 
                startAttendanceDate.setDate(startDay);
            }
            
            const startAttendanceISO = startAttendanceDate.toISOString();
            const endAttendanceNextDay = new Date(endAttendanceDate);
            endAttendanceNextDay.setDate(endAttendanceNextDay.getDate() + 1);
            const endAttendanceISO = endAttendanceNextDay.toISOString();
            
            console.log(`[Payroll] Menghitung data absensi dari ${startAttendanceDate.toLocaleDateString('id-ID')} sampai ${endAttendanceDate.toLocaleDateString('id-ID')}`);

            // 3. Ambil Karyawan (REVISI: Ambil JADWAL KERJA)
            let employeeQuery = _supabase
                .from('profiles')
                .select('id, full_name, workhours( schedule )') // (REVISI: Ambil workhours)
                .in('role', ['karyawan', 'company_admin']);
                
            if (globalProfile.role !== 'super_admin') {
                employeeQuery = employeeQuery.eq('company_id', companyId);
            }
            const { data: employees, error: empError } = await employeeQuery;

            if (empError || employees.length === 0) {
                showMessage(`Gagal: Tidak ada karyawan ditemukan di perusahaan ini. ${empError?.message || ''}`, 'error');
                calculateButton.disabled = false;
                calculateButton.innerHTML = `<ion-icon name="calculator-outline" class="text-lg mr-2"></ion-icon> Hitung & Proses Payroll`;
                return;
            }
            const employeeIds = employees.map(e => e.id);

            // ===============================================================
            // 4. PRE-FETCH DATA (LOGIKA BARU YANG PENTING)
            // ===============================================================
            
            // 4a. Ambil SEMUA data absensi dalam rentang waktu
            const { data: allAttendance, error: attError } = await _supabase
                .from('attendance')
                .select('user_id, attendance_status, created_at') // (REVISI: Ambil created_at)
                .in('user_id', employeeIds)
                .gte('created_at', startAttendanceISO)
                .lt('created_at', endAttendanceISO);

            if (attError) {
                showMessage(`Gagal memuat data absensi: ${attError.message}`, 'error');
            }
            
            // (REVISI) Buat Peta Absensi (Key: "USER_ID|YYYY-MM-DD")
            // Ini PENTING untuk lookup harian
            const attendanceLookupMap = new Map();
            if(allAttendance) {
                allAttendance.forEach(att => {
                    // Konversi UTC ke tanggal lokal yang benar
                    const dateKey = getTodayDateString(new Date(att.created_at)); 
                    attendanceLookupMap.set(`${att.user_id}|${dateKey}`, att.attendance_status);
                });
            }

            // 4b. Ambil SEMUA data lembur (Overtime) yang disetujui
            // (Logika ini sudah benar)
            const { data: allOvertime, error: otError } = await _supabase
                .from('overtime_requests')
                .select('user_id, start_time, end_time')
                .in('user_id', employeeIds)
                .eq('overtime_status', 'Disetujui')
                .gte('overtime_date', getTodayDateString(startAttendanceDate))
                .lte('overtime_date', getTodayDateString(endAttendanceDate));

            if (otError) {
                showMessage(`Gagal memuat data lembur: ${otError.message}`, 'error');
            }

            // Buat Peta Lembur (Map<user_id, total_jam_lembur>)
            // (Logika ini sudah benar)
            const overtimeMap = new Map();
            if(allOvertime) {
                allOvertime.forEach(ot => {
                    const totalHours = (new Date(ot.end_time) - new Date(ot.start_time)) / (1000 * 60 * 60);
                    const currentHours = overtimeMap.get(ot.user_id) || 0;
                    overtimeMap.set(ot.user_id, currentHours + totalHours);
                });
            }

            // 4c. Ambil SEMUA aturan Potongan (Deduction)
            // (Logika ini sudah benar)
            const { data: allDeductionRules, error: dedError } = await _supabase
                .from('deduction_types')
                .select('name, method, value, condition_rule')
                .or(`company_id.eq.${companyId},company_id.is.null`);
            
            if (dedError) {
                showMessage(`Gagal memuat aturan potongan: ${dedError.message}`, 'error');
            }
            
            // (BARU) 4d. Ambil SEMUA Hari Libur Nasional
            const { data: allHolidays, error: holidayError } = await _supabase.from('holidays')
                .select('holiday_date')
                .gte('holiday_date', getTodayDateString(startAttendanceDate))
                .lte('holiday_date', getTodayDateString(endAttendanceDate));
                
            const holidayMap = {};
            if (allHolidays) {
                allHolidays.forEach(h => { holidayMap[h.holiday_date] = true; });
            }
            // Definisikan nama hari (penting untuk cek jadwal/shift)
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

            // ===============================================================
            // 5. LOOP PERHITUNGAN PER KARYAWAN
            // ===============================================================
            let successCount = 0;
            let errorCount = 0;

            for (const employee of employees) {
                try {
                    let grossSalary = 0;
                    let salaryDetails = {};
                    let totalDeductions = 0;
                    let deductionDetails = {};

                    // (REVISI) Ambil data lembur
                    const employeeOvertimeHours = overtimeMap.get(employee.id) || 0;
                    
                    // (LOGIKA BARU) Bangun array status (termasuk 'Alpa')
                    const employeeAttendance = []; // Ini array yang akan diisi
                    
                    // Kita harus buat salinan 'startAttendanceDate' agar loop tidak merusak tanggal aslinya
                    const loopDate = new Date(startAttendanceDate.getTime());
                    
                    while (loopDate <= endAttendanceDate) {
                        const dateKey = getTodayDateString(loopDate); // "YYYY-MM-DD"
                        const dayOfWeek = loopDate.getDay(); // 0=Minggu, 6=Sabtu
                        const todayName = dayNames[dayOfWeek]; // "Senin", "Selasa", ...
                        
                        const isMasterHoliday = holidayMap[dateKey] === true;
                        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                        
                        let status = 'Alpa'; // Status default
                        
                        // 1. Cek di Peta Absensi (Lookup Map)
                        const attStatus = attendanceLookupMap.get(`${employee.id}|${dateKey}`);
                        
                        if (attStatus) {
                            status = attStatus; // 'Hadir', 'Terlambat', 'Izin / Cuti'
                        } else {
                            // 2. Tidak ada data, cek apakah hari libur/shift
                            const schedule = employee.workhours?.schedule;
                            const isShiftOff = (schedule && schedule[todayName] && schedule[todayName].is_off === true);
                            
                            if (isMasterHoliday || isShiftOff || isWeekend) {
                                status = 'Libur'; // Bukan 'Alpa'
                            }
                        }
                        
                        // Masukkan status (Hadir, Alpa, Libur, dll) ke array karyawan
                        employeeAttendance.push(status);
                        
                        // Lanjut ke hari berikutnya
                        loopDate.setDate(loopDate.getDate() + 1);
                    }
                    // (Array 'employeeAttendance' sekarang sudah penuh, cth: ['Hadir', 'Alpa', 'Alpa', 'Libur', ...])

                    // 5a. Ambil Komponen Gaji Karyawan
                    const { data: salaries, error: salError } = await _supabase
                        .from('employee_salaries')
                        .select(`salary_amount, salary_types(name, method)`)
                        .eq('user_id', employee.id);
                    
                    if (salError) throw new Error(`Gagal query gaji: ${salError.message}`);
                    if (!salaries || salaries.length === 0) throw new Error(`Tidak punya komponen gaji.`);

                    // 5b. Hitung PENGHASILAN (Gaji Kotor)
                    for (const sal of salaries) {
                        if (!sal.salary_types) continue;
                        
                        const componentName = sal.salary_types.name;
                        const componentMethod = sal.salary_types.method;
                        const componentRate = sal.salary_amount;
                        let calculatedAmount = 0;

                        if (componentMethod === 'Nominal Tetap') {
                            calculatedAmount = componentRate;
                        } 
                        else if (componentMethod === 'Berdasarkan Lembur') {
                            // (Logika ini sudah benar)
                            calculatedAmount = employeeOvertimeHours * componentRate;
                        } 
                        else if (componentMethod === 'Berdasarkan Absensi') {
                            // (Logika ini sekarang berfungsi)
                            const hadirs = employeeAttendance.filter(s => s === 'Hadir').length;
                            calculatedAmount = hadirs * componentRate; // Cth: Bonus per kehadiran
                        }
                        
                        salaryDetails[componentName] = calculatedAmount;
                        grossSalary += calculatedAmount;
                    }

                    // 5c. Hitung POTONGAN (Deductions)
                    if(allDeductionRules) {
                        for (const rule of allDeductionRules) {
                            const componentName = rule.name;
                            const componentMethod = rule.method;
                            const componentRate = rule.value;
                            let calculatedAmount = 0;

                            if (componentMethod === 'Nominal Tetap') {
                                calculatedAmount = componentRate;
                            } else if (componentMethod === 'Persentase') {
                                calculatedAmount = (grossSalary * componentRate) / 100;
                            } else if (componentMethod === 'Berdasarkan Absensi') {
                                // (Logika ini sekarang berfungsi)
                                const triggerStatus = rule.condition_rule?.trigger_status; // "Alpa"
                                if (triggerStatus) {
                                    // Hitung jumlah 'Alpa' (atau 'Terlambat') dari array yang baru kita buat
                                    const count = employeeAttendance.filter(s => s === triggerStatus).length;
                                    calculatedAmount = count * componentRate; // (Jumlah Alpa * Rate per Alpa)
                                }
                            }

                            if (calculatedAmount > 0) {
                                deductionDetails[componentName] = calculatedAmount;
                                totalDeductions += calculatedAmount;
                            }
                        }
                    }

                    // 5d. Kalkulasi Final
                    const netPay = grossSalary - totalDeductions;

                    // 5e. Siapkan Payload untuk Disimpan
                    const payrollPayload = {
                        user_id: employee.id,
                        company_id: companyId,
                        pay_period_month: payPeriodMonth,
                        salary_detail: salaryDetails,       // JSONB
                        salary_total: grossSalary,
                        deduction_detail: deductionDetails,  // JSONB
                        deduction_total: totalDeductions,
                        takehomepay: netPay,
                        processor_id: globalProfile.id,
                        processed_at: new Date().toISOString(),
                        status: 'Processed', 
                    };

                    // 5f. Simpan (UPSERT)
                    const { error: saveError } = await _supabase
                        .from('payroll')
                        .upsert([payrollPayload], { onConflict: 'user_id, pay_period_month' });

                    if (saveError) throw new Error(saveError.message);
                    
                    successCount++;

                } catch (e) {
                    console.error(`[Payroll] Gagal memproses ${employee.full_name}:`, e.message);
                    errorCount++;
                }
            } // --- Akhir Loop Karyawan ---

            // 6. Selesai
            const finalMessage = `Proses Selesai: ${successCount} payroll berhasil dihitung/diperbarui. ${errorCount} gagal/dilewati.`;
            showMessage(finalMessage, errorCount > 0 ? 'error' : 'success');
            
            calculateButton.disabled = false;
            calculateButton.innerHTML = `<ion-icon name="calculator-outline" class="text-lg mr-2"></ion-icon> Hitung & Proses Payroll`;
            loadPayrollHistory(); // Muat ulang riwayat
        }

        // 3. FUNGSI BARU: Aksi Lihat Payslip (Mengganti Placeholder)
        async function viewPayslip(payrollId) {
            showMessage(`Memuat rincian payslip...`, 'info');
            
            // 1. Ambil data payroll spesifik
            const { data: payroll, error } = await _supabase
                .from('payroll')
                .select(`
                    *,
                    user_id(full_name),
                    processor_id(full_name)
                `)
                .eq('id', payrollId)
                .single();

            if (error || !payroll) {
                showMessage(`Gagal memuat payslip: ${error?.message || 'Data tidak ditemukan.'}`, 'error');
                return;
            }

            // 2. Format Data Numerik
            const formatRupiah = (amount) => 
                new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            
            // 3. Isi Header dan Ringkasan
            const periodDate = new Date(payroll.pay_period_month);
            const periodDisplay = periodDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });

            document.getElementById('payslipPeriod').textContent = `Periode ${periodDisplay}`;
            document.getElementById('payslipEmployeeName').textContent = payroll.user_id ? payroll.user_id.full_name : 'N/A';

            document.getElementById('payslipGross').textContent = formatRupiah(payroll.salary_total);
            document.getElementById('payslipDeduction').textContent = formatRupiah(payroll.deduction_total);
            document.getElementById('payslipNet').textContent = formatRupiah(payroll.takehomepay);

            // 4. Tampilkan Rincian Penghasilan (JSONB: salary_detail)
            const salaryDetailBody = document.getElementById('payslipSalaryDetailBody');
            let salaryHtml = '';
            const salaryDetails = payroll.salary_detail || {};
            const salaryKeys = Object.keys(salaryDetails);

            if (salaryKeys.length > 0) {
                salaryKeys.forEach(key => {
                    const amount = salaryDetails[key];
                    salaryHtml += `
                        <tr>
                            <td class="py-1 text-gray-700">${key}</td>
                            <td class="py-1 text-right font-medium text-green-600">${formatRupiah(amount)}</td>
                        </tr>
                    `;
                });
            } else {
                salaryHtml = `<tr><td colspan="2" class="py-2 text-gray-500">Tidak ada rincian penghasilan.</td></tr>`;
            }
            salaryDetailBody.innerHTML = salaryHtml;

            // 5. Tampilkan Rincian Potongan (JSONB: deduction_detail)
            const deductionDetailBody = document.getElementById('payslipDeductionDetailBody');
            let deductionHtml = '';
            const deductionDetails = payroll.deduction_detail || {};
            const deductionKeys = Object.keys(deductionDetails);

            if (deductionKeys.length > 0) {
                deductionKeys.forEach(key => {
                    const amount = deductionDetails[key];
                    deductionHtml += `
                        <tr>
                            <td class="py-1 text-gray-700">${key}</td>
                            <td class="py-1 text-right font-medium text-red-600">(${formatRupiah(amount)})</td>
                        </tr>
                    `;
                });
            } else {
                deductionHtml = `<tr><td colspan="2" class="py-2 text-gray-500">Tidak ada rincian potongan.</td></tr>`;
            }
            deductionDetailBody.innerHTML = deductionHtml;
            
            // 6. Tampilkan Footer Info
            const processorName = payroll.processor_id ? payroll.processor_id.full_name : 'Sistem';
            const processedDate = payroll.processed_at ? new Date(payroll.processed_at).toLocaleDateString('id-ID') : 'N/A';
            document.getElementById('payslipProcessedAt').textContent = `Diproses oleh ${processorName} pada ${processedDate}`;


            // 7. Tampilkan Modal
            payslipModal.classList.remove('hidden');
        }

        // 4. FUNGSI BARU: Aksi Hapus Payroll (Hanya memanggil konfirmasi)
        function deletePayroll(payrollId, periodDisplay) {
            // Mengganti window.confirm dengan modal kustom
            openConfirmPayrollDelete(payrollId, periodDisplay);
        }

        // 4. Placeholder Aksi (Hapus Payroll)
        async function deletePayroll(payrollId, periodDisplay) {
            if (!confirm(`Apakah Anda yakin ingin menghapus hasil payroll periode ${periodDisplay} ini?`)) return;

            showMessage("Menghapus hasil payroll...", 'info');
            
            const { error } = await _supabase.from('payroll').delete().eq('id', payrollId);

            if (error) {
                showMessage(`Gagal menghapus: ${error.message}`, 'error');
                return;
            }

            showMessage('Hasil payroll berhasil dihapus.', 'success');
            loadPayrollHistory();
        }

        // --- LOGIKA MODAL HAPUS PAYROLL ---
        const payrollDeleteModal = document.getElementById('payrollDeleteModal');
        const payrollDeleteText = document.getElementById('payrollDeleteText');
        const payrollDeleteConfirmButton = document.getElementById('payrollDeleteConfirmButton');
        const payslipModal = document.getElementById('payslipModal');

        let currentPayrollDeleteId = null;

        function openConfirmPayrollDelete(id, periodDisplay) {
            currentPayrollDeleteId = id;
            payrollDeleteText.innerHTML = `Apakah Anda yakin ingin menghapus hasil payroll periode <strong>${periodDisplay}</strong> ini? Tindakan ini tidak bisa dibatalkan.`;
            payrollDeleteModal.classList.remove('hidden');
        }

        function closeConfirmPayrollDelete() {
            payrollDeleteModal.classList.add('hidden');
            currentPayrollDeleteId = null;
        }

        // Logika saat tombol konfirmasi Hapus di modal diklik
        async function handleConfirmPayrollDelete() {
            // PERBAIKAN: Simpan ID di variabel lokal terlebih dahulu
            const idToDelete = currentPayrollDeleteId; 

            if (!idToDelete) { // Cek variabel lokal
                console.error("ID payroll untuk dihapus tidak ditemukan.");
                closeConfirmPayrollDelete(); // Pastikan modal tertutup jika terjadi error aneh
                return;
            }

            showMessage("Menghapus hasil payroll...", 'info');
            closeConfirmPayrollDelete(); // Sekarang aman untuk memanggil close, karena ID sudah disimpan

            // PERBAIKAN: Gunakan variabel lokal 'idToDelete'
            const { error } = await _supabase.from('payroll').delete().eq('id', idToDelete); 

            if (error) {
                showMessage(`Gagal menghapus: ${error.message}`, 'error');
                return;
            }

            showMessage('Hasil payroll berhasil dihapus.', 'success');
            loadPayrollHistory();
        }

        // Event listener untuk tombol konfirmasi hapus payroll
        try {
            payrollDeleteConfirmButton.addEventListener('click', handleConfirmPayrollDelete);
        } catch (e) {
            console.warn("Elemen Konfirmasi Hapus Payroll tidak ditemukan.");
        }

        function closePayslipModal() {
            payslipModal.classList.add('hidden');
        }

        // (BARU) Event listener untuk Form Pengajuan Lembur Karyawan
        try {
            document.getElementById('overtimeRequestForm').addEventListener('submit', handleNewOvertimeRequest);
        } catch (e) {
            console.warn("Form pengajuan lembur (overtimeRequestForm) tidak ditemukan.");
        }

        // (BARU) Event listener untuk Form Pengajuan Lembur Karyawan
        try {
            document.getElementById('overtimeRequestForm').addEventListener('submit', handleNewOvertimeRequest);
            
            // ===== TAMBAHKAN EVENT LISTENER BARU DI SINI =====
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            // ===============================================
            
        } catch (e) {
            console.warn("Form pengajuan lembur (overtimeRequestForm) atau changePasswordForm tidak ditemukan.");
        }

        try {
            document.getElementById('overtimeRequestForm').addEventListener('submit', handleNewOvertimeRequest);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // ===== TAMBAHKAN LISTENER KONFIRMASI LOKASI DI SINI =====
            document.getElementById('confirmClockInButton').addEventListener('click', handleConfirmClockIn);
            // =======================================================
            
        } catch (e) {
            console.warn("Form pengajuan lembur (overtimeRequestForm) atau changePasswordForm tidak ditemukan.");
        }

    </script>
</body>
</html>
